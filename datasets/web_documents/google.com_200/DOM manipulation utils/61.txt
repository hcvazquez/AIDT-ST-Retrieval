<!doctype html>
<!--[if lt IE 10]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

  
    itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-offline-url="/"
data-url="/library/view/programming-javascript-applications/9781491950289/ch05.html"
data-archive="9781491950289"
data-publishers="O&#39;Reilly Media, Inc."


  data-htmlfile-name="ch05.html"
  data-epub-title="Programming JavaScript Applications"
  


data-debug="0" ><![endif]-->
<!--[if gt IE 9]><!-->
<html class="no-js" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-offline-url="/" data-url="/library/view/programming-javascript-applications/9781491950289/ch05.html" data-archive="9781491950289" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch05.html" data-epub-title="Programming JavaScript Applications" data-debug="0">
 <!--<![endif]-->
 <head> 
  <meta charset="UTF-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <title>5. Separation of Concerns - Programming JavaScript Applications [Book]</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <link rel="stylesheet" href="/library/view/static/CACHE/css/263a54664f8a.css" type="text/css"> 
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet" type="text/css"> 
  <meta property="og:title" content="5. Separation of Concerns [Book]"> 
  <meta itemprop="isPartOf" content="/library/view/programming-javascript-applications/9781491950289/"> 
  <meta itemprop="name" content="5. Separation of Concerns"> 
  <meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/programming-javascript-applications/9781491950289/ch05.html"> 
  <meta property="og:site_name" content="Safari"> 
  <meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781491950289/"> 
  <meta property="og:description" itemprop="description" name="description" content="Chapter&nbsp;5.&nbsp;Separation of Concerns Separation of concerns is the idea that each module or layer in an application should only be responsible for one thing and should not contain ...  - Selection from Programming JavaScript Applications [Book]"> 
  <meta itemprop="inLanguage" content="en"> 
  <meta itemprop="publisher" content="O'Reilly Media, Inc."> 
  <meta property="og:type" content="book"> 
  <meta property="og:book:isbn" itemprop="isbn" content="9781491950296"> 
  <meta property="og:book:author" itemprop="author" content="Eric Elliott"> 
  <meta property="og:book:tag" itemprop="about" content="JavaScript"> 
  <meta name="twitter:card" content="summary"> 
  <meta name="twitter:site" content="@safari"> 
  <!-- Start Visual Website Optimizer Asynchronous Code --> 
  <script type="text/javascript">
var _vwo_code=(function(){
var account_id=291788,
settings_tolerance=2000,
library_tolerance=2500,
use_existing_jquery=false,
/* DO NOT EDIT BELOW THIS LINE */
f=false,d=document;return{use_existing_jquery:function(){return use_existing_jquery;},library_tolerance:function(){return library_tolerance;},finish:function(){if(!f){f=true;var a=d.getElementById('_vis_opt_path_hides');if(a)a.parentNode.removeChild(a);}},finished:function(){return f;},load:function(a){var b=d.createElement('script');b.src=a;b.type='text/javascript';b.innerText;b.onerror=function(){_vwo_code.finish();};d.getElementsByTagName('head')[0].appendChild(b);},init:function(){settings_timer=setTimeout('_vwo_code.finish()',settings_tolerance);var a=d.createElement('style'),b='body{opacity:0 !important;filter:alpha(opacity=0) !important;background:none !important;}',h=d.getElementsByTagName('head')[0];a.setAttribute('id','_vis_opt_path_hides');a.setAttribute('type','text/css');if(a.styleSheet)a.styleSheet.cssText=b;else a.appendChild(d.createTextNode(b));h.appendChild(a);this.load('//dev.visualwebsiteoptimizer.com/j.php?a='+account_id+'&u='+encodeURIComponent(d.URL)+'&r='+Math.random());return settings_timer;}};}());_vwo_settings_timer=_vwo_code.init();
</script> 
  <!-- End Visual Website Optimizer Asynchronous Code --> 
  <link rel="shortcut icon" href="//www.safaribooksonline.com/favicon.ico" type="image/vnd.microsoft.icon"> 
  <link rel="apple-touch-icon" href="//www.safaribooksonline.com/static/corp/img/apple-touch-icon.png"> 
  <style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}
    </style> 
  <style>
    header.global {
      top:26px;
    }
    .orm-topbar {
      width: 100%;
      height: 26px;
      padding: 0 17px;
      line-height: 26px;
      background: #d3002d;
      color: #fff;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9;
      font-size: 13px;
    }
    .orm-topbar svg {
      width: 78px;
      height: 13px;
      fill: #fff;
      vertical-align: middle;
    }
    .orm-topbar span {
      vertical-align: middle;
      float: right;
      color: #fff;
      font-weight: bold;
    }
    .orm-topbar:hover span {
      text-decoration: underline;
    }
    </style> 
  <script type="text/javascript">(window.NREUM||(NREUM={})).loader_config={xpid:"VQQDUVVVGwIAUFFQBQMP"};window.NREUM||(NREUM={}),__nr_require=function(t,n,e){function r(e){if(!n[e]){var o=n[e]={exports:{}};t[e][0].call(o.exports,function(n){var o=t[e][1][n];return r(o||n)},o,o.exports)}return n[e].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<e.length;o++)r(e[o]);return r}({1:[function(t,n,e){function r(t){try{s.console&&console.log(t)}catch(n){}}var o,i=t("ee"),a=t(15),s={};try{o=localStorage.getItem("__nr_flags").split(","),console&&"function"==typeof console.log&&(s.console=!0,o.indexOf("dev")!==-1&&(s.dev=!0),o.indexOf("nr_dev")!==-1&&(s.nrDev=!0))}catch(c){}s.nrDev&&i.on("internal-error",function(t){r(t.stack)}),s.dev&&i.on("fn-err",function(t,n,e){r(e.stack)}),s.dev&&(r("NR AGENT IN DEVELOPMENT MODE"),r("flags: "+a(s,function(t,n){return t}).join(", ")))},{}],2:[function(t,n,e){function r(t,n,e,r,o){try{d?d-=1:i("err",[o||new UncaughtException(t,n,e)])}catch(s){try{i("ierr",[s,c.now(),!0])}catch(u){}}return"function"==typeof f&&f.apply(this,a(arguments))}function UncaughtException(t,n,e){this.message=t||"Uncaught error with no additional information",this.sourceURL=n,this.line=e}function o(t){i("err",[t,c.now()])}var i=t("handle"),a=t(16),s=t("ee"),c=t("loader"),f=window.onerror,u=!1,d=0;c.features.err=!0,t(1),window.onerror=r;try{throw new Error}catch(l){"stack"in l&&(t(8),t(7),"addEventListener"in window&&t(5),c.xhrWrappable&&t(9),u=!0)}s.on("fn-start",function(t,n,e){u&&(d+=1)}),s.on("fn-err",function(t,n,e){u&&(this.thrown=!0,o(e))}),s.on("fn-end",function(){u&&!this.thrown&&d>0&&(d-=1)}),s.on("internal-error",function(t){i("ierr",[t,c.now(),!0])})},{}],3:[function(t,n,e){t("loader").features.ins=!0},{}],4:[function(t,n,e){function r(t){}if(window.performance&&window.performance.timing&&window.performance.getEntriesByType){var o=t("ee"),i=t("handle"),a=t(8),s=t(7),c="learResourceTimings",f="addEventListener",u="resourcetimingbufferfull",d="bstResource",l="resource",p="-start",h="-end",m="fn"+p,w="fn"+h,v="bstTimer",y="pushState",g=t("loader");g.features.stn=!0,t(6);var b=NREUM.o.EV;o.on(m,function(t,n){var e=t[0];e instanceof b&&(this.bstStart=g.now())}),o.on(w,function(t,n){var e=t[0];e instanceof b&&i("bst",[e,n,this.bstStart,g.now()])}),a.on(m,function(t,n,e){this.bstStart=g.now(),this.bstType=e}),a.on(w,function(t,n){i(v,[n,this.bstStart,g.now(),this.bstType])}),s.on(m,function(){this.bstStart=g.now()}),s.on(w,function(t,n){i(v,[n,this.bstStart,g.now(),"requestAnimationFrame"])}),o.on(y+p,function(t){this.time=g.now(),this.startPath=location.pathname+location.hash}),o.on(y+h,function(t){i("bstHist",[location.pathname+location.hash,this.startPath,this.time])}),f in window.performance&&(window.performance["c"+c]?window.performance[f](u,function(t){i(d,[window.performance.getEntriesByType(l)]),window.performance["c"+c]()},!1):window.performance[f]("webkit"+u,function(t){i(d,[window.performance.getEntriesByType(l)]),window.performance["webkitC"+c]()},!1)),document[f]("scroll",r,{passive:!0}),document[f]("keypress",r,!1),document[f]("click",r,!1)}},{}],5:[function(t,n,e){function r(t){for(var n=t;n&&!n.hasOwnProperty(u);)n=Object.getPrototypeOf(n);n&&o(n)}function o(t){s.inPlace(t,[u,d],"-",i)}function i(t,n){return t[1]}var a=t("ee").get("events"),s=t(18)(a,!0),c=t("gos"),f=XMLHttpRequest,u="addEventListener",d="removeEventListener";n.exports=a,"getPrototypeOf"in Object?(r(document),r(window),r(f.prototype)):f.prototype.hasOwnProperty(u)&&(o(window),o(f.prototype)),a.on(u+"-start",function(t,n){var e=t[1],r=c(e,"nr@wrapped",function(){function t(){if("function"==typeof e.handleEvent)return e.handleEvent.apply(e,arguments)}var n={object:t,"function":e}[typeof e];return n?s(n,"fn-",null,n.name||"anonymous"):e});this.wrapped=t[1]=r}),a.on(d+"-start",function(t){t[1]=this.wrapped||t[1]})},{}],6:[function(t,n,e){var r=t("ee").get("history"),o=t(18)(r);n.exports=r,o.inPlace(window.history,["pushState","replaceState"],"-")},{}],7:[function(t,n,e){var r=t("ee").get("raf"),o=t(18)(r),i="equestAnimationFrame";n.exports=r,o.inPlace(window,["r"+i,"mozR"+i,"webkitR"+i,"msR"+i],"raf-"),r.on("raf-start",function(t){t[0]=o(t[0],"fn-")})},{}],8:[function(t,n,e){function r(t,n,e){t[0]=a(t[0],"fn-",null,e)}function o(t,n,e){this.method=e,this.timerDuration=isNaN(t[1])?0:+t[1],t[0]=a(t[0],"fn-",this,e)}var i=t("ee").get("timer"),a=t(18)(i),s="setTimeout",c="setInterval",f="clearTimeout",u="-start",d="-";n.exports=i,a.inPlace(window,[s,"setImmediate"],s+d),a.inPlace(window,[c],c+d),a.inPlace(window,[f,"clearImmediate"],f+d),i.on(c+u,r),i.on(s+u,o)},{}],9:[function(t,n,e){function r(t,n){d.inPlace(n,["onreadystatechange"],"fn-",s)}function o(){var t=this,n=u.context(t);t.readyState>3&&!n.resolved&&(n.resolved=!0,u.emit("xhr-resolved",[],t)),d.inPlace(t,y,"fn-",s)}function i(t){g.push(t),h&&(x?x.then(a):w?w(a):(E=-E,O.data=E))}function a(){for(var t=0;t<g.length;t++)r([],g[t]);g.length&&(g=[])}function s(t,n){return n}function c(t,n){for(var e in t)n[e]=t[e];return n}t(5);var f=t("ee"),u=f.get("xhr"),d=t(18)(u),l=NREUM.o,p=l.XHR,h=l.MO,m=l.PR,w=l.SI,v="readystatechange",y=["onload","onerror","onabort","onloadstart","onloadend","onprogress","ontimeout"],g=[];n.exports=u;var b=window.XMLHttpRequest=function(t){var n=new p(t);try{u.emit("new-xhr",[n],n),n.addEventListener(v,o,!1)}catch(e){try{u.emit("internal-error",[e])}catch(r){}}return n};if(c(p,b),b.prototype=p.prototype,d.inPlace(b.prototype,["open","send"],"-xhr-",s),u.on("send-xhr-start",function(t,n){r(t,n),i(n)}),u.on("open-xhr-start",r),h){var x=m&&m.resolve();if(!w&&!m){var E=1,O=document.createTextNode(E);new h(a).observe(O,{characterData:!0})}}else f.on("fn-end",function(t){t[0]&&t[0].type===v||a()})},{}],10:[function(t,n,e){function r(t){var n=this.params,e=this.metrics;if(!this.ended){this.ended=!0;for(var r=0;r<d;r++)t.removeEventListener(u[r],this.listener,!1);if(!n.aborted){if(e.duration=a.now()-this.startTime,4===t.readyState){n.status=t.status;var i=o(t,this.lastSize);if(i&&(e.rxSize=i),this.sameOrigin){var c=t.getResponseHeader("X-NewRelic-App-Data");c&&(n.cat=c.split(", ").pop())}}else n.status=0;e.cbTime=this.cbTime,f.emit("xhr-done",[t],t),s("xhr",[n,e,this.startTime])}}}function o(t,n){var e=t.responseType;if("json"===e&&null!==n)return n;var r="arraybuffer"===e||"blob"===e||"json"===e?t.response:t.responseText;return h(r)}function i(t,n){var e=c(n),r=t.params;r.host=e.hostname+":"+e.port,r.pathname=e.pathname,t.sameOrigin=e.sameOrigin}var a=t("loader");if(a.xhrWrappable){var s=t("handle"),c=t(11),f=t("ee"),u=["load","error","abort","timeout"],d=u.length,l=t("id"),p=t(14),h=t(13),m=window.XMLHttpRequest;a.features.xhr=!0,t(9),f.on("new-xhr",function(t){var n=this;n.totalCbs=0,n.called=0,n.cbTime=0,n.end=r,n.ended=!1,n.xhrGuids={},n.lastSize=null,p&&(p>34||p<10)||window.opera||t.addEventListener("progress",function(t){n.lastSize=t.loaded},!1)}),f.on("open-xhr-start",function(t){this.params={method:t[0]},i(this,t[1]),this.metrics={}}),f.on("open-xhr-end",function(t,n){"loader_config"in NREUM&&"xpid"in NREUM.loader_config&&this.sameOrigin&&n.setRequestHeader("X-NewRelic-ID",NREUM.loader_config.xpid)}),f.on("send-xhr-start",function(t,n){var e=this.metrics,r=t[0],o=this;if(e&&r){var i=h(r);i&&(e.txSize=i)}this.startTime=a.now(),this.listener=function(t){try{"abort"===t.type&&(o.params.aborted=!0),("load"!==t.type||o.called===o.totalCbs&&(o.onloadCalled||"function"!=typeof n.onload))&&o.end(n)}catch(e){try{f.emit("internal-error",[e])}catch(r){}}};for(var s=0;s<d;s++)n.addEventListener(u[s],this.listener,!1)}),f.on("xhr-cb-time",function(t,n,e){this.cbTime+=t,n?this.onloadCalled=!0:this.called+=1,this.called!==this.totalCbs||!this.onloadCalled&&"function"==typeof e.onload||this.end(e)}),f.on("xhr-load-added",function(t,n){var e=""+l(t)+!!n;this.xhrGuids&&!this.xhrGuids[e]&&(this.xhrGuids[e]=!0,this.totalCbs+=1)}),f.on("xhr-load-removed",function(t,n){var e=""+l(t)+!!n;this.xhrGuids&&this.xhrGuids[e]&&(delete this.xhrGuids[e],this.totalCbs-=1)}),f.on("addEventListener-end",function(t,n){n instanceof m&&"load"===t[0]&&f.emit("xhr-load-added",[t[1],t[2]],n)}),f.on("removeEventListener-end",function(t,n){n instanceof m&&"load"===t[0]&&f.emit("xhr-load-removed",[t[1],t[2]],n)}),f.on("fn-start",function(t,n,e){n instanceof m&&("onload"===e&&(this.onload=!0),("load"===(t[0]&&t[0].type)||this.onload)&&(this.xhrCbStart=a.now()))}),f.on("fn-end",function(t,n){this.xhrCbStart&&f.emit("xhr-cb-time",[a.now()-this.xhrCbStart,this.onload,n],n)})}},{}],11:[function(t,n,e){n.exports=function(t){var n=document.createElement("a"),e=window.location,r={};n.href=t,r.port=n.port;var o=n.href.split("://");!r.port&&o[1]&&(r.port=o[1].split("/")[0].split("@").pop().split(":")[1]),r.port&&"0"!==r.port||(r.port="https"===o[0]?"443":"80"),r.hostname=n.hostname||e.hostname,r.pathname=n.pathname,r.protocol=o[0],"/"!==r.pathname.charAt(0)&&(r.pathname="/"+r.pathname);var i=!n.protocol||":"===n.protocol||n.protocol===e.protocol,a=n.hostname===document.domain&&n.port===e.port;return r.sameOrigin=i&&(!n.hostname||a),r}},{}],12:[function(t,n,e){function r(){}function o(t,n,e){return function(){return i(t,[f.now()].concat(s(arguments)),n?null:this,e),n?void 0:this}}var i=t("handle"),a=t(15),s=t(16),c=t("ee").get("tracer"),f=t("loader"),u=NREUM;"undefined"==typeof window.newrelic&&(newrelic=u);var d=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],l="api-",p=l+"ixn-";a(d,function(t,n){u[n]=o(l+n,!0,"api")}),u.addPageAction=o(l+"addPageAction",!0),u.setCurrentRouteName=o(l+"routeName",!0),n.exports=newrelic,u.interaction=function(){return(new r).get()};var h=r.prototype={createTracer:function(t,n){var e={},r=this,o="function"==typeof n;return i(p+"tracer",[f.now(),t,e],r),function(){if(c.emit((o?"":"no-")+"fn-start",[f.now(),r,o],e),o)try{return n.apply(this,arguments)}finally{c.emit("fn-end",[f.now()],e)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(t,n){h[n]=o(p+n)}),newrelic.noticeError=function(t){"string"==typeof t&&(t=new Error(t)),i("err",[t,f.now()])}},{}],13:[function(t,n,e){n.exports=function(t){if("string"==typeof t&&t.length)return t.length;if("object"==typeof t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&t.byteLength)return t.byteLength;if("undefined"!=typeof Blob&&t instanceof Blob&&t.size)return t.size;if(!("undefined"!=typeof FormData&&t instanceof FormData))try{return JSON.stringify(t).length}catch(n){return}}}},{}],14:[function(t,n,e){var r=0,o=navigator.userAgent.match(/Firefox[\/\s](\d+\.\d+)/);o&&(r=+o[1]),n.exports=r},{}],15:[function(t,n,e){function r(t,n){var e=[],r="",i=0;for(r in t)o.call(t,r)&&(e[i]=n(r,t[r]),i+=1);return e}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],16:[function(t,n,e){function r(t,n,e){n||(n=0),"undefined"==typeof e&&(e=t?t.length:0);for(var r=-1,o=e-n||0,i=Array(o<0?0:o);++r<o;)i[r]=t[n+r];return i}n.exports=r},{}],17:[function(t,n,e){n.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],18:[function(t,n,e){function r(t){return!(t&&t instanceof Function&&t.apply&&!t[a])}var o=t("ee"),i=t(16),a="nr@original",s=Object.prototype.hasOwnProperty,c=!1;n.exports=function(t,n){function e(t,n,e,o){function nrWrapper(){var r,a,s,c;try{a=this,r=i(arguments),s="function"==typeof e?e(r,a):e||{}}catch(f){l([f,"",[r,a,o],s])}u(n+"start",[r,a,o],s);try{return c=t.apply(a,r)}catch(d){throw u(n+"err",[r,a,d],s),d}finally{u(n+"end",[r,a,c],s)}}return r(t)?t:(n||(n=""),nrWrapper[a]=t,d(t,nrWrapper),nrWrapper)}function f(t,n,o,i){o||(o="");var a,s,c,f="-"===o.charAt(0);for(c=0;c<n.length;c++)s=n[c],a=t[s],r(a)||(t[s]=e(a,f?s+o:o,i,s))}function u(e,r,o){if(!c||n){var i=c;c=!0;try{t.emit(e,r,o,n)}catch(a){l([a,e,r,o])}c=i}}function d(t,n){if(Object.defineProperty&&Object.keys)try{var e=Object.keys(t);return e.forEach(function(e){Object.defineProperty(n,e,{get:function(){return t[e]},set:function(n){return t[e]=n,n}})}),n}catch(r){l([r])}for(var o in t)s.call(t,o)&&(n[o]=t[o]);return n}function l(n){try{t.emit("internal-error",n)}catch(e){}}return t||(t=o),e.inPlace=f,e.flag=a,e}},{}],ee:[function(t,n,e){function r(){}function o(t){function n(t){return t&&t instanceof r?t:t?c(t,s,i):i()}function e(e,r,o,i){if(!l.aborted||i){t&&t(e,r,o);for(var a=n(o),s=h(e),c=s.length,f=0;f<c;f++)s[f].apply(a,r);var d=u[y[e]];return d&&d.push([g,e,r,a]),a}}function p(t,n){v[t]=h(t).concat(n)}function h(t){return v[t]||[]}function m(t){return d[t]=d[t]||o(e)}function w(t,n){f(t,function(t,e){n=n||"feature",y[e]=n,n in u||(u[n]=[])})}var v={},y={},g={on:p,emit:e,get:m,listeners:h,context:n,buffer:w,abort:a,aborted:!1};return g}function i(){return new r}function a(){(u.api||u.feature)&&(l.aborted=!0,u=l.backlog={})}var s="nr@context",c=t("gos"),f=t(15),u={},d={},l=n.exports=o();l.backlog=u},{}],gos:[function(t,n,e){function r(t,n,e){if(o.call(t,n))return t[n];var r=e();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(t,n,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return t[n]=r,r}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],handle:[function(t,n,e){function r(t,n,e,r){o.buffer([t],r),o.emit(t,n,e)}var o=t("ee").get("handle");n.exports=r,r.ee=o},{}],id:[function(t,n,e){function r(t){var n=typeof t;return!t||"object"!==n&&"function"!==n?-1:t===window?0:a(t,i,function(){return o++})}var o=1,i="nr@id",a=t("gos");n.exports=r},{}],loader:[function(t,n,e){function r(){if(!x++){var t=b.info=NREUM.info,n=l.getElementsByTagName("script")[0];if(setTimeout(u.abort,3e4),!(t&&t.licenseKey&&t.applicationID&&n))return u.abort();f(y,function(n,e){t[n]||(t[n]=e)}),c("mark",["onload",a()+b.offset],null,"api");var e=l.createElement("script");e.src="https://"+t.agent,n.parentNode.insertBefore(e,n)}}function o(){"complete"===l.readyState&&i()}function i(){c("mark",["domContent",a()+b.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(s=Math.max((new Date).getTime(),s))-b.offset}var s=(new Date).getTime(),c=t("handle"),f=t(15),u=t("ee"),d=window,l=d.document,p="addEventListener",h="attachEvent",m=d.XMLHttpRequest,w=m&&m.prototype;NREUM.o={ST:setTimeout,SI:d.setImmediate,CT:clearTimeout,XHR:m,REQ:d.Request,EV:d.Event,PR:d.Promise,MO:d.MutationObserver};var v=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-1059.min.js"},g=m&&w&&w[p]&&!/CriOS/.test(navigator.userAgent),b=n.exports={offset:s,now:a,origin:v,features:{},xhrWrappable:g};t(12),l[p]?(l[p]("DOMContentLoaded",i,!1),d[p]("load",r,!1)):(l[h]("onreadystatechange",o),d[h]("onload",r)),c("mark",["firstbyte",s],null,"api");var x=0,E=t(17)},{}]},{},["loader",2,10,4,3]);</script> 
 </head> 
 <body class="js-preview-content  "> 
  <header class="global"> 
   <a href="//www.oreilly.com/go/oreilly" class="orm-topbar">
    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 59.13 9.88">
     <desc>
      O'Reilly logo
     </desc>
     <polygon points="28.09 1.96 28.09 0.42 21.68 0.42 21.68 9.64 28.09 9.64 28.09 8.11 23.22 8.11 23.22 5.8 27.86 5.8 27.86 4.27 23.22 4.27 23.22 1.96 28.09 1.96" />
     <polygon points="32.85 9.64 32.85 0.42 34.39 0.42 34.39 8.11 38.82 8.11 38.82 9.64 32.85 9.64" />
     <polygon points="40.07 9.64 40.07 0.42 41.61 0.42 41.61 8.11 46.04 8.11 46.04 9.64 40.07 9.64" />
     <rect x="29.71" y="0.42" width="1.54" height="9.22" />
     <path d="M1.59,6.28a4.8,4.8,0,1,1,4.8,4.8,4.8,4.8,0,0,1-4.8-4.8M4.09,4A3.27,3.27,0,1,0,6.4,3,3.27,3.27,0,0,0,4.09,4" transform="translate(-1.59 -1.2)" />
     <path d="M19.82,6.89A2.69,2.69,0,0,0,19,1.62H14.41v9.22h1.54V7h2.14l2.32,3.84H22.2ZM15.95,5.47V3.16H19a1.15,1.15,0,0,1,0,2.31h-3.1Z" transform="translate(-1.59 -1.2)" />
     <path d="M13.32,2.61a1.13,1.13,0,1,1-1.13-1.13,1.13,1.13,0,0,1,1.13,1.13" transform="translate(-1.59 -1.2)" />
     <polygon points="52.9 0.42 51.03 0.42 48.66 3.85 46.3 0.42 44.43 0.42 47.89 5.44 47.89 9.64 49.43 9.64 49.43 5.44 52.9 0.42" />
     <path d="M58.31,1.2a2.41,2.41,0,1,0,2.41,2.42A2.42,2.42,0,0,0,58.31,1.2m0,4.44a2,2,0,1,1,2-2,2,2,0,0,1-2,2" transform="translate(-1.59 -1.2)" />
     <path d="M59.4,3.09a0.72,0.72,0,0,0-.72-0.72H57.32V4.83h0.41v-1h0.69l0.49,1h0.46l-0.51-1a0.71,0.71,0,0,0,.54-0.69m-1.67-.31h0.95a0.31,0.31,0,0,1,.31.31,0.31,0.31,0,0,1-.31.3H57.73V2.78Z" transform="translate(-1.59 -1.2)" />
    </svg></a> 
   <div class="header-top"> 
    <nav class="main-nav"> 
     <a href="/" class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 125.46 36" class="home-logo">
       <desc>
        Safari Logo
       </desc>
       <path d="M27.85,7.25a1.4,1.4,0,1,1,2.75,0V15.6a1.44,1.44,0,0,1-1.4,1.71A1.49,1.49,0,0,1,28,16.64,13.56,13.56,0,0,1,27.54,14c-0.62-3.89-4.15-6.54-8.66-6.54S11,10.16,11,14c0,3,1.66,4.56,6.8,6.28l5.29,1.82c5.86,2,8.14,4.46,8.14,9,0,5.76-4.36,9.6-10.84,9.6-5,0-8.3-1.87-9.91-5.6v3.42a1.4,1.4,0,1,1-2.75,0V29.71A1.44,1.44,0,0,1,9.18,28c1,0,1.35.52,1.45,2A10.59,10.59,0,0,0,13,35.63a9.05,9.05,0,0,0,6.8,2.7c5,0,8.3-2.8,8.3-7a5.45,5.45,0,0,0-2.54-4.82,18.52,18.52,0,0,0-3.89-1.71l-4.51-1.56c-3.58-1.24-5.24-2-6.54-3a7.46,7.46,0,0,1-2.75-6c0-5.45,4.36-9.13,10.69-9.13,4.46,0,7.63,1.71,9.29,5.08V7.25Z" transform="translate(-7.78 -4.92)" />
       <path d="M51.81,35.11c-1.82,4.1-4.51,5.81-9.28,5.81-5.39,0-8.71-2.75-8.71-7.31A6.88,6.88,0,0,1,38.11,27c1.87-.83,4.62-1.19,8.92-1.19,0.93,0,2,0,2.8.05a7,7,0,0,0,.93.05,0.89,0.89,0,0,0,1-.88V24.84c0-3.37-.31-4.46-1.71-5.71-1.19-1.09-2.8-1.56-5.24-1.56-4.15,0-6.64,1.71-7.11,4.88a1.45,1.45,0,0,1-2.9-.16c0-2.13,1.82-4.67,4.15-5.81a13.94,13.94,0,0,1,6-1.09c3.63,0,6.22.88,7.83,2.75,1.4,1.56,1.82,3.16,1.82,6.64V37a0.89,0.89,0,0,0,1,1h1.76a1.08,1.08,0,1,1,0,2.13H53.05a1.06,1.06,0,0,1-1.24-1.24V35.11Zm-15-1.61c0,3.32,2.33,5.24,6.33,5.24,3.27,0,5.76-1.24,7.16-3.58a16.08,16.08,0,0,0,1.45-6.38A0.8,0.8,0,0,0,51.24,28a34,34,0,0,0-4.62-.21C39.93,27.79,36.76,29.66,36.76,33.5Z" transform="translate(-7.78 -4.92)" />
       <path d="M67.91,37a0.89,0.89,0,0,0,1,1H71.8a1.08,1.08,0,1,1,0,2.13H62a1.09,1.09,0,1,1,0-2.13h2.07a0.89,0.89,0,0,0,1-1V19.29a0.89,0.89,0,0,0-1-1H61.63a1.08,1.08,0,1,1,0-2.13h2.44a0.89,0.89,0,0,0,1-1V13.48c0-3.16.78-5.39,2.39-6.8a8.56,8.56,0,0,1,5.19-1.76,10.85,10.85,0,0,1,3.58.62,1.83,1.83,0,0,1,.52,1,1.23,1.23,0,0,1-.88,1,2.74,2.74,0,0,1-.67-0.1,12.61,12.61,0,0,0-2.28-.31,5.41,5.41,0,0,0-4,2c-0.73,1-1,2.18-1,4.56v1.35a0.89,0.89,0,0,0,1,1h3.58a1.09,1.09,0,1,1,0,2.13H68.95a0.89,0.89,0,0,0-1,1V37Z" transform="translate(-7.78 -4.92)" />
       <path d="M93.68,35.11c-1.82,4.1-4.51,5.81-9.28,5.81-5.39,0-8.71-2.75-8.71-7.31A6.88,6.88,0,0,1,80,27c1.87-.83,4.62-1.19,8.92-1.19,0.93,0,2,0,2.8.05a7,7,0,0,0,.93.05,0.89,0.89,0,0,0,1-.88V24.84c0-3.37-.31-4.46-1.71-5.71-1.19-1.09-2.8-1.56-5.24-1.56-4.15,0-6.64,1.71-7.11,4.88a1.45,1.45,0,0,1-2.9-.16c0-2.13,1.82-4.67,4.15-5.81a13.94,13.94,0,0,1,6-1.09c3.63,0,6.22.88,7.83,2.75,1.4,1.56,1.82,3.16,1.82,6.64V37a0.89,0.89,0,0,0,1,1h1.76a1.08,1.08,0,1,1,0,2.13H94.92a1.06,1.06,0,0,1-1.24-1.24V35.11Zm-15-1.61c0,3.32,2.33,5.24,6.33,5.24,3.27,0,5.76-1.24,7.16-3.58a16.07,16.07,0,0,0,1.45-6.38A0.8,0.8,0,0,0,93.11,28a34,34,0,0,0-4.62-.21C81.8,27.79,78.64,29.66,78.64,33.5Z" transform="translate(-7.78 -4.92)" />
       <path d="M109.44,21.05a6.5,6.5,0,0,1,2-3.53,8.68,8.68,0,0,1,5.71-2.13c1.35,0,2.13.52,2.13,1.35a0.83,0.83,0,0,1-.78,1,3.75,3.75,0,0,1-.67-0.05,2.45,2.45,0,0,0-.78-0.1,11.52,11.52,0,0,0-3.63.88c-2.59,1.19-4,4-4,8.2V37a0.89,0.89,0,0,0,1,1h3a1.08,1.08,0,1,1,0,2.13h-10a1.09,1.09,0,1,1,0-2.13h2.13a0.89,0.89,0,0,0,1-1V19.29a0.89,0.89,0,0,0-1-1h-2.13a1.09,1.09,0,1,1,0-2.13h4.72a1.06,1.06,0,0,1,1.24,1.24v3.68Z" transform="translate(-7.78 -4.92)" />
       <path d="M129.09,37a0.89,0.89,0,0,0,1,1h1.82a1.08,1.08,0,1,1,0,2.13h-8.82a1.09,1.09,0,1,1,0-2.13h2.13a0.89,0.89,0,0,0,1-1V19.29a0.89,0.89,0,0,0-1-1h-2.13a1.09,1.09,0,1,1,0-2.13h4.72a1.06,1.06,0,0,1,1.24,1.24V37ZM129.55,8.5a2.08,2.08,0,0,1-2.07,2.07,2.17,2.17,0,0,1-2.13-2.13,2.08,2.08,0,0,1,2.07-2.08A2.1,2.1,0,0,1,129.55,8.5Z" transform="translate(-7.78 -4.92)" />
      </svg></a> 
    </nav> 
    <nav class="right-nav"> 
     <ul> 
      <li class="callout mobile-link"> <a class="t-register cta-link" data-ga-label="Nav Bar" href="/public/free-trial/?fa=True&amp;cl=/library/view/programming-javascript-applications/9781491950289/ch05.html">Start Free Trial</a> </li> 
      <li class="mobile-link"><a class="t-sign-in" href="/accounts/login/?next=/library/view/programming-javascript-applications/9781491950289/ch05.html">Sign In</a></li> 
      <li><a href="/pricing/">Pricing</a></li> 
      <li><a href="/enterprise/">Enterprise</a></li> 
      <li class="search-field"> 
       <form id="js-search-form" action="/search/"> 
        <script type="application/ld+json">
                {
                  "@context": "http://schema.org",
                  "@type": "WebSite",
                  "url": "https://www.safaribooksonline.com/",
                  "potentialAction": {
                    "@type": "SearchAction",
                    "target": "https://www.safaribooksonline.com/search/?q={search_term_string}",
                    "query-input": "required name=search_term_string"
                  }
                }
                </script> 
        <input data-search-text-focus="Search books and videos..." data-search-text-idle="Search..." id="search" type="search" name="q" placeholder="Search..." autocomplete="off" required> 
        <input type="submit" value="search" class="search-submit"> 
       </form> </li> 
     </ul> 
    </nav> 
   </div> 
   <div class="sbo-menu-top"> 
    <section class="sbo-toc-container"> 
     <a href="/library/view/programming-javascript-applications/9781491950289/" class="sbo-toc-thumb"> <span class="sbo-title ss-list"> <h1 class="t-title">Programming JavaScript Applications by Eric Elliott</h1> </span> </a> 
    </section> 
   </div> 
  </header> 
  <section id="trial-overlay"> 
   <div class="trial-overlay-content"> 
    <h2 class="trial-modal-title"> Stay ahead with the world's most comprehensive technology and business learning platform. </h2> 
    <h2> With Safari, you learn the way you learn best. Get unlimited access to videos, live online training, learning paths, books, tutorials, and more. </h2> 
    <div class="controls"> 
     <a href="/public/free-trial/?fa=True&amp;cl=/library/view/programming-javascript-applications/9781491950289/ch05.html" class="button" data-ga-label="Modal">Start Free Trial</a> 
     <p>No credit card required</p> 
    </div> 
    <a class="modal-dismiss" aria-label="modal dismiss"></a> 
   </div> 
  </section> 
  <section role="document"> 
   <section id="sbo-reader"> 
    <div class="sbo-reader-content sbo-sample-reader "> 
     <div id="sbo-rt-content"> 
      <div id="test-content-id">
       <section class="chapter" title="Chapter&nbsp;5.&nbsp;Separation of Concerns" epub:type="chapter" id="ch9nklpbt00005ig111ud5yao">
        <div class="titlepage">
         <div>
          <div>
           <h2 class="title">Chapter&nbsp;5.&nbsp;Separation of Concerns</h2>
          </div>
         </div>
        </div>
        <p><em class="firstterm">Separation of concerns</em> is the idea that each <a id="I_indexterm5_id319743" class="indexterm"></a><a id="I_indexterm5_id319752" class="indexterm"></a><a id="cl5.0" class="indexterm"></a>module or layer in an application should only be responsible for one thing and should not contain code that deals with other things. Separating concerns reduces code complexity by breaking a large application down into many smaller units of encapsulated functionality.</p>
        <p>It’s easy to confuse separation of concerns with employing modules for the construction of your application, but separation of concerns also implies the layering of functionality in your application. For example, n-tier architecture and MVC architectures are the result of separating concerns across the entire application, rather than at the individual module level. The goal of MVC and related patterns is to separate data management from presentation.</p>
        <p>Separation of concerns can be expressed as functions, modules, controls, widgets, layers, tiers, services, and so on. The various units of concern vary from one app to the next, and each different app may use a different combination. Functions and modules have already been discussed.</p>
        <p>A <em class="firstterm">control</em> is a reusable <a id="I_indexterm5_id319797" class="indexterm"></a>GUI input that enables user interaction with your application. For example, combo boxes, calendar inputs, sliders, buttons, switches, and knobs are all controls.</p>
        <p>A <em class="firstterm">widget</em> is a small <a id="I_indexterm5_id319811" class="indexterm"></a>application which is intended to be embedded in other applications. For example, <a class="ulink" href="http://wordpress.org/" target="_top">WordPress</a> allows developers to offer embeddable units of functionality to blog owners through its plug-in ecosystem. There are many widgets to manage calendars, comments, maps, and all sorts of services from third-party providers.</p>
        <div class="tip" title="Tip">
         <h3 class="title">Tip</h3>
         <p>The word widget is historically used to mean the same thing as controls. To avoid confusion, this book will always refer to interactive form inputs as controls (or inputs), and widgets will always refer to embeddable mini applications.</p>
        </div>
        <p><em class="firstterm">Layers</em> are logical <a id="I_indexterm5_id319840" class="indexterm"></a>groupings of functionality. For example, a data layer might encapsulate functionality related to data and state, while a presentation layer handles display concerns, such as rendering to the DOM and binding UI behaviors.</p>
        <p><em class="firstterm">Tiers</em> are the runtime <a id="I_indexterm5_id319854" class="indexterm"></a>environments that layers get deployed to. A runtime environment usually consists of at least one physical computer, an operating system, the runtime engine (e.g., Node, Java, or Ruby), and any configuration needed to express how the application should interact with its environment.</p>
        <p>It’s possible to run multiple layers on the same tier, but tiers should be kept independent enough that they can easily be deployed to separate machines or even separate data centers. For large-scale applications, it’s usually also necessary that tiers can scale horizontally, meaning that as demand increases, you can add machines to a tier in order to improve its capacity to meet that demand.</p>
        <div class="sect1" title="Client-Side Concerns">
         <div class="titlepage">
          <div>
           <div>
            <h2 class="title" style="clear: both" id="I_sect15_id319871">Client-Side Concerns</h2>
           </div>
          </div>
         </div>
         <p>There are several <a id="se5.1" class="indexterm"></a><a id="cl5.1" class="indexterm"></a>client-side concerns that almost every mature JavaScript application might deal with at some point:</p>
         <div class="itemizedlist">
          <ul class="itemizedlist">
           <li class="listitem"><p>Module management</p></li>
           <li class="listitem"><p>Events</p></li>
           <li class="listitem"><p>Presentation and DOM manipulation</p></li>
           <li class="listitem"><p>Internationalization</p></li>
           <li class="listitem"><p>Data management and IO (including Ajax)</p></li>
           <li class="listitem"><p>Routing (translating URLs to script actions)</p></li>
           <li class="listitem"><p>Logging</p></li>
           <li class="listitem"><p>Analytics tracking</p></li>
           <li class="listitem"><p>Authentication</p></li>
           <li class="listitem"><p>Feature toggling (decouple code deployment and feature release)</p></li>
          </ul>
         </div>
         <p>Various libraries and frameworks exist that generally attempt to provide some combination of mechanisms to deal with these concerns. Libraries roughly fall into two categories: minimal and monolithic. Minimal libraries generally provide a handful of objects and methods which make it easier to build well organized applications. Perhaps the most famous example is <a id="I_indexterm5_id319983" class="indexterm"></a>Backbone.js, which provides views, models, collections, routers, and events.</p>
         <p>That may sound like a lot, until you compare it to something like the <a id="I_indexterm5_id319998" class="indexterm"></a>Dojo framework, which is something like a library of libraries. It includes an impressive array of components that do everything from extending JavaScript with ideas from other programming languages, like <a id="I_indexterm5_id320011" class="indexterm"></a>aspects (aspect-oriented programming), to DOM widgets, such as a calendar. Dojo is interesting because it started out more monolithic, and now it’s actually a tiny module loader with a large library of components that you can use if you wish, without loading the entire Dojo framework.</p>
         <p>Larger frameworks tend to be more heavy-handed (opinionated) about how your application architecture should function.</p>
         <p>There is a growing trend in the JavaScript community moving in the direction of <a id="I_indexterm5_id320029" class="indexterm"></a>microlibraries, and microlibrary frameworks. <a class="ulink" href="http://microjs.com/" target="_top">Microjs.com</a> has <a id="I_indexterm5_id320042" class="indexterm"></a>a list of interesting microlibraries. You should certainly explore the wealth of microlibraries available in the community and use the ones that solve your problems.</p>
         <p>You might see microlibrary proponents discourage the <a id="I_indexterm5_id320054" class="indexterm"></a>use of jQuery, not least because it’s quite large compared to most microlibraries. However, there is some security in using a well-tested library like jQuery because it is used and improved by thousands of other smart developers. It’s usually safe to assume that jQuery will mostly behave as expected (of course, there are always exceptions).</p>
         <p>Despite the claims of microlibary authors, most microlibraries have not undergone the same level of scrutiny as jQuery, and small libraries don’t equate to bug-free libraries. Everybody makes mistakes. Be prepared to debug them as you work with them. Please contribute fixes back to the author if you find and fix a bug.</p>
         <p>It’s also likely that you’ll use most of jQuery’s core feature set in every application that you build. I see no good reason to reassemble that feature set from microlibraries every time you start a new project.</p>
         <p>Also be aware that many microlibraries may need to reinvent the wheel over and over again for commonly needed patterns, like copying attributes from one object to another (as in jQuery or Underscore’s <code class="code">.extend()</code> method). It might seem like a good idea to use less code, but there’s a chance you’ll end up using more, instead, unless you go with a well-organized microlibrary framework with components designed to be used together.</p>
         <p>In order to decide which application frameworks or libraries might help you build your application, take a look at the <a class="ulink" href="http://todomvc.com/" target="_top">TodoMVC project</a>, which <a id="I_indexterm5_id320098" class="indexterm"></a>compares many commonly used libraries, such as Backbone.js, Angular.js, Dojo, and YUI, by showing you an example of what a simple Todo application looks like using each library.</p>
         <div class="sect2" title="Module Management">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="id821071">Module Management</h3>
            </div>
           </div>
          </div>
          <p>Module management <a id="mo5.1.1" class="indexterm"></a><a id="cl5.1.1" class="indexterm"></a><a id="se5.1.1" class="indexterm"></a>is concerned with supplying a standard architecture that allows your modules to fit together easily and communicate with each other without being tightly coupled.</p>
          <p>The module manager prescribes a standard module API that all other modules can implement and a sandbox of common library functionality that any module can use so that application modules can stay lightweight and focus exclusively on the service that they provide.</p>
          <p>Module management typically supplies your application with:</p>
          <div class="itemizedlist">
           <ul class="itemizedlist">
            <li class="listitem"><p>Namespacing</p></li>
            <li class="listitem"><p>Sandbox (a base layer of functionality that other modules can safely use)</p></li>
            <li class="listitem"><p>Access to environment variables and bootstrapped data</p></li>
            <li class="listitem"><p>Module lifecycle hooks (help with setup and teardown)</p></li>
            <li class="listitem"><p>An event system for inter-module communication</p></li>
           </ul>
          </div>
          <p>Nicholas Zakas gave a r<a id="I_indexterm5_id320207" class="indexterm"></a>elated talk called <a class="ulink" href="http://slidesha.re/1pFIYUQ" target="_top">Scalable JavaScript Application Architecture</a>, and <a id="I_indexterm5_id320220" class="indexterm"></a>Addy Osmani (author of Aura) wrote about it in <a class="ulink" href="http://addyosmani.com/largescalejavascript/" target="_top">Patterns For Large-Scale JavaScript Application Architecture</a>. Often, module-management implementations are part of a monolithic application library tightly coupled to a proprietary codebase, or both.</p>
          <p>Aura <a id="I_indexterm5_id320238" class="indexterm"></a>is a good example of an open-source implementation with a fairly narrow focus on module management—with one clear difference: Aura has a strong focus on UI components, which are modules that have UI elements that need to be rendered to the screen. A generic module could perform any type of service and may or may not need a dedicated space to render. A component exists primarily for the purpose of supplying UI output or UI interaction.</p>
          <p>For the sake of clarity and simplicity in the following examples, I wrote a simple <a id="ti5.1.1" class="indexterm"></a>module management solution called Tinyapp. It is an open source library. To get the source, clone it from GitHub:</p>
          <a id="I_programlisting5_id320269"></a>
          <pre class="programlisting"><code class="gp">$</code> git clone git://github.com/dilvie/tinyapp.git</pre>
          <div class="sect3" title="Getting started">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="chanb2cc80001c2rw22adtqek">Getting started</h4>
             </div>
            </div>
           </div>
           <p>As of this writing, Tinyapp is rapidly evolving. Please see the <a class="ulink" href="http://tinyappjs.com/" target="_top">Tinyapp website</a> to learn how to download and install the latest version.</p>
           <p>Simply <code class="code">require()</code> it and initialize your app:</p>
           <a id="I_programlisting5_id320301"></a>
           <pre class="programlisting"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'tinyapp'</code><code class="p">);</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">init</code><code class="p">({</code>
  <code class="nx">environment</code><code class="o">:</code> <code class="nx">environment</code><code class="p">,</code>
  <code class="nx">pageData</code><code class="o">:</code> <code class="nx">pageData</code><code class="p">,</code>
  <code class="nx">beforeRender</code><code class="o">:</code> <code class="p">[</code><code class="nx">promise1</code><code class="p">,</code> <code class="nx">promise2</code><code class="p">...]</code>
<code class="p">});</code></pre>
           <p>The <code class="bold">environment</code> object (optional) is the primary means of passing application environment configuration into your JavaScript application. Use it for passing in data that usually has to come from server-side configuration, such as environment domain names, application IDs for third-party services, CDN URLs, etc.</p>
           <p>There are a couple of ways you could source the environment from the server side: load it with Ajax or include it in the HTML with an inline script.</p>
           <p>The <code class="code">pageData</code> object is intended to register bootstrapped data with the app at page-load time.</p>
           <p><code class="code">beforeRender</code> is a list of promises that all must finish before the render phase begins. For example, many apps will need i18n translations to load before any module is allowed to render. By adding an i18n promise to the application’s <code class="code">beforeRender</code> queue, you can postpone render until the translations are loaded. Using <code class="code">beforeRender</code> can prevent tricky race condition bugs and provide a neat solution if you need a guaranteed way to handle tasks before the modules render. See <a class="xref" href="ch05.html#registration-section" title="Registration, loading, and rendering">Registration, loading, and rendering</a> for more about application and module timing hooks.</p>
           <div class="warning" title="Warning" epub:type="warning">
            <h3 class="title">Warning</h3>
            <p>Be careful with the global <code class="code">beforeRender</code> queue. Each item you add to it compounds the possibility that something in the queue will fail, which might significantly delay or block the render of your application. If what you’re waiting for only impacts a single module, keep the waiting logic isolated to that module.</p>
           </div>
           <p>Here’s how you might build up a typical Tinyapp module:</p>
           <div class="orderedlist">
            <ol class="orderedlist" type="1">
             <li class="listitem"><p>Require Tinyapp:</p><a id="I_programlisting5_id320378"></a><pre class="programlisting"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'tinyapp'</code><code class="p">);</code></pre></li>
             <li class="listitem"><p>Provide an API:</p><a id="I_programlisting5_id320392"></a><pre class="programlisting"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'tinyapp'</code><code class="p">),</code>

  <code class="nx">hello</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">hello</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="s1">'hello, world'</code><code class="p">;</code>
  <code class="p">},</code>

  <code class="nx">api</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">hello</code><code class="o">:</code> <code class="nx">hello</code>
  <code class="p">};</code></pre></li>
             <li class="listitem"><p>Export your module:</p><a id="I_programlisting5_id320407"></a><pre class="programlisting"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'tinyapp'</code><code class="p">),</code>

  <code class="nx">hello</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">hello</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="s1">'hello, world'</code><code class="p">;</code>
  <code class="p">},</code>

  <code class="nx">api</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">hello</code><code class="o">:</code> <code class="nx">hello</code>
  <code class="p">};</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">api</code><code class="p">;</code></pre></li>
            </ol>
           </div>
           <div class="tip" title="Tip">
            <h3 class="title">Tip</h3>
            <p>This contrived example should really be simplified even further. Since it doesn’t actually use <code class="code">tinyapp</code>, it doesn’t need to require it, and since it’s only exporting a single function (which is actually a pretty good idea for lots of modules), it could just be <code class="code">module.exports = function hello() { </code>...</p>
            <p>Any standard node-style module could be used as a Tinyapp module, but as you’ll see, Tinyapp provides some utility and benefit that you’ll use a lot.</p>
           </div>
          </div>
          <div class="sect3" title="Registration, loading, and rendering">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="registration-section">Registration, loading, and rendering</h4>
             </div>
            </div>
           </div>
           <p>If you need to fetch some data asynchronously before you render your module, Tinyapp helps speed things up by launching your asynchronous calls as early as possible.</p>
           <p>Module initialization is broken into two phases: load and render. Imagine you want to asynchronously fetch some data while the page is still loading so that you can begin to render it as early as possible. This can speed up your perceived page-load times.</p>
           <p>The solution is to kick off the asynchronous fetch at load time so that it begins the download as early as possible: before the DOM is ready, and before the page is done processing all the HTML, CSS, and JavaScript. Since the load is asynchronous, it will introduce only a few milliseconds of latency during the load phase, but it’ll do most of the work in the background while the browser continues processing the rest of the page in parallel with the load.</p>
           <p>If you have data that is secondary to the main purpose of the page, and you can get away with waiting until after the DOM is ready, it’s a good idea to let your page load normally and fetch the data during the render step, instead of using the early load hook. This will reduce the number of page requests that must be handled at page-load time (eliminating the latency hit) and hopefully also improve the perceived performance of your app.</p>
           <p>Tinyapp allows you to hook into those page-load phases individually so you can optimize page-load times and manage render dependencies without worrying about asynchronous timing issues.</p>
           <p>You can specify <code class="code">load()</code> and <code class="code">render()</code> callbacks by passing them into a registration method:</p>
           <a id="I_programlisting5_id320492"></a>
           <pre class="programlisting"><code class="nx">app</code><code class="p">.</code><code class="nx">register</code><code class="p">({</code>
  <code class="nx">load</code><code class="o">:</code> <code class="nx">load</code><code class="p">,</code>
  <code class="nx">render</code><code class="o">:</code> <code class="nx">render</code>
<code class="p">});</code></pre>
           <p>The <code class="code">render()</code> callback is called after:</p>
           <div class="itemizedlist">
            <ul class="itemizedlist">
             <li class="listitem"><p>Any promise returned by <code class="code">load()</code> is resolved. For example, if you return a jQuery Ajax promise from your <code class="code">load()</code> function, it will wait until the Ajax fetch is complete. All jQuery Ajax calls return compatible promises.</p></li>
             <li class="listitem"><p>All <code class="code">beforeRender</code> callbacks have fired (see <a class="xref" href="ch05.html#chanb2cc80001c2rw22adtqek" title="Getting started">Getting started</a>).</p></li>
             <li class="listitem"><p>The DOM is ready to be manipulated.</p></li>
            </ul>
           </div>
           <p>Registration is optional. If you don’t need any of the features it provides, you aren’t required to use it.</p>
           <p>Time for an example. Imagine you have a widget that displays tour dates for bands. Here’s how it <a id="I_indexterm5_id320553" class="indexterm"></a><a id="I_indexterm5_id320562" class="indexterm"></a><a id="I_indexterm5_id320570" class="indexterm"></a><a id="I_indexterm5_id320578" class="indexterm"></a>could work:</p>
           <a id="I_programlisting5_id320589"></a>
           <pre class="programlisting"><code class="kd">var</code>
  <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'tinyapp'</code><code class="p">),</code>
  <code class="nx">view</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./view'</code><code class="p">),</code>
  <code class="nx">data</code><code class="p">,</code>

  <code class="nx">load</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">load</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">url</code> <code class="o">=</code> <code class="s1">'http://api.bandsintown.com/artists/'</code> <code class="o">+</code>
      <code class="s1">'Skrillex.json?api_version=2.0&amp;amp;app_id=YOUR_APP_ID'</code><code class="p">;</code>

    <code class="nx">whenLoaded</code> <code class="o">=</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">url</code><code class="p">);</code>
    <code class="nx">whenLoaded</code><code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">response</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">data</code> <code class="o">=</code> <code class="nx">response</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="k">return</code> <code class="nx">whenLoaded</code><code class="p">.</code><code class="nx">promise</code><code class="p">();</code>
  <code class="p">},</code>

  <code class="nx">render</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">render</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">view</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
  <code class="p">};</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">register</code><code class="p">({</code>
  <code class="nx">load</code><code class="o">:</code> <code class="nx">load</code><code class="p">,</code>
  <code class="nx">render</code><code class="o">:</code> <code class="nx">render</code><code class="p">,</code>
<code class="p">});</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">api</code><code class="p">;</code></pre>
           <div class="warning" title="Warning" epub:type="warning">
            <h3 class="title">Warning</h3>
            <p>Try not to do anything blocking in your <code class="code">load()</code> function. For example, you might want to fetch the data that you need to complete your page render, but if you’re loading a large collection and you need to iterate over the collection and do some data processing, save the data processing step for <code class="code">render()</code> time, when you’re not blocking the page render process.</p>
            <p><span class="emphasis"><em>It’s not safe to manipulate the DOM at all in your <code class="code">load()</code> function.</em></span></p>
           </div>
          </div>
         </div>
         <div class="sect2" title="Events">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="id821091">Events</h3>
            </div>
           </div>
          </div>
          <p><em class="firstterm">Events</em> are a method of <a id="I_indexterm5_id320644" class="indexterm"></a><a id="se5.1.2" class="indexterm"></a><a id="cl5.1.2" class="indexterm"></a>communicating between different application modules or components in order to achieve loose coupling, asynchronous communication, interprocess communication, or any combination of the above. For example, the browser environment is event driven. It presents DOM elements to users (buttons and form inputs, for example), and then responds to user input by firing events for the application to listen for and handle.</p>
          <p>You’re probably already familiar with responding to existing browser DOM events. If you need a refresher, consult <a id="I_indexterm5_id320688" class="indexterm"></a><a id="I_indexterm5_id320693" class="indexterm"></a>the <a class="ulink" href="https://developer.mozilla.org/en-US/docs/DOM" target="_top">Mozilla DOM Reference</a>. This section covers defining and using your own custom events, independent of the DOM.</p>
          <div class="tip" title="Tip">
           <h3 class="title">Tip</h3>
           <p>In order to keep modules decoupled from each other, it’s helpful to think of events as reports of what has happened, rather than commands for what should happen next. Other modules can listen for the events they care about and decide what to do next on their own.</p>
          </div>
          <div class="sect3" title="Event emitters">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="id761501">Event emitters</h4>
             </div>
            </div>
           </div>
           <p>Often we need to <a id="I_indexterm5_id320726" class="indexterm"></a><a id="I_indexterm5_id320734" class="indexterm"></a>provide a method API that can handle a range of asynchronous communication. A good solution to this problem is to return an object that emits events. DOM elements are event emitters, so that they can notify you of user input or other state changes. For example, most elements emit a click <code class="code">event</code> when the user clicks them, and the HTML5 video API emits events for loading progress, playback position changes, and a variety of other information that isn’t immediately known.</p>
           <p>It’s possible to create your own event emitter API that you can mix into any JavaScript object. A minimal implementation might only have three methods: <code class="literal">.on()</code>, <code class="literal">.trigger()</code>, and <code class="literal">.off()</code>.</p>
           <p>Backbone.js is a <a id="I_indexterm5_id320770" class="indexterm"></a>client-side MV* library that provides event emitters for models, views, routers, and collections. If you’re using Backbone (which relies on Underscore), you can turn any object into an event emitter like this:</p>
           <a id="I_programlisting5_id320783"></a>
           <pre class="programlisting"><code class="nx">_</code><code class="p">.</code><code class="nx">extend</code><code class="p">(</code><code class="nx">myObject</code><code class="p">,</code> <code class="nx">Backbone</code><code class="p">.</code><code class="nx">Events</code><code class="p">);</code>

<code class="nx">myObject</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'my_event'</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">handle</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
<code class="p">});</code>

<code class="nx">object</code><code class="p">.</code><code class="nx">trigger</code><code class="p">(</code><code class="s1">'my_event'</code><code class="p">,</code> <code class="s1">'hi'</code><code class="p">);</code> <code class="c1">// logs 'hi'</code></pre>
           <p>The downside to triggering events only on the object to which the events belong is that every listener must be given a reference to the object. In situations where there are potentially many objects listening, that strategy requires too much boilerplate code to be maintainable.</p>
           <p>Another problem you might encounter is that listeners must be tightly coupled to emitters, which partially defeats the purpose of using events in the first place. To get around that, you can wire up emitters and receivers through an event mediator or connector.</p>
           <p>In cases where you have nested views that need to communicate up to the top level, this pattern becomes problematic because at each level, the child and parent must register with each other to relay messages. In that situation, you create a lot of code overhead, and debugging event-passing bugs can become very painful.</p>
           <div class="tip" title="Tip">
            <h3 class="title">Tip</h3>
            <p>If you have an object that needs to inform your application about asynchronous events such as incoming push notifications (chat notifications, new items added to collections, etc.), an event emitter might be the right solution.</p>
           </div>
          </div>
          <div class="sect3" title="Event aggregators">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="id761830">Event aggregators</h4>
             </div>
            </div>
           </div>
           <p>In contrast to <a id="I_indexterm5_id320827" class="indexterm"></a>event emitters, an <em class="firstterm">event aggregator</em> is a central object that collects events from multiple sources and delivers them to registered subscribers. This is essentially a type of publish/subscribe pattern. An aggregator eliminates the need for specialized mediators to keep an emitter and listener decoupled. Again, with <a id="I_indexterm5_id320844" class="indexterm"></a><a id="I_indexterm5_id320853" class="indexterm"></a>Backbone and Underscore, that might look something like this:</p>
           <p><a id="I_programlisting5_id320866"></a></p>
           <pre class="programlisting"><code class="c1">// Set up an aggregator on your app object.</code>
<code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">bus</code><code class="o">:</code> <code class="nx">_</code><code class="p">.</code><code class="nx">extend</code><code class="p">({},</code> <code class="nx">Backbone</code><code class="p">.</code><code class="nx">Events</code><code class="p">)</code>
<code class="p">};</code>

<code class="c1">// In your logger module, log all invites in the app.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">bus</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'invite'</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">handle</code><code class="p">(</code><code class="nx">inviteData</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">inviteData</code><code class="p">);</code>
<code class="p">});</code>

<code class="c1">// Trigger an event when a user invites a friend.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">bus</code><code class="p">.</code><code class="nx">trigger</code><code class="p">(</code><code class="s1">'invite'</code><code class="p">,</code> <code class="p">{</code>
  <code class="nx">user</code><code class="o">:</code> <code class="s1">'userId'</code><code class="p">,</code>
  <code class="nx">friend</code><code class="o">:</code> <code class="s1">'friend.email@example.com'</code>
<code class="p">});</code></pre>
           <p>Event aggregators can be enormously useful. Because neither emitter nor subscriber need know about the other, aggregators enable very loose coupling between modules. Each only needs a reference to the aggregator. In this case, the emitter and the listener only need to know about <code class="code">app.bus</code> and the <code class="code">invite</code> event in order to communicate.</p>
          </div>
          <div class="sect3" title="Queues and stacks">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="id767427">Queues and stacks</h4>
             </div>
            </div>
           </div>
           <p>One disadvantage of the publish/subscribe pattern is that there is no guarantee that a message will be processed once it is broadcast.</p>
           <p>A <em class="firstterm">message queue</em> is a type of <a id="I_indexterm5_id320905" class="indexterm"></a><a id="I_indexterm5_id320911" class="indexterm"></a>event mediator that records every message it hears in a queue (or stack) for later processing. That log of messages can be permanently recorded, if needed, and the queue is actively managed, so it’s possible to enforce guarantees that some listener got the message.</p>
           <p>There is often a need for separate modules or processes to collaborate in order to process input. For example, imagine that your application is a tool for photographers. It allows photographers to upload a photo, resize it, watermark it, and then send it to various social networks automatically.</p>
           <p>When a photo is uploaded, it’s added to a processing queue. Later, a pool of photo-processing workers can independently pull jobs from the message queue as they are ready to process them, and message back when the photos are ready to be distributed across the Web. Other workers can then pick up the finished photo messages and handle the distribution step. With this architecture, the processing workers can scale independently of the distribution workers.</p>
           <p>If you need a message queue, you might be in luck. It’s such a common pattern that there are several popular out-of-the-box solutions, <a id="I_indexterm5_id320941" class="indexterm"></a><a id="I_indexterm5_id320947" class="indexterm"></a><a id="I_indexterm5_id320953" class="indexterm"></a><a id="I_indexterm5_id320958" class="indexterm"></a>such as <a class="ulink" href="http://robey.github.com/kestrel/" target="_top">Kestrel</a> or <a class="ulink" href="http://aws.amazon.com/sqs/" target="_top">Amazon Simple Queue Service (SQS)</a>.</p>
          </div>
          <div class="sect3" title="Choosing the right event model">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="id767431">Choosing the right event model</h4>
             </div>
            </div>
           </div>
           <p>In reality, no <a id="I_indexterm5_id320987" class="indexterm"></a>single event model provides a complete solution to event management. It doesn’t make sense to examine a bunch of different event models and chose just one for your application. Most web-based applications eventually need more than one type. Here are some example use cases:</p>
           <div class="itemizedlist">
            <ul class="itemizedlist">
             <li class="listitem"><p>For reusable libraries that deal with asynchronous behaviors, consider an event emitter.</p></li>
             <li class="listitem"><p>For communication between models, views, logging systems, analytics systems, and so on, where it’s advantageous to keep coupling to a minimum, go with an event aggregator.</p></li>
             <li class="listitem"><p>For reliable communication between independently scalable and deployable application tiers, a message queue may be the right solution.</p></li>
            </ul>
           </div>
           <p>This guide has really only skimmed the surface of possible messaging patterns. I’ve intentionally focused only on the most common patterns that might be handy in almost every app that grows beyond a few thousand lines of code. For more ideas, take a look at <a id="I_indexterm5_id321032" class="indexterm"></a>Martin Fowler’s writing on <a class="ulink" href="http://bit.ly/1lmVSWT" target="_top">Event Aggregator</a>, <a class="ulink" href="http://bit.ly/1lmVUxX" target="_top">Observer Synchronization</a>, and <a class="ulink" href="http://bit.ly/1lmVYxD" target="_top">Event Sourcing</a>.</p>
          </div>
          <div class="sect3" title="Events by example">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="id690671">Events by example</h4>
             </div>
            </div>
           </div>
           <p>To better <a id="ev5.1.2.5" class="indexterm"></a>understand how the most common messaging patterns fit together, it might be useful to revisit the guest-list app introduced in <a class="xref" href="ch04.html" title="Chapter&nbsp;4.&nbsp;Modules">Chapter&nbsp;4</a>.</p>
           <p>Of course, the whole idea here is to keep the presentation concerns separate from the data-management and domain-logic concerns. Backbone.js can give you a leg up with that by encapsulating common data-management tasks in models and collections, and encapsulating display and UI concerns in views.</p>
           <p>All <code class="code">Backbone.Model</code> instances <a id="I_indexterm5_id321099" class="indexterm"></a><a id="I_indexterm5_id321108" class="indexterm"></a><a id="I_indexterm5_id321118" class="indexterm"></a>are event emitters. When a model attribute changes, it emits a <code class="code">change:&lt;attribute&gt;</code> event, where <code class="code">&lt;attribute&gt;</code> is the name of the attribute that changed. Since you want to communicate the change to the view without tightly coupling the model to the view or vice versa, you’ll want to have the model listen for its own change event and rebroadcast it at the app level.</p>
           <p>The view can listen for the app level <code class="code">changed</code> event and respond by updating the list item that changed.</p>
           <p><a class="xref" href="ch05.html#example5-1" title="Example&nbsp;5-1.&nbsp;guestmodel.js">Example&nbsp;5-1</a> shows the new guest-list model. You can listen to the <code class="code">Backbone.Model</code> event emitter with <code class="code">this.on('change:checkedIn', handler)</code>.</p>
           <div class="example">
            <a id="example5-1"></a>
            <div class="example-title">
             Example&nbsp;5-1.&nbsp;guestmodel.js
            </div>
            <div class="example-contents">
             <pre class="programlisting"><code class="kd">var</code> <code class="nx">Model</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'backbone-browserify'</code><code class="p">).</code><code class="nx">Model</code><code class="p">,</code>
  <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./tinyapp'</code><code class="p">),</code>

  <code class="c1">// Set the checkedIn attribute on the model.</code>

  <code class="nx">toggleCheckedIn</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">toggleCheckedIn</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'checkedIn'</code><code class="p">,</code> <code class="o">!</code><code class="k">this</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'checkedIn'</code><code class="p">));</code>
  <code class="p">},</code>

  <code class="nx">delegate</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">delegate</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">sourceId</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'id'</code><code class="p">);</code>

    <code class="c1">// Listen for toggled event, sent from the view.</code>
    <code class="c1">// sourceId is used to filter the event. The model</code>
    <code class="c1">// does not need to know where the event comes from,</code>
    <code class="c1">// only which item was clicked.</code>

    <code class="nx">app</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'toggled-checkedin'</code><code class="p">,</code> <code class="nx">sourceId</code><code class="p">,</code>
      <code class="nx">toggleCheckedIn</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">));</code>


    <code class="c1">// Relay the change event so the view can listen for it</code>
    <code class="c1">// without knowing anything about the model.</code>

    <code class="k">this</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'change:checkedIn'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">item</code><code class="p">)</code> <code class="p">{</code>

      <code class="c1">// Send a shallow copy of the list item as the</code>
      <code class="c1">// message payload. Make sure the new checkedIn</code>
      <code class="c1">// state is easy to access.</code>

      <code class="kd">var</code> <code class="nx">event</code> <code class="o">=</code> <code class="nx">app</code><code class="p">.</code><code class="nx">extend</code><code class="p">({},</code> <code class="nx">item</code><code class="p">,</code> <code class="p">{</code>
        <code class="nx">sourceId</code><code class="o">:</code> <code class="k">this</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code>
        <code class="nx">checkedIn</code><code class="o">:</code> <code class="nx">item</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'checkedIn'</code><code class="p">)</code>
      <code class="p">});</code>


      <code class="c1">// Broadcast the message on the aggregator.</code>

      <code class="nx">app</code><code class="p">.</code><code class="nx">trigger</code><code class="p">(</code><code class="s1">'changed.checkedIn'</code><code class="p">,</code> <code class="nx">event</code><code class="p">);</code>
    <code class="p">}.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">));</code>  
  <code class="p">},</code>

  <code class="c1">// The collection expects a Backbone.Model constructor.</code>

  <code class="nx">api</code> <code class="o">=</code> <code class="nx">Model</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
    <code class="nx">initialize</code><code class="o">:</code> <code class="nx">delegate</code><code class="p">,</code>
    <code class="nx">toggleCheckedIn</code><code class="o">:</code> <code class="nx">toggleCheckedIn</code>
  <code class="p">});</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">api</code><code class="p">;</code></pre>
            </div>
           </div>
           <p>Note the line:</p>
           <a id="I_programlisting5_id321190"></a>
           <pre class="programlisting"><code class="nx">app</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'toggled-checkedin'</code><code class="p">,</code> <code class="nx">sourceId</code><code class="p">,</code>
  <code class="nx">toggleCheckedIn</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">));</code></pre>
           <p>Tinyapp adds the <a id="ti5.1.2.5" class="indexterm"></a>concept of a <code class="code">sourceId</code> to event listening. The idea is that you augment your triggered event object with the ID of the object you’re talking about. When you listen for the event (like this example illustrates), you can pass in the object’s ID to filter out any events that don’t have that <code class="code">sourceId</code> on the event object. This can be handled at the application framework or event library level. For example, in Tinyapp, there’s a wrapper around the <code class="code">events.on</code> method that looks something like this:</p>
           <a id="I_programlisting5_id321227"></a>
           <pre class="programlisting"><code class="kd">function</code> <code class="nx">on</code><code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">args</code> <code class="o">=</code> <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">),</code>
    <code class="nx">type</code> <code class="o">=</code> <code class="nx">args</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code>
    <code class="nx">sourceId</code> <code class="o">=</code> <code class="nx">args</code><code class="p">[</code><code class="mi">1</code><code class="p">],</code>
    <code class="nx">callback</code> <code class="o">=</code> <code class="nx">args</code><code class="p">[</code><code class="mi">2</code><code class="p">];</code>

  <code class="c1">// If there's no sourceId, just pass this through</code>
  <code class="c1">// to the event emitter.</code>

  <code class="k">if</code> <code class="p">(</code><code class="nx">args</code><code class="p">.</code><code class="nx">length</code> <code class="o">&lt;=</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">events</code><code class="p">.</code><code class="nx">on</code><code class="p">.</code><code class="nx">apply</code><code class="p">(</code><code class="nx">events</code><code class="p">,</code> <code class="nx">arguments</code><code class="p">);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>


    <code class="c1">// Otherwise, filter out any events that don't match</code>
    <code class="c1">// the expected sourceId.</code>

    <code class="nx">events</code><code class="p">.</code><code class="nx">on</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">events</code><code class="p">,</code> <code class="nx">type</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">event</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">event</code><code class="p">.</code><code class="nx">sourceId</code> <code class="o">===</code> <code class="nx">sourceId</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">callback</code><code class="p">(</code><code class="nx">event</code><code class="p">);</code>
      <code class="p">}</code>
    <code class="p">});</code>
  <code class="p">}</code>
<code class="p">}</code></pre>
           <p>Similar strategies include namespacing events and creating separate channels (aggregators) for separate concerns.</p>
           <div class="warning" title="Warning" epub:type="warning">
            <h3 class="title">Warning</h3>
            <p>Regardless of which mechanism you prefer for event communication, be careful not to refer to other modules directly (including via channels and namespaces). If modules know how to communicate with each other directly, it defeats the purpose of loose coupling, and you might as well give them a direct handle on each other. A common pitfall that I have fallen into myself is to use the module’s namespace as the event namespace. Doing so gives every module that needs to listen knowledge of the emitting module by name.</p>
           </div>
           <p>Returning to the example app: the collection isn’t doing much yet, but later you’ll use it to add and remove guests. For now, it just gets a handle to the model constructor that it will use to instantiate new list items. The <code class="literal">create</code> method is just a thin wrapper around collection instantiation, as shown in <a class="xref" href="ch05.html#example5-2" title="Example&nbsp;5-2.&nbsp;guestlistcollection.js">Example&nbsp;5-2</a>.</p>
           <div class="example">
            <a id="example5-2"></a>
            <div class="example-title">
             Example&nbsp;5-2.&nbsp;guestlistcollection.js
            </div>
            <div class="example-contents">
             <pre class="programlisting"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./tinyapp'</code><code class="p">),</code>
  <code class="nx">Model</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./guestmodel'</code><code class="p">),</code>
  <code class="nx">Collection</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'backbone-browserify'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">Collection</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
      <code class="nx">model</code><code class="o">:</code> <code class="nx">Model</code>
    <code class="p">}),</code>

  <code class="nx">create</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">create</code><code class="p">(</code><code class="nx">models</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">models</code> <code class="o">=</code> <code class="nx">models</code> <code class="o">||</code> <code class="nx">app</code><code class="p">.</code><code class="nx">pageData</code><code class="p">.</code><code class="nx">guestList</code><code class="p">;</code>

    <code class="k">return</code> <code class="k">new</code> <code class="nx">Collection</code><code class="p">(</code><code class="nx">models</code><code class="p">);</code>
  <code class="p">},</code>

  <code class="nx">api</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">create</code><code class="o">:</code> <code class="nx">create</code>
  <code class="p">};</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">api</code><code class="p">;</code></pre>
            </div>
           </div>
           <p>Similar to how the model relays its own events, the view listens for DOM events and relays them on the app event aggregator so that other modules can listen (such as models or click loggers). Pay special attention to the <code class="code">delegate()</code> and <code class="code">relayClick()</code> functions, <a id="I_indexterm5_id321305" class="indexterm"></a><a id="I_indexterm5_id321314" class="indexterm"></a><a id="I_indexterm5_id321322" class="indexterm"></a><a id="I_indexterm5_id321330" class="indexterm"></a>as in <a class="xref" href="ch05.html#example5-3" title="Example&nbsp;5-3.&nbsp;guestlistview.js">Example&nbsp;5-3</a>.</p>
           <div class="example">
            <a id="example5-3"></a>
            <div class="example-title">
             Example&nbsp;5-3.&nbsp;guestlistview.js
            </div>
            <div class="example-contents">
             <pre class="programlisting"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./tinyapp'</code><code class="p">),</code>

  <code class="c1">// Assign Backbone.View to the View var.</code>

  <code class="nx">View</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'backbone-browserify'</code><code class="p">).</code><code class="nx">View</code><code class="p">,</code>

  <code class="nx">$</code> <code class="o">=</code> <code class="nx">app</code><code class="p">.</code><code class="nx">$</code><code class="p">,</code>
  <code class="nx">checkedinClass</code> <code class="o">=</code> <code class="s1">'icon-check'</code><code class="p">,</code>
  <code class="nx">listClass</code> <code class="o">=</code> <code class="s1">'dropdown-menu'</code><code class="p">,</code>
  <code class="nx">guestClass</code> <code class="o">=</code> <code class="s1">'guest'</code><code class="p">,</code>


  <code class="c1">// Rebroadcast DOM click events on the app event</code>
  <code class="c1">// aggregator.</code>

  <code class="nx">relayClick</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">relayClick</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>

    <code class="c1">// Get the ID from the element and use it to</code>
    <code class="c1">// namespace the event.</code>

    <code class="kd">var</code> <code class="nx">sourceId</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'id'</code><code class="p">),</code>
      <code class="nx">event</code> <code class="o">=</code> <code class="nx">app</code><code class="p">.</code><code class="nx">extend</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="p">{</code>
        <code class="nx">sourceId</code><code class="o">:</code> <code class="nx">$</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'id'</code><code class="p">)</code>
      <code class="p">});</code>

    <code class="nx">app</code><code class="p">.</code><code class="nx">trigger</code><code class="p">(</code><code class="s1">'toggled-checkedin'</code><code class="p">,</code> <code class="nx">event</code><code class="p">);</code>
  <code class="p">},</code>

  <code class="nx">delegate</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">delegate</code><code class="p">()</code> <code class="p">{</code>

    <code class="c1">// Delegate all click events to the parent element.</code>

    <code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="s1">'.'</code> <code class="o">+</code> <code class="nx">guestClass</code><code class="p">,</code> <code class="nx">relayClick</code><code class="p">);</code>

    <code class="c1">// Listen for changed events from the model</code>
    <code class="c1">// and make sure the element reflects the current</code>
    <code class="c1">// state.</code>

    <code class="nx">app</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'changed.checkedIn'</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">changeHandler</code><code class="p">(</code><code class="nx">event</code><code class="p">)</code> <code class="p">{</code>
      <code class="kd">var</code> <code class="nx">id</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code>


      <code class="c1">// Select the right list item by ID.</code>

      <code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="s1">'#'</code> <code class="o">+</code> <code class="nx">id</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">toggleClass</code><code class="p">(</code><code class="nx">checkedinClass</code><code class="p">,</code> <code class="nx">event</code><code class="p">.</code><code class="nx">checkedIn</code><code class="p">);</code>

    <code class="p">}.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">));</code>
  <code class="p">},</code>

  <code class="nx">render</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">render</code><code class="p">(</code><code class="nx">guestlist</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">$el</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">;</code>

    <code class="nx">$el</code><code class="p">.</code><code class="nx">empty</code><code class="p">();</code>

    <code class="c1">// Loop over the passed-in guest models and render</code>
    <code class="c1">// them as li elements.</code>

    <code class="nx">guestlist</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">guestModel</code><code class="p">)</code> <code class="p">{</code>
      <code class="kd">var</code> <code class="nx">$guest</code><code class="p">;</code>
      <code class="nx">guest</code> <code class="o">=</code> <code class="nx">guestModel</code><code class="p">.</code><code class="nx">toJSON</code><code class="p">();</code>
      <code class="nx">$guest</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="s1">'&lt;li class="'</code> <code class="o">+</code> <code class="nx">guestClass</code> <code class="o">+</code> <code class="s1">'" '</code> <code class="o">+</code>
        <code class="s1">'id="'</code> <code class="o">+</code> <code class="nx">guest</code><code class="p">.</code><code class="nx">id</code> <code class="o">+</code><code class="s1">'"&gt;'</code> <code class="o">+</code>
        <code class="s1">'&lt;span class="name"&gt;'</code> <code class="o">+</code> <code class="nx">guest</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code>
        <code class="s1">'&lt;/span&gt;&lt;/li&gt;'</code><code class="p">);</code>
      <code class="nx">$guest</code><code class="p">.</code><code class="nx">appendTo</code><code class="p">(</code><code class="nx">$el</code><code class="p">);</code>
    <code class="p">});</code>

    <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
  <code class="p">},</code>

  <code class="c1">// Define the backbone view.</code>
  <code class="nx">GuestlistView</code> <code class="o">=</code> <code class="nx">View</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
    <code class="nx">tagName</code><code class="o">:</code> <code class="s1">'ol'</code><code class="p">,</code>
    <code class="nx">id</code><code class="o">:</code> <code class="s1">'guestlist-view'</code><code class="p">,</code>
    <code class="nx">className</code><code class="o">:</code> <code class="nx">listClass</code><code class="p">,</code>
    <code class="nx">initialize</code><code class="o">:</code> <code class="nx">delegate</code><code class="p">,</code>
    <code class="nx">render</code><code class="o">:</code> <code class="nx">render</code>
  <code class="p">}),</code>

  <code class="c1">// Expose a factory function.</code>
  <code class="nx">create</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">create</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">GuestlistView</code><code class="p">();</code>
  <code class="p">},</code>

  <code class="nx">api</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">create</code><code class="o">:</code> <code class="nx">create</code>
  <code class="p">};</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">api</code><code class="p">;</code></pre>
            </div>
           </div>
          </div>
         </div>
         <div class="sect2" title="Model View Controller/MV*">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="id761401">Model View Controller/MV*</h3>
            </div>
           </div>
          </div>
          <p><em class="firstterm">MVC</em> (Model View Controller) is <a id="se5.1.3" class="indexterm"></a><a id="mv5.1.3" class="indexterm"></a><a id="cl5.1.3" class="indexterm"></a><a id="mo5.1.3" class="indexterm"></a>an architecture for managing separation of presentation logic from business domain logic in applications.</p>
          <p><span class="emphasis"><em>Model</em></span> refers to <a id="I_indexterm5_id321449" class="indexterm"></a>application state, and methods for manipulating and retrieving state. Usually there is a mechanism to notify observing views when the model state changes. There can be more than one view listening to a single model.</p>
          <p><span class="emphasis"><em>View</em></span> refers to the <a id="I_indexterm5_id321463" class="indexterm"></a>UI that gets drawn to the screen. It generally listens to the model so that it can update the UI when state changes, and sometimes to the controller so that it can handle presentation changes that do not impact the business domain (such as scrolling or showing/hiding UI).</p>
          <p><span class="emphasis"><em>Controller</em></span> refers to the <a id="I_indexterm5_id321478" class="indexterm"></a>user interaction logic. It updates the model in response to user requests. In some MVC interpretations, it is responsible for instantiating both the model and the view, and wiring up event listeners between them. Most server-side web frameworks have controllers that route incoming requests to actions, which manipulate the model and serve updated views to the user. See <a class="xref" href="ch05.html#mvc-figure" title="Figure&nbsp;5-1.&nbsp;MVC">Figure&nbsp;5-1</a>.</p>
          <div class="figure">
           <a id="mvc-figure"></a>
           <div class="figure-contents">
            <div class="mediaobject">
             <a id="I_mediaobject5_id321502"></a>
             <img src="/library/view/programming-javascript-applications/9781491950289/httpatomoreillycomsourceoreillyimages2046613.png" alt="MVC" width="754" height="374">
            </div>
           </div>
           <div class="figure-title">
            Figure&nbsp;5-1.&nbsp;MVC
           </div>
          </div>
          <p>In the browser, where each element in the <a id="I_indexterm5_id321521" class="indexterm"></a><a id="I_indexterm5_id321530" class="indexterm"></a>DOM also happens to be an event emitter with most of its own logic built in, it might seem natural to handle a bit more of the input directly in the view (rather than the controller, as is common with MVC). Several alternatives to MVC have sprung up that deviate slightly from the MVC architecture. The alternatives are commonly grouped together and referred to as <em class="firstterm">MV*</em>. Typically, there will be a notion of a model and a view (or something like them), while many of the responsibilities of a controller will be shuffled around to other components. UI logic typically moves mostly into the view, while domain logic gets shifted largely to models. Controllers in modern web applications often get whittled down to simple routers.</p>
          <p>For example, <a class="ulink" href="https://angularjs.org/" target="_top">Angular</a> uses <a id="I_indexterm5_id321558" class="indexterm"></a>a system similar to MVC, except that the view takes on a lot of UI interaction tasks (called directives) that may have been handled by a traditional controller, and the controller handles domain logic and interactions with the models, which are bound to views via simple data structures called scopes. Angular’s controllers might remind you a lot of models from other MVC implementations, if you’re a follower of the “fat models, skinny controllers” approach. They typically supply or consume a collection of related services.</p>
          <p><a class="ulink" href="https://muut.com/riotjs/" target="_top">Riot.js</a> is a <a id="I_indexterm5_id321583" class="indexterm"></a>Model View Presenter (MVP) <a id="I_indexterm5_id321589" class="indexterm"></a><a id="I_indexterm5_id321595" class="indexterm"></a>library that represents the polar opposite of Angular. Riot’s model contains only business-domain logic: state and services to manipulate that state. The view is strictly HTML and CSS. The templates contain zero logic. There are no custom extensions to the HTML. The presenter listens to both the model and the view and responds to the events. This pattern is a branch of MVP known as passive view. The approach is extraordinarily simple, and it’s reflected in both the size and performance of Riot. It weighs in at less than 2 k minified and gzipped, and the template engine significantly outperforms popular competitors. The surface area of the API is so small, you could literally master it in a single sitting.</p>
          <p>The most popular MV* library is <a class="ulink" href="http://backbonejs.org/" target="_top">Backbone</a>. As <a id="I_indexterm5_id321618" class="indexterm"></a>with Angular, Backbone delegates most of what you would find in a controller to the view and router. Instead of models, views, and controllers, and an opinionated way of stitching them together, Backbone defines <code class="code">View</code>, <code class="code">Model</code>, <code class="code">Collection</code>, and <code class="code">Router</code> constructors. You are expected to subclass those constructors using the <code class="code">.extend()</code> method available on each of the constructors.</p>
          <div class="warning" title="Warning" epub:type="warning">
           <h3 class="title">Warning</h3>
           <p>Backbone’s <code class="code">.extend()</code> method <a id="I_indexterm5_id321655" class="indexterm"></a><a id="I_indexterm5_id321666" class="indexterm"></a>creates classical-style inheritance hierarchies, with all the pitfalls that go along with them. I have seen a couple of projects get into trouble by relying too much on Backbone’s <code class="code">.extend()</code> inheritance. Be careful about subclassing from <a id="I_indexterm5_id321684" class="indexterm"></a>subclasses. Instead, try passing exemplar prototypes and mixins into <code class="code">.extend()</code> in order to facilitate code reuse. See <a class="xref" href="ch03.html#chcss2i1z00025eilzn6ki8ds" title="Classical Inheritance Is Obsolete">Classical Inheritance Is Obsolete</a> and <a class="xref" href="ch03.html#chcsrdou100015eilvj6l9inj" title="Prototypes">Prototypes</a>.</p>
          </div>
          <p>Backbone is not terribly opinionated about how you stitch the various pieces together, but most samples you’ll find in the wild give a lot of responsibility to the view, which typically instantiates and keeps a reference to collections, models, or both. A typical arrangement might look something like <a class="xref" href="ch05.html#figure5-2" title="Figure&nbsp;5-2.&nbsp;Backbone">Figure&nbsp;5-2</a>.</p>
          <div class="figure">
           <a id="figure5-2"></a>
           <div class="figure-contents">
            <div class="mediaobject">
             <a id="I_mediaobject5_id321726"></a>
             <img src="/library/view/programming-javascript-applications/9781491950289/httpatomoreillycomsourceoreillyimages2046614.png" alt="Backbone" width="1000" height="340">
            </div>
           </div>
           <div class="figure-title">
            Figure&nbsp;5-2.&nbsp;Backbone
           </div>
          </div>
          <p><code class="code">Backbone.Router</code> allows <a id="I_indexterm5_id321746" class="indexterm"></a>you to update the location bar when the user selects different views, or create actions that get triggered in response to the user navigating to a given URL. This is the primary responsibility of controllers on the server side, because URLs are generally the only way for the user to communicate with a server-side application. That’s not the case in a client-side application.</p>
          <p><code class="code">Backbone.View</code> is <a id="I_indexterm5_id321765" class="indexterm"></a>responsible for encapsulating view logic, such as how and when to display information. Views typically listen for DOM events, translate them into some intended action, and then emit events that the model can subscribe to.</p>
          <div class="warning" title="Warning" epub:type="warning">
           <h3 class="title">Warning</h3>
           <p>It’s common to see views directly update models, collections, and routers, but when they do, it is a slippery slope. Often, developers get confused and start to put too much business logic in the view, which breaks the separation of concerns and leads to code duplication and hard-to-find bugs across multiple views that need to share the same business rules. Instead, views should only manage the presentation concerns and trigger events that other modules can listen for.</p>
          </div>
          <p><code class="code">Backbone.Model</code> is <a id="I_indexterm5_id321793" class="indexterm"></a>responsible for encapsulating state and business logic. When state changes, it emits events that views can subscribe to.</p>
          <p><code class="code">Backbone.Collection</code> is an <a id="I_indexterm5_id321810" class="indexterm"></a>extremely useful abstraction that provides a managed way of dealing with collections of models, complete with Underscore’s many functional methods, which you can use to query, filter, and sort your collections.</p>
          <p>As you’ve already seen in the event examples, there are alternative ways to stitch Backbone’s tools together. For example, you can route most of the communication through an <a id="I_indexterm5_id321827" class="indexterm"></a><a id="I_indexterm5_id321836" class="indexterm"></a>event aggregator to reduce coupling to a minimum, as shown in <a class="xref" href="ch05.html#figure5-3" title="Figure&nbsp;5-3.&nbsp;Backbone with event aggregator">Figure&nbsp;5-3</a>.</p>
          <div class="figure">
           <a id="figure5-3"></a>
           <div class="figure-contents">
            <div class="mediaobject">
             <a id="I_mediaobject5_id321862"></a>
             <img src="/library/view/programming-javascript-applications/9781491950289/httpatomoreillycomsourceoreillyimages2046615.png" alt="Backbone with event aggregator" width="681" height="649">
            </div>
           </div>
           <div class="figure-title">
            Figure&nbsp;5-3.&nbsp;Backbone with event aggregator
           </div>
          </div>
          <p>The solid lines represent direct references. Dashed lines represent event listeners. As you can see, with this setup, you don’t need a lot of direct references, which allows your modules to be a lot less coupled. Views listen for state changes and view selection events and emit user-action events. The router listens for user route selections, and emits route-change events. Collections listen for add and remove events and relay change events from the model. The model listens for UI input changes and emits change events.</p>
          <p>This is the pattern you’ll see developing in the examples, but it’s certainly not the only way to handle separation of concerns in the browser.</p>
          <p>There are many other MV* alternatives, including MVVM and RVP. I’ll leave it to you and Google to work out how they all differ. The important thing to understand is that all of them exist to allow the separation of presentation logic and business-domain logic. In short, your business logic should not be mixed in with your presentation logic and vice versa. You can explore various libraries <a id="I_indexterm5_id321896" class="indexterm"></a><a id="I_indexterm5_id321904" class="indexterm"></a><a id="I_indexterm5_id321913" class="indexterm"></a><a id="I_indexterm5_id321921" class="indexterm"></a><a id="I_indexterm5_id321929" class="indexterm"></a>frameworks at <a class="ulink" href="http://todomvc.com/" target="_top">TodoMVC.com</a>.</p>
         </div>
         <div class="sect2" title="Presentation and DOM Manipulation">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="id772677">Presentation and DOM Manipulation</h3>
            </div>
           </div>
          </div>
          <p>The primary purpose of a view in <a id="sa5.1.4" class="indexterm"></a><a id="sd5.1.4" class="indexterm"></a><a id="ca5.1.4" class="indexterm"></a><a id="cd5.1.4" class="indexterm"></a><a id="do5.1.4" class="indexterm"></a><a id="I_indexterm5_id322017" class="indexterm"></a><a id="I_indexterm5_id322027" class="indexterm"></a><a id="I_indexterm5_id322032" class="indexterm"></a>Backbone is to present the application’s interface to the user and react to user input. As such, every Backbone view should be associated with some DOM. Backbone handles that association with the <code class="code">.el</code> and <code class="code">.$el</code> properties. The <code class="code">.el</code> property is a direct reference to the view’s root element, while <code class="code">.$el</code> is a cached jQuery or Zepto object for the view’s element.</p>
          <p>Consider <a class="xref" href="ch05.html#example5-4" title="Example&nbsp;5-4.&nbsp;Creating a Backbone view">Example&nbsp;5-4</a> from <span class="emphasis"><em>guestlistview.js</em></span>.</p>
          <div class="example">
           <a id="example5-4"></a>
           <div class="example-title">
            Example&nbsp;5-4.&nbsp;Creating a Backbone view
           </div>
           <div class="example-contents">
            <pre class="programlisting"><code class="c1">// Define the backbone view.</code>
<code class="nx">GuestlistView</code> <code class="o">=</code> <code class="nx">View</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
  <code class="nx">tagName</code><code class="o">:</code> <code class="s1">'ol'</code><code class="p">,</code>
  <code class="nx">id</code><code class="o">:</code> <code class="s1">'guestlist-view'</code><code class="p">,</code>
  <code class="nx">className</code><code class="o">:</code> <code class="nx">listClass</code><code class="p">,</code>
  <code class="nx">initialize</code><code class="o">:</code> <code class="nx">delegate</code><code class="p">,</code>
  <code class="nx">render</code><code class="o">:</code> <code class="nx">render</code>
<code class="p">}),</code></pre>
           </div>
          </div>
          <p>If specified, Backbone.View will construct <code class="code">this.el</code> using the <code class="code">tagName</code>, <code class="code">className</code>, <code class="code">id</code>, and <code class="code">attributes</code> parameters. If you don’t specify a <code class="code">tagName</code>, it will create a <code class="code">div</code>. You can also attach the view to an existing element by passing in a value for <code class="code">.el</code>.</p>
          <div class="sect3" title="View events">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="id714073">View events</h4>
             </div>
            </div>
           </div>
           <p>Backbone lets you <a id="I_indexterm5_id322127" class="indexterm"></a>pass in an events hash to declaratively specify event handlers. The hash takes the form, <code class="code">{ 'eventName selector': 'callback' }</code>. If <code class="code">'callback'</code> is a string, it will map to the method on the view object that matches the name. You can also pass an inline function or function reference. Backbone uses <a id="I_indexterm5_id322146" class="indexterm"></a>jQuery’s <code class="code">.on()</code> method and delegates events to the view’s root element (<code class="code">this.el</code>) by default. If you omit the selector, the root element will be the target element.</p>
           <div class="warning" title="Warning" epub:type="warning">
            <h3 class="title">Warning</h3>
            <p>Leaving off the selector is probably a code smell. Could you be delegating events to a parent element instead?</p>
           </div>
           <div class="sect4" title="Event delegation">
            <div class="titlepage">
             <div>
              <div>
               <h5 class="title" id="id789527">Event delegation</h5>
              </div>
             </div>
            </div>
            <p><em class="firstterm">Event delegation</em> is the <a id="do5.1.4.1.1" class="indexterm"></a><a id="ev5.1.4.1.1" class="indexterm"></a><a id="I_indexterm5_id322211" class="indexterm"></a>process of aggregating events from multiple sources to a single event-handling mechanism. It’s common to encounter large collections that share the same event handlers but attach different listeners for each item in the collection.</p>
            <p>For example, it might have been tempting to implement the guest-list item as a separate view, and then rerender the guest template every time the status changed. That might look something like this:</p>
            <a id="I_programlisting5_id322229"></a>
            <pre class="programlisting"><code class="nx">render</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">render</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">$el</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">;</code>

  <code class="c1">// Prevent memory leaks in rerender cases.</code>
  <code class="nx">$el</code><code class="p">.</code><code class="nx">off</code><code class="p">(</code><code class="s1">'click.'</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="nx">className</code><code class="p">);</code>
  <code class="nx">$el</code><code class="p">.</code><code class="nx">empty</code><code class="p">();</code>

  <code class="nx">processTemplate</code><code class="p">(</code><code class="nx">$el</code><code class="p">,</code> <code class="nx">data</code><code class="p">);</code>

  <code class="c1">// Reattach listener.</code>
  <code class="nx">$el</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click.'</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="nx">className</code><code class="p">,</code> <code class="nx">handleClick</code><code class="p">);</code>

  <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">};</code></pre>
            <p>Note that this is essentially equivalent to passing an <code class="code">events</code> hash to Backbone in the hypothetical guests <code class="code">View.extend()</code>:</p>
            <a id="I_programlisting5_id322250"></a>
            <pre class="programlisting"><code class="nx">events</code><code class="o">:</code> <code class="p">{</code>
  <code class="s1">'click'</code><code class="o">:</code> <code class="nx">handleClick</code>
<code class="p">}</code></pre>
            <p>Note that Backbone automatically delegates using <a id="I_indexterm5_id322260" class="indexterm"></a>jQuery’s <code class="code">.on()</code> method. However, passing a hash like this into an item-level view negates that capability. Instead, it will wire up a separate click handler for each list item.</p>
            <p>This approach slows down the application in two ways: first, it takes longer to initialize because of the extra wiring that must be performed for each event handler, for each item. It also consumes more memory, particularly if you chose the inline method to specify the event handler. If you do that, there will actually be a separate copy of the event handler function for each item.</p>
            <p>You should be aware that you can leak memory if you bind event handlers to each item in a dynamic collection. For example, if you have a collection that utilizes the infinite scroll technique, you’ll need to remove elements from the DOM as they scroll out of view to prevent browser performance issues or crashes. You must remember to remove the event listeners when you remove the items from the DOM. Backbone views have a <code class="code">.remove()</code> method that will remove both the DOM listeners and stop the view from listening for events from other objects.</p>
            <p>You’ve already seen event delegation employed in the <code class="code">guestlistview.js</code> <code class="code">delegate()</code> function. Now you’ll use the built in <code class="code">Backbone.View</code> events hash to handle it instead. Here’s what the delegation looked like before:</p>
            <a id="I_programlisting5_id322311"></a>
            <pre class="programlisting"><code class="c1">// From the delegate() function:</code>
<code class="c1">// Delegate all click events to the parent element.</code>
<code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="s1">'.'</code> <code class="o">+</code> <code class="nx">guestClass</code><code class="p">,</code> <code class="nx">relayClick</code><code class="p">);</code></pre>
            <p>You’ll pull that code out of the delegate() function and let Backbone handle it for you:</p>
            <a id="I_programlisting5_id322324"></a>
            <pre class="programlisting"><code class="c1">// Define the backbone view.</code>
<code class="nx">GuestlistView</code> <code class="o">=</code> <code class="nx">View</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
  <code class="nx">tagName</code><code class="o">:</code> <code class="s1">'ol'</code><code class="p">,</code>
  <code class="nx">id</code><code class="o">:</code> <code class="s1">'guestlist-view'</code><code class="p">,</code>
  <code class="nx">className</code><code class="o">:</code> <code class="nx">listClass</code><code class="p">,</code>
  <code class="nx">initialize</code><code class="o">:</code> <code class="nx">delegate</code><code class="p">,</code>
  <code class="nx">render</code><code class="o">:</code> <code class="nx">render</code><code class="p">,</code>

  <code class="c1">// Add the handler to the view object:</code>
  <code class="nx">relayClick</code><code class="o">:</code> <code class="nx">relayClick</code><code class="p">,</code>

  <code class="c1">// Let Backbone handle the event delegation:</code>
  <code class="nx">events</code><code class="o">:</code> <code class="p">{</code>
    <code class="s1">'click .guest'</code><code class="o">:</code> <code class="s1">'relayClick'</code>
  <code class="p">}</code>
<code class="p">}),</code></pre>
            <p>By delegating the <code class="code">click</code> to the parent element instead of to each list item, only one listener has to be attached per behavior, rather than one per behavior for each item in the list. What’s more, you don’t have to worry about removing the listener and adding it again if you need to render a list item again. In short, less code to write, and less risk of memory leaks.</p>
            <p>Bonus: when you expose your event handlers on the view object, it makes them easier to unit test because you don’t have to figure out how to simulate the events in order to invoke the handlers. Keep in mind that events are a part of the API surface area, and event handlers should be tested, just like public <a id="I_indexterm5_id322350" class="indexterm"></a><a id="I_indexterm5_id322358" class="indexterm"></a>methods.</p>
            <div class="warning" title="Warning" epub:type="warning">
             <h3 class="title">Warning</h3>
             <p>If you implement list items as subviews, you still need to remember to call the item’s <code class="code">.remove()</code> method as the item scrolls away, because you still need to stop the view from listening to Backbone events. If you wire up any other kind of event listener (such as an app-level event aggregator), you should remember to remove those listeners as well.</p>
            </div>
           </div>
          </div>
          <div class="sect3" title="Templates">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="id657455">Templates</h4>
             </div>
            </div>
           </div>
           <p>Templates help to <a id="te5.1.4.2" class="indexterm"></a><a id="do5.1.4.2" class="indexterm"></a>separate display structure concerns from logic. Templates define the structure of your UI, along with some indication of where data should be injected. Templates can be reused with a variety of different data. A template processor combines data and templates to produce the DOM output that will be rendered to the screen.</p>
           <div class="warning" title="Warning" epub:type="warning">
            <h3 class="title">Warning</h3>
            <p>It’s common for template languages to support limited logic, such as if/else statements. I recommend that you avoid the temptation to use any of them, because they defeat the purpose of separating DOM structure from logic concerns—instead, your logic just lives somewhere else. Even worse, your logic lives in two places, and it’s even harder to find the source of bugs.</p>
           </div>
           <p>There are many different options for template rendering. Some common choices include Jade, Mustache, Haml, EJS, Plates, and Pure. Plates (a Flatiron library) and Pure provide the ability to write templates in pure HTML, with no specialized DSL mixed in at all. Data gets associated <a id="I_indexterm5_id322442" class="indexterm"></a>via CSS-style selectors in the JavaScript view layer. <a id="ba5.1.4.2" class="indexterm"></a>Backbone relies on the <a id="un5.1.4.2" class="indexterm"></a>Underscore library, which happens to include a simple template engine. For the sake of simplicity and familiarity, you’ll see it used in the examples.</p>
           <p>Let’s revisit the guest-list view and replace the inline HTML with a template.</p>
           <p>Before:</p>
           <a id="I_programlisting5_id322491"></a>
           <pre class="programlisting"><code class="s1">'&lt;li class="'</code> <code class="o">+</code> <code class="nx">guestClass</code> <code class="o">+</code>
  <code class="s1">'" '</code> <code class="o">+</code>  <code class="s1">'id="'</code> <code class="o">+</code> <code class="nx">guest</code><code class="p">.</code><code class="nx">id</code> <code class="o">+</code><code class="s1">'"&gt;'</code> <code class="o">+</code>
  <code class="s1">'&lt;span class="name"&gt;'</code> <code class="o">+</code> <code class="nx">guest</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code>
  <code class="s1">'&lt;/span&gt;&lt;/li&gt;'</code></pre>
           <p>After:</p>
           <a id="I_programlisting5_id322503"></a>
           <pre class="programlisting"><code class="nt">&lt;li</code> <code class="na">class=</code><code class="s">"&lt;%= guestClass %&gt;"</code> <code class="na">id=</code><code class="s">"&lt;%= id %&gt;"</code><code class="nt">&gt;</code>
  <code class="nt">&lt;span</code> <code class="na">class=</code><code class="s">"name"</code><code class="nt">&gt;</code><code class="err">&lt;</code>%= name %&gt;<code class="nt">&lt;/span&gt;</code>
<code class="nt">&lt;/li&gt;</code></pre>
           <p>Even better, now that it isn’t expressed in a JavaScript string, it’s obvious that it doesn’t belong in the JavaScript view layer at all. For a template this small, it wouldn’t do any harm to simply embed it in the HTML for the page. You can do that using a <code class="literal">&lt;script&gt;</code> tag:</p>
           <a id="I_programlisting5_id322521"></a>
           <pre class="programlisting"><code class="nt">&lt;script </code><code class="na">id=</code><code class="s">"guest"</code> <code class="na">type=</code><code class="s">"text/template"</code><code class="nt">&gt;</code>
  <code class="o">&lt;</code><code class="nx">li</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"&lt;%= guestClass %&gt;"</code> <code class="nx">id</code><code class="o">=</code><code class="s2">"&lt;%= id %&gt;"</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">span</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"name"</code><code class="o">&gt;&lt;%=</code> <code class="nx">name</code> <code class="o">%&gt;&lt;</code><code class="err">/span&gt;</code>
  <code class="o">&lt;</code><code class="err">/li&gt;</code>
<code class="nt">&lt;/script&gt;</code></pre>
           <div class="tip" title="Tip">
            <h3 class="title">Tip</h3>
            <p>Unless they are tiny (a few lines), most templates should be in dedicated files. You may want to group them with corresponding views in the directory hierarchy. You can use a build step to pull templates into your HTML, or for templates that are only used rarely, fetch them as needed via Ajax.</p>
           </div>
           <p>If you’re using a module system that doesn’t pollute the global namespace, you’ll need to explicitly require Underscore in order to access the template utility. If you’re just including Backbone standalone, you don’t need to do anything special to use Underscore’s methods. Just use <code class="code">_.template()</code> directly. In this case, Browserify will not <a id="I_indexterm5_id322548" class="indexterm"></a>leak dependencies into the global namespace, so you’ll need to require it. In <span class="emphasis"><em>guestlistview.js</em></span>, you’ll insert the <code class="code">require()</code> line like <a id="I_indexterm5_id322566" class="indexterm"></a><a id="I_indexterm5_id322574" class="indexterm"></a>this:</p>
           <a id="I_programlisting5_id322584"></a>
           <pre class="programlisting"><code class="c1">// Assign Backbone.View to the View var.</code>
<code class="nx">View</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'backbone-browserify'</code><code class="p">).</code><code class="nx">View</code><code class="p">,</code>

<code class="c1">// Grab the template utility from Underscore.</code>
<code class="nx">template</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'underscore'</code><code class="p">).</code><code class="nx">template</code><code class="p">,</code></pre>
           <p>Of course, this isn’t going to work until we add Underscore to <span class="emphasis"><em>package.json</em></span>:</p>
           <a id="I_programlisting5_id322600"></a>
           <pre class="programlisting">"underscore": "*",</pre>
           <p>Save the file and run:</p>
           <a id="I_programlisting5_id322609"></a>
           <pre class="programlisting"><code class="gp">$</code> npm install</pre>
           <p>Now that the dependency is there, it’s time to add the template code. Underscore lets you compile your HTML templates into an executable function in order to speed up template processing. You can do that near the top of the <code class="code">render()</code> function so that it doesn’t need to be called for every guest that gets rendered, as in <a class="xref" href="ch05.html#example5-5" title="Example&nbsp;5-5.&nbsp;render() with template">Example&nbsp;5-5</a>.</p>
           <div class="example">
            <a id="example5-5"></a>
            <div class="example-title">
             Example&nbsp;5-5.&nbsp;render() with template
            </div>
            <div class="example-contents">
             <pre class="programlisting"><code class="nx">render</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">render</code><code class="p">(</code><code class="nx">guestlist</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">$el</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">,</code>

    <code class="c1">// Compile the guest template.</code>
    <code class="nx">guestTemplate</code> <code class="o">=</code> <code class="nx">template</code><code class="p">(</code><code class="nx">$</code><code class="p">(</code><code class="s1">'#guestTemplate'</code><code class="p">).</code><code class="nx">html</code><code class="p">());</code>

  <code class="nx">$el</code><code class="p">.</code><code class="nx">empty</code><code class="p">();</code>


  <code class="c1">// Loop over the passed-in guest models and render</code>
  <code class="c1">// them as li elements.</code>
  <code class="nx">guestlist</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">guestModel</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">guest</code><code class="p">;</code>

    <code class="c1">// Build the data object to pass into the template.</code>
    <code class="nx">guest</code> <code class="o">=</code> <code class="nx">guestModel</code><code class="p">.</code><code class="nx">toJSON</code><code class="p">();</code>

    <code class="c1">// Add the guestClass to the data object.</code>
    <code class="nx">guest</code><code class="p">.</code><code class="nx">guestClass</code> <code class="o">=</code> <code class="nx">guestClass</code><code class="p">;</code>

    <code class="c1">// Process the template data and append the output to the</code>
    <code class="c1">// list element.</code>
    <code class="nx">$el</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="nx">guestTemplate</code><code class="p">(</code><code class="nx">guest</code><code class="p">));</code>
  <code class="p">});</code>

  <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">}</code></pre>
            </div>
           </div>
           <p>Remember to run <code class="code">grunt</code> to rebuild the <a id="I_indexterm5_id322657" class="indexterm"></a>project files, or set up a <code class="code">grunt watch</code> task to build on file save. The tests should pass again. Having the lint and unit test tasks set up makes it easy to refactor like this with confidence, because you’ll catch any mistakes <a id="I_indexterm5_id322669" class="indexterm"></a><a id="I_indexterm5_id322678" class="indexterm"></a>early.</p>
          </div>
          <div class="sect3" title="Web Components">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="id654268">Web Components</h4>
             </div>
            </div>
           </div>
           <p><em class="firstterm">Web Components</em> are a new <a id="we5.1.4.3" class="indexterm"></a><a id="br5.1.4.3" class="indexterm"></a>standard way of creating reusable components and widgets with JavaScript, HTML, and CSS. The new standards currently lack widespread browser support but may soon transform the way we write reusable components for JavaScript applications.</p>
           <div class="tip" title="Tip">
            <h3 class="title">Tip</h3>
            <p>Shadow DOM + custom elements = Web Components.</p>
           </div>
           <p>Web Components use a technology <a id="do5.1.4.3" class="indexterm"></a><a id="sh5.1.4.3" class="indexterm"></a>called <em class="firstterm">Shadow DOM</em>, which allows you to hide an entirely new document context, including HTML, CSS, and JavaScript. Shadow DOM is completely encapsulated from the main document. It gets its own document root (called <em class="firstterm">shadow root</em>), and possibly in the future, its own execution context for JavaScript. Shadow DOM is also minimally affected by the <a id="I_indexterm5_id322768" class="indexterm"></a>CSS on the parent page. The DOM encapsulation features should feel familiar to anyone who has used iframes for encapsulation purposes.</p>
           <p>Your shadow DOM can be made up of many other HTML elements, but they won’t be visible in the DOM tree unless you specifically enable shadow DOM viewing in a debugger, such as Chrome Developer Tools.</p>
           <p><em class="firstterm">Custom tags</em> are an important aspect of Web Components that allow you to simplify your DOM and write more semantic HTML. For example, if you need to create a knob widget, you can create a component called <code class="code">&lt;x-knob&gt;</code>, which reads a lot better than <code class="code">&lt;div class="knob"&gt;</code>. Custom tags can use <a id="I_indexterm5_id322800" class="indexterm"></a><a id="I_indexterm5_id322808" class="indexterm"></a>prototypal inheritance to inherit the properties of other tags. You can simplify the creation of <code class="code">&lt;x-knob&gt;</code> by sharing the prototype from <code class="code">&lt;input&gt;</code> and setting some default properties (for example, by selecting <code class="code">type="range"</code>). Use the new DOM method, <code class="code">document.register()</code> to define the element.</p>
           <p><a class="xref" href="ch05.html#example5-6" title="Example&nbsp;5-6.&nbsp;document.register()">Example&nbsp;5-6</a> shows how you might define <code class="code">&lt;x-knob&gt;</code> using the <code class="code">document.register()</code> polyfill from Mozilla Web Components:</p>
           <div class="example">
            <a id="example5-6"></a>
            <div class="example-title">
             Example&nbsp;5-6.&nbsp;document.register()
            </div>
            <div class="example-contents">
             <pre class="programlisting"><code class="nb">document</code><code class="p">.</code><code class="nx">register</code><code class="p">(</code><code class="s1">'x-knob'</code><code class="p">,</code> <code class="p">{</code>

  <code class="s1">'prototype'</code><code class="o">:</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code> <code class="p">(</code><code class="nb">window</code><code class="p">.</code><code class="nx">HTMLInputElement</code> <code class="o">||</code>
    <code class="nb">window</code><code class="p">.</code><code class="nx">HTMLSpanElement</code> <code class="o">||</code> <code class="nb">window</code><code class="p">.</code><code class="nx">HTMLElement</code><code class="p">).</code><code class="nx">prototype</code> <code class="p">),</code>

  <code class="s1">'lifecycle'</code><code class="o">:</code> <code class="p">{</code>

    <code class="nx">created</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">proto</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">type</code><code class="o">=</code><code class="s1">'range'</code><code class="p">;</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'x-knob created'</code><code class="p">,</code> <code class="k">this</code><code class="p">);</code>
    <code class="p">},</code>

    <code class="nx">inserted</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'x-knob inserted'</code><code class="p">,</code> <code class="k">this</code><code class="p">);</code>
    <code class="p">},</code>

    <code class="nx">removed</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'x-knob removed'</code><code class="p">,</code> <code class="k">this</code><code class="p">);</code>
    <code class="p">},</code>

    <code class="nx">attributeChanged</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">attr</code><code class="p">,</code> <code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'x-knob attributeChanged'</code><code class="p">,</code> <code class="k">this</code><code class="p">,</code> <code class="nx">attr</code><code class="p">,</code> <code class="nx">value</code><code class="p">);</code>
    <code class="p">}</code>

  <code class="p">}</code>
<code class="p">});</code></pre>
            </div>
           </div>
           <p>Now that you have a definition, you can instantiate it with:</p>
           <a id="I_programlisting5_id322874"></a>
           <pre class="programlisting"><code class="kd">var</code> <code class="nx">knob</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'x-knob'</code><code class="p">);</code></pre>
           <p>Take a closer look at what happens in <a class="xref" href="ch05.html#example5-7" title="Example&nbsp;5-7.&nbsp;Custom tag tests">Example&nbsp;5-7</a>.</p>
           <div class="example">
            <a id="example5-7"></a>
            <div class="example-title">
             Example&nbsp;5-7.&nbsp;Custom tag tests
            </div>
            <div class="example-contents">
             <pre class="programlisting"><code class="nx">$</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>

  <code class="nx">test</code><code class="p">(</code><code class="s1">'document.register()'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>

    <code class="nx">equal</code><code class="p">(</code><code class="k">typeof</code> <code class="nb">document</code><code class="p">.</code><code class="nx">register</code><code class="p">,</code> <code class="s1">'function'</code><code class="p">,</code>
      <code class="s1">'Should exist.'</code><code class="p">);</code>

  <code class="p">});</code>

  <code class="nx">test</code><code class="p">(</code><code class="s1">'document.createElement("x-knob")'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">knob</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'x-knob'</code><code class="p">);</code>

    <code class="nx">ok</code><code class="p">(</code><code class="nx">knob</code><code class="p">.</code><code class="nx">getAttribute</code><code class="p">,</code>
      <code class="s1">'should produce a custom element.'</code><code class="p">);</code>
  <code class="p">});</code>

  <code class="nx">test</code><code class="p">(</code><code class="s1">'x-knob inheritance'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">knob</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'x-knob'</code><code class="p">);</code>

    <code class="nx">ok</code><code class="p">(</code><code class="nx">knob</code><code class="p">.</code><code class="nx">checkValidity</code><code class="p">,</code>
      <code class="s1">'should inherit from input element.'</code><code class="p">);</code>
  <code class="p">});</code>

  <code class="nx">test</code><code class="p">(</code><code class="s1">'x-knob input type'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">knob</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'x-knob'</code><code class="p">);</code>

    <code class="nx">equal</code><code class="p">(</code><code class="nx">knob</code><code class="p">.</code><code class="nx">type</code><code class="p">,</code> <code class="s1">'range'</code><code class="p">,</code>
      <code class="s1">'should have type="range".'</code><code class="p">);</code>
  <code class="p">});</code>

<code class="p">});</code></pre>
            </div>
           </div>
           <p>As exciting as all this is, it’s still bleeding edge. There is currently disagreement in the community about this mechanism, arguing that if we go down this road, we’ll lose a lot of the semantic meaning that the community has pushed so hard for. <a id="I_indexterm5_id322916" class="indexterm"></a>Ian Hickson argues along these lines:</p>
           <p>Wouldn’t it be better to add a new attribute so that we can preserve the semantics of existing elements? For example: <code class="code">&lt;input is="knob" type="range"&gt;</code>. An obvious counter argument is that popular tags will become part of the semantic vernacular, and that agents will begin to recognize them, just as they recognize the semantics of many metadata formats, and many semantic extensions built on top of vanilla HTML. Another counter argument is that many custom elements will not have meaningful base elements whose semantics would be useful to build on.</p>
           <p>As of this writing, none of these features are available for production use if you want solid cross-browser support. Mozilla has created a <a class="ulink" href="http://github.com/mozilla/web-components" target="_top">custom tag polyfill</a> that you can experiment with today for nonproduction use.</p>
           <p>More recently, Google has been hard at work on <a class="ulink" href="http://www.polymer-project.org/" target="_top">Polymer</a>, which seems to be more actively maintained, more current, and more complete. Polymer Platform provides polyfills for custom elements, shadow DOM, HTML imports, pointer events (hardware-agnostic pointer inputs for mouse, pen, and touchscreen), and web animations. Polymer Core builds an API on top of Polymer Platform polyfills, providing sugar to make it easier to work with web components. Polymer Elements is a library of reusable custom elements built on top of the Polymer Platform and Polymer Core base layers. As of this writing, Polymer is still in <span class="emphasis"><em>alpha</em></span>, meaning that it’s in an experimental state, and breaking changes might be introduced. However, it’s a very promising start and could be production ready soon. Refer to the <a class="ulink" href="http://www.polymer-project.org/" target="_top">Polymer website</a> for the <a id="I_indexterm5_id322972" class="indexterm"></a>current status and <a id="I_indexterm5_id322978" class="indexterm"></a><a id="I_indexterm5_id322987" class="indexterm"></a><a id="I_indexterm5_id322995" class="indexterm"></a><a id="I_indexterm5_id323003" class="indexterm"></a><a id="I_indexterm5_id323012" class="indexterm"></a><a id="I_indexterm5_id323022" class="indexterm"></a><a id="I_indexterm5_id323030" class="indexterm"></a><a id="I_indexterm5_id323038" class="indexterm"></a><a id="I_indexterm5_id323047" class="indexterm"></a><a id="I_indexterm5_id323055" class="indexterm"></a><a id="I_indexterm5_id323063" class="indexterm"></a>documentation.</p>
          </div>
         </div>
        </div>
        <div class="sect1" title="Server-Side Concerns">
         <div class="titlepage">
          <div>
           <div>
            <h2 class="title" style="clear: both" id="I_sect15_id323081">Server-Side Concerns</h2>
           </div>
          </div>
         </div>
         <p>There was a time when <a id="sep5.2" class="indexterm"></a><a id="ser5.2" class="indexterm"></a>the server side did a lot of work, but that time has come and gone in the world of JavaScript applications. Many current JavaScript applications defer most of the rendering and business logic to the client. For most apps, the server side will look something like this:</p>
         <div class="orderedlist">
          <ol class="orderedlist" type="1">
           <li class="listitem"><p>RESTful or REST-like API.</p></li>
           <li class="listitem"><p>Static file server.</p></li>
           <li class="listitem"><p>A single-page index route that pre-injects data for the initial page load. (This can be replaced by the static file server if you defer the page data to a subsequent Ajax request.)</p></li>
          </ol>
         </div>
         <p>There are many ways to accomplish these goals, but you should have little trouble finding alternatives via Google. In this section, you’ll learn how to get the job done with Node and Express.</p>
         <div class="sect2" title="Getting Started with Node and Express">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="getting-started-with-node-and-express">Getting Started with Node and Express</h3>
            </div>
           </div>
          </div>
          <p>Node is a <a id="no5.2.1" class="indexterm"></a>server-side JavaScript environment with many attractive features:</p>
          <div class="itemizedlist">
           <ul class="itemizedlist">
            <li class="listitem"><p>A fast JavaScript engine (built on V8).</p></li>
            <li class="listitem"><p>Asynchronous by default philosophy (nothing should block).</p></li>
            <li class="listitem"><p>Event-loop design (much like the browser environment).</p></li>
            <li class="listitem"><p>Networking as a first-class citizen (create production-capable servers with few lines of code).</p></li>
            <li class="listitem"><p>A highly usable streams API.</p></li>
            <li class="listitem"><p>A large, rapidly growing developer community.</p></li>
            <li class="listitem"><p>A simple, CommonJS-based module solution that guarantees module encapsulation (your var declarations are limited to module scope). See <a class="xref" href="ch04.html#node-modules" title="Node-Style Modules">Node-Style Modules</a>.</p></li>
            <li class="listitem"><p>A developer-friendly package management system with thousands of open-source packages to choose from.</p></li>
           </ul>
          </div>
          <p>Some of these features might take some getting used to if you are accustomed to server-side environments that allow features such as blocking IO and a single thread per connection (for convenient state management). However, you’ll find that the incredible performance boost achieved by nonblocking request/response cycles is well worth the learning effort.</p>
          <p>Don’t underestimate the value of the asynchronous-by-default philosophy. That is the key to Node’s incredible performance in production environments.</p>
          <p>Where other environments force users to wait in line while files load or network operations take place, Node fires off the request and keeps accepting new connections and executing other code paths while the asynchronous event does its work in the background.</p>
          <p>Processes can spend an incredible amount of time waiting for file reads and network requests, especially if they encounter an error. Node just keeps cruising along. It’s like getting out of congested city streets with stop lights at every block and on to an open freeway.</p>
          <p>Node isn’t fast simply because of the performance of the V8 JavaScript engine (though that does help). It’s fast because it doesn’t waste time waiting around for things to happen. There are other platforms that share some of JavaScript’s performance characteristics: Twisted Python and Tornado spring to mind. They’re fast for the same reason. However, even though they are more mature, they can’t compete with the active membership of the JavaScript developer community.</p>
          <p>Node comes packaged with a module management solution called npm. It gives you access to a package registry stocked with thousands of open source packages and makes it very easy for you to contribute your own or use a private git repository for proprietary work. Of course, it’s easy to mix and match open source and proprietary packages in a single <a id="I_indexterm5_id323285" class="indexterm"></a>application.</p>
          <div class="sect3" title="Installing Node and Express">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="installing-node-and-express">Installing Node and Express</h4>
             </div>
            </div>
           </div>
           <p>First, make <a id="I_indexterm5_id323305" class="indexterm"></a><a id="I_indexterm5_id323314" class="indexterm"></a>sure you have Node installed. There are installers available from the <a class="ulink" href="http://nodejs.org" target="_top">Node homepage</a>, but I like to use <code class="literal">nvm</code> so that I can easily switch between different versions of Node. To install Node <a id="I_indexterm5_id323337" class="indexterm"></a><a id="I_indexterm5_id323343" class="indexterm"></a>with <code class="literal">nvm</code>:</p>
           <a id="I_programlisting5_id323356"></a>
           <pre class="programlisting"><code class="gp">$</code> curl https://raw.github.com/creationix/nvm/master/install.sh | sh</pre>
           <p>For more on <code class="literal">nvm</code>, check out the docs on the <a class="ulink" href="https://github.com/creationix/nvm" target="_top">GitHub repository</a>. With Node installed, you’ll need to create a new directory for your project:</p>
           <a id="I_programlisting5_id323379"></a>
           <pre class="programlisting"><code class="gp">$</code> mkdir my-first-project
<code class="gp">$</code> <code class="nb">cd </code>my-first project</pre>
           <p>Then initialize your project:</p>
           <a id="I_programlisting5_id323391"></a>
           <pre class="programlisting"><code class="gp">$</code> npm init</pre>
           <p>Express is currently the <a id="I_indexterm5_id323400" class="indexterm"></a>most popular application framework for Node. It’s easy to learn and use, and it has a vibrant developer community. If you’re going to build applications in Node, chances are you’ll eventually use Express. There’s no time like the present to get started. Install Express:</p>
           <a id="I_programlisting5_id323414"></a>
           <pre class="programlisting"><code class="gp">$</code> npm install --save express</pre>
           <p>That’s it. You’re ready to get started!</p>
           <p>If this is your first time using Node and Express, it might be helpful to see what some of the community believes are the current set of best practices. <a class="ulink" href="https://github.com/inadarei/nodebootstrap" target="_top">Node Bootstrap</a> aims to show new users some common practices in the Node/Express community, using Twitter Bootstrap. Among other things, there’s an example of using the cluster module to manage multiple instances of the server (utilizing all available CPU cores).</p>
          </div>
          <div class="sect3" title="Organizing files in Node">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="organizing-files-in-node">Organizing files in Node</h4>
             </div>
            </div>
           </div>
           <p>It’s a good idea to <a id="I_indexterm5_id323450" class="indexterm"></a>follow the emerging file organization trends in existing, popular Node repositories. That way, anybody familiar with Node should be able to find their way around your repository. Here are some common file locations:</p>
           <div class="itemizedlist">
            <ul class="itemizedlist">
             <li class="listitem"><p>Main <span class="emphasis"><em>./index.js</em></span>, <span class="emphasis"><em>./server.js</em></span>, or <span class="emphasis"><em>./yourentryfile.js</em></span> in the root</p></li>
             <li class="listitem"><p>Supporting files in <span class="emphasis"><em>./lib/</em></span></p></li>
             <li class="listitem"><p>Static HTTP files in <span class="emphasis"><em>./public/</em></span></p></li>
             <li class="listitem"><p>Views or templates in <span class="emphasis"><em>./views/</em></span></p></li>
             <li class="listitem"><p>Command-line executables in <span class="emphasis"><em>./bin/</em></span></p></li>
             <li class="listitem"><p>Tests in <span class="emphasis"><em>./test/</em></span> (or <span class="emphasis"><em>./spec/</em></span> if you’re a Jasmine cool-aid drinker)</p></li>
             <li class="listitem"><p>npm scripts in <span class="emphasis"><em>./scripts/</em></span></p></li>
             <li class="listitem"><p>Config in <span class="emphasis"><em>./config/</em></span></p></li>
             <li class="listitem"><p>Documentation in <span class="emphasis"><em>./doc/</em></span></p></li>
             <li class="listitem"><p>Examples in <span class="emphasis"><em>./examples/</em></span></p></li>
             <li class="listitem"><p>Performance analysis in <span class="emphasis"><em>./benchmarks/</em></span></p></li>
             <li class="listitem"><p>Native C/C++ source in <span class="emphasis"><em>./source/</em></span></p></li>
            </ul>
           </div>
           <p>The <a class="ulink" href="https://github.com/isaacs/npm" target="_top">npm repository</a> serves as a good example.</p>
          </div>
          <div class="sect3" title="Node libraries">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="node-libraries">Node libraries</h4>
             </div>
            </div>
           </div>
           <p>These libraries <a id="I_indexterm5_id323605" class="indexterm"></a>will help you solve many common problems in Node:</p>
           <div class="variablelist">
            <dl>
             <dt>
              <span class="term"><a class="ulink" href="http://moutjs.com/" target="_top">Mout</a></span>
             </dt>
             <dd>
              <p>Like Underscore/Lo-Dash, stuff that should probably be included in JavaScript</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="http://expressjs.com/" target="_top">Express</a></span>
             </dt>
             <dd>
              <p>Web-application framework</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="https://github.com/kriskowal/q" target="_top">Q</a></span>
             </dt>
             <dd>
              <p>Promises</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="https://github.com/dilvie/qconf" target="_top">Qconf</a></span>
             </dt>
             <dd>
              <p>Application config</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="https://github.com/dilvie/credential" target="_top">Credential</a></span>
             </dt>
             <dd>
              <p>Safe password hashing</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="http://twitter.github.com/hogan.js/" target="_top">Hogan</a></span>
             </dt>
             <dd>
              <p>Mustache for Express</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="https://github.com/visionmedia/superagent" target="_top">Superagent</a></span>
             </dt>
             <dd>
              <p>Communicate with APIs</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="http://socket.io/" target="_top">Socket.io</a></span>
             </dt>
             <dd>
              <p>Realtime communications (WebSocket)</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="https://github.com/caolan/async" target="_top">Async</a></span>
             </dt>
             <dd>
              <p>Asynchronous functional utilities</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="https://github.com/trentm/node-bunyan" target="_top">Bunyan</a></span>
             </dt>
             <dd>
              <p>Logging</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="https://github.com/substack/tape" target="_top">Tape</a></span>
             </dt>
             <dd>
              <p>Testing</p>
             </dd>
             <dt>
              <span class="term"><a class="ulink" href="http://usecuid.org/" target="_top">Cuid</a></span>
             </dt>
             <dd>
              <p>Better than GUID/UUID for web applications</p>
             </dd>
            </dl>
           </div>
          </div>
          <div class="sect3" title="Configuration">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="configuration">Configuration</h4>
             </div>
            </div>
           </div>
           <p>Don’t include <a id="I_indexterm5_id323829" class="indexterm"></a>configuration data in your app repository (including secrets, paths to file locations, server hostnames, etc.). Instead, set up environment files with examples for sane defaults. Check in the examples, but don’t check in the actual configuration. Following this rule of thumb will make deployment/ops support for the app a lot easier. Check an example file into your app repo, <span class="emphasis"><em>s3.env.example</em></span>:</p>
           <a id="I_programlisting5_id323847"></a>
           <pre class="programlisting">S3_KEY=mykey
S3_SECRET=mysecret</pre>
           <p>Then copy it and fill in the real values when you install the app:</p>
           <a id="I_programlisting5_id323857"></a>
           <pre class="programlisting"><code class="gp">$</code> cp s3.env.example s3.env</pre>
           <p>Use a package like <code class="literal">qconf</code> to make <a id="I_indexterm5_id323872" class="indexterm"></a><a id="I_indexterm5_id323878" class="indexterm"></a>the environment variables available in your app. Make sure that the real environment files get added to <code class="literal">.gitignore</code> so that you don’t accidentally check them into your repository.</p>
           <div class="warning" title="Warning" epub:type="warning">
            <h3 class="title">Warning</h3>
            <p>One of the first stumbling blocks you might run into moving from browsers to Node is that you can’t rely on your closure state to be reserved for a single user. You have a single instance of the app, with a single pool of memory, and a potentially unbounded number of incoming connections.</p>
            <p>State <span class="emphasis"><em>should</em></span> be kept in a database, or passed as parameters through function calls. For example, each request in an Express application will have a corresponding request object. That may be a good place to store in-memory state for a single request/response cycle. Likewise, singletons are a good way to store state that will be shared for all requests, such as your application configuration, but otherwise, they’re usually an antipattern in Node applications.</p>
           </div>
          </div>
          <div class="sect3" title="Express">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="express">Express</h4>
             </div>
            </div>
           </div>
           <p>There are many <a id="I_indexterm5_id323923" class="indexterm"></a>application frameworks available for Node. One popular framework that I find particularly useful is Express. It’s basically an HTTP server built on top of Node’s HTTP module and middleware.</p>
          </div>
          <div class="sect3" title="Create your app">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="create-your-app">Create your app</h4>
             </div>
            </div>
           </div>
           <p>To create an <a id="I_indexterm5_id323946" class="indexterm"></a>Express app instance, you’ll need to <code class="literal">require</code> Express and call the function that gets returned:</p>
           <a id="I_programlisting5_id323962"></a>
           <pre class="programlisting"><code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">),</code>

  <code class="c1">// Create app instance.</code>
  <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code></pre>
          </div>
          <div class="sect3" title="Routing">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="routing">Routing</h4>
             </div>
            </div>
           </div>
           <p>Express has a <a id="I_indexterm5_id323980" class="indexterm"></a><a id="I_indexterm5_id323990" class="indexterm"></a>built-in app router. It’s pretty simple to use. First, request method names correspond to the methods you call to set up your route. <code class="literal">GET</code> is <code class="literal">.get()</code>, <code class="literal">POST</code> is <code class="literal">.post()</code>, and so on. To create a route that will handle any request type, use <code class="literal">.all()</code>. Pass the route as the first parameter and a function as the second parameter:</p>
           <a id="I_programlisting5_id324030"></a>
           <pre class="programlisting"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">setHeader</code><code class="p">(</code><code class="s1">'Content-Type'</code><code class="p">,</code> <code class="s1">'text/plain'</code><code class="p">);</code>

  <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'Hello, world!'</code><code class="p">);</code>
<code class="p">});</code></pre>
           <p>Routes have easy parameter matching:</p>
           <a id="I_programlisting5_id324041"></a>
           <pre class="programlisting"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/:name'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
  <code class="kd">var</code> <code class="nx">name</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>

  <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Hello, '</code> <code class="o">+</code> <code class="nx">name</code><code class="p">);</code>
<code class="p">});</code></pre>
           <p>A route can be a regular expression:</p>
           <a id="I_programlisting5_id324053"></a>
           <pre class="programlisting"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="sr">/(Hugh|Kevin)/</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">name</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code> <code class="c1">// Whitelisted user</code>
    <code class="nx">output</code><code class="p">;</code>

  <code class="c1">// Write something to output...</code>

  <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Hello, '</code> <code class="o">+</code> <code class="nx">name</code><code class="p">);</code>
<code class="p">});</code></pre>
          </div>
          <div class="sect3" title="Middleware">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="middleware">Middleware</h4>
             </div>
            </div>
           </div>
           <p>Middleware is software <a id="mi5.2.1.8" class="indexterm"></a><a id="ex5.2.1.8" class="indexterm"></a>that takes an incoming request, processes it, and passes it on to the next piece of middleware in the chain. Express middleware takes the form:</p>
           <a id="I_programlisting5_id324099"></a>
           <pre class="programlisting"><code class="c1">// Add some data to the request object that your other</code>
<code class="c1">// middleware and routes can use.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">req</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="s1">'bar'</code><code class="p">;</code>
  <code class="nx">next</code><code class="p">();</code>
<code class="p">});</code></pre>
           <p>Here’s how it works in the context of an Express server:</p>
           <a id="I_programlisting5_id324111"></a>
           <pre class="programlisting"><code class="s1">'use strict'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">),</code>

  <code class="c1">// Create app instance.</code>
  <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">(),</code>

  <code class="c1">// Use the `PORT` environment variable, or port 44444</code>
  <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">44444</code><code class="p">;</code>

<code class="c1">// The new middleware adds the property `foo` to the request</code>
<code class="c1">// object and sets it to 'bar'.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">req</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="s1">'bar'</code><code class="p">;</code>
  <code class="nx">next</code><code class="p">();</code>
<code class="p">});</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">setHeader</code><code class="p">(</code><code class="s1">'Content-Type'</code><code class="p">,</code> <code class="s1">'text/plain'</code><code class="p">);</code>

  <code class="c1">// Send the value passed from the middleware, above.</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">foo</code><code class="p">);</code>
<code class="p">});</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Listening on port '</code> <code class="o">+</code> <code class="nx">port</code><code class="p">);</code>
<code class="p">});</code></pre>
           <p>Point a browser at the new server, or just use <code class="literal">curl</code>:</p>
           <a id="I_programlisting5_id324130"></a>
           <pre class="programlisting"><code class="gp">$</code> curl http://localhost:44444/
<code class="go">bar</code></pre>
           <p>Handling errors is just as <a id="er5.2.1.8" class="indexterm"></a><a id="I_indexterm5_id324153" class="indexterm"></a>simple. Again, you’ll use middleware:</p>
           <a id="I_programlisting5_id324165"></a>
           <pre class="programlisting"><code class="s1">'use strict'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">),</code>

  <code class="c1">// Create app instance.</code>
  <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">(),</code>

  <code class="c1">// Use the `PORT` environment variable, or port 44444</code>
  <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">44444</code><code class="p">;</code>

<code class="c1">// Some middleware that produces an error:</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">request</code><code class="p">,</code> <code class="nx">response</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">bar</code><code class="p">;</code>

  <code class="k">try</code> <code class="p">{</code>

    <code class="c1">// This will throw because `foo` is undefined.</code>
    <code class="nx">request</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="nx">foo</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'bar'</code><code class="p">);</code>

  <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>

    <code class="c1">// Pass the error to the next error handler in the</code>
    <code class="c1">// middleware chain. If you forget `return` here,</code>
    <code class="c1">// it will continue to process the rest of the</code>
    <code class="c1">// function, and probably throw an unhandled exception.</code>

    <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="c1">// Do something with bar.</code>
<code class="p">});</code>

<code class="c1">// Tell express to process routes before it gets to the error handler.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">router</code><code class="p">);</code>


<code class="c1">// Error handlers take four parameters. The first is the error.</code>
<code class="c1">// Generally, you'll want to add your error handler to the bottom of</code>
<code class="c1">// your app.use() stack.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">request</code><code class="p">,</code> <code class="nx">response</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// Log the error.</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>

  <code class="c1">// Send the user a friendly message:</code>
  <code class="nx">response</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">500</code><code class="p">,</code> <code class="s1">'Your request was not handled successfully. '</code> <code class="o">+</code>
    <code class="s1">'Our smartest fix-it guy has already been alerted. '</code> <code class="o">+</code>
    <code class="s1">'Contact us if you need help.'</code><code class="p">);</code>

  <code class="c1">// Use setTimeout to give the app time to log and clean up,</code>
  <code class="c1">// but shut down ASAP to avoid unintended behavior.</code>
  <code class="c1">// Could also use setImmediate() in recent versions of Node.</code>
  <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">process</code><code class="p">.</code><code class="nx">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
  <code class="p">},</code> <code class="mi">0</code><code class="p">);</code>

<code class="p">});</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">setHeader</code><code class="p">(</code><code class="s1">'Content-Type'</code><code class="p">,</code> <code class="s1">'text/plain'</code><code class="p">);</code>

  <code class="c1">// Sadly, nobody will ever see this friendly greeting.</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'Hello, world!'</code><code class="p">);</code>
<code class="p">});</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Listening on port '</code> <code class="o">+</code> <code class="nx">port</code><code class="p">);</code>
<code class="p">});</code></pre>
           <p>You can clean up after a lot of errors. In fact, sometimes an error is an expected probability. For example, there’s a chance that sometimes remote services won’t be available, and you can recover from that condition and try again later. However, sometimes you just won’t get the answer you’re looking for and there’s nothing you can do to recover. You don’t want to keep your server running with undefined state. In the case of errors that you can’t easily recover from, it’s important to shut down the process as quickly as possible.</p>
           <div class="sect4" title="Let it crash">
            <div class="titlepage">
             <div>
              <div>
               <h5 class="title" id="let-it-crash">Let it crash</h5>
              </div>
             </div>
            </div>
            <p>Processes crash. Like all things, your server’s runtime will expire. Don’t sweat it. Log the error, shut down the server, and launch a new instance. You can use Node’s cluster module, forever (a Node module available on npm), or a wide range of other server monitor utilities to detect crashes and repair the service in order to keep things running smoothly, even in the face of unexpected <a id="I_indexterm5_id324208" class="indexterm"></a><a id="I_indexterm5_id324216" class="indexterm"></a><a id="I_indexterm5_id324225" class="indexterm"></a>exceptions.</p>
           </div>
          </div>
          <div class="sect3" title="Templates">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="templates">Templates</h4>
             </div>
            </div>
           </div>
           <p>Express <a id="I_indexterm5_id324247" class="indexterm"></a><a id="I_indexterm5_id324256" class="indexterm"></a>comes with some built-in handling of templates, but it must be configured. You have to tell Express which view engine to use in order to process templates, and where to find the views. First, you’ll want to require your template engine. For Mustache templates, you can use Hogan:</p>
           <a id="I_programlisting5_id324269"></a>
           <pre class="programlisting"><code class="kd">var</code> <code class="nx">hulk</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'hulk-hogan'</code><code class="p">);</code></pre>
           <p>Most of the settings for Express are specified with <code class="literal">app.set()</code>. You’ll need to use it to configure Express to use the template engine of your choice. There are four options that you should be aware of:</p>
           <a id="I_programlisting5_id324287"></a>
           <pre class="programlisting"><code class="c1">// Tell express where to find your templates.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'views'</code><code class="p">,</code> <code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/views'</code><code class="p">);</code>

<code class="c1">// By default, Express will use a generic HTML wrapper (a layout)</code>
<code class="c1">// to render all your pages. If you don't need that, turn it off.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view options'</code><code class="p">,</code> <code class="p">{</code><code class="nx">layout</code><code class="o">:</code> <code class="kc">false</code><code class="p">});</code>

<code class="c1">// Tell express which engine to use.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'hulk-hogan'</code><code class="p">);</code>

<code class="c1">// Specify the extension you'll use for your views.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">engine</code><code class="p">(</code><code class="s1">'.html'</code><code class="p">,</code> <code class="nx">hulk</code><code class="p">.</code><code class="nx">__express</code><code class="p">);</code></pre>
           <p>Remember to define a route that uses your new view. Assuming you’ve used your middleware to build a data object on the request object called <code class="literal">req.data</code> (see <a class="xref" href="ch05.html#middleware" title="Middleware">Middleware</a>):</p>
           <a id="I_programlisting5_id324312"></a>
           <pre class="programlisting"><code class="nx">app</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'index'</code><code class="p">,</code> <code class="nx">req</code><code class="p">.</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">callback</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">html</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Handle error.</code>
  <code class="p">});</code>
<code class="p">});</code></pre>
           <p>You can leave off the callback parameter and any errors will be internally passed via <code class="literal">next(err)</code> for your generic error handlers to catch. If you pass the callback, that automatic error handling will not occur, and you should handle the error explicitly.</p>
          </div>
          <div class="sect3" title="Next steps">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="next-steps">Next steps</h4>
             </div>
            </div>
           </div>
           <p>Of course, you <a id="I_indexterm5_id324342" class="indexterm"></a>want to do a lot more with your app than return a hard-coded message to your users. The good news is that there are drivers for just about any database you can dream of. You can use a variety of template libraries, and of course, serve static files. I encourage you to dive into the Node module playground and take a look around. For starters, here’s a simple static file server example using the built-in static middleware:</p>
           <a id="I_programlisting5_id324357"></a>
           <pre class="programlisting"><code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">),</code>

    <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">(),</code> <code class="c1">// Create the express app.</code>

    <code class="c1">// Try pulling the port from the environment. Or</code>
    <code class="c1">// default to 5555 if no environment variable is set.</code>
    <code class="nx">port</code> <code class="o">=</code> <code class="o">+</code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">5555</code><code class="p">;</code>

<code class="c1">// .bodyParser() parses the request body and creates the</code>
<code class="c1">// req.body object.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">express</code><code class="p">.</code><code class="nx">bodyParser</code><code class="p">()</code> <code class="p">);</code>

<code class="c1">// .methodOverride() lets you simulate DELETE and PUT</code>
<code class="c1">// methods with POST methods. Common boilerplate.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">express</code><code class="p">.</code><code class="nx">methodOverride</code><code class="p">()</code> <code class="p">);</code>

<code class="c1">// .static() creates a static file server, which looks for</code>
<code class="c1">// assets in the /public directory, in this case.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/public'</code><code class="p">)</code> <code class="p">);</code>

<code class="c1">// app.router handles path routing for express apps.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">app</code><code class="p">.</code><code class="nx">router</code> <code class="p">);</code>

<code class="c1">// Express comes with a default error handler that is</code>
<code class="c1">// intended for development use. You'll want to implement</code>
<code class="c1">// your own for production systems.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">express</code><code class="p">.</code><code class="nx">errorHandler</code><code class="p">()</code> <code class="p">);</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Server listening on port '</code> <code class="o">+</code> <code class="nx">port</code><code class="p">);</code>
<code class="p">});</code></pre>
           <p>Have a look at the <a class="ulink" href="http://expressjs.com/guide.html" target="_top">Express guide</a> and <a class="ulink" href="http://expressjs.com/api.html" target="_top">API reference</a> for a lot more useful examples, and the <a class="ulink" href="http://nodejs.org/api/" target="_top">Node manual</a> for Node API documentation. There are lots of useful gems that you’ll want to learn more <a id="I_indexterm5_id324402" class="indexterm"></a><a id="I_indexterm5_id324410" class="indexterm"></a>about.</p>
          </div>
         </div>
        </div>
        <div class="sect1" title="Conclusion">
         <div class="titlepage">
          <div>
           <div>
            <h2 class="title" style="clear: both" id="I_sect15_id324424">Conclusion</h2>
           </div>
          </div>
         </div>
         <p>The key takeaways you should internalize from this chapter are:</p>
         <div class="itemizedlist">
          <ul class="itemizedlist">
           <li class="listitem"><p>Think of your application in terms of layers of responsibility.</p></li>
           <li class="listitem"><p>Let layer separations inform your decisions about what should be included in each application tier.</p></li>
           <li class="listitem"><p>Think about the relationships between modules, layers, and tiers in your application. How will you organize them?</p></li>
           <li class="listitem"><p>Be aware when you’re passing information between different layers. Which messaging patterns will be most effective for communication?</p></li>
           <li class="listitem"><p>Minimize intermodule and interlayer coupling. Use patterns like event emitters and facades to reduce the impact to dependent layers when you change something in another layer.</p></li>
           <li class="listitem"><p>Maintain separation between your domain layer (data/business logic) and your presentation layer.</p></li>
          </ul>
         </div>
         <p>You should be aware by now why it’s important to separate different layers of responsibility into different application modules and tiers, and now that you’ve seen some tools and examples, you should be able to decide when and where to apply various techniques to you own applications.</p>
         <p>The next few chapters will cover some concerns that almost every application needs to deal with at some point. For each one, try to keep in mind how the functionality being described can be implemented without intermingling user interface logic with the business <a id="I_indexterm5_id324493" class="indexterm"></a>domain.</p>
        </div>
       </section>
      </div> 
     </div> 
     <section class="t-bottom-cta bottom-cta bottom-cta-book free-chapter"> 
      <h2> With Safari, you learn the way you learn best. Get unlimited access to videos, live online training, learning paths, books, interactive tutorials, and more. </h2> 
      <div class="controls"> 
       <a href="/public/free-trial/?fa=True&amp;cl=/library/view/programming-javascript-applications/9781491950289/ch05.html" class="button" data-ga-label="Bottom CTA">Start Free Trial</a> 
       <p>No credit card required</p> 
      </div> 
     </section> 
    </div> 
   </section> 
  </section> 
  <footer class="anybird-footer"> 
   <nav class="grid"> 
    <ul class="footer-nav col"> 
     <li><a href="/explore/"><span>Explore</span></a></li> 
     <li><a href="/our-library/"><span>Tour</span></a></li> 
     <li><a href="/pricing/"><span>Pricing</span></a></li> 
     <li><a href="/enterprise/"><span>Enterprise</span></a></li> 
     <li><a href="/government/"><span>Government</span></a></li> 
     <li><a href="/academic-public-library/"><span>Education</span></a></li> 
     <li><a href="/your-experience/#queue"><span>Queue App</span></a></li> 
    </ul> 
    <ul class="footer-contact col"> 
     <li><a href="/learn/"><span>Learn</span></a></li> 
     <li><a href="/blog/"><span>Blog</span></a></li> 
     <li><a href="/contact/"><span>Contact</span></a></li> 
     <li><a href="/careers/"><span>Careers</span></a></li> 
     <li><a href="/press-resources/"><span>Press Resources</span></a></li> 
     <li><a href="/public/support/"><span>Support</span></a></li> 
    </ul> 
    <ul class="footer-social col"> 
     <li id="footer-twitter"><a href="https://twitter.com/safari"><span>Twitter</span></a></li> 
     <li id="footer-github"><a href="http://github.com/safarijv"><span>GitHub</span></a></li> 
     <li id="footer-facebook"><a href="http://www.facebook.com/safaribooksonline"><span>Facebook</span></a></li> 
     <li id="footer-linkedin"><a href="https://www.linkedin.com/company/safari-books-online"><span>LinkedIn</span></a></li> 
    </ul> 
    <ul class="footer-legal col"> 
     <li><a href="/terms/"><span>Terms of Service</span></a></li> 
     <li><a href="/membership-agreement/"><span>Membership Agreement</span></a></li> 
     <li><a href="/privacy/"><span>Privacy Policy</span></a></li> 
    </ul> 
   </nav> 
   <div class="footer-copyright">
     Copyright © 2017 Safari Books Online. 
   </div> 
  </footer> 
  <script>
  var g = {
    
    position_cache: {},
    title: "Programming JavaScript Applications",
    author_list: "Eric Elliott",
    format: "book",
    source: "application/epub+zip",
    is_system_book: true,
    is_public: true,
    loaded_from_server: true,
    allow_scripts: false,
    has_mathml: false
    
  };
</script> 
  <script type="text/javascript" src="/library/view/static/CACHE/js/e5475d26c7d7.js"></script> 
  <noscript> 
   <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P4V6Z" height="0" width="0" style="display:none;visibility:hidden"> </iframe> 
  </noscript> 
  <script async defer src="/library/view/pageview.js"></script> 
  <script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","queueTime":0,"licenseKey":"510f1a6865","agent":"","transactionName":"YgdaZ0NSW0cEB0RdWltNfkZfUEFdCgofVVtMAFFBVR1DXQATQw5GVA9IX1RsQ10AEw==","applicationID":"10402228","errorBeacon":"bam.nr-data.net","applicationTime":701}</script>   
 </body>
</html>