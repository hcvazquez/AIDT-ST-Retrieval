<!doctype html>
<!--[if lt IE 10]><html class="no-js ie8 oldie" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#"

  
    itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-offline-url="/"
data-url="/library/view/test-driven-development-with/9781449365141/ch15.html"
data-archive="9781449365141"
data-publishers="O&#39;Reilly Media, Inc."


  data-htmlfile-name="ch15.html"
  data-epub-title="Test-Driven Development with Python"
  


data-debug="0" ><![endif]-->
<!--[if gt IE 9]><!-->
<html class="no-js" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope itemtype="http://schema.org/Book http://schema.org/ItemPage" data-offline-url="/" data-url="/library/view/test-driven-development-with/9781449365141/ch15.html" data-archive="9781449365141" data-publishers="O'Reilly Media, Inc." data-htmlfile-name="ch15.html" data-epub-title="Test-Driven Development with Python" data-debug="0">
 <!--<![endif]-->
 <head> 
  <meta charset="UTF-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <title>15. User Authentication, Integrating Third-Party Plugins, and Mocking with JavaScript - Test-Driven Development with Python [Book]</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <link rel="stylesheet" href="/library/view/static/CACHE/css/263a54664f8a.css" type="text/css"> 
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet" type="text/css"> 
  <meta property="og:title" content="15. User Authentication, Integrating Third-Party Plugins, and Mocking with JavaScript [Book]"> 
  <meta itemprop="isPartOf" content="/library/view/test-driven-development-with/9781449365141/"> 
  <meta itemprop="name" content="15. User Authentication, Integrating Third-Party Plugins, and Mocking with JavaScript"> 
  <meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/test-driven-development-with/9781449365141/ch15.html"> 
  <meta property="og:site_name" content="Safari"> 
  <meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781449365141/"> 
  <meta property="og:description" itemprop="description" name="description" content="Chapter&nbsp;15.&nbsp;User Authentication, Integrating Third-Party Plugins, and Mocking with JavaScript Our beautiful lists site has been live for a few days, and our users are starting to come back ...  - Selection from Test-Driven Development with Python [Book]"> 
  <meta itemprop="inLanguage" content="en"> 
  <meta itemprop="publisher" content="O'Reilly Media, Inc."> 
  <meta property="og:type" content="book"> 
  <meta property="og:book:isbn" itemprop="isbn" content="9781449364823"> 
  <meta property="og:book:author" itemprop="author" content="Harry J.W. Percival"> 
  <meta property="og:book:tag" itemprop="about" content="Python"> 
  <meta name="twitter:card" content="summary"> 
  <meta name="twitter:site" content="@safari"> 
  <!-- Start Visual Website Optimizer Asynchronous Code --> 
  <script type="text/javascript">
var _vwo_code=(function(){
var account_id=291788,
settings_tolerance=2000,
library_tolerance=2500,
use_existing_jquery=false,
/* DO NOT EDIT BELOW THIS LINE */
f=false,d=document;return{use_existing_jquery:function(){return use_existing_jquery;},library_tolerance:function(){return library_tolerance;},finish:function(){if(!f){f=true;var a=d.getElementById('_vis_opt_path_hides');if(a)a.parentNode.removeChild(a);}},finished:function(){return f;},load:function(a){var b=d.createElement('script');b.src=a;b.type='text/javascript';b.innerText;b.onerror=function(){_vwo_code.finish();};d.getElementsByTagName('head')[0].appendChild(b);},init:function(){settings_timer=setTimeout('_vwo_code.finish()',settings_tolerance);var a=d.createElement('style'),b='body{opacity:0 !important;filter:alpha(opacity=0) !important;background:none !important;}',h=d.getElementsByTagName('head')[0];a.setAttribute('id','_vis_opt_path_hides');a.setAttribute('type','text/css');if(a.styleSheet)a.styleSheet.cssText=b;else a.appendChild(d.createTextNode(b));h.appendChild(a);this.load('//dev.visualwebsiteoptimizer.com/j.php?a='+account_id+'&u='+encodeURIComponent(d.URL)+'&r='+Math.random());return settings_timer;}};}());_vwo_settings_timer=_vwo_code.init();
</script> 
  <!-- End Visual Website Optimizer Asynchronous Code --> 
  <link rel="shortcut icon" href="//www.safaribooksonline.com/favicon.ico" type="image/vnd.microsoft.icon"> 
  <link rel="apple-touch-icon" href="//www.safaribooksonline.com/static/corp/img/apple-touch-icon.png"> 
  <style type="text/css" title="ibis-book">
    @charset "utf-8";#sbo-rt-content html,#sbo-rt-content div,#sbo-rt-content div,#sbo-rt-content span,#sbo-rt-content applet,#sbo-rt-content object,#sbo-rt-content iframe,#sbo-rt-content h1,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5,#sbo-rt-content h6,#sbo-rt-content p,#sbo-rt-content blockquote,#sbo-rt-content pre,#sbo-rt-content a,#sbo-rt-content abbr,#sbo-rt-content acronym,#sbo-rt-content address,#sbo-rt-content big,#sbo-rt-content cite,#sbo-rt-content code,#sbo-rt-content del,#sbo-rt-content dfn,#sbo-rt-content em,#sbo-rt-content font,#sbo-rt-content img,#sbo-rt-content ins,#sbo-rt-content kbd,#sbo-rt-content q,#sbo-rt-content s,#sbo-rt-content samp,#sbo-rt-content small,#sbo-rt-content strike,#sbo-rt-content strong,#sbo-rt-content sub,#sbo-rt-content sup,#sbo-rt-content tt,#sbo-rt-content var,#sbo-rt-content b,#sbo-rt-content u,#sbo-rt-content i,#sbo-rt-content center,#sbo-rt-content dl,#sbo-rt-content dt,#sbo-rt-content dd,#sbo-rt-content ol,#sbo-rt-content ul,#sbo-rt-content li,#sbo-rt-content fieldset,#sbo-rt-content form,#sbo-rt-content label,#sbo-rt-content legend,#sbo-rt-content table,#sbo-rt-content caption,#sbo-rt-content tdiv,#sbo-rt-content tfoot,#sbo-rt-content thead,#sbo-rt-content tr,#sbo-rt-content th,#sbo-rt-content td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}@page{margin:5px !important}#sbo-rt-content p{margin:8px 0 0;line-height:125%;text-align:left}#sbo-rt-content em{font-style:italic;font-family:inherit}#sbo-rt-content em.replaceable{font-style:italic}#sbo-rt-content em strong,#sbo-rt-content strong em{font-weight:bold;font-style:italic;font-family:inherit}#sbo-rt-content strong.userinput{font-weight:bold;font-style:normal}#sbo-rt-content span.bolditalic{font-weight:bold;font-style:italic}#sbo-rt-content strong,#sbo-rt-content span.bold{font-weight:bold}#sbo-rt-content a.ulink,#sbo-rt-content a.xref,#sbo-rt-content a.email,#sbo-rt-content a.link{text-decoration:none;color:#8e0012}#sbo-rt-content sup{font-size:x-small;vertical-align:super}#sbo-rt-content sub{font-size:smaller;vertical-align:sub}#sbo-rt-content span.lineannotation{font-style:italic;color:#A62A2A;font-family:serif,"DejaVuSerif"}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content span.strikethrough{text-decoration:line-through}#sbo-rt-content span.smallcaps{font-variant:small-caps}#sbo-rt-content span.cursor{background:#000;color:#FFF}#sbo-rt-content span.smaller{font-size:75%}#sbo-rt-content .boxedtext,#sbo-rt-content .keycap{border-style:solid;border-width:1px;border-color:#000;padding:1px}#sbo-rt-content span.gray50{color:#7F7F7F;}#sbo-rt-content .gray-background,#sbo-rt-content .reverse-video{background:#2E2E2E;color:#FFF}#sbo-rt-content .light-gray-background{background:#A0A0A0}#sbo-rt-content .preserve-whitespace{white-space:pre-wrap}#sbo-rt-content h1,#sbo-rt-content div.toc-title,#sbo-rt-content h2,#sbo-rt-content h3,#sbo-rt-content h4,#sbo-rt-content h5{-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none;font-weight:bold;text-align:left;page-break-after:avoid !important;font-family:sans-serif,"DejaVuSans"}#sbo-rt-content h1,#sbo-rt-content div.toc-title{font-size:1.5em;margin-top:20px !important}#sbo-rt-content h2{font-size:1.3em;color:#8e0012;margin:40px 0 8px 0}#sbo-rt-content h3{font-size:1.1em;margin:30px 0 8px 0 !important}#sbo-rt-content h4{font-size:1em;color:#555;margin:20px 0 8px 0 !important}#sbo-rt-content h5{font-size:1em;font-weight:normal;font-style:italic;margin:15px 0 6px 0 !important}#sbo-rt-content section.chapter div.titlepage,#sbo-rt-content section.appendix div.titlepage,#sbo-rt-content section.preface div.titlepage{page-break-inside:avoid;page-break-after:avoid}#sbo-rt-content section.chapter>div.titlepage,#sbo-rt-content section.preface>div.titlepage,#sbo-rt-content section.appendix>div.titlepage{margin-bottom:50px}#sbo-rt-content section.chapter>div.titlepage h2.title,#sbo-rt-content section.preface>div.titlepage h2.title,#sbo-rt-content section.appendix>div.titlepage h2.title{font-size:2em;line-height:1;margin-bottom:15px;color:#000;padding-bottom:10px;border-bottom:1px solid #000}#sbo-rt-content div.toc-title{margin-bottom:30px !important}#sbo-rt-content div.part h1{font-size:2em;text-align:center;margin-top:0 !important;padding:50px 0 20px 0;border-bottom:1px solid #000}#sbo-rt-content img{max-width:95%;margin:0 auto;padding:0}#sbo-rt-content div.figure{background-color:transparent;text-align:center;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;padding:15px 5px 15px 5px !important;margin:30px 0 30px 0 !important;max-height:100%;page-break-inside:avoid}#sbo-rt-content div.figure-title,#sbo-rt-content div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.informalfigure{text-align:center;padding:5px 0 !important}#sbo-rt-content div.sidebar{margin:30px 0 20px 0 !important;-webkit-border-radius:5px;border-radius:5px;border:1px solid #DCDCDC;background-color:#F7F7F7;font-size:90%;padding:15px !important;page-break-inside:avoid}#sbo-rt-content div.sidebar-title{font-weight:bold;font-size:1em;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px 0 !important;page-break-inside:avoid}#sbo-rt-content div.sidebar div.figure p.title,#sbo-rt-content div.sidebar div.informalfigure div.caption{font-size:90%;text-align:center;font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";color:#000;padding:5px !important;page-break-before:avoid;page-break-after:avoid}#sbo-rt-content div.sidebar ol{margin-left:15px}#sbo-rt-content div.sidebar div.tip,#sbo-rt-content div.sidebar div.note,#sbo-rt-content div.sidebar div.warning,#sbo-rt-content div.sidebar div.caution,#sbo-rt-content div.sidebar div.important{margin:20px auto 20px auto !important;font-size:90%;width:85%}#sbo-rt-content div.sidebar div.figure{border:none}#sbo-rt-content pre{white-space:pre-wrap;font-family:"Ubuntu Mono",monospace;margin:25px 0 25px 20px;font-size:85%;display:block;-webkit-hyphens:none;hyphens:none;adobe-hyphenate:none}#sbo-rt-content div.note pre.programlisting,#sbo-rt-content div.tip pre.programlisting,#sbo-rt-content div.warning pre.programlisting,#sbo-rt-content div.caution pre.programlisting,#sbo-rt-content div.important pre.programlisting{margin-bottom:0}#sbo-rt-content code{font-family:"Ubuntu Mono",monospace}#sbo-rt-content code strong em,#sbo-rt-content code em strong,#sbo-rt-content pre em strong,#sbo-rt-content pre strong em,#sbo-rt-content strong code em code,#sbo-rt-content em code strong code,#sbo-rt-content span.bolditalic code{font-weight:bold;font-style:italic;font-family:"Ubuntu Mono BoldItal",monospace}#sbo-rt-content code em,#sbo-rt-content em code,#sbo-rt-content pre em,#sbo-rt-content em.replaceable{font-family:"Ubuntu Mono Ital",monospace;font-style:italic}#sbo-rt-content code strong,#sbo-rt-content strong code,#sbo-rt-content pre strong,#sbo-rt-content strong.userinput{font-family:"Ubuntu Mono Bold",monospace;font-weight:bold}#sbo-rt-content div.example{margin:10px 0 15px 0 !important}#sbo-rt-content div.example-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:10px 0 5px 0 !important;border-bottom:1px solid #000}#sbo-rt-content li pre.example{padding:10px 0 !important}#sbo-rt-content div.example-contents pre.programlisting,#sbo-rt-content div.example-contents pre.screen{margin:0}#sbo-rt-content span.gray{color:#4C4C4C}#sbo-rt-content div.book div.titlepage h1.title{font-size:3em;font-family:sans-serif,"DejaVuSans";font-weight:bold;margin:50px 0 10px 0 !important;line-height:1;text-align:center}#sbo-rt-content div.book div.titlepage h2.subtitle{text-align:center;color:#000;margin:0 !important;font-style:italic;font-family:serif;font-size:1.5em}#sbo-rt-content div.book div.titlepage div.author h3{font-size:2em;font-family:sans-serif,"DejaVuSans";font-weight:bold;color:#8e0012;margin:50px 0 !important;text-align:center}#sbo-rt-content div.book div.titlepage div.publishername{margin-top:60%;margin-bottom:20px;text-align:center;font-size:1.25em}#sbo-rt-content div.book div.titlepage div.locations p{margin:0;text-align:center}#sbo-rt-content div.book div.titlepage div.locations p.cities{font-size:80%;text-align:center;margin-top:5px}#sbo-rt-content section.preface[title="Dedication"]>div.titlepage h2.title{text-align:center;text-transform:uppercase;font-size:1.5em;margin-top:50px;margin-bottom:50px}#sbo-rt-content section.preface[title="Dedication"] p{font-style:italic;text-align:center}#sbo-rt-content div.colophon h1.title{font-size:1.3em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon h2.subtitle{margin:0 !important;color:#000;font-family:serif,"DejaVuSerif";font-size:1em;font-weight:normal}#sbo-rt-content div.colophon div.author h3.author{font-size:1.1em;font-family:serif,"DejaVuSerif";margin:10px 0 0 !important;font-weight:normal}#sbo-rt-content div.colophon div.editor h4,#sbo-rt-content div.colophon div.editor h3.editor{color:#000;font-size:.8em;margin:15px 0 0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.editor h3.editor{font-size:.8em;margin:0 !important;font-family:serif,"DejaVuSerif";font-weight:normal}#sbo-rt-content div.colophon div.publisher{margin-top:10px}#sbo-rt-content div.colophon div.publisher p,#sbo-rt-content div.colophon div.publisher span.publishername{margin:0;font-size:.8em}#sbo-rt-content div.legalnotice p,#sbo-rt-content div.timestamp p{font-size:.8em}#sbo-rt-content div.timestamp p{margin-top:10pt}#sbo-rt-content div.colophon[title="About the Author"] h1.title,#sbo-rt-content div.colophon[title="Colophon"] h1.title{font-size:1.5em;margin:0 !important;font-family:sans-serif,"DejaVuSans";font-weight:bold}#sbo-rt-content section.chapter div.titlepage div.author{margin:10px 0 10px 0}#sbo-rt-content section.chapter div.titlepage div.author div.affiliation{font-style:italic}#sbo-rt-content div.attribution{margin:5px 0 0 50px !important}#sbo-rt-content h3.author span.orgname{display:none}#sbo-rt-content div.epigraph{margin:10px 0 10px 20px !important;page-break-inside:avoid;font-size:90%}#sbo-rt-content div.epigraph p{font-style:italic}#sbo-rt-content blockquote,#sbo-rt-content div.blockquote{margin:10px !important;page-break-inside:avoid;font-size:95%}#sbo-rt-content blockquote p,#sbo-rt-content div.blockquote p{font-family:serif,"DejaVuSerif";font-style:italic}#sbo-rt-content blockquote div.attribution{margin:5px 0 0 30px !important;text-align:right;width:80%}#sbo-rt-content blockquote div.attribution p{font-style:normal}#sbo-rt-content p.right{text-align:right;margin:0}#sbo-rt-content div.footnote{font-size:90%}#sbo-rt-content div.refnamediv h2,#sbo-rt-content div.refnamediv h3,#sbo-rt-content div.refsynopsisdiv h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refentry div.refsect1 h2{font-size:1.1em;color:#000;margin-top:15px !important;margin-bottom:0 !important}#sbo-rt-content div.refsect2 h3{font-size:1em;color:#000;margin-top:10px !important;margin-bottom:0 !important}#sbo-rt-content div.refnamediv p{margin-left:15px !important}#sbo-rt-content dt{padding-top:10px !important;padding-bottom:0 !important}#sbo-rt-content dt span.term{font-weight:bold;font-style:italic}#sbo-rt-content dt span.term code.literal{font-style:normal;font-weight:normal}#sbo-rt-content dt span.term em code.literal{font-style:italic}#sbo-rt-content dd{margin-left:1.5em !important}#sbo-rt-content dd,#sbo-rt-content li{text-align:left}#sbo-rt-content ol{list-style-type:decimal;margin-top:8px !important;margin-bottom:8px !important;margin-left:20px !important;padding-left:25px !important}#sbo-rt-content ol ol{list-style-type:lower-alpha}#sbo-rt-content ol ol ol{list-style-type:lower-roman}#sbo-rt-content ul{list-style-type:square;margin-top:8px !important;margin-bottom:8px !important;margin-left:5px !important;padding-left:20px !important}#sbo-rt-content ul ul{list-style-type:none;padding-left:0 !important;margin-left:0 !important}#sbo-rt-content ol li,#sbo-rt-content ul li,#sbo-rt-content dd{margin-bottom:1em}#sbo-rt-content ul ul li p:before{content:"— "}#sbo-rt-content ul ul ul li p:before{content:""}#sbo-rt-content ul ul ul{list-style-type:square;margin-left:20px !important;padding-left:30px !important}#sbo-rt-content div.orderedlistalpha{list-style-type:upper-alpha}#sbo-rt-content table.simplelist{margin-left:20px !important;margin-bottom:10px}#sbo-rt-content table.simplelist td{border:none;font-size:90%}#sbo-rt-content table.simplelist tr{border-bottom:none}#sbo-rt-content table.simplelist tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.calloutlist p:first-child{margin-top:-25px !important}#sbo-rt-content div.calloutlist dd{padding-left:0;margin-top:-25px}#sbo-rt-content div.calloutlist img{padding:0}#sbo-rt-content a.co img{padding:0}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist{margin-top:25pt}#sbo-rt-content div.calloutlist>dl>dd>div.orderedlist>ol.orderedlist>li{margin-bottom:25pt}#sbo-rt-content div.toc ol{margin-top:8px !important;margin-bottom:8px !important;margin-left:0 !important;padding-left:0 !important}#sbo-rt-content div.toc ol ol{margin-left:30px !important;padding-left:0 !important}#sbo-rt-content div.toc ol li{list-style-type:none}#sbo-rt-content div.toc a{color:#8e0012}#sbo-rt-content div.toc ol a{font-size:1em;font-weight:bold}#sbo-rt-content div.toc ol>li>ol a{font-weight:bold;font-size:1em}#sbo-rt-content div.toc ol>li>ol>li>ol a{text-decoration:none;font-weight:normal;font-size:1em}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.warning,#sbo-rt-content div.caution,#sbo-rt-content div.important{margin:30px !important;-webkit-border-radius:5px;border-radius:5px;font-size:90%;padding:10px 8px 20px 8px !important;page-break-inside:avoid}#sbo-rt-content div.tip,#sbo-rt-content div.note,#sbo-rt-content div.important{border:1px solid #BEBEBE;background-color:transparent}#sbo-rt-content div.warning,#sbo-rt-content div.caution{border:1px solid #BC8F8F}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3,#sbo-rt-content div.important h3{font:bold 90%;font-family:sans-serif,"DejaVuSans";text-transform:uppercase;letter-spacing:1px;text-align:center;margin:4px 0 6px !important}#sbo-rt-content div.tip h3,#sbo-rt-content div.note h3,#sbo-rt-content div.important h3{color:#737373}#sbo-rt-content div.warning h3,#sbo-rt-content div.caution h3{color:#C67171}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note{background-color:transparent;margin:8px 0 0 !important;border:0 solid #BEBEBE;-webkit-border-radius:0;border-radius:0;font-size:100%;padding:0 !important;page-break-inside:avoid}#sbo-rt-content div.sect1[title="Safari® Books Online"] div.note h3{display:none}#sbo-rt-content div.table,#sbo-rt-content table{margin:15px auto 30px auto !important;max-width:95%;border-collapse:collapse;border-spacing:0}#sbo-rt-content div.table,#sbo-rt-content div.informaltable{page-break-inside:avoid}#sbo-rt-content tr{border-bottom:1px solid #c3c3c3}#sbo-rt-content thead td{border-bottom:#9d9d9d 1px solid !important;border-top:#9d9d9d 1px solid !important}#sbo-rt-content tr:nth-of-type(even){background-color:#f1f6fc}#sbo-rt-content thead{font-family:sans-serif,"DejaVuSans";color:#000;font-weight:bold}#sbo-rt-content td{padding:.3em;text-align:left;vertical-align:baseline;font-size:80%}#sbo-rt-content div.informaltable table{margin:10px auto !important}#sbo-rt-content div.informaltable table tr{border-bottom:none}#sbo-rt-content div.informaltable table tr:nth-of-type(even){background-color:transparent}#sbo-rt-content div.informaltable td,#sbo-rt-content div.informaltable th{border:#9d9d9d 1px solid}#sbo-rt-content div.table-title{font-weight:normal;font-style:italic;font-family:serif,"DejaVuSerif";margin:20px 0 0 0 !important;text-align:center;padding:0}#sbo-rt-content table code{font-size:smaller}#sbo-rt-content div.equation{margin:10px 0 15px 0 !important}#sbo-rt-content div.equation-title{font-style:italic;font-weight:normal;font-family:serif,"DejaVuSerif";margin:20px 0 10px 0 !important;page-break-after:avoid}#sbo-rt-content div.equation-contents{margin-left:20px}#sbo-rt-content span.inlinemediaobject{height:.85em;display:inline-block;margin-bottom:.2em}#sbo-rt-content span.inlinemediaobject img{margin:0;height:.85em}#sbo-rt-content div.informalequation{margin:20px 0 20px 20px;width:75%}#sbo-rt-content div.informalequation img{width:75%}#sbo-rt-content div.index{font-weight:bold}#sbo-rt-content div.index dt{line-height:140%}#sbo-rt-content div.index a.indexterm{color:#8e0012}#sbo-rt-content code.boolean,#sbo-rt-content .navy{color:rgb(0,0,128);}#sbo-rt-content code.character,#sbo-rt-content .olive{color:rgb(128,128,0);}#sbo-rt-content code.comment,#sbo-rt-content .blue{color:rgb(0,0,255);}#sbo-rt-content code.conditional,#sbo-rt-content .limegreen{color:rgb(50,205,50);}#sbo-rt-content code.constant,#sbo-rt-content .darkorange{color:rgb(255,140,0);}#sbo-rt-content code.debug,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.define,#sbo-rt-content .darkgoldenrod,#sbo-rt-content .gold{color:rgb(184,134,11);}#sbo-rt-content code.delimiter,#sbo-rt-content .dimgray{color:rgb(105,105,105);}#sbo-rt-content code.error,#sbo-rt-content .red{color:rgb(255,0,0);}#sbo-rt-content code.exception,#sbo-rt-content .salmon{color:rgb(250,128,11);}#sbo-rt-content code.float,#sbo-rt-content .steelblue{color:rgb(70,130,180);}#sbo-rt-content pre code.function,#sbo-rt-content .green{color:rgb(0,128,0);}#sbo-rt-content code.identifier,#sbo-rt-content .royalblue{color:rgb(65,105,225);}#sbo-rt-content code.ignore,#sbo-rt-content .gray{color:rgb(128,128,128);}#sbo-rt-content code.include,#sbo-rt-content .purple{color:rgb(128,0,128);}#sbo-rt-content code.keyword,#sbo-rt-content .sienna{color:rgb(160,82,45);}#sbo-rt-content code.label,#sbo-rt-content .deeppink{color:rgb(255,20,147);}#sbo-rt-content code.macro,#sbo-rt-content .orangered{color:rgb(255,69,0);}#sbo-rt-content code.number,#sbo-rt-content .brown{color:rgb(165,42,42);}#sbo-rt-content code.operator,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.preCondit,#sbo-rt-content .teal{color:rgb(0,128,128);}#sbo-rt-content code.preProc,#sbo-rt-content .fuschia{color:rgb(255,0,255);}#sbo-rt-content code.repeat,#sbo-rt-content .indigo{color:rgb(75,0,130);}#sbo-rt-content code.special,#sbo-rt-content .saddlebrown{color:rgb(139,69,19);}#sbo-rt-content code.specialchar,#sbo-rt-content .magenta{color:rgb(255,0,255);}#sbo-rt-content code.specialcomment,#sbo-rt-content .seagreen{color:rgb(46,139,87);}#sbo-rt-content code.statement,#sbo-rt-content .forestgreen{color:rgb(34,139,34);}#sbo-rt-content code.storageclass,#sbo-rt-content .plum{color:rgb(221,160,221);}#sbo-rt-content code.string,#sbo-rt-content .darkred{color:rgb(139,0,0);}#sbo-rt-content code.structure,#sbo-rt-content .chocolate{color:rgb(210,106,30);}#sbo-rt-content code.tag,#sbo-rt-content .darkcyan{color:rgb(0,139,139);}#sbo-rt-content code.todo,#sbo-rt-content .black{color:#000;}#sbo-rt-content code.type,#sbo-rt-content .mediumslateblue{color:rgb(123,104,238);}#sbo-rt-content code.typedef,#sbo-rt-content .darkgreen{color:rgb(0,100,0);}#sbo-rt-content code.underlined{text-decoration:underline;}#sbo-rt-content pre code.hll{background-color:#ffc}#sbo-rt-content pre code.c{color:#09F;font-style:italic}#sbo-rt-content pre code.err{color:#A00}#sbo-rt-content pre code.k{color:#069;font-weight:bold}#sbo-rt-content pre code.o{color:#555}#sbo-rt-content pre code.cm{color:#35586C;font-style:italic}#sbo-rt-content pre code.cp{color:#099}#sbo-rt-content pre code.c1{color:#35586C;font-style:italic}#sbo-rt-content pre code.cs{color:#35586C;font-weight:bold;font-style:italic}#sbo-rt-content pre code.gd{background-color:#FCC}#sbo-rt-content pre code.ge{font-style:italic}#sbo-rt-content pre code.gr{color:#F00}#sbo-rt-content pre code.gh{color:#030;font-weight:bold}#sbo-rt-content pre code.gi{background-color:#CFC}#sbo-rt-content pre code.go{color:#000}#sbo-rt-content pre code.gp{color:#009;font-weight:bold}#sbo-rt-content pre code.gs{font-weight:bold}#sbo-rt-content pre code.gu{color:#030;font-weight:bold}#sbo-rt-content pre code.gt{color:#9C6}#sbo-rt-content pre code.kc{color:#069;font-weight:bold}#sbo-rt-content pre code.kd{color:#069;font-weight:bold}#sbo-rt-content pre code.kn{color:#069;font-weight:bold}#sbo-rt-content pre code.kp{color:#069}#sbo-rt-content pre code.kr{color:#069;font-weight:bold}#sbo-rt-content pre code.kt{color:#078;font-weight:bold}#sbo-rt-content pre code.m{color:#F60}#sbo-rt-content pre code.s{color:#C30}#sbo-rt-content pre code.na{color:#309}#sbo-rt-content pre code.nb{color:#366}#sbo-rt-content pre code.nc{color:#0A8;font-weight:bold}#sbo-rt-content pre code.no{color:#360}#sbo-rt-content pre code.nd{color:#99F}#sbo-rt-content pre code.ni{color:#999;font-weight:bold}#sbo-rt-content pre code.ne{color:#C00;font-weight:bold}#sbo-rt-content pre code.nf{color:#C0F}#sbo-rt-content pre code.nl{color:#99F}#sbo-rt-content pre code.nn{color:#0CF;font-weight:bold}#sbo-rt-content pre code.nt{color:#309;font-weight:bold}#sbo-rt-content pre code.nv{color:#033}#sbo-rt-content pre code.ow{color:#000;font-weight:bold}#sbo-rt-content pre code.w{color:#bbb}#sbo-rt-content pre code.mf{color:#F60}#sbo-rt-content pre code.mh{color:#F60}#sbo-rt-content pre code.mi{color:#F60}#sbo-rt-content pre code.mo{color:#F60}#sbo-rt-content pre code.sb{color:#C30}#sbo-rt-content pre code.sc{color:#C30}#sbo-rt-content pre code.sd{color:#C30;font-style:italic}#sbo-rt-content pre code.s2{color:#C30}#sbo-rt-content pre code.se{color:#C30;font-weight:bold}#sbo-rt-content pre code.sh{color:#C30}#sbo-rt-content pre code.si{color:#A00}#sbo-rt-content pre code.sx{color:#C30}#sbo-rt-content pre code.sr{color:#3AA}#sbo-rt-content pre code.s1{color:#C30}#sbo-rt-content pre code.ss{color:#A60}#sbo-rt-content pre code.bp{color:#366}#sbo-rt-content pre code.vc{color:#033}#sbo-rt-content pre code.vg{color:#033}#sbo-rt-content pre code.vi{color:#033}#sbo-rt-content pre code.il{color:#F60}#sbo-rt-content pre code.g{color:#050}#sbo-rt-content pre code.l{color:#C60}#sbo-rt-content pre code.l{color:#F90}#sbo-rt-content pre code.n{color:#008}#sbo-rt-content pre code.nx{color:#008}#sbo-rt-content pre code.py{color:#96F}#sbo-rt-content pre code.p{color:#000}#sbo-rt-content pre code.x{color:#F06}#sbo-rt-content div.blockquote_sampler_toc{width:95%;margin:5px 5px 5px 10px !important}#sbo-rt-content div{font-family:serif,"DejaVuSerif";text-align:left}#sbo-rt-content p.sourcecode{font-family:"DejaVuSerif",serif;font-size:90%;text-align:right;margin-right:5%}#sbo-rt-content p.sourcecode strong{font-weight:normal;font-style:italic}#sbo-rt-content p.sourcecode+pre.programlisting{margin-top:0}
    </style> 
  <style>
    header.global {
      top:26px;
    }
    .orm-topbar {
      width: 100%;
      height: 26px;
      padding: 0 17px;
      line-height: 26px;
      background: #d3002d;
      color: #fff;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9;
      font-size: 13px;
    }
    .orm-topbar svg {
      width: 78px;
      height: 13px;
      fill: #fff;
      vertical-align: middle;
    }
    .orm-topbar span {
      vertical-align: middle;
      float: right;
      color: #fff;
      font-weight: bold;
    }
    .orm-topbar:hover span {
      text-decoration: underline;
    }
    </style> 
  <script type="text/javascript">(window.NREUM||(NREUM={})).loader_config={xpid:"VQQDUVVVGwIAUFFQBQMP"};window.NREUM||(NREUM={}),__nr_require=function(t,n,e){function r(e){if(!n[e]){var o=n[e]={exports:{}};t[e][0].call(o.exports,function(n){var o=t[e][1][n];return r(o||n)},o,o.exports)}return n[e].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<e.length;o++)r(e[o]);return r}({1:[function(t,n,e){function r(t){try{s.console&&console.log(t)}catch(n){}}var o,i=t("ee"),a=t(15),s={};try{o=localStorage.getItem("__nr_flags").split(","),console&&"function"==typeof console.log&&(s.console=!0,o.indexOf("dev")!==-1&&(s.dev=!0),o.indexOf("nr_dev")!==-1&&(s.nrDev=!0))}catch(c){}s.nrDev&&i.on("internal-error",function(t){r(t.stack)}),s.dev&&i.on("fn-err",function(t,n,e){r(e.stack)}),s.dev&&(r("NR AGENT IN DEVELOPMENT MODE"),r("flags: "+a(s,function(t,n){return t}).join(", ")))},{}],2:[function(t,n,e){function r(t,n,e,r,o){try{d?d-=1:i("err",[o||new UncaughtException(t,n,e)])}catch(s){try{i("ierr",[s,c.now(),!0])}catch(u){}}return"function"==typeof f&&f.apply(this,a(arguments))}function UncaughtException(t,n,e){this.message=t||"Uncaught error with no additional information",this.sourceURL=n,this.line=e}function o(t){i("err",[t,c.now()])}var i=t("handle"),a=t(16),s=t("ee"),c=t("loader"),f=window.onerror,u=!1,d=0;c.features.err=!0,t(1),window.onerror=r;try{throw new Error}catch(l){"stack"in l&&(t(8),t(7),"addEventListener"in window&&t(5),c.xhrWrappable&&t(9),u=!0)}s.on("fn-start",function(t,n,e){u&&(d+=1)}),s.on("fn-err",function(t,n,e){u&&(this.thrown=!0,o(e))}),s.on("fn-end",function(){u&&!this.thrown&&d>0&&(d-=1)}),s.on("internal-error",function(t){i("ierr",[t,c.now(),!0])})},{}],3:[function(t,n,e){t("loader").features.ins=!0},{}],4:[function(t,n,e){function r(t){}if(window.performance&&window.performance.timing&&window.performance.getEntriesByType){var o=t("ee"),i=t("handle"),a=t(8),s=t(7),c="learResourceTimings",f="addEventListener",u="resourcetimingbufferfull",d="bstResource",l="resource",p="-start",h="-end",m="fn"+p,w="fn"+h,v="bstTimer",y="pushState",g=t("loader");g.features.stn=!0,t(6);var b=NREUM.o.EV;o.on(m,function(t,n){var e=t[0];e instanceof b&&(this.bstStart=g.now())}),o.on(w,function(t,n){var e=t[0];e instanceof b&&i("bst",[e,n,this.bstStart,g.now()])}),a.on(m,function(t,n,e){this.bstStart=g.now(),this.bstType=e}),a.on(w,function(t,n){i(v,[n,this.bstStart,g.now(),this.bstType])}),s.on(m,function(){this.bstStart=g.now()}),s.on(w,function(t,n){i(v,[n,this.bstStart,g.now(),"requestAnimationFrame"])}),o.on(y+p,function(t){this.time=g.now(),this.startPath=location.pathname+location.hash}),o.on(y+h,function(t){i("bstHist",[location.pathname+location.hash,this.startPath,this.time])}),f in window.performance&&(window.performance["c"+c]?window.performance[f](u,function(t){i(d,[window.performance.getEntriesByType(l)]),window.performance["c"+c]()},!1):window.performance[f]("webkit"+u,function(t){i(d,[window.performance.getEntriesByType(l)]),window.performance["webkitC"+c]()},!1)),document[f]("scroll",r,{passive:!0}),document[f]("keypress",r,!1),document[f]("click",r,!1)}},{}],5:[function(t,n,e){function r(t){for(var n=t;n&&!n.hasOwnProperty(u);)n=Object.getPrototypeOf(n);n&&o(n)}function o(t){s.inPlace(t,[u,d],"-",i)}function i(t,n){return t[1]}var a=t("ee").get("events"),s=t(18)(a,!0),c=t("gos"),f=XMLHttpRequest,u="addEventListener",d="removeEventListener";n.exports=a,"getPrototypeOf"in Object?(r(document),r(window),r(f.prototype)):f.prototype.hasOwnProperty(u)&&(o(window),o(f.prototype)),a.on(u+"-start",function(t,n){var e=t[1],r=c(e,"nr@wrapped",function(){function t(){if("function"==typeof e.handleEvent)return e.handleEvent.apply(e,arguments)}var n={object:t,"function":e}[typeof e];return n?s(n,"fn-",null,n.name||"anonymous"):e});this.wrapped=t[1]=r}),a.on(d+"-start",function(t){t[1]=this.wrapped||t[1]})},{}],6:[function(t,n,e){var r=t("ee").get("history"),o=t(18)(r);n.exports=r,o.inPlace(window.history,["pushState","replaceState"],"-")},{}],7:[function(t,n,e){var r=t("ee").get("raf"),o=t(18)(r),i="equestAnimationFrame";n.exports=r,o.inPlace(window,["r"+i,"mozR"+i,"webkitR"+i,"msR"+i],"raf-"),r.on("raf-start",function(t){t[0]=o(t[0],"fn-")})},{}],8:[function(t,n,e){function r(t,n,e){t[0]=a(t[0],"fn-",null,e)}function o(t,n,e){this.method=e,this.timerDuration=isNaN(t[1])?0:+t[1],t[0]=a(t[0],"fn-",this,e)}var i=t("ee").get("timer"),a=t(18)(i),s="setTimeout",c="setInterval",f="clearTimeout",u="-start",d="-";n.exports=i,a.inPlace(window,[s,"setImmediate"],s+d),a.inPlace(window,[c],c+d),a.inPlace(window,[f,"clearImmediate"],f+d),i.on(c+u,r),i.on(s+u,o)},{}],9:[function(t,n,e){function r(t,n){d.inPlace(n,["onreadystatechange"],"fn-",s)}function o(){var t=this,n=u.context(t);t.readyState>3&&!n.resolved&&(n.resolved=!0,u.emit("xhr-resolved",[],t)),d.inPlace(t,y,"fn-",s)}function i(t){g.push(t),h&&(x?x.then(a):w?w(a):(E=-E,O.data=E))}function a(){for(var t=0;t<g.length;t++)r([],g[t]);g.length&&(g=[])}function s(t,n){return n}function c(t,n){for(var e in t)n[e]=t[e];return n}t(5);var f=t("ee"),u=f.get("xhr"),d=t(18)(u),l=NREUM.o,p=l.XHR,h=l.MO,m=l.PR,w=l.SI,v="readystatechange",y=["onload","onerror","onabort","onloadstart","onloadend","onprogress","ontimeout"],g=[];n.exports=u;var b=window.XMLHttpRequest=function(t){var n=new p(t);try{u.emit("new-xhr",[n],n),n.addEventListener(v,o,!1)}catch(e){try{u.emit("internal-error",[e])}catch(r){}}return n};if(c(p,b),b.prototype=p.prototype,d.inPlace(b.prototype,["open","send"],"-xhr-",s),u.on("send-xhr-start",function(t,n){r(t,n),i(n)}),u.on("open-xhr-start",r),h){var x=m&&m.resolve();if(!w&&!m){var E=1,O=document.createTextNode(E);new h(a).observe(O,{characterData:!0})}}else f.on("fn-end",function(t){t[0]&&t[0].type===v||a()})},{}],10:[function(t,n,e){function r(t){var n=this.params,e=this.metrics;if(!this.ended){this.ended=!0;for(var r=0;r<d;r++)t.removeEventListener(u[r],this.listener,!1);if(!n.aborted){if(e.duration=a.now()-this.startTime,4===t.readyState){n.status=t.status;var i=o(t,this.lastSize);if(i&&(e.rxSize=i),this.sameOrigin){var c=t.getResponseHeader("X-NewRelic-App-Data");c&&(n.cat=c.split(", ").pop())}}else n.status=0;e.cbTime=this.cbTime,f.emit("xhr-done",[t],t),s("xhr",[n,e,this.startTime])}}}function o(t,n){var e=t.responseType;if("json"===e&&null!==n)return n;var r="arraybuffer"===e||"blob"===e||"json"===e?t.response:t.responseText;return h(r)}function i(t,n){var e=c(n),r=t.params;r.host=e.hostname+":"+e.port,r.pathname=e.pathname,t.sameOrigin=e.sameOrigin}var a=t("loader");if(a.xhrWrappable){var s=t("handle"),c=t(11),f=t("ee"),u=["load","error","abort","timeout"],d=u.length,l=t("id"),p=t(14),h=t(13),m=window.XMLHttpRequest;a.features.xhr=!0,t(9),f.on("new-xhr",function(t){var n=this;n.totalCbs=0,n.called=0,n.cbTime=0,n.end=r,n.ended=!1,n.xhrGuids={},n.lastSize=null,p&&(p>34||p<10)||window.opera||t.addEventListener("progress",function(t){n.lastSize=t.loaded},!1)}),f.on("open-xhr-start",function(t){this.params={method:t[0]},i(this,t[1]),this.metrics={}}),f.on("open-xhr-end",function(t,n){"loader_config"in NREUM&&"xpid"in NREUM.loader_config&&this.sameOrigin&&n.setRequestHeader("X-NewRelic-ID",NREUM.loader_config.xpid)}),f.on("send-xhr-start",function(t,n){var e=this.metrics,r=t[0],o=this;if(e&&r){var i=h(r);i&&(e.txSize=i)}this.startTime=a.now(),this.listener=function(t){try{"abort"===t.type&&(o.params.aborted=!0),("load"!==t.type||o.called===o.totalCbs&&(o.onloadCalled||"function"!=typeof n.onload))&&o.end(n)}catch(e){try{f.emit("internal-error",[e])}catch(r){}}};for(var s=0;s<d;s++)n.addEventListener(u[s],this.listener,!1)}),f.on("xhr-cb-time",function(t,n,e){this.cbTime+=t,n?this.onloadCalled=!0:this.called+=1,this.called!==this.totalCbs||!this.onloadCalled&&"function"==typeof e.onload||this.end(e)}),f.on("xhr-load-added",function(t,n){var e=""+l(t)+!!n;this.xhrGuids&&!this.xhrGuids[e]&&(this.xhrGuids[e]=!0,this.totalCbs+=1)}),f.on("xhr-load-removed",function(t,n){var e=""+l(t)+!!n;this.xhrGuids&&this.xhrGuids[e]&&(delete this.xhrGuids[e],this.totalCbs-=1)}),f.on("addEventListener-end",function(t,n){n instanceof m&&"load"===t[0]&&f.emit("xhr-load-added",[t[1],t[2]],n)}),f.on("removeEventListener-end",function(t,n){n instanceof m&&"load"===t[0]&&f.emit("xhr-load-removed",[t[1],t[2]],n)}),f.on("fn-start",function(t,n,e){n instanceof m&&("onload"===e&&(this.onload=!0),("load"===(t[0]&&t[0].type)||this.onload)&&(this.xhrCbStart=a.now()))}),f.on("fn-end",function(t,n){this.xhrCbStart&&f.emit("xhr-cb-time",[a.now()-this.xhrCbStart,this.onload,n],n)})}},{}],11:[function(t,n,e){n.exports=function(t){var n=document.createElement("a"),e=window.location,r={};n.href=t,r.port=n.port;var o=n.href.split("://");!r.port&&o[1]&&(r.port=o[1].split("/")[0].split("@").pop().split(":")[1]),r.port&&"0"!==r.port||(r.port="https"===o[0]?"443":"80"),r.hostname=n.hostname||e.hostname,r.pathname=n.pathname,r.protocol=o[0],"/"!==r.pathname.charAt(0)&&(r.pathname="/"+r.pathname);var i=!n.protocol||":"===n.protocol||n.protocol===e.protocol,a=n.hostname===document.domain&&n.port===e.port;return r.sameOrigin=i&&(!n.hostname||a),r}},{}],12:[function(t,n,e){function r(){}function o(t,n,e){return function(){return i(t,[f.now()].concat(s(arguments)),n?null:this,e),n?void 0:this}}var i=t("handle"),a=t(15),s=t(16),c=t("ee").get("tracer"),f=t("loader"),u=NREUM;"undefined"==typeof window.newrelic&&(newrelic=u);var d=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],l="api-",p=l+"ixn-";a(d,function(t,n){u[n]=o(l+n,!0,"api")}),u.addPageAction=o(l+"addPageAction",!0),u.setCurrentRouteName=o(l+"routeName",!0),n.exports=newrelic,u.interaction=function(){return(new r).get()};var h=r.prototype={createTracer:function(t,n){var e={},r=this,o="function"==typeof n;return i(p+"tracer",[f.now(),t,e],r),function(){if(c.emit((o?"":"no-")+"fn-start",[f.now(),r,o],e),o)try{return n.apply(this,arguments)}finally{c.emit("fn-end",[f.now()],e)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(t,n){h[n]=o(p+n)}),newrelic.noticeError=function(t){"string"==typeof t&&(t=new Error(t)),i("err",[t,f.now()])}},{}],13:[function(t,n,e){n.exports=function(t){if("string"==typeof t&&t.length)return t.length;if("object"==typeof t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&t.byteLength)return t.byteLength;if("undefined"!=typeof Blob&&t instanceof Blob&&t.size)return t.size;if(!("undefined"!=typeof FormData&&t instanceof FormData))try{return JSON.stringify(t).length}catch(n){return}}}},{}],14:[function(t,n,e){var r=0,o=navigator.userAgent.match(/Firefox[\/\s](\d+\.\d+)/);o&&(r=+o[1]),n.exports=r},{}],15:[function(t,n,e){function r(t,n){var e=[],r="",i=0;for(r in t)o.call(t,r)&&(e[i]=n(r,t[r]),i+=1);return e}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],16:[function(t,n,e){function r(t,n,e){n||(n=0),"undefined"==typeof e&&(e=t?t.length:0);for(var r=-1,o=e-n||0,i=Array(o<0?0:o);++r<o;)i[r]=t[n+r];return i}n.exports=r},{}],17:[function(t,n,e){n.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],18:[function(t,n,e){function r(t){return!(t&&t instanceof Function&&t.apply&&!t[a])}var o=t("ee"),i=t(16),a="nr@original",s=Object.prototype.hasOwnProperty,c=!1;n.exports=function(t,n){function e(t,n,e,o){function nrWrapper(){var r,a,s,c;try{a=this,r=i(arguments),s="function"==typeof e?e(r,a):e||{}}catch(f){l([f,"",[r,a,o],s])}u(n+"start",[r,a,o],s);try{return c=t.apply(a,r)}catch(d){throw u(n+"err",[r,a,d],s),d}finally{u(n+"end",[r,a,c],s)}}return r(t)?t:(n||(n=""),nrWrapper[a]=t,d(t,nrWrapper),nrWrapper)}function f(t,n,o,i){o||(o="");var a,s,c,f="-"===o.charAt(0);for(c=0;c<n.length;c++)s=n[c],a=t[s],r(a)||(t[s]=e(a,f?s+o:o,i,s))}function u(e,r,o){if(!c||n){var i=c;c=!0;try{t.emit(e,r,o,n)}catch(a){l([a,e,r,o])}c=i}}function d(t,n){if(Object.defineProperty&&Object.keys)try{var e=Object.keys(t);return e.forEach(function(e){Object.defineProperty(n,e,{get:function(){return t[e]},set:function(n){return t[e]=n,n}})}),n}catch(r){l([r])}for(var o in t)s.call(t,o)&&(n[o]=t[o]);return n}function l(n){try{t.emit("internal-error",n)}catch(e){}}return t||(t=o),e.inPlace=f,e.flag=a,e}},{}],ee:[function(t,n,e){function r(){}function o(t){function n(t){return t&&t instanceof r?t:t?c(t,s,i):i()}function e(e,r,o,i){if(!l.aborted||i){t&&t(e,r,o);for(var a=n(o),s=h(e),c=s.length,f=0;f<c;f++)s[f].apply(a,r);var d=u[y[e]];return d&&d.push([g,e,r,a]),a}}function p(t,n){v[t]=h(t).concat(n)}function h(t){return v[t]||[]}function m(t){return d[t]=d[t]||o(e)}function w(t,n){f(t,function(t,e){n=n||"feature",y[e]=n,n in u||(u[n]=[])})}var v={},y={},g={on:p,emit:e,get:m,listeners:h,context:n,buffer:w,abort:a,aborted:!1};return g}function i(){return new r}function a(){(u.api||u.feature)&&(l.aborted=!0,u=l.backlog={})}var s="nr@context",c=t("gos"),f=t(15),u={},d={},l=n.exports=o();l.backlog=u},{}],gos:[function(t,n,e){function r(t,n,e){if(o.call(t,n))return t[n];var r=e();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(t,n,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return t[n]=r,r}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],handle:[function(t,n,e){function r(t,n,e,r){o.buffer([t],r),o.emit(t,n,e)}var o=t("ee").get("handle");n.exports=r,r.ee=o},{}],id:[function(t,n,e){function r(t){var n=typeof t;return!t||"object"!==n&&"function"!==n?-1:t===window?0:a(t,i,function(){return o++})}var o=1,i="nr@id",a=t("gos");n.exports=r},{}],loader:[function(t,n,e){function r(){if(!x++){var t=b.info=NREUM.info,n=l.getElementsByTagName("script")[0];if(setTimeout(u.abort,3e4),!(t&&t.licenseKey&&t.applicationID&&n))return u.abort();f(y,function(n,e){t[n]||(t[n]=e)}),c("mark",["onload",a()+b.offset],null,"api");var e=l.createElement("script");e.src="https://"+t.agent,n.parentNode.insertBefore(e,n)}}function o(){"complete"===l.readyState&&i()}function i(){c("mark",["domContent",a()+b.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(s=Math.max((new Date).getTime(),s))-b.offset}var s=(new Date).getTime(),c=t("handle"),f=t(15),u=t("ee"),d=window,l=d.document,p="addEventListener",h="attachEvent",m=d.XMLHttpRequest,w=m&&m.prototype;NREUM.o={ST:setTimeout,SI:d.setImmediate,CT:clearTimeout,XHR:m,REQ:d.Request,EV:d.Event,PR:d.Promise,MO:d.MutationObserver};var v=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-1044.min.js"},g=m&&w&&w[p]&&!/CriOS/.test(navigator.userAgent),b=n.exports={offset:s,now:a,origin:v,features:{},xhrWrappable:g};t(12),l[p]?(l[p]("DOMContentLoaded",i,!1),d[p]("load",r,!1)):(l[h]("onreadystatechange",o),d[h]("onload",r)),c("mark",["firstbyte",s],null,"api");var x=0,E=t(17)},{}]},{},["loader",2,10,4,3]);</script> 
 </head> 
 <body class="js-preview-content  "> 
  <header class="global"> 
   <a href="//www.oreilly.com/go/oreilly" class="orm-topbar">
    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 59.13 9.88">
     <desc>
      O'Reilly logo
     </desc>
     <polygon points="28.09 1.96 28.09 0.42 21.68 0.42 21.68 9.64 28.09 9.64 28.09 8.11 23.22 8.11 23.22 5.8 27.86 5.8 27.86 4.27 23.22 4.27 23.22 1.96 28.09 1.96" />
     <polygon points="32.85 9.64 32.85 0.42 34.39 0.42 34.39 8.11 38.82 8.11 38.82 9.64 32.85 9.64" />
     <polygon points="40.07 9.64 40.07 0.42 41.61 0.42 41.61 8.11 46.04 8.11 46.04 9.64 40.07 9.64" />
     <rect x="29.71" y="0.42" width="1.54" height="9.22" />
     <path d="M1.59,6.28a4.8,4.8,0,1,1,4.8,4.8,4.8,4.8,0,0,1-4.8-4.8M4.09,4A3.27,3.27,0,1,0,6.4,3,3.27,3.27,0,0,0,4.09,4" transform="translate(-1.59 -1.2)" />
     <path d="M19.82,6.89A2.69,2.69,0,0,0,19,1.62H14.41v9.22h1.54V7h2.14l2.32,3.84H22.2ZM15.95,5.47V3.16H19a1.15,1.15,0,0,1,0,2.31h-3.1Z" transform="translate(-1.59 -1.2)" />
     <path d="M13.32,2.61a1.13,1.13,0,1,1-1.13-1.13,1.13,1.13,0,0,1,1.13,1.13" transform="translate(-1.59 -1.2)" />
     <polygon points="52.9 0.42 51.03 0.42 48.66 3.85 46.3 0.42 44.43 0.42 47.89 5.44 47.89 9.64 49.43 9.64 49.43 5.44 52.9 0.42" />
     <path d="M58.31,1.2a2.41,2.41,0,1,0,2.41,2.42A2.42,2.42,0,0,0,58.31,1.2m0,4.44a2,2,0,1,1,2-2,2,2,0,0,1-2,2" transform="translate(-1.59 -1.2)" />
     <path d="M59.4,3.09a0.72,0.72,0,0,0-.72-0.72H57.32V4.83h0.41v-1h0.69l0.49,1h0.46l-0.51-1a0.71,0.71,0,0,0,.54-0.69m-1.67-.31h0.95a0.31,0.31,0,0,1,.31.31,0.31,0.31,0,0,1-.31.3H57.73V2.78Z" transform="translate(-1.59 -1.2)" />
    </svg></a> 
   <div class="header-top"> 
    <nav class="main-nav"> 
     <a href="/" class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 125.46 36" class="home-logo">
       <desc>
        Safari Logo
       </desc>
       <path d="M27.85,7.25a1.4,1.4,0,1,1,2.75,0V15.6a1.44,1.44,0,0,1-1.4,1.71A1.49,1.49,0,0,1,28,16.64,13.56,13.56,0,0,1,27.54,14c-0.62-3.89-4.15-6.54-8.66-6.54S11,10.16,11,14c0,3,1.66,4.56,6.8,6.28l5.29,1.82c5.86,2,8.14,4.46,8.14,9,0,5.76-4.36,9.6-10.84,9.6-5,0-8.3-1.87-9.91-5.6v3.42a1.4,1.4,0,1,1-2.75,0V29.71A1.44,1.44,0,0,1,9.18,28c1,0,1.35.52,1.45,2A10.59,10.59,0,0,0,13,35.63a9.05,9.05,0,0,0,6.8,2.7c5,0,8.3-2.8,8.3-7a5.45,5.45,0,0,0-2.54-4.82,18.52,18.52,0,0,0-3.89-1.71l-4.51-1.56c-3.58-1.24-5.24-2-6.54-3a7.46,7.46,0,0,1-2.75-6c0-5.45,4.36-9.13,10.69-9.13,4.46,0,7.63,1.71,9.29,5.08V7.25Z" transform="translate(-7.78 -4.92)" />
       <path d="M51.81,35.11c-1.82,4.1-4.51,5.81-9.28,5.81-5.39,0-8.71-2.75-8.71-7.31A6.88,6.88,0,0,1,38.11,27c1.87-.83,4.62-1.19,8.92-1.19,0.93,0,2,0,2.8.05a7,7,0,0,0,.93.05,0.89,0.89,0,0,0,1-.88V24.84c0-3.37-.31-4.46-1.71-5.71-1.19-1.09-2.8-1.56-5.24-1.56-4.15,0-6.64,1.71-7.11,4.88a1.45,1.45,0,0,1-2.9-.16c0-2.13,1.82-4.67,4.15-5.81a13.94,13.94,0,0,1,6-1.09c3.63,0,6.22.88,7.83,2.75,1.4,1.56,1.82,3.16,1.82,6.64V37a0.89,0.89,0,0,0,1,1h1.76a1.08,1.08,0,1,1,0,2.13H53.05a1.06,1.06,0,0,1-1.24-1.24V35.11Zm-15-1.61c0,3.32,2.33,5.24,6.33,5.24,3.27,0,5.76-1.24,7.16-3.58a16.08,16.08,0,0,0,1.45-6.38A0.8,0.8,0,0,0,51.24,28a34,34,0,0,0-4.62-.21C39.93,27.79,36.76,29.66,36.76,33.5Z" transform="translate(-7.78 -4.92)" />
       <path d="M67.91,37a0.89,0.89,0,0,0,1,1H71.8a1.08,1.08,0,1,1,0,2.13H62a1.09,1.09,0,1,1,0-2.13h2.07a0.89,0.89,0,0,0,1-1V19.29a0.89,0.89,0,0,0-1-1H61.63a1.08,1.08,0,1,1,0-2.13h2.44a0.89,0.89,0,0,0,1-1V13.48c0-3.16.78-5.39,2.39-6.8a8.56,8.56,0,0,1,5.19-1.76,10.85,10.85,0,0,1,3.58.62,1.83,1.83,0,0,1,.52,1,1.23,1.23,0,0,1-.88,1,2.74,2.74,0,0,1-.67-0.1,12.61,12.61,0,0,0-2.28-.31,5.41,5.41,0,0,0-4,2c-0.73,1-1,2.18-1,4.56v1.35a0.89,0.89,0,0,0,1,1h3.58a1.09,1.09,0,1,1,0,2.13H68.95a0.89,0.89,0,0,0-1,1V37Z" transform="translate(-7.78 -4.92)" />
       <path d="M93.68,35.11c-1.82,4.1-4.51,5.81-9.28,5.81-5.39,0-8.71-2.75-8.71-7.31A6.88,6.88,0,0,1,80,27c1.87-.83,4.62-1.19,8.92-1.19,0.93,0,2,0,2.8.05a7,7,0,0,0,.93.05,0.89,0.89,0,0,0,1-.88V24.84c0-3.37-.31-4.46-1.71-5.71-1.19-1.09-2.8-1.56-5.24-1.56-4.15,0-6.64,1.71-7.11,4.88a1.45,1.45,0,0,1-2.9-.16c0-2.13,1.82-4.67,4.15-5.81a13.94,13.94,0,0,1,6-1.09c3.63,0,6.22.88,7.83,2.75,1.4,1.56,1.82,3.16,1.82,6.64V37a0.89,0.89,0,0,0,1,1h1.76a1.08,1.08,0,1,1,0,2.13H94.92a1.06,1.06,0,0,1-1.24-1.24V35.11Zm-15-1.61c0,3.32,2.33,5.24,6.33,5.24,3.27,0,5.76-1.24,7.16-3.58a16.07,16.07,0,0,0,1.45-6.38A0.8,0.8,0,0,0,93.11,28a34,34,0,0,0-4.62-.21C81.8,27.79,78.64,29.66,78.64,33.5Z" transform="translate(-7.78 -4.92)" />
       <path d="M109.44,21.05a6.5,6.5,0,0,1,2-3.53,8.68,8.68,0,0,1,5.71-2.13c1.35,0,2.13.52,2.13,1.35a0.83,0.83,0,0,1-.78,1,3.75,3.75,0,0,1-.67-0.05,2.45,2.45,0,0,0-.78-0.1,11.52,11.52,0,0,0-3.63.88c-2.59,1.19-4,4-4,8.2V37a0.89,0.89,0,0,0,1,1h3a1.08,1.08,0,1,1,0,2.13h-10a1.09,1.09,0,1,1,0-2.13h2.13a0.89,0.89,0,0,0,1-1V19.29a0.89,0.89,0,0,0-1-1h-2.13a1.09,1.09,0,1,1,0-2.13h4.72a1.06,1.06,0,0,1,1.24,1.24v3.68Z" transform="translate(-7.78 -4.92)" />
       <path d="M129.09,37a0.89,0.89,0,0,0,1,1h1.82a1.08,1.08,0,1,1,0,2.13h-8.82a1.09,1.09,0,1,1,0-2.13h2.13a0.89,0.89,0,0,0,1-1V19.29a0.89,0.89,0,0,0-1-1h-2.13a1.09,1.09,0,1,1,0-2.13h4.72a1.06,1.06,0,0,1,1.24,1.24V37ZM129.55,8.5a2.08,2.08,0,0,1-2.07,2.07,2.17,2.17,0,0,1-2.13-2.13,2.08,2.08,0,0,1,2.07-2.08A2.1,2.1,0,0,1,129.55,8.5Z" transform="translate(-7.78 -4.92)" />
      </svg></a> 
    </nav> 
    <nav class="right-nav"> 
     <ul> 
      <li class="callout mobile-link"> <a class="t-register cta-link" data-ga-label="Nav Bar" href="/public/free-trial/?fa=True&amp;cl=/library/view/test-driven-development-with/9781449365141/ch15.html">Start Free Trial</a> </li> 
      <li class="mobile-link"><a class="t-sign-in" href="/accounts/login/?next=/library/view/test-driven-development-with/9781449365141/ch15.html">Sign In</a></li> 
      <li><a href="/pricing/">Pricing</a></li> 
      <li><a href="/enterprise/">Enterprise</a></li> 
      <li class="search-field"> 
       <form id="js-search-form" action="/search/"> 
        <script type="application/ld+json">
                {
                  "@context": "http://schema.org",
                  "@type": "WebSite",
                  "url": "https://www.safaribooksonline.com/",
                  "potentialAction": {
                    "@type": "SearchAction",
                    "target": "https://www.safaribooksonline.com/search/?q={search_term_string}",
                    "query-input": "required name=search_term_string"
                  }
                }
                </script> 
        <input data-search-text-focus="Search books and videos..." data-search-text-idle="Search..." id="search" type="search" name="q" placeholder="Search..." autocomplete="off" required> 
        <input type="submit" value="search" class="search-submit"> 
       </form> </li> 
     </ul> 
    </nav> 
   </div> 
   <div class="sbo-menu-top"> 
    <section class="sbo-toc-container"> 
     <a href="/library/view/test-driven-development-with/9781449365141/" class="sbo-toc-thumb"> <span class="sbo-title ss-list"> <h1 class="t-title">Test-Driven Development with Python by Harry J.W. Percival</h1> </span> </a> 
    </section> 
   </div> 
  </header> 
  <section id="trial-overlay"> 
   <div class="trial-overlay-content"> 
    <h2 class="trial-modal-title"> Stay ahead with the world's most comprehensive technology and business learning platform. </h2> 
    <h2> With Safari, you learn the way you learn best. Get unlimited access to videos, live online training, learning paths, books, tutorials, and more. </h2> 
    <div class="controls"> 
     <a href="/public/free-trial/?fa=True&amp;cl=/library/view/test-driven-development-with/9781449365141/ch15.html" class="button" data-ga-label="Modal">Start Free Trial</a> 
     <p>No credit card required</p> 
    </div> 
    <a class="modal-dismiss" aria-label="modal dismiss"></a> 
   </div> 
  </section> 
  <section role="document"> 
   <section id="sbo-reader"> 
    <div class="sbo-reader-content sbo-sample-reader "> 
     <div id="sbo-rt-content"> 
      <div id="test-content-id">
       <section class="chapter" title="Chapter&nbsp;15.&nbsp;User Authentication, Integrating Third-Party Plugins, and Mocking with JavaScript" epub:type="chapter" id="Persona-clientside-chapter">
        <div class="titlepage">
         <div>
          <div>
           <h2 class="title">Chapter&nbsp;15.&nbsp;User Authentication, Integrating Third-Party Plugins, and Mocking with JavaScript</h2>
          </div>
         </div>
        </div>
        <p><a id="id589938" class="indexterm"></a> <a id="id589930" class="indexterm"></a> Our beautiful lists site has been live for a few days, and our users are starting to come back to us with feedback. “We love the site”, they say, “but we keep losing our lists. Manually remembering URLs is hard. It’d be great if it could remember what lists we’d started”.</p>
        <p>Remember Henry Ford and faster horses. Whenever you hear a user requirement, it’s important to dig a little deeper and think—what is the real requirement here? And how can I make it involve a cool new technology I’ve been wanting to try out?</p>
        <p>Clearly the requirement here is that people want to have some kind of user account on the site. So, without further ado, let’s dive into authentication.</p>
        <p>Naturally we’re not going to mess about with remembering passwords ourselves—besides being <span class="emphasis"><em>so</em></span> ’90s, secure storage of user passwords is a security nightmare we’d rather leave to someone else. We’ll use a federated authentication system instead.</p>
        <p>(If you <span class="emphasis"><em>insist</em></span> on storing your own passwords, Django’s default auth module is ready and waiting for you. It’s nice and straightforward, and I’ll leave it to you to discover on your own.)</p>
        <p><a id="id589894" class="indexterm"></a> <a id="id589902" class="indexterm"></a> In this chapter, we’re going to get pretty deep into a testing technique called “mocking”. Personally, I know it took me a few weeks to really get my head around mocking, so don’t worry if it’s confusing at first. In this chapter we do a lot of mocking in JavaScript. In the next chapter we’ll do some mocking with Python, which you might find a little easier to grasp. I would recommend reading both of them through together, and just letting the whole concept wash over you; then come back and do them again, and see if you understand all of the steps a little better on the second round.</p>
        <div class="note" title="Note">
         <h3 class="title">Note</h3>
         <p>Do let me know via <span class="email"><a class="email" href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a></span> if you feel there’s any particular sections where I don’t explain things well, or where I’m going too fast.</p>
        </div>
        <div class="sect1" title="Mozilla Persona (BrowserID)">
         <div class="titlepage">
          <div>
           <div>
            <h2 class="title" style="clear: both" id="_mozilla_persona_browserid">Mozilla Persona (BrowserID)</h2>
           </div>
          </div>
         </div>
         <p><a id="id717736" class="indexterm"></a> <a id="id717743" class="indexterm"></a> <a id="id717778" class="indexterm"></a> But which federated authentication system to use? Oauth? Openid? “Login with Facebook”? Ugh. In my book those all have unacceptable creepy overtones; why should Google or Facebook know what sites you’re logging into and when? Thankfully there are still some techno-hippy-idealists out there, and the lovely people at Mozilla have cooked up a privacy-friendly auth mechanism they call “Persona”, or sometimes “BrowserID”.</p>
         <p>The theory goes that your web browser acts as a third party between the website that wants to check your ID, and the website that you will use as a guarantor of your ID. The latter may be Google or Facebook or whomever, but a clever protocol means that they never need know which website you were logging into or when.</p>
         <p>Ultimately, Persona may never take off as an authentication platform, but the main lessons from the next couple of chapters should be relevant no matter what third-party auth system you want to integrate:</p>
         <div class="itemizedlist">
          <ul class="itemizedlist">
           <li class="listitem"> Don’t test other people’s code or APIs. </li>
           <li class="listitem"> But, test that you’ve integrated them correctly into your own code. </li>
           <li class="listitem"> Check that everything works from the point of view of the user. </li>
           <li class="listitem"> Test that your system degrades gracefully if the third party is down. </li>
          </ul>
         </div>
        </div>
        <div class="sect1" title="Exploratory Coding, aka “Spiking”">
         <div class="titlepage">
          <div>
           <div>
            <h2 class="title" style="clear: both" id="_exploratory_coding_aka_spiking">Exploratory Coding, aka “Spiking”</h2>
           </div>
          </div>
         </div>
         <p><a id="ix_javaspiking" class="indexterm"></a> <a id="ix_spikingjava" class="indexterm"></a> <a id="ix_spiking" class="indexterm"></a> <a id="id717913" class="indexterm"></a> Before I wrote this chapter all I’d seen of Persona was a talk at PyCon by Dan Callahan, in which he promised it could be implemented in 30 lines of code, and magic’d his way through a demo—in other words, I knew it not at all.</p>
         <p>In <a class="xref" href="ch10.html" title="Chapter&nbsp;10.&nbsp;Input Validation and Test Organisation">Chapter&nbsp;10</a> and <a class="xref" href="ch11.html" title="Chapter&nbsp;11.&nbsp;A Simple Form">Chapter&nbsp;11</a> we saw that you can use a unit test as a way of exploring a new API, but sometimes you just want to hack something together without any tests at all, just to see if it works, to learn it or get a feel for it. That’s absolutely fine. When learning a new tool or exploring a new possible solution, it’s often appropriate to leave the rigorous TDD process to one side, and build a little prototype without tests, or perhaps with very few tests. The goat doesn’t mind looking the other way for a bit.</p>
         <p>This kind of prototyping activity is often called a “spike”, for <a class="ulink" href="http://stackoverflow.com/questions/249969/why-are-tdd-spikes-called-spikes" target="_top">reasons best known</a>.</p>
         <p><a id="id581542" class="indexterm"></a> The first thing I did was take a look at an existing Django-Persona integration called <a class="ulink" href="https://github.com/mozilla/django-browserid" target="_top">Django-BrowserID</a>, but unfortunately it didn’t really support Python 3. I’m sure it will by the time you read this, but I was quietly relieved since I was rather looking forward to writing my own code for this!</p>
         <p>It took me about three hours of hacking about, using a combination of code stolen from Dan’s talk and the example code on the <a class="ulink" href="https://developer.mozilla.org/en-US/docs/Mozilla/Persona" target="_top">Persona site</a>, but by the end I had something which just about works. I’ll take you on a tour, and then we’ll go through and “de-spike” the implementation.</p>
         <p>You should go ahead and add this code to your own site too, and then you can have a play with it, try logging in with your own email address, and convince yourself that it really does work.</p>
         <div class="sect2" title="Starting a Branch for the Spike">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_starting_a_branch_for_the_spike">Starting a Branch for the Spike</h3>
            </div>
           </div>
          </div>
          <p>Before embarking on a spike, it’s a good idea to start a new branch, so you can still use your VCS without worrying about your spike commits getting mixed up with your production code:</p>
          <pre class="screen">$ <span class="strong"><strong>git checkout -b persona-spike</strong></span></pre>
         </div>
         <div class="sect2" title="Frontend and JavaScript Code">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_frontend_and_javascript_code">Frontend and JavaScript Code</h3>
            </div>
           </div>
          </div>
          <p><a id="id581511" class="indexterm"></a> Let’s start with the frontend. I was able to cut and paste code from the Persona site and Dan’s slides with minimal modification:</p>
          <p class="sourcecode small-code" title="lists/templates/base.html (ch15l001)"><span class="title"><strong>lists/templates/base.html (ch15l001)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"http://code.jquery.com/jquery.min.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"/static/list.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"https://login.persona.org/include.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script&gt;</code>
<code class="nx">$</code><code class="p">(</code><code class="nb">document</code><code class="p">).</code><code class="nx">ready</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>

<code class="kd">var</code> <code class="nx">loginLink</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'login'</code><code class="p">);</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">loginLink</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">loginLink</code><code class="p">.</code><code class="nx">onclick</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">request</code><code class="p">();</code> <code class="p">};</code>
<code class="p">}</code>

<code class="kd">var</code> <code class="nx">logoutLink</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'logout'</code><code class="p">);</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">logoutLink</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">logoutLink</code><code class="p">.</code><code class="nx">onclick</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">logout</code><code class="p">();</code> <code class="p">};</code>
<code class="p">}</code>

<code class="kd">var</code> <code class="nx">currentUser</code> <code class="o">=</code> <code class="s1">'{{ user.email }}'</code> <code class="o">||</code> <code class="kc">null</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">csrf_token</code> <code class="o">=</code> <code class="s1">'{{ csrf_token }}'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">currentUser</code><code class="p">);</code>

<code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">watch</code><code class="p">({</code>
  <code class="nx">loggedInUser</code><code class="o">:</code> <code class="nx">currentUser</code><code class="p">,</code>
  <code class="nx">onlogin</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">assertion</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">$</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/accounts/login'</code><code class="p">,</code> <code class="p">{</code><code class="nx">assertion</code><code class="o">:</code> <code class="nx">assertion</code><code class="p">,</code> <code class="nx">csrfmiddlewaretoken</code><code class="o">:</code> <code class="nx">csrf_token</code><code class="p">})</code>
    <code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nb">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">reload</code><code class="p">();</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">fail</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">logout</code><code class="p">();});</code>
  <code class="p">},</code>
  <code class="nx">onlogout</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">$</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/accounts/logout'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">always</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nb">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">reload</code><code class="p">();</code> <code class="p">});</code>
  <code class="p">}</code>
<code class="p">});</code>

<code class="p">});</code>
<code class="nt">&lt;/script&gt;</code></pre>
          <p class="sourcecode small-code" title="lists/templates/base.html (ch15l001)"> </p>
          <p>The Persona JavaScript library gives us a special <code class="literal">navigator.id</code> object. We bind its <code class="literal">request</code> method to our link called “login” (which I’ve put in any old where at the top of the page), and similarly a “logout” link gets bound to a <code class="literal">logout</code> function:</p>
          <p class="sourcecode" title="lists/templates/base.html (ch15l002)"><span class="title"><strong>lists/templates/base.html (ch15l002)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="nt">&lt;body&gt;</code>
<code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"container"</code><code class="nt">&gt;</code>

    <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"navbar"</code><code class="nt">&gt;</code>
        {% if user.email %}
            <code class="nt">&lt;p&gt;</code>Logged in as {{ user.email}}<code class="nt">&lt;/p&gt;</code>
            <code class="nt">&lt;p&gt;&lt;a</code> <code class="na">id=</code><code class="s">"logout"</code> <code class="na">href=</code><code class="s">"{% url 'logout' %}"</code><code class="nt">&gt;</code>Sign out<code class="nt">&lt;/a&gt;&lt;/p&gt;</code>
        {% else %}
            <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"#"</code> <code class="na">id=</code><code class="s">"login"</code><code class="nt">&gt;</code>Sign in<code class="nt">&lt;/a&gt;</code>
        {% endif %}
        <code class="nt">&lt;p&gt;</code>User: {{user}}<code class="nt">&lt;/p&gt;</code>
    <code class="nt">&lt;/div&gt;</code>

    <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"row"</code><code class="nt">&gt;</code>
    [...]</pre>
          <p class="sourcecode" title="lists/templates/base.html (ch15l002)"> </p>
         </div>
         <div class="sect2" title="The Browser-ID Protocol">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_the_browser_id_protocol">The Browser-ID Protocol</h3>
            </div>
           </div>
          </div>
          <p><a id="id707756" class="indexterm"></a> Persona will now pop up its authentication dialog box if users click the log in link. What happens next is the clever part of the Persona protocol: the user enters an email address, and the browser takes care of validating that email address, by taking the user to the email provider (Google, Yahoo, or whoever), and validating it with them.</p>
          <p>Let’s say it’s Google: Google asks the user to confirm their username and password, and maybe even does some two-factor auth wizardry, and is then prepared to confirm to your browser that you are who you say you are. Google then passes a certificate back to the browser, which is cryptographically signed to prove it’s from Google, and which contains the user’s email address.</p>
          <p>At this point the browser can trust that you do own that email address, and it can incidentally reuse that certificate for any other websites that use Persona.</p>
          <p>Now it combines the certificate with the domain name of the website you want to log into in to a blob called an “assertion”, and sends them on to our site for validation.</p>
          <p>This is the point between the <code class="literal">navigator.id.request</code> and the <code class="literal">navigator.id.watch</code> callback for <code class="literal">onlogin</code>—we send the assertion via POST to the login URL on our site, which I’ve put at <span class="emphasis"><em>accounts/login</em></span>.</p>
          <p>On the server, we now have the job of verifying the assertion: is it really proof that the user owns that email address? Our server can check, because Google has signed part of the assertion with its public key. We can either write code to do the crypto for this step ourselves, or we can use a public service from Mozilla to do it for us.</p>
          <div class="note" title="Note">
           <h3 class="title">Note</h3>
           <p>Yes, letting Mozilla do it for us totally defeats the whole privacy point, but it’s the <span class="emphasis"><em>principle</em></span>. We could do it ourselves if we wanted to. It’s left as an exercise for the reader! There are more details on the <a class="ulink" href="https://developer.mozilla.org/en-US/docs/Mozilla/Persona/Protocol_Overview" target="_top">Mozilla site</a>, including all the clever public key crypto that keeps Google from knowing what site you want to log in to, but also stops replay attacks and so on. Smart.</p>
          </div>
         </div>
         <div class="sect2" title="The Server Side: Custom Authentication">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_the_server_side_custom_authentication">The Server Side: Custom Authentication</h3>
            </div>
           </div>
          </div>
          <p><a id="ix_spikingssa" class="indexterm"></a> <a id="ix_authcust" class="indexterm"></a> <a id="ix_Djangoauth" class="indexterm"></a> Next we prep an app for our accounts stuff:</p>
          <pre class="screen">$ <span class="strong"><strong>python3 manage.py startapp accounts</strong></span></pre>
          <p>Here’s the view that handles the POST to <span class="emphasis"><em>accounts/login</em></span>:</p>
          <p class="sourcecode small-code" title="accounts/views.py"><span class="title"><strong>accounts/views.py</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kn">import</code> <code class="nn">sys</code>
<code class="kn">from</code> <code class="nn">django.contrib.auth</code> <code class="kn">import</code> <code class="n">authenticate</code>
<code class="kn">from</code> <code class="nn">django.contrib.auth</code> <code class="kn">import</code> <code class="n">login</code> <code class="k">as</code> <code class="n">auth_login</code>
<code class="kn">from</code> <code class="nn">django.shortcuts</code> <code class="kn">import</code> <code class="n">redirect</code>

<code class="k">def</code> <code class="nf">login</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">print</code><code class="p">(</code><code class="s">'login view'</code><code class="p">,</code> <code class="nb">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">)</code>
    <code class="c"># user = PersonaAuthenticationBackend().authenticate(request.POST['assertion'])</code>
    <code class="n">user</code> <code class="o">=</code> <code class="n">authenticate</code><code class="p">(</code><code class="n">assertion</code><code class="o">=</code><code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s">'assertion'</code><code class="p">])</code>
    <code class="k">if</code> <code class="n">user</code> <code class="ow">is</code> <code class="ow">not</code> <code class="bp">None</code><code class="p">:</code>
        <code class="n">auth_login</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="n">user</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="s">'/'</code><code class="p">)</code></pre>
          <p class="sourcecode small-code" title="accounts/views.py"> </p>
          <p>You can see that it’s clearly “spike” code from things like the commented-out line, evidence of an early experiment that failed.</p>
          <p>Here’s the <code class="literal">authenticate</code> function, which is implemented as a custom Django “authentication backend”. (We could have done it inline in the view, but using a backend is the Django recommended way. It would let us reuse the authentication system in the admin site, for example.)</p>
          <p class="sourcecode small-code" title="accounts/authentication.py"><span class="title"><strong>accounts/authentication.py</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kn">import</code> <code class="nn">requests</code>
<code class="kn">import</code> <code class="nn">sys</code>
<code class="kn">from</code> <code class="nn">accounts.models</code> <code class="kn">import</code> <code class="n">ListUser</code>

<code class="k">class</code> <code class="nc">PersonaAuthenticationBackend</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>

    <code class="k">def</code> <code class="nf">authenticate</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">assertion</code><code class="p">):</code>
        <code class="c"># Send the assertion to Mozilla's verifier service.</code>
        <code class="n">data</code> <code class="o">=</code> <code class="p">{</code><code class="s">'assertion'</code><code class="p">:</code> <code class="n">assertion</code><code class="p">,</code> <code class="s">'audience'</code><code class="p">:</code> <code class="s">'localhost'</code><code class="p">}</code>
        <code class="k">print</code><code class="p">(</code><code class="s">'sending to mozilla'</code><code class="p">,</code> <code class="n">data</code><code class="p">,</code> <code class="nb">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">)</code>
        <code class="n">resp</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s">'https://verifier.login.persona.org/verify'</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="n">data</code><code class="p">)</code>
        <code class="k">print</code><code class="p">(</code><code class="s">'got'</code><code class="p">,</code> <code class="n">resp</code><code class="o">.</code><code class="n">content</code><code class="p">,</code> <code class="nb">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">)</code>

        <code class="c"># Did the verifier respond?</code>
        <code class="k">if</code> <code class="n">resp</code><code class="o">.</code><code class="n">ok</code><code class="p">:</code>
            <code class="c"># Parse the response</code>
            <code class="n">verification_data</code> <code class="o">=</code> <code class="n">resp</code><code class="o">.</code><code class="n">json</code><code class="p">()</code>

            <code class="c"># Check if the assertion was valid</code>
            <code class="k">if</code> <code class="n">verification_data</code><code class="p">[</code><code class="s">'status'</code><code class="p">]</code> <code class="o">==</code> <code class="s">'okay'</code><code class="p">:</code>
                <code class="n">email</code> <code class="o">=</code> <code class="n">verification_data</code><code class="p">[</code><code class="s">'email'</code><code class="p">]</code>
                <code class="k">try</code><code class="p">:</code>
                    <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">get_user</code><code class="p">(</code><code class="n">email</code><code class="p">)</code>
                <code class="k">except</code> <code class="n">ListUser</code><code class="o">.</code><code class="n">DoesNotExist</code><code class="p">:</code>
                    <code class="k">return</code> <code class="n">ListUser</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">email</code><code class="o">=</code><code class="n">email</code><code class="p">)</code>


    <code class="k">def</code> <code class="nf">get_user</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">email</code><code class="p">):</code>
        <code class="k">return</code> <code class="n">ListUser</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">email</code><code class="o">=</code><code class="n">email</code><code class="p">)</code></pre>
          <p class="sourcecode small-code" title="accounts/authentication.py"> </p>
          <p>This code is copy-pasted directly from the Mozilla site, as you can see from the explanatory comments.</p>
          <p>You’ll need to <code class="literal">pip install requests</code> into your virtualenv. If you’ve never used it before, <a class="ulink" href="http://docs.python-requests.org/" target="_top">Requests</a> is a great alternative to the Python standard library tools for HTTP requests.</p>
          <p>To finish off the job of customising authentication in Django, we just need a custom user model:</p>
          <p class="sourcecode" title="accounts/models.py"><span class="title"><strong>accounts/models.py</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kn">from</code> <code class="nn">django.contrib.auth.models</code> <code class="kn">import</code> <code class="n">AbstractBaseUser</code><code class="p">,</code> <code class="n">PermissionsMixin</code>
<code class="kn">from</code> <code class="nn">django.db</code> <code class="kn">import</code> <code class="n">models</code>

<code class="k">class</code> <code class="nc">ListUser</code><code class="p">(</code><code class="n">AbstractBaseUser</code><code class="p">,</code> <code class="n">PermissionsMixin</code><code class="p">):</code>
    <code class="n">email</code> <code class="o">=</code> <code class="n">models</code><code class="o">.</code><code class="n">EmailField</code><code class="p">(</code><code class="n">primary_key</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
    <code class="n">USERNAME_FIELD</code> <code class="o">=</code> <code class="s">'email'</code>
    <code class="c">#REQUIRED_FIELDS = ['email', 'height']</code>

    <code class="n">objects</code> <code class="o">=</code> <code class="n">ListUserManager</code><code class="p">()</code>

    <code class="nd">@property</code>
    <code class="k">def</code> <code class="nf">is_staff</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">email</code> <code class="o">==</code> <code class="s">'harry.percival@example.com'</code>

    <code class="nd">@property</code>
    <code class="k">def</code> <code class="nf">is_active</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="k">return</code> <code class="bp">True</code></pre>
          <p class="sourcecode" title="accounts/models.py"> </p>
          <p>That’s what I call a minimal user model! One field, none of this firstname/lastname/username nonsense, and, pointedly, no password! Somebody else’s problem! But, again, you can see that this code isn’t ready for production, from the commented-out lines to the hardcoded harry email address.</p>
          <div class="note" title="Note">
           <h3 class="title">Note</h3>
           <p>At this point I’d recommend a little browse through the <a class="ulink" href="https://docs.djangoproject.com/en/1.7/topics/auth/customizing/" target="_top">Django auth documentation</a>.</p>
          </div>
          <p>Aside from that, you need a model manager for the user:</p>
          <p class="sourcecode small-code" title="accounts/models.py (ch15l006)"><span class="title"><strong>accounts/models.py (ch15l006)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kn">from</code> <code class="nn">django.contrib.auth.models</code> <code class="kn">import</code> <code class="n">AbstractBaseUser</code><code class="p">,</code> <code class="n">BaseUserManager</code><code class="p">,</code> <code class="n">PermissionsMixin</code>

<code class="k">class</code> <code class="nc">ListUserManager</code><code class="p">(</code><code class="n">BaseUserManager</code><code class="p">):</code>

    <code class="k">def</code> <code class="nf">create_user</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">email</code><code class="p">):</code>
        <code class="n">ListUser</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">email</code><code class="o">=</code><code class="n">email</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">create_superuser</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">email</code><code class="p">,</code> <code class="n">password</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">create_user</code><code class="p">(</code><code class="n">email</code><code class="p">)</code></pre>
          <p class="sourcecode small-code" title="accounts/models.py (ch15l006)"> </p>
          <p>A logout view:</p>
          <p class="sourcecode" title="accounts/views.py (ch15l007)"><span class="title"><strong>accounts/views.py (ch15l007)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kn">from</code> <code class="nn">django.contrib.auth</code> <code class="kn">import</code> <code class="n">login</code> <code class="k">as</code> <code class="n">auth_login</code><code class="p">,</code> <code class="n">logout</code> <code class="k">as</code> <code class="n">auth_logout</code>
<code class="p">[</code><code class="o">...</code><code class="p">]</code>

<code class="k">def</code> <code class="nf">logout</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="n">auth_logout</code><code class="p">(</code><code class="n">request</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="s">'/'</code><code class="p">)</code></pre>
          <p class="sourcecode" title="accounts/views.py (ch15l007)"> </p>
          <p>Some URLs for our two views:</p>
          <p class="sourcecode" title="superlists/urls.py (ch15l008)"><span class="title"><strong>superlists/urls.py (ch15l008)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="n">urlpatterns</code> <code class="o">=</code> <code class="n">patterns</code><code class="p">(</code><code class="s">''</code><code class="p">,</code>
    <code class="n">url</code><code class="p">(</code><code class="s">r'^$'</code><code class="p">,</code> <code class="s">'lists.views.home_page'</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s">'home'</code><code class="p">),</code>
    <code class="n">url</code><code class="p">(</code><code class="s">r'^lists/'</code><code class="p">,</code> <code class="n">include</code><code class="p">(</code><code class="s">'lists.urls'</code><code class="p">)),</code>
    <code class="n">url</code><code class="p">(</code><code class="s">r'^accounts/'</code><code class="p">,</code> <code class="n">include</code><code class="p">(</code><code class="s">'accounts.urls'</code><code class="p">)),</code>
    <code class="c"># url(r'^admin/', include(admin.site.urls)),</code>
<code class="p">)</code></pre>
          <p class="sourcecode" title="superlists/urls.py (ch15l008)"> </p>
          <p>and</p>
          <p class="sourcecode" title="accounts/urls.py"><span class="title"><strong>accounts/urls.py</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kn">from</code> <code class="nn">django.conf.urls</code> <code class="kn">import</code> <code class="n">patterns</code><code class="p">,</code> <code class="n">url</code>

<code class="n">urlpatterns</code> <code class="o">=</code> <code class="n">patterns</code><code class="p">(</code><code class="s">''</code><code class="p">,</code>
    <code class="n">url</code><code class="p">(</code><code class="s">r'^login$'</code><code class="p">,</code> <code class="s">'accounts.views.login'</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s">'login'</code><code class="p">),</code>
    <code class="n">url</code><code class="p">(</code><code class="s">r'^logout$'</code><code class="p">,</code> <code class="s">'accounts.views.logout'</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s">'logout'</code><code class="p">),</code>
<code class="p">)</code></pre>
          <p class="sourcecode" title="accounts/urls.py"> </p>
          <p><a id="id594764" class="indexterm"></a> <a id="id594941" class="indexterm"></a> <a id="id594949" class="indexterm"></a> Almost there. We switch on the auth backend and our new accounts app in <span class="emphasis"><em>settings.py</em></span>:</p>
          <p class="sourcecode" title="superlists/settings.py"><span class="title"><strong>superlists/settings.py</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="n">INSTALLED_APPS</code> <code class="o">=</code> <code class="p">(</code>
    <code class="c">#'django.contrib.admin',</code>
    <code class="s">'django.contrib.auth'</code><code class="p">,</code>
    <code class="s">'django.contrib.contenttypes'</code><code class="p">,</code>
    <code class="s">'django.contrib.sessions'</code><code class="p">,</code>
    <code class="s">'django.contrib.messages'</code><code class="p">,</code>
    <code class="s">'django.contrib.staticfiles'</code><code class="p">,</code>
    <code class="s">'lists'</code><code class="p">,</code>
    <code class="s">'accounts'</code><code class="p">,</code>
<code class="p">)</code>

<code class="n">AUTH_USER_MODEL</code> <code class="o">=</code> <code class="s">'accounts.ListUser'</code>
<code class="n">AUTHENTICATION_BACKENDS</code> <code class="o">=</code> <code class="p">(</code>
    <code class="s">'accounts.authentication.PersonaAuthenticationBackend'</code><code class="p">,</code>
<code class="p">)</code>

<code class="n">MIDDLEWARE_CLASSES</code> <code class="o">=</code> <code class="p">(</code>
<code class="p">[</code><code class="o">...</code><code class="p">]</code></pre>
          <p class="sourcecode" title="superlists/settings.py"> </p>
          <p>And a quick <code class="literal">makemigrations</code> to make the new user model real:</p>
          <pre class="screen">$ <span class="strong"><strong>python3 manage.py makemigrations</strong></span>
Migrations for 'accounts':
  0001_initial.py:
    - Create model ListUser</pre>
          <p>And a <code class="literal">migrate</code> to build the database:</p>
          <pre class="screen">$ <span class="strong"><strong>python3 manage.py migrate</strong></span>
[...]
Running migrations:
  Applying accounts.0001_initial... OK</pre>
          <p>And we should be all done! Why not spin up a dev server with <code class="literal">runserver</code> and see how it all looks (<a class="xref" href="ch15.html#persona-login-working" title="Figure&nbsp;15-1.&nbsp;It works! It works! Mwahahahaha.">Figure&nbsp;15-1</a>)?</p>
          <div class="figure">
           <a id="persona-login-working"></a>
           <div class="figure-contents">
            <div class="mediaobject">
             <img src="/library/view/test-driven-development-with/9781449365141/images/twdp_1501.png.jpg" alt="The Persona login screen" width="800" height="595">
            </div>
           </div>
           <div class="figure-title">
            Figure&nbsp;15-1.&nbsp;It works! It works! Mwahahahaha.
           </div>
          </div>
          <p><a id="id691426" class="indexterm"></a> That’s pretty much it! Along the way, I had to fight pretty hard, including debugging Ajax requests by hand in the Firefox console (see <a class="xref" href="ch15.html#debugging-ajax" title="Figure&nbsp;15-2.&nbsp;Debugging Ajax requests in the Firefox network console">Figure&nbsp;15-2</a>), catching infinite page-refresh loops, stumbling over several missing attributes on my custom user model (because I didn’t read the docs properly), and even one point switching to the dev version of Django to overcome a bug, which thankfully turned out to be irrelevant. <a id="id691461" class="indexterm"></a> <a id="id691468" class="indexterm"></a></p>
          <div class="figure">
           <a id="debugging-ajax"></a>
           <div class="figure-contents">
            <div class="mediaobject">
             <img src="/library/view/test-driven-development-with/9781449365141/images/twdp_1502.png.jpg" alt="Shows the Firefox debug console open on the network tab" width="1000" height="749">
            </div>
           </div>
           <div class="figure-title">
            Figure&nbsp;15-2.&nbsp;Debugging Ajax requests in the Firefox network console
           </div>
          </div>
          <div class="tip" title="Tip">
           <h3 class="title">Tip</h3>
           <p>If it’s not working when you try it manually, and you see “audience mismatch” errors in the console, make sure you’re visiting the site via <span class="emphasis"><em>http://localhost:8000</em></span>, and not <span class="emphasis"><em>127.0.0.1</em></span>. <a id="id691498" class="indexterm"></a></p>
          </div>
          <div class="sidebar">
           <div class="sidebar-title">
            Aside: Logging to stderr
           </div>
           <p>While spiking, it’s pretty critical to be able to see exceptions that are being generated by your code. Annoyingly, Django doesn’t send all exceptions to the terminal by default, but you can make it do so with a variable called <code class="literal">LOGGING</code> in <span class="emphasis"><em>settings.py</em></span>:</p>
           <p class="sourcecode" title="superlists/settings.py (ch15l011)"><span class="title"><strong>superlists/settings.py (ch15l011)</strong></span>.&nbsp; </p>
           <pre class="programlisting"><code class="n">LOGGING</code> <code class="o">=</code> <code class="p">{</code>
    <code class="s">'version'</code><code class="p">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s">'disable_existing_loggers'</code><code class="p">:</code> <code class="bp">False</code><code class="p">,</code>
    <code class="s">'handlers'</code><code class="p">:</code> <code class="p">{</code>
        <code class="s">'console'</code><code class="p">:</code> <code class="p">{</code>
            <code class="s">'level'</code><code class="p">:</code> <code class="s">'DEBUG'</code><code class="p">,</code>
            <code class="s">'class'</code><code class="p">:</code> <code class="s">'logging.StreamHandler'</code><code class="p">,</code>
        <code class="p">},</code>
    <code class="p">},</code>
    <code class="s">'loggers'</code><code class="p">:</code> <code class="p">{</code>
        <code class="s">'django'</code><code class="p">:</code> <code class="p">{</code>
            <code class="s">'handlers'</code><code class="p">:</code> <code class="p">[</code><code class="s">'console'</code><code class="p">],</code>
        <code class="p">},</code>
    <code class="p">},</code>
    <code class="s">'root'</code><code class="p">:</code> <code class="p">{</code><code class="s">'level'</code><code class="p">:</code> <code class="s">'INFO'</code><code class="p">},</code>
<code class="p">}</code></pre>
           <p class="sourcecode" title="superlists/settings.py (ch15l011)"> </p>
           <p>Django uses the rather “enterprisey” logging package from the Python standard library, which, although very fully featured, does suffer from a fairly steep learning curve. It’s covered a little more in <a class="xref" href="ch17.html" title="Chapter&nbsp;17.&nbsp;Test Fixtures, Logging, and Server-Side Debugging">Chapter&nbsp;17</a>, and in the <a class="ulink" href="https://docs.djangoproject.com/en/1.7/topics/logging/" target="_top">Django docs</a>.</p>
          </div>
          <p>But we now have a working solution! Let’s commit it on our spike branch: <a id="id632670" class="indexterm"></a></p>
          <pre class="screen">$ <span class="strong"><strong>git status</strong></span>
$ <span class="strong"><strong>git add accounts</strong></span>
$ <span class="strong"><strong>git commit -am "spiked in custom auth backend with persona"</strong></span></pre>
          <p>Time to de-spike!</p>
         </div>
        </div>
        <div class="sect1" title="De-spiking">
         <div class="titlepage">
          <div>
           <div>
            <h2 class="title" style="clear: both" id="_de_spiking">De-spiking</h2>
           </div>
          </div>
         </div>
         <p><a id="id632717" class="indexterm"></a> <a id="id661765" class="indexterm"></a> <a id="id661775" class="indexterm"></a> <a id="id661787" class="indexterm"></a> De-spiking means rewriting your prototype code using TDD. We now have enough information to “do it properly”. So what’s the first step? An FT of course!</p>
         <p>We’ll stay on the spike branch for now, to see our FT pass against our spiked code. Then we’ll go back to master, and commit just the FT.</p>
         <p>Here’s the basic outline:</p>
         <p class="sourcecode" title="functional_tests/test_login.py"><span class="title"><strong>functional_tests/test_login.py</strong></span>.&nbsp; </p>
         <pre class="programlisting"><code class="kn">from</code> <code class="nn">.base</code> <code class="kn">import</code> <code class="n">FunctionalTest</code>

<code class="k">class</code> <code class="nc">LoginTest</code><code class="p">(</code><code class="n">FunctionalTest</code><code class="p">):</code>

    <code class="k">def</code> <code class="nf">test_login_with_persona</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="c"># Edith goes to the awesome superlists site</code>
        <code class="c"># and notices a "Sign in" link for the first time.</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">server_url</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element_by_id</code><code class="p">(</code><code class="s">'login'</code><code class="p">)</code><code class="o">.</code><code class="n">click</code><code class="p">()</code>

        <code class="c"># A Persona login box appears</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">switch_to_new_window</code><code class="p">(</code><code class="s">'Mozilla Persona'</code><code class="p">)</code>  <code class="c">#</code><a id="CO30-1"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12">

        <code class="c"># Edith logs in with her email address</code>
        <code class="c">## Use mockmyid.com for test email</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element_by_id</code><code class="p">(</code>
            <code class="s">'authentication_email'</code>  <code class="c">#</code><a id="CO30-2"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12">
        <code class="p">)</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="s">'edith@mockmyid.com'</code><code class="p">)</code> <code class="c">#</code><a id="CO30-3"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/3.png" alt="3" width="12" height="12">
        <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element_by_tag_name</code><code class="p">(</code><code class="s">'button'</code><code class="p">)</code><code class="o">.</code><code class="n">click</code><code class="p">()</code>

        <code class="c"># The Persona window closes</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">switch_to_new_window</code><code class="p">(</code><code class="s">'To-Do'</code><code class="p">)</code>

        <code class="c"># She can see that she is logged in</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">wait_for_element_with_id</code><code class="p">(</code><code class="s">'logout'</code><code class="p">)</code>  <code class="c">#</code><a id="CO30-4"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/4.png" alt="4" width="12" height="12">
        <code class="n">navbar</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element_by_css_selector</code><code class="p">(</code><code class="s">'.navbar'</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertIn</code><code class="p">(</code><code class="s">'edith@mockmyid.com'</code><code class="p">,</code> <code class="n">navbar</code><code class="o">.</code><code class="n">text</code><code class="p">)</code></pre>
         <p class="sourcecode" title="functional_tests/test_login.py"> </p>
         <div class="calloutlist">
          <dl>
           <dt>
            <a href="#CO30-1"><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12"></a> 
            <a href="#CO30-4"><img src="/library/view/test-driven-development-with/9781449365141/callouts/4.png" alt="4" width="12" height="12"></a> 
           </dt>
           <dd>
            <p> The FT needs a couple of helper functions, both of which do something that’s very common in Selenium testing: they wait for something to happen. Listings for them follow. </p>
           </dd>
           <dt>
            <a href="#CO30-2"><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12"></a> 
           </dt>
           <dd>
            <p> I found the ID of the Persona login box by opening the site manually, and using the Firefox debug toolbar (Ctrl+Shift+I). See <a class="xref" href="ch15.html#firefox-debug-persona" title="Figure&nbsp;15-3.&nbsp;Using the Debug toolbar to find locators">Figure&nbsp;15-3</a>. </p>
           </dd>
           <dt>
            <a href="#CO30-3"><img src="/library/view/test-driven-development-with/9781449365141/callouts/3.png" alt="3" width="12" height="12"></a> 
           </dt>
           <dd>
            <p> Rather than using a “real” email address and having to click through their authentication screens, we use a “fake” provider. <a class="ulink" href="http://mockmyid.com" target="_top">MockMyID</a> is one; you can also check out <a class="ulink" href="http://personatestuser.org" target="_top">Persona Test User</a>. <a id="id629932" class="indexterm"></a> <a id="id629940" class="indexterm"></a> </p>
           </dd>
          </dl>
         </div>
         <div class="sidebar">
          <div class="sidebar-title">
           Evaluate Third-Party Systems’ Test Infrastructure
          </div>
          <p><a id="id629963" class="indexterm"></a> <a id="id629972" class="indexterm"></a> Testing should be part of how you evaluate third-party systems. When you integrate with an external service, you’re going to have to think through how you’re going to work with it in your functional tests.</p>
          <p>Often you can just use the same service in your tests and in “real life”. But sometimes you’re going to want to run against a “test” version of the third-party service. In the case of this integration with Persona, we could have used a “real” email address; when I first wrote this chapter, I actually had an FT that clicked through to Yahoo.com, and logged in with a throwaway account I’d created. The problem is that it made the FT totally reliant on particular details of Yahoo’s email login screens, which can change at any time.</p>
          <p>Instead, MockMyID and PersonaTestUser are both linked to from the Persona documentation, and they work very smoothly, letting us test just the important parts of the integration.</p>
          <p>Perhaps more critically, think about payment systems. If you start integrating payments, they’re going to be one of the most important parts of your site, and you’re going to want to make sure they’re tested thoroughly … but you don’t want to be putting actual transactions on real credit cards through, every time you run an FT! So most providers will provide a “test” version of their payments API. These vary in quality (naming no names), so make sure you investigate them thoroughly.</p>
         </div>
         <div class="figure">
          <a id="firefox-debug-persona"></a>
          <div class="figure-contents">
           <div class="mediaobject">
            <img src="/library/view/test-driven-development-with/9781449365141/images/twdp_1503.png" alt="The Firefox debug toolbar open on the Persona screen" width="804" height="721">
           </div>
          </div>
          <div class="figure-title">
           Figure&nbsp;15-3.&nbsp;Using the Debug toolbar to find locators
          </div>
         </div>
         <div class="sect2" title="A Common Selenium Technique: Explicit Waits">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_a_common_selenium_technique_explicit_waits">A Common Selenium Technique: Explicit Waits</h3>
            </div>
           </div>
          </div>
          <p><a id="id630067" class="indexterm"></a> <a id="id630020" class="indexterm"></a> <a id="id630027" class="indexterm"></a> Here’s the first of the two “wait” helper functions:</p>
          <p class="dofirst-ch15l013 sourcecode" title="functional_tests/test_login.py (ch15l014)"><span class="title"><strong>functional_tests/test_login.py (ch15l014)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kn">import</code> <code class="nn">time</code>
<code class="p">[</code><code class="o">...</code><code class="p">]</code>

    <code class="k">def</code> <code class="nf">switch_to_new_window</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">text_in_title</code><code class="p">):</code>
        <code class="n">retries</code> <code class="o">=</code> <code class="mi">60</code>
        <code class="k">while</code> <code class="n">retries</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">for</code> <code class="n">handle</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">window_handles</code><code class="p">:</code>
                <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">switch_to_window</code><code class="p">(</code><code class="n">handle</code><code class="p">)</code>
                <code class="k">if</code> <code class="n">text_in_title</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">title</code><code class="p">:</code>
                    <code class="k">return</code>
            <code class="n">retries</code> <code class="o">-=</code> <code class="mi">1</code>
            <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mf">0.5</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">fail</code><code class="p">(</code><code class="s">'could not find window'</code><code class="p">)</code></pre>
          <p class="dofirst-ch15l013 sourcecode" title="functional_tests/test_login.py (ch15l014)"> </p>
          <p>In this one we’ve “rolled our own” wait—we iterate through all the current browser windows, looking for one with a particular title. If we can’t find it, we do a short wait, and try again, decrementing a retry counter.</p>
          <p>This is such a common pattern in Selenium tests that the team created an API for waiting—it doesn’t quite handle all use cases though, so that’s why we had to roll our own the first time around. When doing something simpler like waiting for an element with a given ID to appear on the page, we can use the <code class="literal">WebDriverWait</code> class:</p>
          <p class="sourcecode" title="functional_tests/test_login.py (ch15l015)"><span class="title"><strong>functional_tests/test_login.py (ch15l015)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kn">from</code> <code class="nn">selenium.webdriver.support.ui</code> <code class="kn">import</code> <code class="n">WebDriverWait</code>
<code class="p">[</code><code class="o">...</code><code class="p">]</code>

    <code class="k">def</code> <code class="nf">wait_for_element_with_id</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">element_id</code><code class="p">):</code>
        <code class="n">WebDriverWait</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="p">,</code> <code class="n">timeout</code><code class="o">=</code><code class="mi">30</code><code class="p">)</code><code class="o">.</code><code class="n">until</code><code class="p">(</code>
            <code class="k">lambda</code> <code class="n">b</code><code class="p">:</code> <code class="n">b</code><code class="o">.</code><code class="n">find_element_by_id</code><code class="p">(</code><code class="n">element_id</code><code class="p">)</code>
        <code class="p">)</code></pre>
          <p class="sourcecode" title="functional_tests/test_login.py (ch15l015)"> </p>
          <p>This is what Selenium calls an “explicit wait”. If you remember, we already defined an “implicit wait” in <code class="literal">FunctionalTest.setUp</code>. We set that to just three seconds, which is fine in most cases, but when we’re waiting for an external service like Persona, we sometimes need to bump that default timeout.</p>
          <p>There are more examples in the <a class="ulink" href="http://docs.seleniumhq.org/docs/04_webdriver_advanced.jsp" target="_top">Selenium docs</a>, but I actually found reading the <a class="ulink" href="http://code.google.com/p/selenium/source/browse/py/selenium/webdriver/support/wait.py" target="_top">source code</a> more instructive—there are good docstrings!</p>
          <div class="tip" title="Tip">
           <h3 class="title">Tip</h3>
           <p><code class="literal">implicitly_wait</code> is unreliable, especially once JavaScript is involved. Prefer the “wait-for” pattern in your FT whenever you need to check for asynchronous interactions on your pages. We’ll see this again in <a class="xref" href="ch20.html" title="Chapter&nbsp;20.&nbsp;Continuous Integration (CI)">Chapter&nbsp;20</a>.</p>
          </div>
          <p>And if we run the FT, it works!</p>
          <pre class="screen">$ <span class="strong"><strong>python3 manage.py test functional_tests.test_login</strong></span>
Creating test database for alias 'default'...
Not Found: /favicon.ico
login view
sending to mozilla {'assertion': [...]
[...]

got b'{"audience":"localhost","expires":[...]
[...]

.
 ---------------------------------------------------------------------
Ran 1 test in 32.222s

OK
Destroying test database for alias 'default'...</pre>
          <p>You can even see some of the debug output I left in my spiked view implementations. Now it’s time to revert all of our temporary changes, and reintroduce them one by one in a test-driven way.</p>
         </div>
         <div class="sect2" title="Reverting Our Spiked Code">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_reverting_our_spiked_code">Reverting Our Spiked Code</h3>
            </div>
           </div>
          </div>
          <pre class="screen">$ <span class="strong"><strong>git checkout master</strong></span> # switch back to master branch
$ <span class="strong"><strong>rm -rf accounts</strong></span> # remove any trace of spiked code
$ <span class="strong"><strong>git add functional_tests/test_login.py</strong></span>
$ <span class="strong"><strong>git commit -m "FT for login with Persona"</strong></span></pre>
          <p>Now we rerun the FT and let it drive our development:</p>
          <pre class="screen">$ <span class="strong"><strong>python3 manage.py test functional_tests.test_login</strong></span>
selenium.common.exceptions.NoSuchElementException: Message: 'Unable to locate
element: {"method":"id","selector":"login"}' ; Stacktrace:
[...]</pre>
          <p>The first thing it wants us to do is add a login link. Incidentally, I prefer prefixing HTML IDs with <code class="literal">id_</code>; it’s a convention to make it easy to tell the difference between classes and IDs in HTML and CSS. So let’s tweak the FT first:</p>
          <p class="sourcecode" title="functional_tests/test_login.py (ch15l017)"><span class="title"><strong>functional_tests/test_login.py (ch15l017)</strong></span>.&nbsp; </p>
          <pre class="programlisting">    <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element_by_id</code><code class="p">(</code><code class="s">'id_login'</code><code class="p">)</code><code class="o">.</code><code class="n">click</code><code class="p">()</code>
    <code class="p">[</code><code class="o">...</code><code class="p">]</code>
    <code class="bp">self</code><code class="o">.</code><code class="n">wait_for_element_with_id</code><code class="p">(</code><code class="s">'id_logout'</code><code class="p">)</code></pre>
          <p class="sourcecode" title="functional_tests/test_login.py (ch15l017)"> </p>
          <p>Next a “do-nothing” login link. Bootstrap has some built-in classes for navigation bars, so we’ll use them:</p>
          <p class="sourcecode" title="lists/templates/base.html"><span class="title"><strong>lists/templates/base.html</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"container"</code><code class="nt">&gt;</code>

    <code class="nt">&lt;nav</code> <code class="na">class=</code><code class="s">"navbar navbar-default"</code> <code class="na">role=</code><code class="s">"navigation"</code><code class="nt">&gt;</code>
        <code class="nt">&lt;a</code> <code class="na">class=</code><code class="s">"navbar-brand"</code> <code class="na">href=</code><code class="s">"/"</code><code class="nt">&gt;</code>Superlists<code class="nt">&lt;/a&gt;</code>
        <code class="nt">&lt;a</code> <code class="na">class=</code><code class="s">"btn navbar-btn navbar-right"</code> <code class="na">id=</code><code class="s">"id_login"</code> <code class="na">href=</code><code class="s">"#"</code><code class="nt">&gt;</code>Sign in<code class="nt">&lt;/a&gt;</code>
    <code class="nt">&lt;/nav&gt;</code>

    <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"row"</code><code class="nt">&gt;</code>
    [...]</pre>
          <p class="sourcecode" title="lists/templates/base.html"> </p>
          <p>After 30 seconds, that gives:</p>
          <pre class="screen">AssertionError: could not find window</pre>
          <p>License to move on! Next thing: more JavaScript. <a id="id468978" class="indexterm"></a> <a id="id468971" class="indexterm"></a></p>
         </div>
        </div>
        <div class="sect1" title="JavaScript Unit Tests Involving External Components: Our First Mocks!">
         <div class="titlepage">
          <div>
           <div>
            <h2 class="title" style="clear: both" id="_javascript_unit_tests_involving_external_components_our_first_mocks">JavaScript Unit Tests Involving External Components: Our First Mocks!</h2>
           </div>
          </div>
         </div>
         <p>To get our FT further, we’re going to need to get the Persona window to pop up. For that, we’ll need to de-spike our client-side JavaScript code that uses the Persona libraries. We’ll test-drive that using JavaScript unit tests and mocking.</p>
         <div class="sect2" title="Housekeeping: A Site-Wide Static Files Folder">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_housekeeping_a_site_wide_static_files_folder">Housekeeping: A Site-Wide Static Files Folder</h3>
            </div>
           </div>
          </div>
          <p><a id="id469006" class="indexterm"></a> A bit of housekeeping first: create a site-wide static files directory inside <span class="emphasis"><em>superlists/superlists</em></span>, and move all the Bootsrap CSS, QUnit code, and <span class="emphasis"><em>base.css</em></span> into it, so it looks like this:</p>
          <pre class="screen">$ <span class="strong"><strong>tree superlists -L 3 -I __pycache__</strong></span>
superlists
??? __init__.py
??? settings.py
??? static
?&nbsp;&nbsp; ??? base.css
?&nbsp;&nbsp; ??? bootstrap
?&nbsp;&nbsp; ?&nbsp;&nbsp; ??? css
?&nbsp;&nbsp; ?&nbsp;&nbsp; ??? fonts
?&nbsp;&nbsp; ?&nbsp;&nbsp; ??? js
?&nbsp;&nbsp; ??? tests
?&nbsp;&nbsp;     ??? qunit.css
?&nbsp;&nbsp;     ??? qunit.js
??? urls.py
??? wsgi.py

6 directories, 7 files</pre>
          <div class="tip" title="Tip">
           <h3 class="title">Tip</h3>
           <p>Always do a commit before and after a bit of housekeeping like this.</p>
          </div>
          <p>That means adjusting our existing JavaScript unit tests:</p>
          <p class="sourcecode" title="lists/static/tests/tests.html (ch15l020)"><span class="title"><strong>lists/static/tests/tests.html (ch15l020)</strong></span>.&nbsp; </p>
          <pre class="programlisting">    <code class="nt">&lt;link</code> <code class="na">rel=</code><code class="s">"stylesheet"</code> <code class="na">href=</code><code class="s">"../../../superlists/static/tests/qunit.css"</code><code class="nt">&gt;</code>

    [...]

    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"http://code.jquery.com/jquery.min.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"../../../superlists/static/tests/qunit.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"../list.js"</code><code class="nt">&gt;&lt;/script&gt;</code></pre>
          <p class="sourcecode" title="lists/static/tests/tests.html (ch15l020)"> </p>
          <p>And we check they still work, by opening them up in a browser:</p>
          <pre class="screen">2 assertions of 2 passed, 0 failed.</pre>
          <p>Here’s how we tell our settings file about the new static folder:</p>
          <p class="sourcecode" title="superlists/settings.py"><span class="title"><strong>superlists/settings.py</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="p">[</code><code class="o">...</code><code class="p">]</code>
<code class="n">STATIC_ROOT</code> <code class="o">=</code> <code class="n">os</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">BASE_DIR</code><code class="p">,</code> <code class="s">'../static'</code><code class="p">)</code>
<code class="n">STATICFILES_DIRS</code> <code class="o">=</code> <code class="p">(</code>
    <code class="n">os</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">BASE_DIR</code><code class="p">,</code> <code class="s">'superlists'</code><code class="p">,</code> <code class="s">'static'</code><code class="p">),</code>
<code class="p">)</code></pre>
          <p class="sourcecode" title="superlists/settings.py"> </p>
          <div class="note" title="Note">
           <h3 class="title">Note</h3>
           <p>I recommend reintroducing the <code class="literal">LOGGING</code> setting from earlier at this point. There’s no need for an explicit test for it; our current test suite will let us know in the unlikely event that it breaks anything. As we’ll find out in <a class="xref" href="ch17.html" title="Chapter&nbsp;17.&nbsp;Test Fixtures, Logging, and Server-Side Debugging">Chapter&nbsp;17</a>, it’ll be useful for debugging later.</p>
          </div>
          <p>And we can quickly run the layout + styling FT to check the CSS all still works:</p>
          <pre class="screen">$ <span class="strong"><strong>python3 manage.py test functional_tests.test_layout_and_styling</strong></span>
[...]
OK</pre>
          <p>Next, create an app called <code class="literal">accounts</code> to hold all the code related to login. That will include our Persona JavaScript stuff:</p>
          <pre class="screen">$ <span class="strong"><strong>python3 manage.py startapp accounts</strong></span>
$ <span class="strong"><strong>mkdir -p accounts/static/tests</strong></span></pre>
          <p>That’s the housekeeping done. Now’s a good time for a commit. Then, let’s take another look at our spiked-in javascript:</p>
          <pre class="programlisting"><code class="kd">var</code> <code class="nx">loginLink</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'login'</code><code class="p">);</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">loginLink</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">loginLink</code><code class="p">.</code><code class="nx">onclick</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">request</code><code class="p">();</code> <code class="p">};</code>
<code class="p">}</code></pre>
         </div>
         <div class="sect2" title="Mocking: Who, Why, What?">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_mocking_who_why_what">Mocking: Who, Why, What?</h3>
            </div>
           </div>
          </div>
          <p><a id="ix_mockingjava" class="indexterm"></a> We want our login link’s on-click to be bound to a function provided by the Persona library, <code class="literal">navigator.id.request</code>.</p>
          <p>Now we don’t want to call the <span class="emphasis"><em>actual</em></span> third-party function in our unit tests, because we don’t want our unit tests popping up Persona windows all over the shop. So instead, we are going to do what’s called “mocking it out”: creating a “fake” or “mock” implementation of the third-party API for our tests to run against.</p>
          <p>What we’re going to do is replace the real <code class="literal">navigator</code> object with a <span class="emphasis"><em>fake</em></span> one that we’ve built ourselves, one that will be able to tell us what happens to it.</p>
          <div class="note" title="Note">
           <h3 class="title">Note</h3>
           <p>I had hoped that our first Mock example was going to be in Python, but it looks like it’s going to be JavaScript instead. Needs must. You may find it’s worth rereading the rest of the chapter a couple of times after you get to the end of it, to let it all sink in.</p>
          </div>
         </div>
         <div class="sect2" title="Namespacing">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_namespacing">Namespacing</h3>
            </div>
           </div>
          </div>
          <p><a id="id552987" class="indexterm"></a> <a id="id552994" class="indexterm"></a> In the context of <span class="emphasis"><em>base.html</em></span>, <code class="literal">navigator</code> is just an object in the global scope, as provided by the <span class="emphasis"><em>include.js</em></span> <code class="literal">&lt;script&gt;</code> tag that we get from Mozilla. Testing global variables is a pain though, so we can turn it into a local variable by passing it into an “initialize”<sup>[<a id="id552955" href="#ftn.id552955" epub:type="noteref" class="footnote">20</a>]</sup> function. The code we’ll end up with in <span class="emphasis"><em>base.html</em></span> will look like this:</p>
          <p class="sourcecode skipme" title="lists/templates/base.html"><span class="title"><strong>lists/templates/base.html</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"/static/accounts/accounts.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script&gt;</code>
    <code class="nx">$</code><code class="p">(</code><code class="nb">document</code><code class="p">).</code><code class="nx">ready</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>

        <code class="nx">Superlists</code><code class="p">.</code><code class="nx">Accounts</code><code class="p">.</code><code class="nx">initialize</code><code class="p">(</code><code class="nx">navigator</code><code class="p">)</code>

    <code class="p">});</code>
<code class="nt">&lt;/script&gt;</code></pre>
          <p class="sourcecode skipme" title="lists/templates/base.html"> </p>
          <p>I’ve specified that our <code class="literal">initialize</code> function will be <span class="emphasis"><em>namespaced</em></span> inside some nested objects, <code class="literal">Superlists.Accounts</code>. JavaScript suffers from a programming model that’s tied into a global scope, and this sort of namespacing/naming convention helps to keep things under control. Lots of JavaScript libraries might want to call a function <code class="literal">initialize</code>, but very few will call it <code class="literal">Superlists.Accounts.initialize</code>!<sup>[<a id="id553170" href="#ftn.id553170" epub:type="noteref" class="footnote">21</a>]</sup></p>
          <p>This call to <code class="literal">initialize</code> is simple enough that I’m happy it doesn’t need any unit tests of its own.</p>
         </div>
         <div class="sect2" title="A Simple Mock to Unit Tests Our initialize Function">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_a_simple_mock_to_unit_tests_our_initialize_function">A Simple Mock to Unit Tests Our initialize Function</h3>
            </div>
           </div>
          </div>
          <p><a id="ix_mockinginitialize" class="indexterm"></a> The <code class="literal">initialize</code> function itself we <span class="emphasis"><em>will</em></span> test. Copy the lists tests across to get the boilerplate HTML, and then adjust the following:</p>
          <p class="dofirst-ch15l023 sourcecode" title="accounts/static/tests/tests.html"><span class="title"><strong>accounts/static/tests/tests.html</strong></span>.&nbsp; </p>
          <pre class="programlisting">    <code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"qunit-fixture"</code><code class="nt">&gt;</code>
        <code class="nt">&lt;a</code> <code class="na">id=</code><code class="s">"id_login"</code><code class="nt">&gt;</code>Sign in<code class="nt">&lt;/a&gt;</code>
    <code class="nt">&lt;/div&gt;</code>

    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"http://code.jquery.com/jquery.min.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"../../../superlists/static/tests/qunit.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"../accounts.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
    <code class="nt">&lt;script&gt;</code>
/*global $, test, equal, sinon, Superlists */

test("initialize binds sign in button to navigator.id.request", function () {
    var requestWasCalled = false; //<a id="CO31-1"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12">
    var mockRequestFunction = function () { requestWasCalled = true; }; //<a id="CO31-2"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12">
    var mockNavigator = { //<a id="CO31-3"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/3.png" alt="3" width="12" height="12">
        id: {
            request: mockRequestFunction
        }
    };

    Superlists.Accounts.initialize(mockNavigator); //<a id="CO31-4"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/4.png" alt="4" width="12" height="12">

    $('#id_login').trigger('click'); //<a id="CO31-5"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/5.png" alt="5" width="12" height="12">

    equal(requestWasCalled, true); //<a id="CO31-6"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/6.png" alt="6" width="12" height="12">
});

    <code class="nt">&lt;/script&gt;</code></pre>
          <p class="dofirst-ch15l023 sourcecode" title="accounts/static/tests/tests.html"> </p>
          <p>One of the best ways to understand this test, or indeed any test, is to work backwards. The first thing we see is the assertion:</p>
          <div class="calloutlist">
           <dl>
            <dt>
             <a href="#CO31-6"><img src="/library/view/test-driven-development-with/9781449365141/callouts/6.png" alt="6" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> We are asserting that a variable called <code class="literal">requestWasCalled</code> is <code class="literal">true</code>. We’re checking that, one way or another, the <code class="literal">request</code> function, as in <code class="literal">navigator.id.request</code>, was called. </p>
            </dd>
            <dt>
             <a href="#CO31-5"><img src="/library/view/test-driven-development-with/9781449365141/callouts/5.png" alt="5" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> Called when? When a click event happens to the <code class="literal">id_login</code> element. </p>
            </dd>
            <dt>
             <a href="#CO31-4"><img src="/library/view/test-driven-development-with/9781449365141/callouts/4.png" alt="4" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> Before we trigger that click event, we call our <code class="literal">Superlists.Accounts.initialize</code> function, just like we will on the real page. The only difference is, instead of passing it the real global <code class="literal">navigator</code> object from Persona, we pass in a fake one called <code class="literal">mockNavigator</code>.<sup>[<a id="id588279" href="#ftn.id588279" class="footnote">22</a>]</sup> </p>
            </dd>
            <dt>
             <a href="#CO31-3"><img src="/library/view/test-driven-development-with/9781449365141/callouts/3.png" alt="3" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> That’s defined as a generic JavaScript object, with an attribute called <code class="literal">id</code> which in turn has an attribute called <code class="literal">request</code>, which we’re assigning to a variable called <code class="literal">mockRequestFunction</code>. </p>
            </dd>
            <dt>
             <a href="#CO31-2"><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> <code class="literal">mockRequestFunction</code> we define as a very simple function, which if called will simply set the value of the <code class="literal">requestWasCalled</code> variable to <code class="literal">true</code>. </p>
            </dd>
            <dt>
             <a href="#CO31-1"><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> And finally (firstly?) we make sure that <code class="literal">requestWasCalled</code> starts out as <code class="literal">false</code>. </p>
            </dd>
           </dl>
          </div>
          <p>The upshot of all this is: the only way this test will pass is if our <code class="literal">initialize</code> function binds the <code class="literal">click</code> event on <code class="literal">id_login</code> to the method <code class="literal">.id.request</code> of the object we pass it. If we get the tests passing when we use the mock object, we are reassured that our <code class="literal">initialize</code> function will also do the right thing when we give it a real object on our real page.</p>
          <p>Does that make sense? Let’s play around with the test and see if we can get the hang of it.</p>
          <div class="tip" title="Tip">
           <h3 class="title">Tip</h3>
           <p>When testing events on DOM elements, you need an actual element to trigger events against, and to register listeners on. If you forget, it’s a particularly fiendish test bug, because <code class="literal">.trigger</code> will just silently no-op, and you’ll be left scratching your head about why it’s not working. So don’t forget to add the <code class="literal">&lt;div id="id_login"&gt;</code> inside the <code class="literal">qunit-fixture</code> div!</p>
          </div>
          <p>Our first error is this:</p>
          <pre class="screen">1. Died on test #1
@file:///workspace/superlists/accounts/static/tests/tests.html:35:
Superlists is not defined</pre>
          <p>That’s the equivalent of an <code class="literal">ImportError</code> in Python. Let’s start work on <span class="emphasis"><em>accounts/static/accounts.js</em></span>:</p>
          <p class="sourcecode" title="accounts/static/accounts.js"><span class="title"><strong>accounts/static/accounts.js</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="nb">window</code><code class="p">.</code><code class="nx">Superlists</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js"> </p>
          <p>Just as in Python we might do <code class="literal">Superlists = None</code>, here we do <code class="literal">window.Superlists = null</code>. Using <code class="literal">window.</code> makes sure we get the global object:</p>
          <pre class="screen">1. Died on test #1
@file:///workspace/superlists/accounts/static/tests/tests.html:35:
Superlists is null</pre>
          <p>OK, next baby step or two:</p>
          <p class="sourcecode" title="accounts/static/accounts.js"><span class="title"><strong>accounts/static/accounts.js</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="nb">window</code><code class="p">.</code><code class="nx">Superlists</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">Accounts</code><code class="o">:</code> <code class="p">{}</code>
<code class="p">};</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js"> </p>
          <p>gives:<sup>[<a id="id606469" href="#ftn.id606469" epub:type="noteref" class="footnote">23</a>]</sup></p>
          <pre class="screen">Superlists.Accounts.initialize is not a function</pre>
          <p>So let’s make it a function:</p>
          <p class="sourcecode" title="accounts/static/accounts.js"><span class="title"><strong>accounts/static/accounts.js</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="nb">window</code><code class="p">.</code><code class="nx">Superlists</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">Accounts</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">initialize</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{}</code>
    <code class="p">}</code>
<code class="p">};</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js"> </p>
          <p>And now we get a real test failure instead of just errors:</p>
          <pre class="screen">1. initialize binds sign in button to navigator.id.request (1, 0, 1)

    1. failed
        Expected: true
        Result: false</pre>
          <p>Next—let’s separate defining our <code class="literal">initialize</code> function from the part where we export it into the <code class="literal">Superlists</code> namespace. We’ll also do a <code class="literal">console.log</code>, which is the JavaScript equivalent of a debug-print, to take a look at what the initialize function is being called with:</p>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l028)"><span class="title"><strong>accounts/static/accounts.js (ch15l028)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kd">var</code> <code class="nx">initialize</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">navigator</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">navigator</code><code class="p">);</code>
<code class="p">};</code>

<code class="nb">window</code><code class="p">.</code><code class="nx">Superlists</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">Accounts</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">initialize</code><code class="o">:</code> <code class="nx">initialize</code>
    <code class="p">}</code>
<code class="p">};</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l028)"> </p>
          <p><a id="id606648" class="indexterm"></a> <a id="id671692" class="indexterm"></a> In Firefox and I believe Chrome also, you can use the shortcut Ctrl-Shift-I to bring up the JavaScript console, and see the [object Object] that was logged (see <a class="xref" href="ch15.html#javascript-console" title="Figure&nbsp;15-4.&nbsp;Debugging in the JavaScript console">Figure&nbsp;15-4</a>). If you click on it, you can see it has the properties we defined in our test: an <code class="literal">id</code>, and inside that, a function called <code class="literal">request</code>.</p>
          <div class="figure">
           <a id="javascript-console"></a>
           <div class="figure-contents">
            <div class="mediaobject">
             <img src="/library/view/test-driven-development-with/9781449365141/images/twdp_1504.png" alt="The JavaScript console in our qunit run, showing the console.log" width="916" height="738">
            </div>
           </div>
           <div class="figure-title">
            Figure&nbsp;15-4.&nbsp;Debugging in the JavaScript console
           </div>
          </div>
          <p>So let’s now just pile in and get the test to pass:</p>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l029)"><span class="title"><strong>accounts/static/accounts.js (ch15l029)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kd">var</code> <code class="nx">initialize</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">navigator</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">request</code><code class="p">();</code>
<code class="p">};</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l029)"> </p>
          <p>That gets the tests to pass, but it’s not quite the implementation we want. We’re calling <code class="literal">navigator.id.request</code> always, instead of only on click. We’ll need to adjust our tests.</p>
          <pre class="screen">1 assertions of 1 passed, 0 failed.
1. initialize binds sign in button to navigator.id.request (0, 1, 1)</pre>
          <p>Before we do, let’s just have a play around to see if we really understand what’s going on. What happens if we do this?</p>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l029-1)"><span class="title"><strong>accounts/static/accounts.js (ch15l029-1)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kd">var</code> <code class="nx">initialize</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">navigator</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">request</code><code class="p">();</code>
    <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">doSomethingElse</code><code class="p">();</code>
<code class="p">};</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l029-1)"> </p>
          <p>We get:</p>
          <pre class="screen">1. Died on test #1
@file:///workspace/superlists/accounts/static/tests/tests.html:35:
navigator.id.doSomethingElse is not a function</pre>
          <p>You see, the mock navigator object that we pass in is entirely under our control. It has only the attributes and methods we give it. You can play around with it now if you like:</p>
          <p class="sourcecode" title="accounts/static/tests/tests.html"><span class="title"><strong>accounts/static/tests/tests.html</strong></span>.&nbsp; </p>
          <pre class="programlisting">    var mockNavigator = {
        id: {
            request: mockRequestFunction,
            doSomethingElse: function () { console.log("called me!");}
        }
    };</pre>
          <p class="sourcecode" title="accounts/static/tests/tests.html"> </p>
          <p>That will give you a pass, and if you open up the debug window, you’ll see:</p>
          <pre class="screen">[01:22:27.456] "called me!"</pre>
          <p>Does that help to see what’s going on? Let’s revert those last two changes, and tweak our unit test so that it checks the <code class="literal">request</code> function is only called <span class="emphasis"><em>after</em></span> we fire off the click event. We also add some error messages to help see which of the two <code class="literal">equal</code> assertions is failing:</p>
          <p class="dofirst-ch15l029-2 sourcecode" title="accounts/static/tests/tests.html (ch15l032)"><span class="title"><strong>accounts/static/tests/tests.html (ch15l032)</strong></span>.&nbsp; </p>
          <pre class="programlisting">    var mockNavigator = {
        id: {
            request: mockRequestFunction
        }
    };
    Superlists.Accounts.initialize(mockNavigator);
    equal(requestWasCalled, false, 'check request not called before click');
    $('#id_login').trigger('click');
    equal(requestWasCalled, true, 'check request called after click');</pre>
          <p class="dofirst-ch15l029-2 sourcecode" title="accounts/static/tests/tests.html (ch15l032)"> </p>
          <div class="note" title="Note">
           <h3 class="title">Note</h3>
           <p>Assertion messages (the third argument to <code class="literal">equal</code>), in QUnit, are actually “success” messages. Rather than only being displayed if the test fails, they are also displayed when the test passes. That’s why they have the positive phrasing. <a id="id500953" class="indexterm"></a> <a id="id500942" class="indexterm"></a></p>
          </div>
          <p>Now we get a neater failure:</p>
          <pre class="screen">1 assertions of 2 passed, 1 failed.
1. initialize binds sign in button to navigator.id.request (1, 1, 2)
    1. check request not called before click
        Expected: false
        Result: true</pre>
          <p>So let’s make it so that the call to <code class="literal">navigator.id.request</code> only happens if our <code class="literal">id_login</code> is clicked:</p>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l033)"><span class="title"><strong>accounts/static/accounts.js (ch15l033)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="cm">/*global $ */</code>

<code class="kd">var</code> <code class="nx">initialize</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">navigator</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">$</code><code class="p">(</code><code class="s1">'#id_login'</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
        <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">request</code><code class="p">();</code>
    <code class="p">});</code>
<code class="p">};</code>
<code class="p">[...]</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l033)"> </p>
          <p>That passes. A good start! Let’s try pulling it into our template:</p>
          <p class="sourcecode" title="lists/templates/base.html"><span class="title"><strong>lists/templates/base.html</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"http://code.jquery.com/jquery.min.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"https://login.persona.org/include.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"/static/accounts.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"/static/list.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script&gt;</code>
    <code class="cm">/*global $, Superlists, navigator */</code>
    <code class="nx">$</code><code class="p">(</code><code class="nb">document</code><code class="p">).</code><code class="nx">ready</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
        <code class="nx">Superlists</code><code class="p">.</code><code class="nx">Accounts</code><code class="p">.</code><code class="nx">initialize</code><code class="p">(</code><code class="nx">navigator</code><code class="p">);</code>
    <code class="p">});</code>
<code class="nt">&lt;/script&gt;</code>
<code class="nt">&lt;/body&gt;</code></pre>
          <p class="sourcecode" title="lists/templates/base.html"> </p>
          <p>We also need to add the <code class="literal">accounts</code> app to <span class="emphasis"><em>settings.py</em></span>, otherwise it won’t be serving the static file at <span class="emphasis"><em>accounts/static/accounts.js</em></span>:</p>
          <p class="sourcecode" title="superlists/settings.py"><span class="title"><strong>superlists/settings.py</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="gi">+++ b/superlists/settings.py</code>
<code class="gu">@@ -37,4 +37,5 @@ INSTALLED_APPS = (</code>
     'lists',
<code class="gi">+    'accounts',</code>
 )</pre>
          <p class="sourcecode" title="superlists/settings.py"> </p>
          <p><a id="id643816" class="indexterm"></a> A quick check on the FT … doesn’t get any further unfortunately. To see why, we can open up the site manually, and check the JavaScript debug console:</p>
          <pre class="screen">[01:36:54.572] Error: navigator.id.watch must be called before
navigator.id.request @ https://login.persona.org/include.js:8</pre>
         </div>
         <div class="sect2" title="More Advanced Mocking">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_more_advanced_mocking">More Advanced Mocking</h3>
            </div>
           </div>
          </div>
          <p>We now need to call Mozilla’s <code class="literal">navigator.id.watch</code> correctly. Taking another look at our spike, it should be something like this:</p>
          <pre class="programlisting"><code class="kd">var</code> <code class="nx">currentUser</code> <code class="o">=</code> <code class="s1">'{{ user.email }}'</code> <code class="o">||</code> <code class="kc">null</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">csrf_token</code> <code class="o">=</code> <code class="s1">'{{ csrf_token }}'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">currentUser</code><code class="p">);</code>

<code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">watch</code><code class="p">({</code>
  <code class="nx">loggedInUser</code><code class="o">:</code> <code class="nx">currentUser</code><code class="p">,</code> <code class="c1">//</code><a id="CO32-1"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12">
  <code class="nx">onlogin</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">assertion</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">$</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/accounts/login'</code><code class="p">,</code> <code class="p">{</code><code class="nx">assertion</code><code class="o">:</code> <code class="nx">assertion</code><code class="p">,</code> <code class="nx">csrfmiddlewaretoken</code><code class="o">:</code> <code class="nx">csrf_token</code><code class="p">})</code> <code class="c1">//</code><a id="CO32-2"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12">
    <code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nb">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">reload</code><code class="p">();</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">fail</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">logout</code><code class="p">();});</code>
  <code class="p">},</code>
  <code class="nx">onlogout</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">$</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/accounts/logout'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">always</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nb">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">reload</code><code class="p">();</code> <code class="p">});</code>
  <code class="p">}</code>
<code class="p">});</code></pre>
          <p><a id="id643868" class="indexterm"></a> Decoding that, the <code class="literal">watch</code> function needs to know a couple of things from the global scope:</p>
          <div class="calloutlist">
           <dl>
            <dt>
             <a href="#CO32-1"><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> The current user’s email, to be passed in as the <code class="literal">loggedInUser</code> parameter to <code class="literal">watch</code>. </p>
            </dd>
            <dt>
             <a href="#CO32-2"><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> The current CSRF token, to pass in the Ajax POST request to the login view.<sup>[<a id="id696437" href="#ftn.id696437" epub:type="noteref" class="footnote">24</a>]</sup> </p>
            </dd>
           </dl>
          </div>
          <p>We’ve also got two hardcoded URLs in there, which would be better to get from Django, something like this:</p>
          <pre class="programlisting"><code class="kd">var</code> <code class="nx">urls</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">login</code><code class="o">:</code> <code class="s2">"{% url 'login' %}"</code><code class="p">,</code>
    <code class="nx">logout</code><code class="o">:</code> <code class="s2">"{% url 'logout' %}"</code><code class="p">,</code>
<code class="p">};</code></pre>
          <p>So that would be a third parameter to pass in from the global scope. We’ve already got an <code class="literal">initialize</code> function, so let’s imagine using it like this:</p>
          <pre class="programlisting"><code class="nx">Superlists</code><code class="p">.</code><code class="nx">Accounts</code><code class="p">.</code><code class="nx">initialize</code><code class="p">(</code><code class="nx">navigator</code><code class="p">,</code> <code class="nx">user</code><code class="p">,</code> <code class="nx">token</code><code class="p">,</code> <code class="nx">urls</code><code class="p">);</code></pre>
          <div class="sect3" title="Using a sinon.js mock to check we call the API correctly">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="_using_a_sinon_js_mock_to_check_we_call_the_api_correctly">Using a sinon.js mock to check we call the API correctly</h4>
             </div>
            </div>
           </div>
           <p><a id="id696625" class="indexterm"></a> <a id="id696639" class="indexterm"></a> “Rolling your own” mocks is possible as we’ve seen, and JavaScript actually makes it relatively easy, but using a mocking library can save us a lot of heavy lifting. The most popular one in the JavaScript world is called <span class="emphasis"><em>sinon.js</em></span>. Let’s download it (from <a class="ulink" href="http://sinonjs.org" target="_top">http://sinonjs.org</a>) and put it in our site-wide static tests folder:</p>
           <pre class="screen">$ <span class="strong"><strong>tree superlists/static/tests/</strong></span>
superlists/static/tests/
??? qunit.css
??? qunit.js
??? sinon.js</pre>
           <p>Next we include it in our accounts tests:</p>
           <p class="sourcecode" title="accounts/static/tests/tests.html"><span class="title"><strong>accounts/static/tests/tests.html</strong></span>.&nbsp; </p>
           <pre class="programlisting">    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"http://code.jquery.com/jquery.min.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"../../../superlists/static/tests/qunit.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"../../../superlists/static/tests/sinon.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"../accounts.js"</code><code class="nt">&gt;&lt;/script&gt;</code></pre>
           <p class="sourcecode" title="accounts/static/tests/tests.html"> </p>
           <p>And now we can write a test that uses Sinon’s mock object:<sup>[<a id="id696784" href="#ftn.id696784" epub:type="noteref" class="footnote">25</a>]</sup></p>
           <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l038)"><span class="title"><strong>accounts/static/tests/tests.html (ch15l038)</strong></span>.&nbsp; </p>
           <pre class="programlisting"><code class="nx">test</code><code class="p">(</code><code class="s2">"initialize calls navigator.id.watch"</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">user</code> <code class="o">=</code> <code class="s1">'current user'</code><code class="p">;</code>
    <code class="kd">var</code> <code class="nx">token</code> <code class="o">=</code> <code class="s1">'csrf token'</code><code class="p">;</code>
    <code class="kd">var</code> <code class="nx">urls</code> <code class="o">=</code> <code class="p">{</code><code class="nx">login</code><code class="o">:</code> <code class="s1">'login url'</code><code class="p">,</code> <code class="nx">logout</code><code class="o">:</code> <code class="s1">'logout url'</code><code class="p">};</code>
    <code class="kd">var</code> <code class="nx">mockNavigator</code> <code class="o">=</code> <code class="p">{</code>
        <code class="nx">id</code><code class="o">:</code> <code class="p">{</code>
            <code class="nx">watch</code><code class="o">:</code> <code class="nx">sinon</code><code class="p">.</code><code class="nx">mock</code><code class="p">()</code> <code class="c1">//</code><a id="CO33-1"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12">
        <code class="p">}</code>
    <code class="p">};</code>

    <code class="nx">Superlists</code><code class="p">.</code><code class="nx">Accounts</code><code class="p">.</code><code class="nx">initialize</code><code class="p">(</code><code class="nx">mockNavigator</code><code class="p">,</code> <code class="nx">user</code><code class="p">,</code> <code class="nx">token</code><code class="p">,</code> <code class="nx">urls</code><code class="p">);</code>

    <code class="nx">equal</code><code class="p">(</code>
        <code class="nx">mockNavigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">watch</code><code class="p">.</code><code class="nx">calledOnce</code><code class="p">,</code> <code class="c1">//</code><a id="CO33-2"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12">
        <code class="kc">true</code><code class="p">,</code>
        <code class="s1">'check watch function called'</code>
    <code class="p">);</code>
<code class="p">});</code></pre>
           <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l038)"> </p>
           <div class="calloutlist">
            <dl>
             <dt>
              <a href="#CO33-1"><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12"></a> 
             </dt>
             <dd>
              <p> We create a mock navigator object as before, but now instead of hand-crafting a function to mock out the function we’re interested in, we use a <code class="literal">sinon.mock()</code> object. </p>
             </dd>
             <dt>
              <a href="#CO33-2"><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12"></a> 
             </dt>
             <dd>
              <p> This object then records what happens to it inside special properties like <code class="literal">calledOnce</code>, which we can make assertions against. </p>
             </dd>
            </dl>
           </div>
           <p>There’s more info in the Sinon docs—the <a class="ulink" href="http://sinonjs.org/" target="_top">front page</a> actually has quite a good overview.</p>
           <p>Here’s our expected test failure:</p>
           <pre class="screen">2 assertions of 3 passed, 1 failed.

1. initialize binds sign in button to navigator.id.request (0, 2, 2)
2. initialize calls navigator.id.watch (1, 0, 1)
    1. check watch function called
        Expected: true
        Result: false</pre>
           <p>We add in the call to <code class="literal">watch</code>…</p>
           <p class="sourcecode" title="accounts/static/accounts.js"><span class="title"><strong>accounts/static/accounts.js</strong></span>.&nbsp; </p>
           <pre class="programlisting"><code class="kd">var</code> <code class="nx">initialize</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">navigator</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">$</code><code class="p">(</code><code class="s1">'#id_login'</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
        <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">request</code><code class="p">();</code>
    <code class="p">});</code>

    <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">watch</code><code class="p">();</code>
<code class="p">};</code></pre>
           <p class="sourcecode" title="accounts/static/accounts.js"> </p>
           <p>But that breaks the other test!</p>
           <pre class="screen">1 assertions of 2 passed, 1 failed.

1. initialize binds sign in button to navigator.id.request (1, 0, 1)
    1. Died on test #1
@file:///workspace/superlists/accounts/static/tests/tests.html:36:
missing argument 1 when calling function navigator.id.watch

2. initialize calls navigator.id.watch (0, 1, 1)</pre>
           <p>That was a puzzler—that “missing argument 1 when calling function navigator.id.watch” took me a while to figure out. <a class="ulink" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/watch" target="_top">Turns out that</a>, in Firefox, <code class="literal">.watch</code> is a function on every object. We’ll need to mock it out in the previous test too:</p>
           <p class="sourcecode" title="accounts/static/tests/tests.html"><span class="title"><strong>accounts/static/tests/tests.html</strong></span>.&nbsp; </p>
           <pre class="programlisting">test("initialize binds sign in button to navigator.id.request", function () {
    var requestWasCalled = false;
    var mockRequestFunction = function () { requestWasCalled = true; };
    var mockNavigator = {
        id: {
            request: mockRequestFunction,
            watch: function () {}
        }
    };
    [...]</pre>
           <p class="sourcecode" title="accounts/static/tests/tests.html"> </p>
           <p>And we’re back to passing tests:</p>
           <pre class="screen">3 assertions of 3 passed, 0 failed.

1. initialize binds sign in button to navigator.id.request (0, 2, 2)
2. initialize calls navigator.id.watch (0, 1, 1)</pre>
          </div>
         </div>
         <div class="sect2" title="Checking Call Arguments">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_checking_call_arguments">Checking Call Arguments</h3>
            </div>
           </div>
          </div>
          <p><a id="id557661" class="indexterm"></a> We’re not calling the <code class="literal">watch</code> function correctly yet—it needs to know the current user, and we have to set up a couple of callbacks for login and logout. Let’s start with the user:</p>
          <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l042)"><span class="title"><strong>accounts/static/tests/tests.html (ch15l042)</strong></span>.&nbsp; </p>
          <pre class="programlisting">test("watch sees current user", function () {
    var user = 'current user';
    var token = 'csrf token';
    var urls = {login: 'login url', logout: 'logout url'};
    var mockNavigator = {
        id: {
            watch: sinon.mock()
        }
    };

    Superlists.Accounts.initialize(mockNavigator, user, token, urls);
    var watchCallArgs = mockNavigator.id.watch.firstCall.args[0];
    equal(watchCallArgs.loggedInUser, user, 'check user');
});</pre>
          <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l042)"> </p>
          <p>We have a very similar setup (which is a code smell incidentally—on the next test, we’re going to want to do some de-duplication of test code). Then we use the <code class="literal">.firstCall.args[0]</code> property on the mock to check on the parameter we passed to the <code class="literal">watch</code> function (<code class="literal">args</code> being a list of positional arguments). That gives us:</p>
          <pre class="screen">3. watch sees current user (1, 0, 1)
    1. Died on test #1
@file:///workspace/superlists/accounts/static/tests/tests.html:72:
watchCallArgs is undefined</pre>
          <p>because we’re not currently passing any arguments to <code class="literal">watch</code>. Step by step, we can do:</p>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l043)"><span class="title"><strong>accounts/static/accounts.js (ch15l043)</strong></span>.&nbsp; </p>
          <pre class="programlisting">    <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">watch</code><code class="p">({});</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l043)"> </p>
          <p>and get a clearer error message:</p>
          <pre class="screen">3. watch sees current user (1, 0, 1)
    1. check user
        Expected: "current user"
        Result: undefined</pre>
          <p>and fix it thusly:</p>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l044)"><span class="title"><strong>accounts/static/accounts.js (ch15l044)</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="kd">var</code> <code class="nx">initialize</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">navigator</code><code class="p">,</code> <code class="nx">user</code><code class="p">,</code> <code class="nx">token</code><code class="p">,</code> <code class="nx">urls</code><code class="p">)</code> <code class="p">{</code>
    <code class="p">[...]</code>

    <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">watch</code><code class="p">({</code>
        <code class="nx">loggedInUser</code><code class="o">:</code> <code class="nx">user</code>
    <code class="p">});</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l044)"> </p>
          <p>Good.</p>
          <pre class="screen">4 assertions of 4 passed, 0 failed.</pre>
         </div>
         <div class="sect2" title="QUnit setup and teardown, Testing Ajax">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_qunit_setup_and_teardown_testing_ajax">QUnit setup and teardown, Testing Ajax</h3>
            </div>
           </div>
          </div>
          <p><a id="id460051" class="indexterm"></a> <a id="id460058" class="indexterm"></a> <a id="id460067" class="indexterm"></a> Next we need to check the <code class="literal">onlogin</code> callback, which is called when Persona has some user authentication information, and we need to send it up to our server for validation. That involves an Ajax call (<code class="literal">$.post</code>), and they’re normally quite hard to test, but sinon.js has a helper called <a class="ulink" href="http://sinonjs.org/docs/#server" target="_top">fake XMLHttpRequest</a>.</p>
          <p>This patches out the native JavaScript <code class="literal">XMLHttpRequest</code> class, so it’s good practice to make sure we restore it afterwards. This gives us a good excuse to learn about QUnit’s <code class="literal">setup</code> and <code class="literal">teardown</code> methods—they are used in a function called <code class="literal">module</code>, which acts a bit like a <code class="literal">unittest.TestCase</code> class, and groups all the tests that follow it together.</p>
          <div class="sidebar">
           <div class="sidebar-title">
            Aside on Ajax
           </div>
           <p><a id="id460092" class="indexterm"></a> If you’ve never used Ajax before, here is a very brief overview. You may find it useful to read up on it elsewhere before proceeding though.</p>
           <p>Ajax stands for “Asynchronous JavaScript and XML”, although the XML part is a bit of a misnomer these days, since everyone usually sends text or JSON rather than XML. It’s a way of letting your client-side JavaScript code send and receive information via the HTTP protocol (GET and POST requests), but do so “asynchronously”, ie, without blocking and without needing to reload the page.</p>
           <p>Here we’re going to use Ajax requests to send a POST request to our login view, sending it the assertion information from the Persona UI. We’ll use the <a class="ulink" href="http://api.jquery.com/jQuery.post/" target="_top">jQuery Ajax convenience functions</a>.</p>
          </div>
          <p>Let’s add this “module” after the first test, before the test for <code class="literal">"initialize calls navigator.id.watch"</code>:</p>
          <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l045)"><span class="title"><strong>accounts/static/tests/tests.html (ch15l045)</strong></span>.&nbsp; </p>
          <pre class="programlisting">var user, token, urls, mockNavigator, requests, xhr; //<a id="CO34-1"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12">
module("navigator.id.watch tests", {
    setup: function () {
        user = 'current user'; //<a id="CO34-2"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12">
        token = 'csrf token';
        urls = { login: 'login url', logout: 'logout url' };
        mockNavigator = {
            id: {
                watch: sinon.mock()
            }
        };
        xhr = sinon.useFakeXMLHttpRequest(); //<a id="CO34-3"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/3.png" alt="3" width="12" height="12">
        requests = []; //<a id="CO34-4"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/4.png" alt="4" width="12" height="12">
        xhr.onCreate = function (request) { requests.push(request); }; //<a id="CO34-5"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/5.png" alt="5" width="12" height="12">
    },
    teardown: function () {
        mockNavigator.id.watch.reset(); //<a id="CO34-6"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/6.png" alt="6" width="12" height="12">
        xhr.restore(); //<a id="CO34-7"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/7.png" alt="7" width="12" height="12">
    }
});

test("initialize calls navigator.id.watch", function () {
    [...]</pre>
          <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l045)"> </p>
          <div class="calloutlist">
           <dl>
            <dt>
             <a href="#CO34-1"><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> We pull out the variables <code class="literal">user</code>, <code class="literal">token</code>, <code class="literal">urls</code>, etc. up to a higher scope, so that they’ll be available to all of the tests in the file. </p>
            </dd>
            <dt>
             <a href="#CO34-2"><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> We initialise said variables inside the <code class="literal">setup</code> function, which, just like a <code class="literal">unittest</code> <code class="literal">setUp</code> function, will run before each test. That includes our <code class="literal">mockNavigator</code>. </p>
            </dd>
            <dt>
             <a href="#CO34-3"><img src="/library/view/test-driven-development-with/9781449365141/callouts/3.png" alt="3" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> We also invoke Sinon’s <code class="literal">useFakeXMLHttpRequest</code>, which patches out the browser’s Ajax capabilities. </p>
            </dd>
            <dt>
             <a href="#CO34-4"><img src="/library/view/test-driven-development-with/9781449365141/callouts/4.png" alt="4" width="12" height="12"></a> 
             <a href="#CO34-5"><img src="/library/view/test-driven-development-with/9781449365141/callouts/5.png" alt="5" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> There’s one more bit of boilerplate: we tell Sinon to take any Ajax requests and put them into the <code class="literal">requests</code> array, so that we can inspect them in our tests. </p>
            </dd>
            <dt>
             <a href="#CO34-6"><img src="/library/view/test-driven-development-with/9781449365141/callouts/6.png" alt="6" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> Finally we have the cleanup—we “reset” the mock for the <code class="literal">watch</code> function in between each test (otherwise calls from one test would show up in others). </p>
            </dd>
            <dt>
             <a href="#CO34-7"><img src="/library/view/test-driven-development-with/9781449365141/callouts/7.png" alt="7" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> And we put the JavaScript <code class="literal">XMLHttpRequest</code> back to the way we found it. </p>
            </dd>
           </dl>
          </div>
          <p>That lets us rewrite our two tests to be much shorter:</p>
          <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l046)"><span class="title"><strong>accounts/static/tests/tests.html (ch15l046)</strong></span>.&nbsp; </p>
          <pre class="programlisting">test("initialize calls navigator.id.watch", function () {
    Superlists.Accounts.initialize(mockNavigator, user, token, urls);
    equal(mockNavigator.id.watch.calledOnce, true, 'check watch function called');
});


test("watch sees current user", function () {
    Superlists.Accounts.initialize(mockNavigator, user, token, urls);
    var watchCallArgs = mockNavigator.id.watch.firstCall.args[0];
    equal(watchCallArgs.loggedInUser, user, 'check user');
});</pre>
          <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l046)"> </p>
          <p>And they still pass, but their name is neatly prefixed with our module name:</p>
          <pre class="screen">4 assertions of 4 passed, 0 failed.

1. initialize binds sign in button to navigator.id.request (0, 2, 2)
2. navigator.id.watch tests: initialize calls navigator.id.watch (0, 1, 1)
3. navigator.id.watch tests: watch sees current user (0, 1, 1)</pre>
          <p>And here’s how we test the <code class="literal">onlogin</code> callback:</p>
          <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l047)"><span class="title"><strong>accounts/static/tests/tests.html (ch15l047)</strong></span>.&nbsp; </p>
          <pre class="programlisting">test("onlogin does ajax post to login url", function () {
    Superlists.Accounts.initialize(mockNavigator, user, token, urls);
    var onloginCallback = mockNavigator.id.watch.firstCall.args[0].onlogin; //<a id="CO35-1"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12">
    onloginCallback(); //<a id="CO35-2"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12">
    equal(requests.length, 1, 'check ajax request'); //<a id="CO35-3"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/3.png" alt="3" width="12" height="12">
    equal(requests[0].method, 'POST');
    equal(requests[0].url, urls.login, 'check url');
});

test("onlogin sends assertion with csrf token", function () {
    Superlists.Accounts.initialize(mockNavigator, user, token, urls);
    var onloginCallback = mockNavigator.id.watch.firstCall.args[0].onlogin;
    var assertion = 'browser-id assertion';
    onloginCallback(assertion);
    equal(
        requests[0].requestBody,
        $.param({ assertion: assertion, csrfmiddlewaretoken: token }), //<a id="CO35-4"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/4.png" alt="4" width="12" height="12">
        'check POST data'
    );
});</pre>
          <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l047)"> </p>
          <div class="calloutlist">
           <dl>
            <dt>
             <a href="#CO35-1"><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> The mock we set on the mock navigator’s watch function lets us extract the callback function we set as “onlogin.” </p>
            </dd>
            <dt>
             <a href="#CO35-2"><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> We can then actually call that function in order to test it. </p>
            </dd>
            <dt>
             <a href="#CO35-3"><img src="/library/view/test-driven-development-with/9781449365141/callouts/3.png" alt="3" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> Sinon’s <code class="literal">fakeXMLHttpRequest</code> server will catch any Ajax requests we make, and put them into the <code class="literal">requests</code> array. We can then check on things like whether it was a POST and what URL it was sent to. </p>
            </dd>
            <dt>
             <a href="#CO35-4"><img src="/library/view/test-driven-development-with/9781449365141/callouts/4.png" alt="4" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> The actual POST parameters are held in <code class="literal">.requestBody</code>, but they are URL-encoded (using the &amp;key=val syntax). jQuery’s <code class="literal">$.param</code> function does URL-encoding, so we use that to do our comparison. </p>
            </dd>
           </dl>
          </div>
          <p>And the two tests fail as expected:</p>
          <pre class="screen">4. navigator.id.watch tests: onlogin does ajax post to login url (1, 0, 1)
    1. Died on test #1
@file:///workspace/superlists/accounts/static/tests/tests.html:78:
onloginCallback is not a function

5. navigator.id.watch tests: onlogin sends assertion with csrf token (1, 0, 1)
    1. Died on test #1
@file:///workspace/superlists/accounts/static/tests/tests.html:90:
onloginCallback is not a function</pre>
          <p>Another unit-test/code cycle. Here’s the failure messages I went through:</p>
          <pre class="screen">1. check ajax request
Expected: 1</pre>
          <p>…</p>
          <pre class="screen">3. check url
Expected: "login url"</pre>
          <p>…</p>
          <pre class="screen">7 assertions of 8 passed, 1 failed.
1. check POST data
Expected:
"assertion=browser-id+assertion&amp;csrfmiddlewaretoken=csrf+token"
Result: null</pre>
          <p>…</p>
          <pre class="screen">1. check POST data
Expected:
"assertion=browser-id+assertion&amp;csrfmiddlewaretoken=csrf+token"
Result: "assertion=browser-id+assertion"</pre>
          <p>…</p>
          <pre class="screen">8 assertions of 8 passed, 0 failed.</pre>
          <p>And I ended up with this code:</p>
          <p class="sourcecode currentcontents" title="accounts/static/accounts.js"><span class="title"><strong>accounts/static/accounts.js</strong></span>.&nbsp; </p>
          <pre class="programlisting">    <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">watch</code><code class="p">({</code>
        <code class="nx">loggedInUser</code><code class="o">:</code> <code class="nx">user</code><code class="p">,</code>
        <code class="nx">onlogin</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">assertion</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">$</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code>
                <code class="nx">urls</code><code class="p">.</code><code class="nx">login</code><code class="p">,</code>
                <code class="p">{</code> <code class="nx">assertion</code><code class="o">:</code> <code class="nx">assertion</code><code class="p">,</code> <code class="nx">csrfmiddlewaretoken</code><code class="o">:</code> <code class="nx">token</code> <code class="p">}</code>
            <code class="p">);</code>
        <code class="p">}</code>
    <code class="p">});</code></pre>
          <p class="sourcecode currentcontents" title="accounts/static/accounts.js"> </p>
          <div class="sect3" title="Logout">
           <div class="titlepage">
            <div>
             <div>
              <h4 class="title" id="_logout">Logout</h4>
             </div>
            </div>
           </div>
           <p>At the time of writing, the “onlogout” part of the watch API’s status was uncertain. It works, but it’s not necessary for our purposes. We’ll just make it a do-nothing function, as a placeholder. Here’s a minimal test for that:</p>
           <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l053)"><span class="title"><strong>accounts/static/tests/tests.html (ch15l053)</strong></span>.&nbsp; </p>
           <pre class="programlisting">test("onlogout is just a placeholder", function () {
    Superlists.Accounts.initialize(mockNavigator, user, token, urls);
    var onlogoutCallback = mockNavigator.id.watch.firstCall.args[0].onlogout;
    equal(typeof onlogoutCallback, "function", "onlogout should be a function");
});</pre>
           <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l053)"> </p>
           <p>And we get quite a simple logout function:</p>
           <p class="sourcecode" title="accounts/static/accounts.js (ch15l054)"><span class="title"><strong>accounts/static/accounts.js (ch15l054)</strong></span>.&nbsp; </p>
           <pre class="programlisting">    <code class="p">},</code>
    <code class="nx">onlogout</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{}</code>
<code class="p">});</code></pre>
           <p class="sourcecode" title="accounts/static/accounts.js (ch15l054)"> </p>
          </div>
         </div>
         <div class="sect2" title="More Nested Callbacks! Testing Asynchronous Code">
          <div class="titlepage">
           <div>
            <div>
             <h3 class="title" id="_more_nested_callbacks_testing_asynchronous_code">More Nested Callbacks! Testing Asynchronous Code</h3>
            </div>
           </div>
          </div>
          <p><a id="ix_mockingcallbacks" class="indexterm"></a> <a id="ix_asynchcode" class="indexterm"></a> <a id="id686901" class="indexterm"></a> This is what JavaScript’s all about folks! Thankfully, sinon.js really does help. We still need to test that our login <code class="literal">post</code> methods <span class="emphasis"><em>also</em></span> set some callbacks for things to do <span class="emphasis"><em>after</em></span> the POST request comes back:</p>
          <pre class="programlisting">    <code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nb">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">reload</code><code class="p">();</code> <code class="p">})</code>
    <code class="p">.</code><code class="nx">fail</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">logout</code><code class="p">();});</code></pre>
          <p>I’m going to skip testing the <code class="literal">window.location.reload</code>, because it’s a bit unnecessarily complicated,<sup>[<a id="id638994" href="#ftn.id638994" epub:type="noteref" class="footnote">26</a>]</sup> and I think we can allow that this will be tested by our Selenium test. We will do a test for the on-fail callback though, just to demonstrate that it is possible:</p>
          <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l055)"><span class="title"><strong>accounts/static/tests/tests.html (ch15l055)</strong></span>.&nbsp; </p>
          <pre class="programlisting">test("onlogin post failure should do navigator.id.logout ", function () {
    mockNavigator.id.logout = sinon.mock(); //<a id="CO36-1"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12">
    Superlists.Accounts.initialize(mockNavigator, user, token, urls);
    var onloginCallback = mockNavigator.id.watch.firstCall.args[0].onlogin;
    var server = sinon.fakeServer.create(); //<a id="CO36-2"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12">
    server.respondWith([403, {}, "permission denied"]); //<a id="CO36-3"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/3.png" alt="3" width="12" height="12">

    onloginCallback();
    equal(mockNavigator.id.logout.called, false, 'should not logout yet');

    server.respond(); //<a id="CO36-4"></a><img src="/library/view/test-driven-development-with/9781449365141/callouts/4.png" alt="4" width="12" height="12">
    equal(mockNavigator.id.logout.called, true, 'should call logout');
});</pre>
          <p class="sourcecode" title="accounts/static/tests/tests.html (ch15l055)"> </p>
          <div class="calloutlist">
           <dl>
            <dt>
             <a href="#CO36-1"><img src="/library/view/test-driven-development-with/9781449365141/callouts/1.png" alt="1" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> We put a mock on the <code class="literal">navigator.id.logout</code> function which we’re interested in. </p>
            </dd>
            <dt>
             <a href="#CO36-2"><img src="/library/view/test-driven-development-with/9781449365141/callouts/2.png" alt="2" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> We use Sinon’s <code class="literal">fakeServer</code>, which is an abstraction on top of the <code class="literal">fakeXMLHttpRequest</code> to simulate Ajax server responses. </p>
            </dd>
            <dt>
             <a href="#CO36-3"><img src="/library/view/test-driven-development-with/9781449365141/callouts/3.png" alt="3" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> We set up our fake server to respond with a 403 “permission denied” response, to simulate what will happen for unauthorized users. </p>
            </dd>
            <dt>
             <a href="#CO36-4"><img src="/library/view/test-driven-development-with/9781449365141/callouts/4.png" alt="4" width="12" height="12"></a> 
            </dt>
            <dd>
             <p> We then explicitly tell the fake server to send that response. Only then should we see the logout call. </p>
            </dd>
           </dl>
          </div>
          <p>That gets us to this—a slight change to our spiked code:</p>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l056)"><span class="title"><strong>accounts/static/accounts.js (ch15l056)</strong></span>.&nbsp; </p>
          <pre class="programlisting">    <code class="nx">onlogin</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">assertion</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">$</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code>
            <code class="nx">urls</code><code class="p">.</code><code class="nx">login</code><code class="p">,</code>
            <code class="p">{</code> <code class="nx">assertion</code><code class="o">:</code> <code class="nx">assertion</code><code class="p">,</code> <code class="nx">csrfmiddlewaretoken</code><code class="o">:</code> <code class="nx">token</code> <code class="p">}</code>
        <code class="p">).</code><code class="nx">fail</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">logout</code><code class="p">();</code> <code class="p">});</code>
    <code class="p">},</code>
    <code class="nx">onlogout</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{}</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l056)"> </p>
          <p>Finally we add our <code class="literal">window.location.reload</code>, just to check it doesn’t break any unit tests:</p>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l057)"><span class="title"><strong>accounts/static/accounts.js (ch15l057)</strong></span>.&nbsp; </p>
          <pre class="programlisting">    <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">watch</code><code class="p">({</code>
        <code class="nx">loggedInUser</code><code class="o">:</code> <code class="nx">user</code><code class="p">,</code>
        <code class="nx">onlogin</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">assertion</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">$</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code>
                <code class="nx">urls</code><code class="p">.</code><code class="nx">login</code><code class="p">,</code>
                <code class="p">{</code> <code class="nx">assertion</code><code class="o">:</code> <code class="nx">assertion</code><code class="p">,</code> <code class="nx">csrfmiddlewaretoken</code><code class="o">:</code> <code class="nx">token</code> <code class="p">}</code>
            <code class="p">)</code>
                <code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="nb">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">reload</code><code class="p">();</code> <code class="p">})</code>
                <code class="p">.</code><code class="nx">fail</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">logout</code><code class="p">();</code> <code class="p">});</code>
        <code class="p">},</code>
        <code class="nx">onlogout</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{}</code>
    <code class="p">});</code></pre>
          <p class="sourcecode" title="accounts/static/accounts.js (ch15l057)"> </p>
          <p>Everything’s still OK:</p>
          <pre class="screen">11 assertions of 11 passed, 0 failed.</pre>
          <p>If those chained <code class="literal">.done</code> and <code class="literal">.fail</code> calls are bugging you—they bug me a little—you can rewrite that as, eg:</p>
          <pre class="programlisting">    <code class="kd">var</code> <code class="nx">deferred</code> <code class="o">=</code> <code class="nx">$</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code>
        <code class="nx">urls</code><code class="p">.</code><code class="nx">login</code><code class="p">,</code>
        <code class="p">{</code> <code class="nx">assertion</code><code class="o">:</code> <code class="nx">assertion</code><code class="p">,</code> <code class="nx">csrfmiddlewaretoken</code><code class="o">:</code> <code class="nx">token</code> <code class="p">}</code>
    <code class="p">);</code>
    <code class="nx">deferred</code><code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="nb">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">reload</code><code class="p">();</code> <code class="p">})</code>
    <code class="nx">deferred</code><code class="p">.</code><code class="nx">fail</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">id</code><code class="p">.</code><code class="nx">logout</code><code class="p">();</code> <code class="p">});</code></pre>
          <p>But async code is always a bit mind-bending. I find it just about readable as it is: “do a post to urls.login with the assertion and csrf token, when it’s done, do a window reload, or if it fails, do a navigator.id.logout”. You can read up on JavaScript deferreds, aka “promises”, <a class="ulink" href="http://otaqui.com/blog/1637/introducing-javascript-promises-aka-futures-in-google-chrome-canary/" target="_top">here</a>.</p>
          <p>We’re approaching the moment of truth: will our FTs get any further? First, we adjust our <code class="literal">initialize</code> call:</p>
          <p class="sourcecode" title="lists/templates/base.html"><span class="title"><strong>lists/templates/base.html</strong></span>.&nbsp; </p>
          <pre class="programlisting"><code class="nt">&lt;script&gt;</code>
    <code class="cm">/*global $, Superlists, navigator */</code>
    <code class="nx">$</code><code class="p">(</code><code class="nb">document</code><code class="p">).</code><code class="nx">ready</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">user</code> <code class="o">=</code> <code class="s2">"{{ user.email }}"</code> <code class="o">||</code> <code class="kc">null</code><code class="p">;</code>
        <code class="kd">var</code> <code class="nx">token</code> <code class="o">=</code> <code class="s2">"{{ csrf_token }}"</code><code class="p">;</code>
        <code class="kd">var</code> <code class="nx">urls</code> <code class="o">=</code> <code class="p">{</code>
            <code class="nx">login</code><code class="o">:</code> <code class="s2">"TODO"</code><code class="p">,</code>
            <code class="nx">logout</code><code class="o">:</code> <code class="s2">"TODO"</code><code class="p">,</code>
        <code class="p">};</code>
        <code class="nx">Superlists</code><code class="p">.</code><code class="nx">Accounts</code><code class="p">.</code><code class="nx">initialize</code><code class="p">(</code><code class="nx">navigator</code><code class="p">,</code> <code class="nx">user</code><code class="p">,</code> <code class="nx">token</code><code class="p">,</code> <code class="nx">urls</code><code class="p">);</code>
    <code class="p">});</code>
<code class="nt">&lt;/script&gt;</code></pre>
          <p class="sourcecode" title="lists/templates/base.html"> </p>
          <p>And we run the FT…</p>
          <pre class="screen">$ <span class="strong"><strong>python3 manage.py test functional_tests.test_login</strong></span>
Creating test database for alias 'default'...
Not Found: /favicon.ico
Not Found: /TODO
E
======================================================================
ERROR: test_login_with_persona (functional_tests.test_login.LoginTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/workspace/superlists/functional_tests/test_login.py", line 47, in
test_login_with_persona
    self.wait_for_element_with_id('id_logout')
  File "/workspace/superlists/functional_tests/test_login.py", line 23, in
wait_for_element_with_id
    lambda b: b.find_element_by_id(element_id)
[...]
selenium.common.exceptions.TimeoutException: Message: ''

 ---------------------------------------------------------------------
Ran 1 test in 28.779s

FAILED (errors=1)
Destroying test database for alias 'default'...</pre>
          <p>Hooray! I mean, I know it failed, but we saw it popping up the Persona dialog and getting through it and everything! Next chapter: the server side. <a id="id448460" class="indexterm"></a> <a id="id448446" class="indexterm"></a> <a id="id448454" class="indexterm"></a></p>
          <div class="sidebar">
           <div class="sidebar-title">
            On Spiking and Mocking with JavaScript
           </div>
           <div class="variablelist">
            <dl>
             <dt>
              <span class="term"> Spiking </span>
             </dt>
             <dd>
               Exploratory coding to find out about a new API, or to explore the feasibility of a new solution. Spiking can be done without tests. It’s a good idea to do your spike on a new branch, and go back to master when de-spiking. 
              <a id="id448494" class="indexterm"></a> 
             </dd>
             <dt>
              <span class="term"> Mocking </span>
             </dt>
             <dd>
               We use mocking in unit tests when we have an external dependency that we don’t want to actually use in our tests. A mock is used to simulate the third-party API. Whilst it is possible to “roll your own” mocks in JavaScript, a mocking framework like Sinon provides a lot of helpful shortcuts which will make it easier to write (and more importantly, read) your tests. 
             </dd>
             <dt>
              <span class="term"> Unit testing Ajax </span>
             </dt>
             <dd>
               Sinon is a great help here. Manually mocking Ajax methods is a real pain. 
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="footnotes" epub:type="footnotes">
         <br>
         <hr style="width: 100; align: left;">
         <div class="footnote" epub:type="footnote" id="ftn.id552955">
          <p><sup>[<a href="#id552955" class="simpara">20</a>] </sup>UK-English speakers may bristle at that incorrect spelling of the word “initialise”. I know, it grates with me too. But it’s an increasingly accepted convention to use American spelling in code. It makes it easier to search, for example, and just to work together more generally, if we all agree on how words are spelt. We have to accept that we’re in the minority here, and this is one battle we’ve probably lost.</p>
         </div>
         <div class="footnote" epub:type="footnote" id="ftn.id553170">
          <p><sup>[<a href="#id553170" class="simpara">21</a>] </sup>The new shiny in the JavaScript world for avoiding namespacing problems is called <span class="emphasis"><em>require.js</em></span>. It was one thing too many to squeeze into this book, but you should check it out.</p>
         </div>
         <div class="footnote" id="ftn.id588279">
          <p><sup>[<a href="#id588279" class="simpara">22</a>] </sup>I’ve called this object a “mock”, but it’s probably more correctly called a “spy”. We don’t have to concern ourselves with the differences in this book, but for more on the general class of tools called “Test Doubles”, including the difference between stubs, mocks, fakes, and spies, see <a class="ulink" href="https://leanpub.com/mocks-fakes-stubs" target="_top">Mocks, Fakes and Stubs</a> by Emily Bache.</p>
         </div>
         <div class="footnote" epub:type="footnote" id="ftn.id606469">
          <p><sup>[<a href="#id606469" class="simpara">23</a>] </sup>In the real world, when setting up a namespace like this, you’d want to follow a sort of “add-or-create” pattern, so that, if there’s already a <code class="literal">window.Superlists</code> in the scope, we extend it rather than replacing it. <code class="literal">window.Superlists = window.Superlists || {}</code> is one formulation, and jQuery’s <code class="literal">$.extend</code> is another possibilty. But, there’s already a lot of content in this chapter, and I thought this was probably one too many things to talk about!</p>
         </div>
         <div class="footnote" epub:type="footnote" id="ftn.id696437">
          <p><sup>[<a href="#id696437" class="simpara">24</a>] </sup>Incidentally, notice we use <code class="literal">{{ csrf_token }}</code> which gives you the raw string token, rather than <code class="literal">{% csrf_token%}</code> which would give us a full HTML tag, <code class="literal">&lt;input type="hidden" name="etc etc</code>.</p>
         </div>
         <div class="footnote" epub:type="footnote" id="ftn.id696784">
          <p><sup>[<a href="#id696784" class="simpara">25</a>] </sup>Sinon also has more specialised objects for “spies” and “stubs”. Mocks can do everything that spies and stubs can do though, so I figured, one less piece of terminology would keep things simple.</p>
         </div>
         <div class="footnote" epub:type="footnote" id="ftn.id638994">
          <p><sup>[<a href="#id638994" class="simpara">26</a>] </sup>You can’t mock out <code class="literal">window.location.reload</code>, so instead you have to define an (untested) function called <code class="literal">Superlists.Accounts.refreshPage</code>, and then put a mock on <span class="emphasis"><em>that</em></span> to check that it gets set as the Ajax <code class="literal">.done</code> callback.</p>
         </div>
        </div>
       </section>
      </div> 
     </div> 
     <section class="t-bottom-cta bottom-cta bottom-cta-book free-chapter"> 
      <h2> With Safari, you learn the way you learn best. Get unlimited access to videos, live online training, learning paths, books, interactive tutorials, and more. </h2> 
      <div class="controls"> 
       <a href="/public/free-trial/?fa=True&amp;cl=/library/view/test-driven-development-with/9781449365141/ch15.html" class="button" data-ga-label="Bottom CTA">Start Free Trial</a> 
       <p>No credit card required</p> 
      </div> 
     </section> 
    </div> 
   </section> 
  </section> 
  <footer class="anybird-footer"> 
   <nav class="grid"> 
    <ul class="footer-nav col"> 
     <li><a href="/explore/"><span>Explore</span></a></li> 
     <li><a href="/our-library/"><span>Tour</span></a></li> 
     <li><a href="/pricing/"><span>Pricing</span></a></li> 
     <li><a href="/enterprise/"><span>Enterprise</span></a></li> 
     <li><a href="/government/"><span>Government</span></a></li> 
     <li><a href="/academic-public-library/"><span>Education</span></a></li> 
     <li><a href="/your-experience/#queue"><span>Queue App</span></a></li> 
    </ul> 
    <ul class="footer-contact col"> 
     <li><a href="/learn/"><span>Learn</span></a></li> 
     <li><a href="/blog/"><span>Blog</span></a></li> 
     <li><a href="/contact/"><span>Contact</span></a></li> 
     <li><a href="/careers/"><span>Careers</span></a></li> 
     <li><a href="/press-resources/"><span>Press Resources</span></a></li> 
     <li><a href="/public/support/"><span>Support</span></a></li> 
    </ul> 
    <ul class="footer-social col"> 
     <li id="footer-twitter"><a href="https://twitter.com/safari"><span>Twitter</span></a></li> 
     <li id="footer-github"><a href="http://github.com/safarijv"><span>GitHub</span></a></li> 
     <li id="footer-facebook"><a href="http://www.facebook.com/safaribooksonline"><span>Facebook</span></a></li> 
     <li id="footer-linkedin"><a href="https://www.linkedin.com/company/safari-books-online"><span>LinkedIn</span></a></li> 
    </ul> 
    <ul class="footer-legal col"> 
     <li><a href="/terms/"><span>Terms of Service</span></a></li> 
     <li><a href="/membership-agreement/"><span>Membership Agreement</span></a></li> 
     <li><a href="/privacy/"><span>Privacy Policy</span></a></li> 
    </ul> 
   </nav> 
   <div class="footer-copyright">
     Copyright © 2017 Safari Books Online. 
   </div> 
  </footer> 
  <script>
  var g = {
    
    position_cache: {},
    title: "Test-Driven Development with Python",
    author_list: "Harry J.W. Percival",
    format: "book",
    source: "application/epub+zip",
    is_system_book: true,
    is_public: true,
    loaded_from_server: true,
    allow_scripts: false,
    has_mathml: false
    
  };
</script> 
  <script type="text/javascript" src="/library/view/static/CACHE/js/e5475d26c7d7.js"></script> 
  <noscript> 
   <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P4V6Z" height="0" width="0" style="display:none;visibility:hidden"> </iframe> 
  </noscript> 
  <script async defer src="/library/view/pageview.js"></script> 
  <script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","queueTime":0,"licenseKey":"510f1a6865","agent":"","transactionName":"YgdaZ0NSW0cEB0RdWltNfkZfUEFdCgofVVtMAFFBVR1DXQATQw5GVA9IX1RsQ10AEw==","applicationID":"10402228","errorBeacon":"bam.nr-data.net","applicationTime":582}</script>   
 </body>
</html>