<!doctype html>
<html class="no-js" lang="en-US">
 <head> 
  <link rel="profile" href="http://gmpg.org/xfn/11"> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Using OWIN and Active Directory to authenticate users in ASP.Net MVC 5 application « Trailmax Tech</title> 
  <link rel="dns-prefetch" href="//s.w.org"> 
  <link rel="alternate" type="application/rss+xml" title="Trailmax Tech » Feed" href="http://tech.trailmax.info/feed/"> 
  <link rel="alternate" type="application/rss+xml" title="Trailmax Tech » Comments Feed" href="http://tech.trailmax.info/comments/feed/"> 
  <link rel="alternate" type="application/rss+xml" title="Trailmax Tech » Using OWIN and Active Directory to authenticate users in ASP.Net MVC 5 application Comments Feed" href="http://tech.trailmax.info/2016/03/using-owin-and-active-directory-to-authenticate-users-in-asp-net-mvc-5-application/feed/"> 
  <script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/tech.trailmax.info\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.8.1"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,56826,8203,55356,56819),0,0),c=j.toDataURL(),b===c&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55358,56794,8205,9794,65039),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55358,56794,8203,9794,65039),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script> 
  <style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style> 
  <link rel="stylesheet" id="EG-Attachments-css" href="http://tech.trailmax.info/wp-content/plugins/eg-attachments/css/eg-attachments.css?ver=2.1.3" type="text/css" media="all"> 
  <link rel="stylesheet" id="wpt-twitter-feed-css" href="http://tech.trailmax.info/wp-content/plugins/wp-to-twitter/css/twitter-feed.css?ver=4.8.1" type="text/css" media="all"> 
  <link rel="stylesheet" id="tw-bootstrap-css" href="http://tech.trailmax.info/wp-content/themes/the-bootstrap/css/bootstrap.min.css?ver=2.0.3" type="text/css" media="all"> 
  <link rel="stylesheet" id="the-bootstrap-css" href="http://tech.trailmax.info/wp-content/themes/the-bootstrap/style.min.css?ver=2.0.1" type="text/css" media="all"> 
  <link rel="stylesheet" id="wp-markdown-prettify-css" href="http://tech.trailmax.info/wp-content/plugins/wp-markdown/css/prettify.css?ver=1.5.1" type="text/css" media="all"> 
  <script type="text/javascript" src="http://tech.trailmax.info/wp-includes/js/jquery/jquery.js?ver=1.12.4"></script> 
  <script type="text/javascript" src="http://tech.trailmax.info/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1"></script> 
  <script type="text/javascript" src="http://tech.trailmax.info/wp-content/plugins/wp-google-analytics/wp-google-analytics.js?ver=0.0.3"></script> 
  <script type="text/javascript" src="http://tech.trailmax.info/wp-content/plugins/wp-markdown/js/prettify.min.js?ver=1.5.1"></script> 
  <link rel="https://api.w.org/" href="http://tech.trailmax.info/wp-json/"> 
  <link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://tech.trailmax.info/xmlrpc.php?rsd"> 
  <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://tech.trailmax.info/wp-includes/wlwmanifest.xml"> 
  <link rel="prev" title="Maths is Hard" href="http://tech.trailmax.info/2016/02/maths-is-hard/"> 
  <link rel="next" title="Performance Tuning of Entity Framework Requests" href="http://tech.trailmax.info/2016/03/performance-tuning-of-entity-framework-requests/"> 
  <meta name="generator" content="WordPress 4.8.1"> 
  <link rel="canonical" href="http://tech.trailmax.info/2016/03/using-owin-and-active-directory-to-authenticate-users-in-asp-net-mvc-5-application/"> 
  <link rel="shortlink" href="http://tech.trailmax.info/?p=1182"> 
  <link rel="alternate" type="application/json+oembed" href="http://tech.trailmax.info/wp-json/oembed/1.0/embed?url=http%3A%2F%2Ftech.trailmax.info%2F2016%2F03%2Fusing-owin-and-active-directory-to-authenticate-users-in-asp-net-mvc-5-application%2F"> 
  <link rel="alternate" type="text/xml+oembed" href="http://tech.trailmax.info/wp-json/oembed/1.0/embed?url=http%3A%2F%2Ftech.trailmax.info%2F2016%2F03%2Fusing-owin-and-active-directory-to-authenticate-users-in-asp-net-mvc-5-application%2F&amp;format=xml"> 
  <script type="text/javascript" src="http://tech.trailmax.info/wp-content/plugins/wp-highlightjs/highlight.pack.js"></script> 
  <script type="text/javascript">hljs.initHighlightingOnLoad();</script> 
  <link rel="stylesheet" href="http://tech.trailmax.info/wp-content/plugins/wp-highlightjs/styles/default.css"> 
  <style>pre.hljs {padding: 0px;}
pre.hljs code {border: 1px solid #ccc; padding: 5px;}</style> 
  <!--[if lt IE 9]>
		<script src="http://tech.trailmax.info/wp-content/themes/the-bootstrap/js/html5shiv.min.js" type="text/javascript"></script>
		<script src="http://tech.trailmax.info/wp-content/themes/the-bootstrap/js/respond.min.js" type="text/javascript"></script>
	<![endif]--> 
 </head> 
 <body class="post-template-default single single-post postid-1182 single-format-standard content-sidebar"> 
  <div class="container"> 
   <div id="page" class="hfeed row"> 
    <header id="branding" role="banner" class="span12"> 
     <hgroup> 
      <h1 id="site-title"> <a href="http://tech.trailmax.info/" title="Trailmax Tech" rel="home"> <span>Trailmax Tech</span> </a> </h1> 
      <h2 id="site-description">Max Vasilyev: ASP.Net MVC development in Aberdeen, Scotland</h2> 
     </hgroup> 
     <nav id="access" role="navigation"> 
      <h3 class="assistive-text">Main menu</h3> 
      <div class="skip-link">
       <a class="assistive-text" href="#content" title="Skip to primary content">Skip to primary content</a>
      </div> 
      <div class="skip-link">
       <a class="assistive-text" href="#secondary" title="Skip to secondary content">Skip to secondary content</a>
      </div> 
      <div class="navbar navbar-inverse"> 
       <div class="navbar-inner"> 
        <div class="container"> 
         <!-- .btn-navbar is used as the toggle for collapsed navbar content --> 
         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> 
         <span class="brand">Trailmax Tech</span> 
         <div class="nav-collapse"> 
          <div class="menu-general-container">
           <ul id="menu-general" class="nav">
            <li id="menu-item-726" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-726"><a href="http://tech.trailmax.info/talks/">My Talks</a></li> 
            <li id="menu-item-336" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-336"><a href="http://tech.trailmax.info/cachecopypage/">cacheCopy</a></li> 
            <li id="menu-item-337" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-337"><a href="http://tech.trailmax.info/about/">About</a></li> 
           </ul>
          </div> 
          <form id="searchform" class="navbar-search pull-right" method="get" action="http://tech.trailmax.info/"> 
           <label for="s" class="assistive-text hidden">Search</label> 
           <input type="search" class="search-query" name="s" id="s" placeholder="Search"> 
          </form> 
         </div> 
        </div> 
       </div> 
      </div> 
     </nav>
     <!-- #access --> 
    </header>
    <!-- #branding --> 
    <section id="primary" class="span8"> 
     <div id="content" role="main"> 
      <article id="post-1182" class="post-1182 post type-post status-publish format-standard hentry category-uncategorized tag-net tag-active-directory tag-asp-net tag-c tag-identity tag-mvc tag-recipe"> 
       <header class="page-header"> 
        <h1 class="entry-title">Using OWIN and Active Directory to authenticate users in ASP.Net MVC 5 application</h1> 
        <div class="entry-meta">
         <span class="sep">Posted on </span>
         <a href="http://tech.trailmax.info/2016/03/using-owin-and-active-directory-to-authenticate-users-in-asp-net-mvc-5-application/" title="1:35 am" rel="bookmark"><time class="entry-date" datetime="2016-03-10T01:35:41+00:00" pubdate>March 10, 2016</time></a>
         <span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://tech.trailmax.info/author/trailmax/" title="View all posts by trailmax" rel="author">trailmax</a></span></span> 
         <span class="sep"> | </span> 
         <span class="comments-link"> <a href="http://tech.trailmax.info/2016/03/using-owin-and-active-directory-to-authenticate-users-in-asp-net-mvc-5-application/#comments"><span class="dsq-postid" data-dsqidentifier="1182 http://tech.trailmax.info/?p=1182"><strong>100</strong> Replies</span></a> </span> 
        </div>
        <!-- .entry-meta --> 
       </header>
       <!-- .entry-header --> 
       <div class="entry-content clearfix"> 
        <p><strong>UPD</strong> There is a <a href="http://tech.trailmax.info/2016/09/active-directory-authentication-with-owin-in-mvc5-part-2-roles-and-corrections/">part 2 of this blog-post</a> explaining how to do roles and fixing a minor issue with authentication.</p> 
        <p><strong>UPD</strong> If you are on Windows 10 and get “System.IO.FileNotFoundException: The system cannot find the file specified”, have a <a href="http://stackoverflow.com/q/33717673/809357">look on this page</a>. Thanks to David Engel for this link.</p> 
        <p>A while back I had to implement a login system that relied on in-house Active Directory. I did spend some time on figuring out how to work this in the nicest possible ways.</p> 
        <p>One of the approaches I used in the past is to slam Windows Authentication on top of the entire site and be done with it. But this is not very user-friendly – before showing anything, you are slammed with a nasty prompt for username/password. And you need to remember to include your domain name in some cases. I totally did not want that on a new green-field project. So here goes the instructions on how to do a nice authentication against your Windows Users or in-house hosted Active Directory.</p> 
        <p>For this project I’ll use Visual Studio 2015. But steps for VS2013 will be the same. Can’t say anything nice about any earlier versions of Visual Studio – I don’t use them anymore.</p> 
        <p><span id="more-1182"></span></p> 
        <p>First create an MVC project and make sure you select “No Authentication” when you create the project:</p> 
        <p><img src="http://tech.trailmax.info/wp-content/uploads/2016/03/2016-03-09-22_41_57-Start-Page-Microsoft-Visual-Studio-Administrator.png" alt="2016-03-09 22_41_57-Start Page - Microsoft Visual Studio (Administrator)" width="853" height="638" class="thumbnail aligncenter size-full wp-image-1183" srcset="http://tech.trailmax.info/wp-content/uploads/2016/03/2016-03-09-22_41_57-Start-Page-Microsoft-Visual-Studio-Administrator.png 853w, http://tech.trailmax.info/wp-content/uploads/2016/03/2016-03-09-22_41_57-Start-Page-Microsoft-Visual-Studio-Administrator-300x224.png 300w, http://tech.trailmax.info/wp-content/uploads/2016/03/2016-03-09-22_41_57-Start-Page-Microsoft-Visual-Studio-Administrator-768x574.png 768w" sizes="(max-width: 853px) 100vw, 853px"></p> 
        <p>Just after creation of a new project, I usually update all NuGet packages – it is easier to update packages when project is empty, rather later down the line. You don’t have to do this.</p> 
        <p>Now install new NuGet packages. You will need the following and all their dependencies:</p> 
        <ul> 
         <li>Microsoft.Owin.Security.Cookies</li> 
         <li>Microsoft.Owin.Host.SystemWeb</li> 
        </ul> 
        <p>Now in your <code>App_Start</code> folder create <code>Startup.cs</code> file (does not have to be in this folder or with this name, only following convention). Put this into that file:</p> 
        <pre><code>using Microsoft.Owin;
using Owin;

[assembly: OwinStartupAttribute(typeof(MyProject.Startup))]
namespace MyProject
{
    public partial class Startup
    {
        public void Configuration(IAppBuilder app)
        {
            ConfigureAuth(app);
        }
    }
}
</code></pre> 
        <p>This will not compile because you don’t have <code>ConfigureAuth</code> method. Add another file in <code>App_Start</code> called <code>Startup.Auth.cs</code> and put this code there:</p> 
        <pre><code>using System;
using Microsoft.Owin;
using Microsoft.Owin.Security.Cookies;
using Owin;


namespace MyProject
{
    public static class MyAuthentication
    {
        public const String ApplicationCookie = "MyProjectAuthenticationType";
    }

    public partial class Startup
    {
        public void ConfigureAuth(IAppBuilder app)
        {
            // need to add UserManager into owin, because this is used in cookie invalidation
            app.UseCookieAuthentication(new CookieAuthenticationOptions
            {
                AuthenticationType = MyAuthentication.ApplicationCookie,
                LoginPath = new PathString("/Login"),
                Provider = new CookieAuthenticationProvider(),
                CookieName = "MyCookieName",
                CookieHttpOnly = true,
                ExpireTimeSpan = TimeSpan.FromHours(12), // adjust to your needs
            });
        }
    }
}
</code></pre> 
        <p>Let’s see what we’ve done so far. <code>Startup.cs</code> file contains <code>OwinStartupAttribute</code> attribute on top of the class – this tells OWIN system what Configuration method required by OWIN is named <code>MyProject.Startup</code>. There are <a href="http://www.asp.net/aspnet/overview/owin-and-katana/owin-startup-class-detection">other ways of doing this</a>. Second file <code>Startup.Auth.cs</code> contains OWIN configuration for authentication – this is very similar to what you’d see if you created a project with ASP.Net Identity authentication. Only I’ve replaced the name of <code>AuthenticationType</code> with my own, stored in statically-available constant – we’ll need this value elsewhere later. Also we are saying that OWIN should redirect unauthenticated requests to <code>/Login</code>, but we don’t have anything there at the moment. Let’s create a controller for that.</p> 
        <pre><code>using System.ComponentModel.DataAnnotations;
using System.Web.Mvc;


namespace ActiveDirectoryAuthentication.Controllers
{
    public class LoginController : Controller
    {
        [AllowAnonymous]
        public virtual ActionResult Index()
        {
            return View();
        }


        [HttpPost]
        [AllowAnonymous]
        [ValidateAntiForgeryToken]
        public virtual ActionResult Index(LoginViewModel model)
        {
            //TODO process login
        }
    }


    public class LoginViewModel
    {
        [Required, AllowHtml]
        public string Username { get; set; }

        [Required]
        [AllowHtml]
        [DataType(DataType.Password)]
        public string Password { get; set; }
    }
}
</code></pre> 
        <p>And <code>Index.cshtml</code> will be like this:</p> 
        <pre><code>@model ActiveDirectoryAuthentication.Controllers.LoginViewModel

@{
    ViewBag.Title = "Login";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

&lt;h2&gt;Login&lt;/h2&gt;

&lt;div class="row"&gt;
    &lt;div class="col-md-8"&gt;
        &lt;section id="loginForm"&gt;
            @using (Html.BeginForm("Index", "Login", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
            {
                @Html.AntiForgeryToken()
                &lt;hr /&gt;
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                &lt;div class="form-group"&gt;
                    @Html.LabelFor(m =&gt; m.Username, new { @class = "col-md-2 control-label" })
                    &lt;div class="col-md-10"&gt;
                        @Html.TextBoxFor(m =&gt; m.Username, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m =&gt; m.Username, "", new { @class = "text-danger" })
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div class="form-group"&gt;
                    @Html.LabelFor(m =&gt; m.Password, new { @class = "col-md-2 control-label" })
                    &lt;div class="col-md-10"&gt;
                        @Html.PasswordFor(m =&gt; m.Password, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m =&gt; m.Password, "", new { @class = "text-danger" })
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div class="form-group"&gt;
                    &lt;div class="col-md-offset-2 col-md-10"&gt;
                        &lt;input type="submit" value="Log in" class="btn btn-default" /&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            }
        &lt;/section&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre> 
        <p>This will give us a nice login form:</p> 
        <p><img src="http://tech.trailmax.info/wp-content/uploads/2016/03/2016-03-09-23_26_12-Login-My-ASP.NET-Application.png" alt="2016-03-09 23_26_12-Login - My ASP.NET Application" width="639" height="406" class="thumbnail aligncenter size-full wp-image-1184" srcset="http://tech.trailmax.info/wp-content/uploads/2016/03/2016-03-09-23_26_12-Login-My-ASP.NET-Application.png 639w, http://tech.trailmax.info/wp-content/uploads/2016/03/2016-03-09-23_26_12-Login-My-ASP.NET-Application-300x191.png 300w" sizes="(max-width: 639px) 100vw, 639px"></p> 
        <p>To check if our authentication stuff works let’s put <code>[Authorize]</code> attribute on one of the existing actions in <code>HomeController</code>:</p> 
        <pre><code>[Authorize]
public ActionResult About()
{
    ViewBag.Message = "Your application description page.";

    return View();
}
</code></pre> 
        <p>Now if you navigate to <code>/Home/About</code> you should be redirected to login page. It is important that this works. If you don’t get login prompt, something is wrong and you need to go back re-do missing steps. Two possible problems I can see here: <code>/Login</code> route does not point to <code>LoginController</code> or OWIN startup configuration is not called.</p> 
        <p>All of above was easy – now we need to come up with logic that actually does checking of username and password combination against AD.</p> 
        <p>Before we start any further add <code>System.DirectoryServices.AccountManagement</code> as a Reference to your project. And now create this class:</p> 
        <pre><code>using System;
using System.DirectoryServices.AccountManagement;
using System.Security.Claims;
using Microsoft.Owin.Security;
using MyProject;


namespace ActiveDirectoryAuthentication.Models
{
    public class AdAuthenticationService
    {
        public class AuthenticationResult
        {
            public AuthenticationResult(string errorMessage = null)
            {
                ErrorMessage = errorMessage;
            }

            public String ErrorMessage { get; private set; }
            public Boolean IsSuccess =&gt; String.IsNullOrEmpty(ErrorMessage); 
        }

        private readonly IAuthenticationManager authenticationManager;

        public AdAuthenticationService(IAuthenticationManager authenticationManager)
        {
            this.authenticationManager = authenticationManager;
        }


        /// &lt;summary&gt;
        /// Check if username and password matches existing account in AD. 
        /// &lt;/summary&gt;
        /// &lt;param name="username"&gt;&lt;/param&gt;
        /// &lt;param name="password"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public AuthenticationResult SignIn(String username, String password)
        {
#if DEBUG
            // authenticates against your local machine - for development time
            ContextType authenticationType = ContextType.Machine; 
#else
            // authenticates against your Domain AD
            ContextType authenticationType = ContextType.Domain;
#endif
            PrincipalContext principalContext = new PrincipalContext(authenticationType);
            bool isAuthenticated = false;
            UserPrincipal userPrincipal = null;
            try
            {
                isAuthenticated = principalContext.ValidateCredentials(username, password, ContextOptions.Negotiate);
                if (isAuthenticated)
                {
                    userPrincipal = UserPrincipal.FindByIdentity(principalContext, username);
                }
            }
            catch (Exception)
            {
                isAuthenticated = false;
                userPrincipal = null;
            }

            if (!isAuthenticated || userPrincipal == null)
            {
                return new AuthenticationResult("Username or Password is not correct");
            }

            if (userPrincipal.IsAccountLockedOut())
            {
                // here can be a security related discussion weather it is worth 
                // revealing this information
                return new AuthenticationResult("Your account is locked.");
            }

            if (userPrincipal.Enabled.HasValue &amp;&amp; userPrincipal.Enabled.Value == false)
            {
                // here can be a security related discussion weather it is worth 
                // revealing this information
                return new AuthenticationResult("Your account is disabled");
            }

            var identity = CreateIdentity(userPrincipal);

            authenticationManager.SignOut(MyAuthentication.ApplicationCookie);
            authenticationManager.SignIn(new AuthenticationProperties() { IsPersistent = false }, identity);


            return new AuthenticationResult();
        }


        private ClaimsIdentity CreateIdentity(UserPrincipal userPrincipal)
        {
            var identity = new ClaimsIdentity(MyAuthentication.ApplicationCookie, ClaimsIdentity.DefaultNameClaimType, ClaimsIdentity.DefaultRoleClaimType);
            identity.AddClaim(new Claim("http://schemas.microsoft.com/accesscontrolservice/2010/07/claims/identityprovider", "Active Directory"));
            identity.AddClaim(new Claim(ClaimTypes.Name, userPrincipal.SamAccountName));
            identity.AddClaim(new Claim(ClaimTypes.NameIdentifier, userPrincipal.SamAccountName));
            if (!String.IsNullOrEmpty(userPrincipal.EmailAddress))
            {
                identity.AddClaim(new Claim(ClaimTypes.Email, userPrincipal.EmailAddress));
            }

            // add your own claims if you need to add more information stored on the cookie

            return identity;
        }
    }
}
</code></pre> 
        <p>Then in you <code>LoginController</code> do the following changes:</p> 
        <pre><code>using System;
using System.ComponentModel.DataAnnotations;
using System.Web;
using System.Web.Mvc;
using ActiveDirectoryAuthentication.Models;
using Microsoft.Owin.Security;


namespace ActiveDirectoryAuthentication.Controllers
{
    public class LoginController : Controller
    {
        [AllowAnonymous]
        public virtual ActionResult Index()
        {
            return View();
        }


        [HttpPost]
        [AllowAnonymous]
        [ValidateAntiForgeryToken]
        public virtual ActionResult Index(LoginViewModel model, string returnUrl)
        {
            if (!ModelState.IsValid)
            {
                return View(model);
            }

            // usually this will be injected via DI. but creating this manually now for brevity
            IAuthenticationManager authenticationManager = HttpContext.GetOwinContext().Authentication;
            var authService = new AdAuthenticationService(authenticationManager);

            var authenticationResult = authService.SignIn(model.Username, model.Password);

            if (authenticationResult.IsSuccess)
            {
                // we are in!
                return RedirectToLocal(returnUrl);
            }

            ModelState.AddModelError("", authenticationResult.ErrorMessage);
            return View(model);
        }


        private ActionResult RedirectToLocal(string returnUrl)
        {
            if (Url.IsLocalUrl(returnUrl))
            {
                return Redirect(returnUrl);
            }
            return RedirectToAction("Index", "Home");
        }


        [ValidateAntiForgeryToken]
        public virtual ActionResult Logoff()
        {
            IAuthenticationManager authenticationManager = HttpContext.GetOwinContext().Authentication;
            authenticationManager.SignOut(MyAuthentication.ApplicationCookie);

            return RedirectToAction("Index");
        }
    }


    public class LoginViewModel
    {
        [Required, AllowHtml]
        public string Username { get; set; }

        [Required]
        [AllowHtml]
        [DataType(DataType.Password)]
        public string Password { get; set; }
    }
}
</code></pre> 
        <p>Now you will be able to login with your own PC password. On my home PC I have no Domain, so when I’m creating a <code>authenticationType</code> I show <code>ContextType.Machine</code> – this will check username/password against users on your local machine. This is handy for development time if your machine is not in domain. When you deploy to the server most likely you’ll have to change this to <code>ContextType.Domain</code>. In the code above I do this change by compilation type – if you compile in Debug, you’ll get Machine authentication; for Release configuration you’ll get Domain authentication. In my latest project that uses this type of authentication I specify what type of authentication I need in <code>web.config</code>. You can do it, but leave it for later, once you have everything running as required.</p> 
        <p>So once you authenticated an authentication cookie is set on your requests. The only minor problem is that we don’t see logged-in username anywhere and no way to log-out. Let’s make this happen.</p> 
        <p>In <code>Views/Shared</code> create new Razor file <code>_LoginPartial.cshtml</code>:</p> 
        <pre><code>@if (Request.IsAuthenticated)
{
    using (Html.BeginForm("Logoff", "Login", FormMethod.Post, new { id = "logoutForm", @class = "navbar-right" }))
    {
        @Html.AntiForgeryToken()

        &lt;ul class="nav navbar-nav navbar-right dropdown"&gt;
            &lt;li class="dropdown"&gt;
                &lt;a href="#" class="dropdown-toggle" data-toggle="dropdown"&gt;@User.Identity.Name&lt;span class="caret"&gt;&lt;/span&gt;&lt;/a&gt;
                &lt;ul class="dropdown-menu" role="menu"&gt;
                    &lt;li&gt;&lt;a href="javascript:document.getElementById('logoutForm').submit()"&gt;Log off&lt;/a&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
    }
}
else
{
    &lt;ul class="nav navbar-nav navbar-right"&gt;
        &lt;li&gt;@Html.ActionLink("Log in", "Index", "Login", null, new { id = "loginLink" })&lt;/li&gt;
    &lt;/ul&gt;
}
</code></pre> 
        <p>In <code>Views/Shared/_Layout.cshtml</code> add <code>@Html.Partial("_LoginPartial")</code>:</p> 
        <pre><code>.......SNIP........
&lt;div class="navbar-collapse collapse"&gt;
    &lt;ul class="nav navbar-nav"&gt;
        &lt;li&gt;@Html.ActionLink("Home", "Index", "Home")&lt;/li&gt;
        &lt;li&gt;@Html.ActionLink("About", "About", "Home")&lt;/li&gt;
        &lt;li&gt;@Html.ActionLink("Contact", "Contact", "Home")&lt;/li&gt;
    &lt;/ul&gt;
    @Html.Partial("_LoginPartial")
&lt;/div&gt;
.......SNIP........
</code></pre> 
        <p>And now you should be able to login with your machine/Domain user credentials and logout. You may ask about password reset, but I have not implemented this yet, though I might need it pretty soon – I’ll blog about this separately.</p> 
        <p>In case you struggle, I have posted full solution to <a href="https://github.com/trailmax/OwinADAuthentication">GitHub repository</a>.</p> 
       </div>
       <!-- .entry-content --> 
       <footer class="entry-footer"> 
        <span class="cat-links block">Posted in <a href="http://tech.trailmax.info/category/uncategorized/" rel="category tag">Uncategorized</a>.</span>
        <span class="tag-links block">Tagged <a href="http://tech.trailmax.info/tag/net/" rel="tag">.Net</a>, <a href="http://tech.trailmax.info/tag/active-directory/" rel="tag">Active Directory</a>, <a href="http://tech.trailmax.info/tag/asp-net/" rel="tag">asp.net</a>, <a href="http://tech.trailmax.info/tag/c/" rel="tag">c#</a>, <a href="http://tech.trailmax.info/tag/identity/" rel="tag">Identity</a>, <a href="http://tech.trailmax.info/tag/mvc/" rel="tag">mvc</a>, <a href="http://tech.trailmax.info/tag/recipe/" rel="tag">recipe</a>.</span> 
       </footer>
       <!-- .entry-footer --> 
      </article>
      <!-- #post-1182 --> 
      <div id="disqus_thread"> 
       <div id="dsq-content"> 
        <ul id="dsq-comments"> 
         <li class="comment even thread-even depth-1" id="dsq-comment-433"> 
          <div id="dsq-comment-header-433" class="dsq-comment-header"> 
           <cite id="dsq-cite-433"> <span id="dsq-author-user-433">Michael Chora</span> </cite> 
          </div> 
          <div id="dsq-comment-body-433" class="dsq-comment-body"> 
           <div id="dsq-comment-message-433" class="dsq-comment-message">
            <p>If you follow this step by step.. where you first make the LoginController.cs the following code needs to be updated slightly:</p> 
            <p> public virtual ActionResult Index(LoginViewModel model)<br> {<br> //TODO process login<br> }</p> 
            <p>the ‘//TODO process login’ needs to be ‘return null;’ in order to debug the application.</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment odd alt depth-2" id="dsq-comment-492"> 
            <div id="dsq-comment-header-492" class="dsq-comment-header"> 
             <cite id="dsq-cite-492"> <span id="dsq-author-user-492">MV</span> </cite> 
            </div> 
            <div id="dsq-comment-body-492" class="dsq-comment-body"> 
             <div id="dsq-comment-message-492" class="dsq-comment-message">
              <p>Thank you!</p> 
             </div> 
            </div> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-440"> 
          <div id="dsq-comment-header-440" class="dsq-comment-header"> 
           <cite id="dsq-cite-440"> <span id="dsq-author-user-440">???? ??????</span> </cite> 
          </div> 
          <div id="dsq-comment-body-440" class="dsq-comment-body"> 
           <div id="dsq-comment-message-440" class="dsq-comment-message">
            <p>works fine with local username. i changed compilation debug to “false” in my web.config and i cannot login with my domain credentials. What else i need to do to make it work?</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment odd alt depth-2" id="dsq-comment-441"> 
            <div id="dsq-comment-header-441" class="dsq-comment-header"> 
             <cite id="dsq-cite-441"> <a id="dsq-author-user-441" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-441" class="dsq-comment-body"> 
             <div id="dsq-comment-message-441" class="dsq-comment-message">
              <p>What is the value of `authenticationType` in line `PrincipalContext principalContext = new PrincipalContext(authenticationType);` in `AdAuthenticationService.SignIn()`?</p> 
              <p>Though `debug=”false”` should not make any difference – if this is the only thing changed.</p> 
             </div> 
            </div> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-even depth-1" id="dsq-comment-443"> 
          <div id="dsq-comment-header-443" class="dsq-comment-header"> 
           <cite id="dsq-cite-443"> <span id="dsq-author-user-443">Stefan Kjellberg</span> </cite> 
          </div> 
          <div id="dsq-comment-body-443" class="dsq-comment-body"> 
           <div id="dsq-comment-message-443" class="dsq-comment-message">
            <p>First, very good and informative.<br> Problem I have is that on IIS Express Everything runs fine, but when shifting over to Local IIS I end up with a 500..</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment odd alt depth-2" id="dsq-comment-444"> 
            <div id="dsq-comment-header-444" class="dsq-comment-header"> 
             <cite id="dsq-cite-444"> <a id="dsq-author-user-444" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-444" class="dsq-comment-body"> 
             <div id="dsq-comment-message-444" class="dsq-comment-message">
              <p>What does 500 say? can you get exception message?<br> I almost never use IIS Express, so this project was done on local IIS and I have a production project with this code running on IIS with no problem.</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment even depth-3" id="dsq-comment-447"> 
              <div id="dsq-comment-header-447" class="dsq-comment-header"> 
               <cite id="dsq-cite-447"> <span id="dsq-author-user-447">Stefan Kjellberg</span> </cite> 
              </div> 
              <div id="dsq-comment-body-447" class="dsq-comment-body"> 
               <div id="dsq-comment-message-447" class="dsq-comment-message">
                <p>I fixed it by setting up a new minimal root web site in Local IIS, then publish from VS.<br> So my settings where wrong, have not had time to check exactly what diffs there where.<br> All Auth settings in root was deactivated, but anonymous.</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment odd alt depth-4" id="dsq-comment-448"> 
                <div id="dsq-comment-header-448" class="dsq-comment-header"> 
                 <cite id="dsq-cite-448"> <a id="dsq-author-user-448" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                </div> 
                <div id="dsq-comment-body-448" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-448" class="dsq-comment-message">
                  <p>Good staff. Thanks for sharing – I’ll update the article when I have a bit more time.</p> 
                 </div> 
                </div> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
           <li class="comment even depth-2" id="dsq-comment-445"> 
            <div id="dsq-comment-header-445" class="dsq-comment-header"> 
             <cite id="dsq-cite-445"> <span id="dsq-author-user-445">???? ??????</span> </cite> 
            </div> 
            <div id="dsq-comment-body-445" class="dsq-comment-body"> 
             <div id="dsq-comment-message-445" class="dsq-comment-message">
              <p>I have the same thing, works only in iis express, on local iis i get<br> Username or Password is not correct. no exception</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment odd alt depth-3" id="dsq-comment-446"> 
              <div id="dsq-comment-header-446" class="dsq-comment-header"> 
               <cite id="dsq-cite-446"> <a id="dsq-author-user-446" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
              </div> 
              <div id="dsq-comment-body-446" class="dsq-comment-body"> 
               <div id="dsq-comment-message-446" class="dsq-comment-message">
                <p>I can only think of IIS permissions. I run ApplicationPool as a LocalSystem – maybe this can help?</p> 
               </div> 
              </div> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-458"> 
          <div id="dsq-comment-header-458" class="dsq-comment-header"> 
           <cite id="dsq-cite-458"> <span id="dsq-author-user-458">??????? ?????</span> </cite> 
          </div> 
          <div id="dsq-comment-body-458" class="dsq-comment-body"> 
           <div id="dsq-comment-message-458" class="dsq-comment-message">
            <p>Thank you for an excellent article! Is it possible to transfer the code to the ASP.NET 1.0 Core? And also is it possible to integrate with ASP.NET Identity 3?</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment odd alt depth-2" id="dsq-comment-459"> 
            <div id="dsq-comment-header-459" class="dsq-comment-header"> 
             <cite id="dsq-cite-459"> <a id="dsq-author-user-459" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-459" class="dsq-comment-body"> 
             <div id="dsq-comment-message-459" class="dsq-comment-message">
              <p>Sorry, don’t know. Have not had a chance to play with Core yet. I doubt that `System.DirectoryServices.AccountManagement` has been transferred to Core yet – and it is the key authentication component.</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment even depth-3" id="dsq-comment-460"> 
              <div id="dsq-comment-header-460" class="dsq-comment-header"> 
               <cite id="dsq-cite-460"> <span id="dsq-author-user-460">??????? ?????</span> </cite> 
              </div> 
              <div id="dsq-comment-body-460" class="dsq-comment-body"> 
               <div id="dsq-comment-message-460" class="dsq-comment-message">
                <p>I forgot to clarify that I do not use .NET Core and the full .NET Framework. I got access to the AD. I will continue on.</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment odd alt depth-4" id="dsq-comment-561"> 
                <div id="dsq-comment-header-561" class="dsq-comment-header"> 
                 <cite id="dsq-cite-561"> <span id="dsq-author-user-561">Zig</span> </cite> 
                </div> 
                <div id="dsq-comment-body-561" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-561" class="dsq-comment-message">
                  <p>Have you tried to make it work with core version of .NET?</p> 
                 </div> 
                </div> 
                <ul class="children"> 
                 <li class="comment even depth-5" id="dsq-comment-562"> 
                  <div id="dsq-comment-header-562" class="dsq-comment-header"> 
                   <cite id="dsq-cite-562"> <a id="dsq-author-user-562" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                  </div> 
                  <div id="dsq-comment-body-562" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-562" class="dsq-comment-message">
                    <p>Quick search gives this answer: <a href="http://stackoverflow.com/a/38247274/809357" rel="nofollow">http://stackoverflow.com/a/38247274/809357</a><br> Not sure how much work it’ll be to update my solution to work with this library, but you can give it a try</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                </ul>
                <!-- .children --> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-even depth-1" id="dsq-comment-468"> 
          <div id="dsq-comment-header-468" class="dsq-comment-header"> 
           <cite id="dsq-cite-468"> <span id="dsq-author-user-468">Scott</span> </cite> 
          </div> 
          <div id="dsq-comment-body-468" class="dsq-comment-body"> 
           <div id="dsq-comment-message-468" class="dsq-comment-message">
            <p>Is there a reason you have [AllowHtml]<br> in the LoginViewModel? Isn’t that a security risk?</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-469"> 
            <div id="dsq-comment-header-469" class="dsq-comment-header"> 
             <cite id="dsq-cite-469"> <a id="dsq-author-user-469" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-469" class="dsq-comment-body"> 
             <div id="dsq-comment-message-469" class="dsq-comment-message">
              <p>It is a risk only if you are going to render username or password in pages. But your password should never be displayed anywhere and stored only hashed. And if users have angle brackets in their password and you don’t have this attribute, they will never be able login. Not so much for username, but here usernames are already provided by Active Directory and there is only a limited set of special characters AD allows into username. So if somebody puts some malicious input into username, they’ll never login. Possibly they’ll generate an exception from MVC, but nothing else.</p> 
             </div> 
            </div> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-odd thread-alt depth-1" id="dsq-comment-471"> 
          <div id="dsq-comment-header-471" class="dsq-comment-header"> 
           <cite id="dsq-cite-471"> <span id="dsq-author-user-471">Luis Costa</span> </cite> 
          </div> 
          <div id="dsq-comment-body-471" class="dsq-comment-body"> 
           <div id="dsq-comment-message-471" class="dsq-comment-message">
            <p>hello, I’m having an error in the class AuthenticationResult, in the VST2013 I’m stucked with the operator =&gt; is returning that ; is expected. “public Boolean IsSuccess =&gt; String.IsNullOrEmpty(ErrorMessage); ”<br> could you help me?</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-473"> 
            <div id="dsq-comment-header-473" class="dsq-comment-header"> 
             <cite id="dsq-cite-473"> <a id="dsq-author-user-473" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-473" class="dsq-comment-body"> 
             <div id="dsq-comment-message-473" class="dsq-comment-message">
              <p>It is C# 6 notation. Replace it with something like this:</p> 
              <p>public Boolean IsSuccess()<br> {<br> return String.IsNullOrEmpty(ErrorMessage);<br> }</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment odd alt depth-3" id="dsq-comment-474"> 
              <div id="dsq-comment-header-474" class="dsq-comment-header"> 
               <cite id="dsq-cite-474"> <span id="dsq-author-user-474">Luis Costa</span> </cite> 
              </div> 
              <div id="dsq-comment-body-474" class="dsq-comment-body"> 
               <div id="dsq-comment-message-474" class="dsq-comment-message">
                <p>Yes I had already substitute that. Thanks </p> 
               </div> 
              </div> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-even depth-1" id="dsq-comment-475"> 
          <div id="dsq-comment-header-475" class="dsq-comment-header"> 
           <cite id="dsq-cite-475"> <span id="dsq-author-user-475">Linn</span> </cite> 
          </div> 
          <div id="dsq-comment-body-475" class="dsq-comment-body"> 
           <div id="dsq-comment-message-475" class="dsq-comment-message">
            <p>Hi, I seem to not be able to get the logoff part to work as it does not actually log the user out of the application. I implemented everything as was written here, but I am not sure what is causing the issues. Additionally, I seem to not be able to return to the correct ReturnUrl on successful login, it always takes the path of the fall back controller, even when I add an else statement to the RedirectToLocal(returnUrl). Any help is greatly appreciated.</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment odd alt depth-2" id="dsq-comment-476"> 
            <div id="dsq-comment-header-476" class="dsq-comment-header"> 
             <cite id="dsq-cite-476"> <a id="dsq-author-user-476" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-476" class="dsq-comment-body"> 
             <div id="dsq-comment-message-476" class="dsq-comment-message">
              <p>I’ve seen a lot of problems with logoff when “SomeString” in `authenticationManager.SignOut(“SomeString”)` does not match “SomeString” in Startup.cs `AuthenticationType = “SomeString”,`. Check if that is the case for you.</p> 
              <p>As for redirect to local – many reasons for that, can’t easily help you here.</p> 
             </div> 
            </div> </li>
           <!-- #comment-## --> 
           <li class="comment even depth-2" id="dsq-comment-495"> 
            <div id="dsq-comment-header-495" class="dsq-comment-header"> 
             <cite id="dsq-cite-495"> <span id="dsq-author-user-495">Ivelin Denev</span> </cite> 
            </div> 
            <div id="dsq-comment-body-495" class="dsq-comment-body"> 
             <div id="dsq-comment-message-495" class="dsq-comment-message">
              <p>In order returnUrl to work correctly, index method in the LoginController should be like this:</p> 
              <p>public virtual ActionResult Index( string returnUrl )<br> {<br> ViewBag.ReturnUrl = returnUrl;<br> return View();<br> }</p> 
              <p>And the index view login form should start with:</p> 
              <p> @using (Html.BeginForm(“Index”, “Login”, new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { @class = “form-horizontal”, role = “form” }))</p> 
              <p>This fixed the issue for me.</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment odd alt depth-3" id="dsq-comment-536"> 
              <div id="dsq-comment-header-536" class="dsq-comment-header"> 
               <cite id="dsq-cite-536"> <span id="dsq-author-user-536">David Engel</span> </cite> 
              </div> 
              <div id="dsq-comment-body-536" class="dsq-comment-body"> 
               <div id="dsq-comment-message-536" class="dsq-comment-message">
                <p>I was able to get the redirect to URL working without the ViewBag using BeginForm in the index.cshtml like this:<br> @using (Html.BeginForm(“Index”, “Login”, new { returnUrl = Request.QueryString[“ReturnUrl”] }, FormMethod.Post, new { @class = “form-horizontal”, role = “form” }))</p> 
                <p>-Dave</p> 
               </div> 
              </div> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-477"> 
          <div id="dsq-comment-header-477" class="dsq-comment-header"> 
           <cite id="dsq-cite-477"> <span id="dsq-author-user-477">???? ??????</span> </cite> 
          </div> 
          <div id="dsq-comment-body-477" class="dsq-comment-body"> 
           <div id="dsq-comment-message-477" class="dsq-comment-message">
            <p>after user succesfully loged in, what is the best way to store user details in database (like Surname, GivenName), for logging? thanks.</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment odd alt depth-2" id="dsq-comment-478"> 
            <div id="dsq-comment-header-478" class="dsq-comment-header"> 
             <cite id="dsq-cite-478"> <a id="dsq-author-user-478" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-478" class="dsq-comment-body"> 
             <div id="dsq-comment-message-478" class="dsq-comment-message">
              <p>why do you need to save user details in DB? they are in AD already. Also how is logging using DB?</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment even depth-3" id="dsq-comment-479"> 
              <div id="dsq-comment-header-479" class="dsq-comment-header"> 
               <cite id="dsq-cite-479"> <span id="dsq-author-user-479">???? ??????</span> </cite> 
              </div> 
              <div id="dsq-comment-body-479" class="dsq-comment-body"> 
               <div id="dsq-comment-message-479" class="dsq-comment-message">
                <p>I create a simple application documentflow, for document management, i want to save the document and also a username who saved document</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment odd alt depth-4" id="dsq-comment-480"> 
                <div id="dsq-comment-header-480" class="dsq-comment-header"> 
                 <cite id="dsq-cite-480"> <a id="dsq-author-user-480" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                </div> 
                <div id="dsq-comment-body-480" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-480" class="dsq-comment-message">
                  <p>use this to get username:</p> 
                  <p> public static String GetUsername(this IPrincipal principal)<br> {<br> var claimsPrincipal = principal as ClaimsPrincipal;<br> //TODO claimsPrincipal check for null</p> 
                  <p> var claimsIdentity = principal.Identity as ClaimsIdentity;<br> //TODO claimsIdentity check for null<br> var name = claimsIdentity.FindFirst(ClaimTypes.Name).Value;<br> return name;<br> }</p> 
                  <p> var currentUsername = HttpContext.Current.User.GetUsername();</p> 
                 </div> 
                </div> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-even depth-1" id="dsq-comment-481"> 
          <div id="dsq-comment-header-481" class="dsq-comment-header"> 
           <cite id="dsq-cite-481"> <span id="dsq-author-user-481">Abhilash D K</span> </cite> 
          </div> 
          <div id="dsq-comment-body-481" class="dsq-comment-body"> 
           <div id="dsq-comment-message-481" class="dsq-comment-message">
            <p>Hi. Thank you for a great post like this. Helped me understand a lot. I am able to login through my corporate domain account. I do have one requirement. I don’t want to present a Login screen. I would like to login directly i.e without entering user name and password. How can I achive this? I have tried setting and Providing an Authorize attribute on my HomeController it works. I am not using OWIN middleware there. But If I need the same kind of functionality using OWIN what changes are needed? Also I would like to Show/Hide menus based on the Roles the user is associated with. Could you shed some light on it? I used [Authorize(Roles=@”DOMAINNAMEAdministrators”)]. It did not work maybe because I am not in Administrators role. I tried [Authorize(Roles=@”DOMAINNAMEUsers”)]. It’s asking for UserName and Password. I don’t want that. It should display the HomeControllers Index Action if the user is in Users Role without asking for password. Please could you guide me how to do that?</p> 
            <p>Thanks in Advance</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment odd alt depth-2" id="dsq-comment-482"> 
            <div id="dsq-comment-header-482" class="dsq-comment-header"> 
             <cite id="dsq-cite-482"> <a id="dsq-author-user-482" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-482" class="dsq-comment-body"> 
             <div id="dsq-comment-message-482" class="dsq-comment-message">
              <p>Try removing “DOMAINNAME” from your filter.</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment even depth-3" id="dsq-comment-483"> 
              <div id="dsq-comment-header-483" class="dsq-comment-header"> 
               <cite id="dsq-cite-483"> <span id="dsq-author-user-483">Abhilash D K</span> </cite> 
              </div> 
              <div id="dsq-comment-body-483" class="dsq-comment-body"> 
               <div id="dsq-comment-message-483" class="dsq-comment-message">
                <p>Hi Thank you. Can you guide me how to login automatically without using Login Form.</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment odd alt depth-4" id="dsq-comment-484"> 
                <div id="dsq-comment-header-484" class="dsq-comment-header"> 
                 <cite id="dsq-cite-484"> <a id="dsq-author-user-484" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                </div> 
                <div id="dsq-comment-body-484" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-484" class="dsq-comment-message">
                  <p>I did briefly look into this and was unable to produce a reliable solution. It all depends on too many factors, including browser and domain configuration. Unfortunately I’m unable to help you in this matter.</p> 
                 </div> 
                </div> 
                <ul class="children"> 
                 <li class="comment even depth-5" id="dsq-comment-485"> 
                  <div id="dsq-comment-header-485" class="dsq-comment-header"> 
                   <cite id="dsq-cite-485"> <span id="dsq-author-user-485">Abhilash D K</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-485" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-485" class="dsq-comment-message">
                    <p>Hi No Problem. Thank you very much. </p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment odd alt depth-5" id="dsq-comment-567"> 
                  <div id="dsq-comment-header-567" class="dsq-comment-header"> 
                   <cite id="dsq-cite-567"> <a id="dsq-author-user-567" href="http://denisemdb.com" target="_blank" rel="nofollow">avatart0ph</a> </cite> 
                  </div> 
                  <div id="dsq-comment-body-567" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-567" class="dsq-comment-message">
                    <p>hi. were you able to come up with a solution?</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment even depth-5" id="dsq-comment-569"> 
                  <div id="dsq-comment-header-569" class="dsq-comment-header"> 
                   <cite id="dsq-cite-569"> <span id="dsq-author-user-569">Abhilash D K</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-569" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-569" class="dsq-comment-message">
                    <p>No. I am not able to find a solution for this. </p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment odd alt depth-5" id="dsq-comment-568"> 
                  <div id="dsq-comment-header-568" class="dsq-comment-header"> 
                   <cite id="dsq-cite-568"> <a id="dsq-author-user-568" href="http://denisemdb.com" target="_blank" rel="nofollow">avatart0ph</a> </cite> 
                  </div> 
                  <div id="dsq-comment-body-568" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-568" class="dsq-comment-message">
                    <p>was wondering, regardless of browser and domain configuration, will auto login still be possible?</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment even depth-5" id="dsq-comment-570"> 
                  <div id="dsq-comment-header-570" class="dsq-comment-header"> 
                   <cite id="dsq-cite-570"> <a id="dsq-author-user-570" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                  </div> 
                  <div id="dsq-comment-body-570" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-570" class="dsq-comment-message">
                    <p>Possible, but I have not spent enough time/effort on this, so won’t be publishing any findings.</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                </ul>
                <!-- .children --> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-odd thread-alt depth-1" id="dsq-comment-493"> 
          <div id="dsq-comment-header-493" class="dsq-comment-header"> 
           <cite id="dsq-cite-493"> <span id="dsq-author-user-493">MV</span> </cite> 
          </div> 
          <div id="dsq-comment-body-493" class="dsq-comment-body"> 
           <div id="dsq-comment-message-493" class="dsq-comment-message">
            <p>In addition to checking username and password, Is there a way to allow people to log in based on whether they are part of a certain AD security group?</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-494"> 
            <div id="dsq-comment-header-494" class="dsq-comment-header"> 
             <cite id="dsq-cite-494"> <a id="dsq-author-user-494" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-494" class="dsq-comment-body"> 
             <div id="dsq-comment-message-494" class="dsq-comment-message">
              <p>See this answer: <a href="http://stackoverflow.com/a/25751247/809357" rel="nofollow">http://stackoverflow.com/a/25751247/809357</a><br> I’ve not had a need in doing this, but you can add all user groups for user as Roles.</p> 
              <p>in `private ClaimsIdentity CreateIdentity(UserPrincipal userPrincipal)` do this:</p> 
              <p> var groups = user.GetAuthorizationGroups();<br> foreach(GroupPrincipal group in groups)<br> {<br> identity.AddClaim(new Claim(ClaimTypes.Role, group.Name));<br> }</p> 
              <p>And then you’ll be able to use [Authorize(Roles=”Admin”)]</p> 
              <p>Disclaimer – not tested, might not work as expected.</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment odd alt depth-3" id="dsq-comment-499"> 
              <div id="dsq-comment-header-499" class="dsq-comment-header"> 
               <cite id="dsq-cite-499"> <span id="dsq-author-user-499">wesly arfan</span> </cite> 
              </div> 
              <div id="dsq-comment-body-499" class="dsq-comment-body"> 
               <div id="dsq-comment-message-499" class="dsq-comment-message">
                <p>i have the same issue and i have tried to do like you suggest, it does not wok yet</p> 
               </div> 
              </div> </li>
             <!-- #comment-## --> 
             <li class="comment even depth-3" id="dsq-comment-503"> 
              <div id="dsq-comment-header-503" class="dsq-comment-header"> 
               <cite id="dsq-cite-503"> <span id="dsq-author-user-503">wesly arfan</span> </cite> 
              </div> 
              <div id="dsq-comment-body-503" class="dsq-comment-body"> 
               <div id="dsq-comment-message-503" class="dsq-comment-message">
                <p>when i tried your suggest on your project that you put in github, it is works.<br> so i have to tried and find the differencces between your and mine.<br> thank you.</p> 
               </div> 
              </div> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-even depth-1" id="dsq-comment-497"> 
          <div id="dsq-comment-header-497" class="dsq-comment-header"> 
           <cite id="dsq-cite-497"> <span id="dsq-author-user-497">wesly arfan</span> </cite> 
          </div> 
          <div id="dsq-comment-body-497" class="dsq-comment-body"> 
           <div id="dsq-comment-message-497" class="dsq-comment-message">
            <p>i have implement and i think it was ok.<br> when i want to set permission of user to access some controller, it does not work.</p> 
            <p> [EnableQuery(MaxExpansionDepth = 4)]<br> [Authorize(Roles = “asset5”)]<br> public IQueryable GetWellActivityMonitoringMasterDataOData()<br> {<br> return db.WELL_ACTIVITY_MONITORING;<br> }</p> 
            <p>for example like that,<br> i have a user that is member of group asset5 in active directory, why can not the user able to acces the GetWellActivityMonitoringMasterDataOData controller?</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-498"> 
            <div id="dsq-comment-header-498" class="dsq-comment-header"> 
             <cite id="dsq-cite-498"> <a id="dsq-author-user-498" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-498" class="dsq-comment-body"> 
             <div id="dsq-comment-message-498" class="dsq-comment-message">
              <p>This is because I don’t do anything with the roles – I don’t read them, I did not add them to the cookie. See the comment below on how to get this implemented.</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment odd alt depth-3" id="dsq-comment-500"> 
              <div id="dsq-comment-header-500" class="dsq-comment-header"> 
               <cite id="dsq-cite-500"> <span id="dsq-author-user-500">wesly arfan</span> </cite> 
              </div> 
              <div id="dsq-comment-body-500" class="dsq-comment-body"> 
               <div id="dsq-comment-message-500" class="dsq-comment-message">
                <p>i have already try your suggest, but get nothing.</p> 
                <p>I get error like this, </p> 
                <p> A network-related or instance-specific error<br> occurred while establishing a connection to SQL Server. The server was<br> not found or was not accessible. Verify that the instance name is<br> correct and that SQL Server is configured to allow remote connections.<br> (provider: SQL Network Interfaces, error: 26 – Error Locating<br> Server/Instance Specified)</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment even depth-4" id="dsq-comment-501"> 
                <div id="dsq-comment-header-501" class="dsq-comment-header"> 
                 <cite id="dsq-cite-501"> <a id="dsq-author-user-501" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                </div> 
                <div id="dsq-comment-body-501" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-501" class="dsq-comment-message">
                  <p>That’s odd. It is trying to reach SQL Server – it should not every think about it. What line causes the exception?</p> 
                 </div> 
                </div> 
                <ul class="children"> 
                 <li class="comment odd alt depth-5" id="dsq-comment-502"> 
                  <div id="dsq-comment-header-502" class="dsq-comment-header"> 
                   <cite id="dsq-cite-502"> <span id="dsq-author-user-502">wesly arfan</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-502" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-502" class="dsq-comment-message">
                    <p>i can’t see where exactly the error come.<br> my program can not reach the code inside my controller.<br> there is never haven my program execute the return View();<br> my controller is like this</p> 
                    <p> [Authorize(Roles = “files-pep-pekarya”)]<br> public ActionResult Index()<br> {<br> return View();<br> }</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment even depth-5" id="dsq-comment-504"> 
                  <div id="dsq-comment-header-504" class="dsq-comment-header"> 
                   <cite id="dsq-cite-504"> <span id="dsq-author-user-504">wesly arfan</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-504" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-504" class="dsq-comment-message">
                    <p>i got it. that is because i add the following code in my webconfig<br> s</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment odd alt depth-5" id="dsq-comment-505"> 
                  <div id="dsq-comment-header-505" class="dsq-comment-header"> 
                   <cite id="dsq-cite-505"> <a id="dsq-author-user-505" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                  </div> 
                  <div id="dsq-comment-body-505" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-505" class="dsq-comment-message">
                    <p>I was about to suggest you to check your web.config, but you got it yourself. Glad it works for you!</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment even depth-5" id="dsq-comment-506"> 
                  <div id="dsq-comment-header-506" class="dsq-comment-header"> 
                   <cite id="dsq-cite-506"> <span id="dsq-author-user-506">wesly arfan</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-506" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-506" class="dsq-comment-message">
                    <p>thank you very much. you much help me.</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                </ul>
                <!-- .children --> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-odd thread-alt depth-1" id="dsq-comment-538"> 
          <div id="dsq-comment-header-538" class="dsq-comment-header"> 
           <cite id="dsq-cite-538"> <span id="dsq-author-user-538">David Engel</span> </cite> 
          </div> 
          <div id="dsq-comment-body-538" class="dsq-comment-body"> 
           <div id="dsq-comment-message-538" class="dsq-comment-message">
            <p>I am using Windows 10 and VS2015. After following the instructions, my login would always return invalid user on IIS Express but when deployed to IIS server, it worked fine. I am using Machine authentication with local users. After some research, I found this related article:</p> 
            <p><a href="http://stackoverflow.com/questions/33717673/system-directoryservices-accountmanagement-principalcontext-broken-after-windows" rel="nofollow">http://stackoverflow.com/questions/33717673/system-directoryservices-accountmanagement-principalcontext-broken-after-windows</a></p> 
            <p>It explains that registry key edits are needed for the ValidateCredentials method to work after some Windows 10 updates in the answer from Doogal. Hope it helps.</p> 
            <p>-Dave</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-540"> 
            <div id="dsq-comment-header-540" class="dsq-comment-header"> 
             <cite id="dsq-cite-540"> <a id="dsq-author-user-540" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-540" class="dsq-comment-body"> 
             <div id="dsq-comment-message-540" class="dsq-comment-message">
              <p>Oh, that explains it – I had people asking me about that exception and I’m on Windows 7. Thanks very much – I’ve added this link to the article</p> 
             </div> 
            </div> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-even depth-1" id="dsq-comment-547"> 
          <div id="dsq-comment-header-547" class="dsq-comment-header"> 
           <cite id="dsq-cite-547"> <span id="dsq-author-user-547">Mark</span> </cite> 
          </div> 
          <div id="dsq-comment-body-547" class="dsq-comment-body"> 
           <div id="dsq-comment-message-547" class="dsq-comment-message">
            <p>Great: this all works well. However, I need to be able to persist logins for a period of time, negating the need to login each time. IsPersistent = true does not seem to work as expected and some of the workarounds I’ve looked at assume a full authentication load rather than your simplified version. In a nutshell, how can I get logins to persist? Thanks</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-548"> 
            <div id="dsq-comment-header-548" class="dsq-comment-header"> 
             <cite id="dsq-cite-548"> <a id="dsq-author-user-548" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-548" class="dsq-comment-body"> 
             <div id="dsq-comment-message-548" class="dsq-comment-message">
              <p>What’s the value for your `ExpireTimeSpan` in `AuthStartup.cs`? IsPersist is known to be flaky at best, so just set longer ExpireTimeStamp. No magic here – cookie is set by the same libraries used in ASP.Net Identity.</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment odd alt depth-3" id="dsq-comment-549"> 
              <div id="dsq-comment-header-549" class="dsq-comment-header"> 
               <cite id="dsq-cite-549"> <span id="dsq-author-user-549">Mark</span> </cite> 
              </div> 
              <div id="dsq-comment-body-549" class="dsq-comment-body"> 
               <div id="dsq-comment-message-549" class="dsq-comment-message">
                <p>TimeSpan.FromDays(90)</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment even depth-4" id="dsq-comment-550"> 
                <div id="dsq-comment-header-550" class="dsq-comment-header"> 
                 <cite id="dsq-cite-550"> <a id="dsq-author-user-550" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                </div> 
                <div id="dsq-comment-body-550" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-550" class="dsq-comment-message">
                  <p>Do you have TimestampValidator configured in any way? How long does the cookie last?</p> 
                 </div> 
                </div> 
                <ul class="children"> 
                 <li class="comment odd alt depth-5" id="dsq-comment-551"> 
                  <div id="dsq-comment-header-551" class="dsq-comment-header"> 
                   <cite id="dsq-cite-551"> <span id="dsq-author-user-551">Mark</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-551" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-551" class="dsq-comment-message">
                    <p>No – I have implemented your code exactly as is (which works great, BTW). Where would that go?</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment even depth-5" id="dsq-comment-552"> 
                  <div id="dsq-comment-header-552" class="dsq-comment-header"> 
                   <cite id="dsq-cite-552"> <a id="dsq-author-user-552" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                  </div> 
                  <div id="dsq-comment-body-552" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-552" class="dsq-comment-message">
                    <p>No, no need in Timestamp validator, but if it is configured – it can be a reason behind the log outs. How long does the login last? What is the actual cookie expiry date set?</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment odd alt depth-5" id="dsq-comment-556"> 
                  <div id="dsq-comment-header-556" class="dsq-comment-header"> 
                   <cite id="dsq-cite-556"> <span id="dsq-author-user-556">Mark</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-556" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-556" class="dsq-comment-message">
                    <p>ExpiresUtc = DateTime.UtcNow.AddDays(1000)</p> 
                    <p>Is that correct?<br> I have read that IsPersistent is a little flaky but this only seems to hold the login for no more than an hour.<br> Appreciate the help.</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment even depth-5" id="dsq-comment-558"> 
                  <div id="dsq-comment-header-558" class="dsq-comment-header"> 
                   <cite id="dsq-cite-558"> <a id="dsq-author-user-558" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                  </div> 
                  <div id="dsq-comment-body-558" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-558" class="dsq-comment-message">
                    <p>No, I mean if you look on cookie records in HTTP Headers (using Fiddler or Developer tools in Chrome), what are the cookie properties? also when you are getting logged out, are cookies getting erased? also, does this answer help: <a href="http://stackoverflow.com/a/37090696/809357" rel="nofollow">http://stackoverflow.com/a/37090696/809357</a></p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                </ul>
                <!-- .children --> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-odd thread-alt depth-1" id="dsq-comment-563"> 
          <div id="dsq-comment-header-563" class="dsq-comment-header"> 
           <cite id="dsq-cite-563"> <span id="dsq-author-user-563">sayish</span> </cite> 
          </div> 
          <div id="dsq-comment-body-563" class="dsq-comment-body"> 
           <div id="dsq-comment-message-563" class="dsq-comment-message">
            <p>hi, will i am able to change domain user passwords and register user in active directory using this approach?</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-564"> 
            <div id="dsq-comment-header-564" class="dsq-comment-header"> 
             <cite id="dsq-cite-564"> <a id="dsq-author-user-564" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-564" class="dsq-comment-body"> 
             <div id="dsq-comment-message-564" class="dsq-comment-message">
              <p>To change user passwords and register new users you need to add more code. Here we just check username/password against AD.</p> 
             </div> 
            </div> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-even depth-1" id="dsq-comment-586"> 
          <div id="dsq-comment-header-586" class="dsq-comment-header"> 
           <cite id="dsq-cite-586"> <span id="dsq-author-user-586">shivani goyal</span> </cite> 
          </div> 
          <div id="dsq-comment-body-586" class="dsq-comment-body"> 
           <div id="dsq-comment-message-586" class="dsq-comment-message">
            <p>Hi, This article helped me a lot. But I am not able to login with my login details. I am running my application on remote machine using mstsc. which credentials should I use?<br> Thanks in advance.</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-587"> 
            <div id="dsq-comment-header-587" class="dsq-comment-header"> 
             <cite id="dsq-cite-587"> <a id="dsq-author-user-587" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-587" class="dsq-comment-body"> 
             <div id="dsq-comment-message-587" class="dsq-comment-message">
              <p>You need to use credentials the same as you use for remote machine</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment odd alt depth-3" id="dsq-comment-588"> 
              <div id="dsq-comment-header-588" class="dsq-comment-header"> 
               <cite id="dsq-cite-588"> <span id="dsq-author-user-588">shivani goyal</span> </cite> 
              </div> 
              <div id="dsq-comment-body-588" class="dsq-comment-body"> 
               <div id="dsq-comment-message-588" class="dsq-comment-message">
                <p>I have tried with both the remote machine credentials as well as with my pc credentials but in both the cases it says “Username or password is incorrect”</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment even depth-4" id="dsq-comment-589"> 
                <div id="dsq-comment-header-589" class="dsq-comment-header"> 
                 <cite id="dsq-cite-589"> <a id="dsq-author-user-589" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                </div> 
                <div id="dsq-comment-body-589" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-589" class="dsq-comment-message">
                  <p>Is this domain account you use or just a machine one? have you accordingly set a value in your ContextType to be ContextType.Machine or ContextType.Domain?</p> 
                 </div> 
                </div> 
                <ul class="children"> 
                 <li class="comment odd alt depth-5" id="dsq-comment-590"> 
                  <div id="dsq-comment-header-590" class="dsq-comment-header"> 
                   <cite id="dsq-cite-590"> <span id="dsq-author-user-590">shivani goyal</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-590" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-590" class="dsq-comment-message">
                    <p>I have tried with both domain as well machine. all permutations and combinations. Still unable to get in…..<br> could you plz tell me where can I check active directory enty?<br> or how does it work?<br> from where AD authentication the existence of the user?<br> Any help would be appreciable :)</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment even depth-5" id="dsq-comment-591"> 
                  <div id="dsq-comment-header-591" class="dsq-comment-header"> 
                   <cite id="dsq-cite-591"> <a id="dsq-author-user-591" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                  </div> 
                  <div id="dsq-comment-body-591" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-591" class="dsq-comment-message">
                    <p>Sorry, can’t be much help here – so many possibilities, not enough data in my hands.</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment odd alt depth-5" id="dsq-comment-592"> 
                  <div id="dsq-comment-header-592" class="dsq-comment-header"> 
                   <cite id="dsq-cite-592"> <span id="dsq-author-user-592">shivani goyal</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-592" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-592" class="dsq-comment-message">
                    <p>I was not using proper credentials. It worked now.<br> Thanx</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment even depth-5" id="dsq-comment-594"> 
                  <div id="dsq-comment-header-594" class="dsq-comment-header"> 
                   <cite id="dsq-cite-594"> <a id="dsq-author-user-594" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                  </div> 
                  <div id="dsq-comment-body-594" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-594" class="dsq-comment-message">
                    <p>Nice! It is always something very simple that gets you!</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                </ul>
                <!-- .children --> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-odd thread-alt depth-1" id="dsq-comment-595"> 
          <div id="dsq-comment-header-595" class="dsq-comment-header"> 
           <cite id="dsq-cite-595"> <span id="dsq-author-user-595">Richard</span> </cite> 
          </div> 
          <div id="dsq-comment-body-595" class="dsq-comment-body"> 
           <div id="dsq-comment-message-595" class="dsq-comment-message">
            <p>Hi there,</p> 
            <p>Thanks for this post! I have managed to integrate your code into a standard MVC 5 project, replacing the Individual logins (e.g. logins stored on SQL). The code works fine and I have managed to login against our local AD server.</p> 
            <p>However I am finding that the session dose not remain “authorized” and User.Identity.IsAuthenticated dose not return true.</p> 
            <p>I know this is probably because I am trying to retro fit an existing MVC 5 project but because of the amount of development which when into the original app I cant just start again. And I need to move it over to AD..</p> 
            <p>Any pointers?<br> Thanks</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-596"> 
            <div id="dsq-comment-header-596" class="dsq-comment-header"> 
             <cite id="dsq-cite-596"> <a id="dsq-author-user-596" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-596" class="dsq-comment-body"> 
             <div id="dsq-comment-message-596" class="dsq-comment-message">
              <p>That’s strange, because I use `User.Identity.IsAuthenticated` in my projects and everything is as expected. One thing to check – in debugger inspect `User.Identity` object. It should actually be `ClaimsIdentity` with the claims. And also check if you have assigned a value to string `MyAuthentication.ApplicationCookie` – this is a description of authentication type. And this is what is looked at when executing `IsAuthenticated`: <a href="https://referencesource.microsoft.com/#mscorlib/system/security/claims/ClaimsIdentity.cs,459" rel="nofollow">https://referencesource.microsoft.com/#mscorlib/system/security/claims/ClaimsIdentity.cs,459</a></p> 
             </div> 
            </div> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-even depth-1" id="dsq-comment-598"> 
          <div id="dsq-comment-header-598" class="dsq-comment-header"> 
           <cite id="dsq-cite-598"> <span id="dsq-author-user-598">Koolbaba Dev</span> </cite> 
          </div> 
          <div id="dsq-comment-body-598" class="dsq-comment-body"> 
           <div id="dsq-comment-message-598" class="dsq-comment-message">
            <p>I downloaded your solution and converted down to .NET 4.5 in VS 2013. When I ran the app in my local, “userPrincipal = UserPrincipal.FindByIdentity(principalContext, username)” always returns null. When I changed the ContextType to ContextType.Domain, “isAuthenticated” always returns false. Am I missing something? Can you please shed some lights? Thank you!</p> 
           </div> 
          </div> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-601"> 
          <div id="dsq-comment-header-601" class="dsq-comment-header"> 
           <cite id="dsq-cite-601"> <span id="dsq-author-user-601">Anthony Griggs</span> </cite> 
          </div> 
          <div id="dsq-comment-body-601" class="dsq-comment-body"> 
           <div id="dsq-comment-message-601" class="dsq-comment-message">
            <p>Much Thanks! You made it real simple and had it up and going in about 15 Minutes! @disqus_ynXTw58tLd:disqus I had the same issue. For me the fix was simply to switch my ContextType.Machine to ContextType.Domain. Although in your case from what you have described it doesn’t look like it’s going to be that simple?</p> 
           </div> 
          </div> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-even depth-1" id="dsq-comment-606"> 
          <div id="dsq-comment-header-606" class="dsq-comment-header"> 
           <cite id="dsq-cite-606"> <span id="dsq-author-user-606">Andrej Milas</span> </cite> 
          </div> 
          <div id="dsq-comment-body-606" class="dsq-comment-body"> 
           <div id="dsq-comment-message-606" class="dsq-comment-message">
            <p>Great article. It’s amazing how little information there is surrounding AD auth + claims management , Microsoft just kind of assumed we would all move toward Azure AD authentication. I think they consider Corp Intranet sites and on-prem AD services ancient history. Meanwhile devs get stuck trying to manage roles in Angular2 clients , with a mish mash of AD , indentity framework and magic.</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-607"> 
            <div id="dsq-comment-header-607" class="dsq-comment-header"> 
             <cite id="dsq-cite-607"> <a id="dsq-author-user-607" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-607" class="dsq-comment-body"> 
             <div id="dsq-comment-message-607" class="dsq-comment-message">
              <p>Well, I’ve found all I needed for this article online. And with some tinkering managed to string it all together for a working solution. So information is there, it is just not well organised.</p> 
             </div> 
            </div> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-odd thread-alt depth-1" id="dsq-comment-611"> 
          <div id="dsq-comment-header-611" class="dsq-comment-header"> 
           <cite id="dsq-cite-611"> <span id="dsq-author-user-611">Bartosz Jarmu?</span> </cite> 
          </div> 
          <div id="dsq-comment-body-611" class="dsq-comment-body"> 
           <div id="dsq-comment-message-611" class="dsq-comment-message">
            <p>Hello,<br> This might be a silly question, but I am all new to this topic and I’m just started reading about authentication.<br> There is a tutorial on the same thing but it is considerably different: <a href="http://www.schiffhauer.com/mvc-5-and-active-directory-authentication/" rel="nofollow">http://www.schiffhauer.com/mvc-5-and-active-directory-authentication/</a></p> 
            <p>The thing that puzzles me is that you do not mention setting up the AD connection string ever… so where/how does the server know against which domain to authenticate?</p> 
            <p>Another thing is that the authentication code inside the Login action itself is considerably different, using different objects… </p> 
            <p>What is the reason behind this differences?</p> 
            <p>===================<br> Also – this is a great post and I also liked the series of related posts, thanks for that!</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-612"> 
            <div id="dsq-comment-header-612" class="dsq-comment-header"> 
             <cite id="dsq-cite-612"> <a id="dsq-author-user-612" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-612" class="dsq-comment-body"> 
             <div id="dsq-comment-message-612" class="dsq-comment-message">
              <p>Difference is that your reference uses Membership Provider that is somewhat outdated and no longer actively developed. I’m using OWIN to set the cookie – this is more modern.</p> 
              <p>As for where does it connect to – connects to the domain if machine is in the domain. Or to the localhost if you are using `.Machine` setting in the configuration.</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment odd alt depth-3" id="dsq-comment-613"> 
              <div id="dsq-comment-header-613" class="dsq-comment-header"> 
               <cite id="dsq-cite-613"> <span id="dsq-author-user-613">Bartosz Jarmu?</span> </cite> 
              </div> 
              <div id="dsq-comment-body-613" class="dsq-comment-body"> 
               <div id="dsq-comment-message-613" class="dsq-comment-message">
                <p>Thanks a lot – I now have to figure out how to specify a different domain than my server is on…</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment even depth-4" id="dsq-comment-614"> 
                <div id="dsq-comment-header-614" class="dsq-comment-header"> 
                 <cite id="dsq-cite-614"> <a id="dsq-author-user-614" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                </div> 
                <div id="dsq-comment-body-614" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-614" class="dsq-comment-message">
                  <p>I’ve not done that, but I suspect you will have to dig into `PrincipalContext` class: <a href="https://msdn.microsoft.com/en-us/library/system.directoryservices.accountmanagement.principalcontext(v=vs.110)" rel="nofollow">https://msdn.microsoft.com/en-us/library/system.directoryservices.accountmanagement.principalcontext(v=vs.110)</a>.aspx</p> 
                 </div> 
                </div> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-even depth-1" id="dsq-comment-618"> 
          <div id="dsq-comment-header-618" class="dsq-comment-header"> 
           <cite id="dsq-cite-618"> <span id="dsq-author-user-618">taimo</span> </cite> 
          </div> 
          <div id="dsq-comment-body-618" class="dsq-comment-body"> 
           <div id="dsq-comment-message-618" class="dsq-comment-message">
            <p>Works great, thanks.</p> 
            <p>I came across your post about preventing multiple logins at <a href="http://tech.trailmax.info/2015/09/prevent-multiple-logins-in-asp-net-identity/" rel="nofollow">http://tech.trailmax.info/2015/09/prevent-multiple-logins-in-asp-net-identity/</a>. How should I implement UserManager class in order to add UserManager.UpdateSecurityStampAsync to controller, and ApplicationUserManager and ApplicationUser classes in Startup.Auth.cs?</p> 
           </div> 
          </div> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-619"> 
          <div id="dsq-comment-header-619" class="dsq-comment-header"> 
           <cite id="dsq-cite-619"> <span id="dsq-author-user-619">Matt</span> </cite> 
          </div> 
          <div id="dsq-comment-body-619" class="dsq-comment-body"> 
           <div id="dsq-comment-message-619" class="dsq-comment-message">
            <p>I was able to replicate your tutorial and it was great. I got it to work/validate locally on my computer with my login through ContextType.Domain. But when I package the project up and deploy it through IIS on Windows Server 2012 I go to run it and it tells me the ldap server was unavailable. Is this on the code, or something I need to setup in IIS for the code to run properly, or is it the connection to the domain? Initially it seems to be the connection but I’m just confused as to why it can work locally but not on the server.</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment odd alt depth-2" id="dsq-comment-620"> 
            <div id="dsq-comment-header-620" class="dsq-comment-header"> 
             <cite id="dsq-cite-620"> <a id="dsq-author-user-620" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-620" class="dsq-comment-body"> 
             <div id="dsq-comment-message-620" class="dsq-comment-message">
              <p>Is your server part of domain? Is there Active Directory available in the domain? If not, it would not work with `ContextType.Domain`.</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment even depth-3" id="dsq-comment-621"> 
              <div id="dsq-comment-header-621" class="dsq-comment-header"> 
               <cite id="dsq-cite-621"> <span id="dsq-author-user-621">Matt</span> </cite> 
              </div> 
              <div id="dsq-comment-body-621" class="dsq-comment-body"> 
               <div id="dsq-comment-message-621" class="dsq-comment-message">
                <p>There is an active directory domain tied to the computer. I use an account to log into the vm that goes through an active directory. but when i go to use that same log in on the application, it doesn’t work. the only time the login works on the vm is when I use ContextType.Computer and log in with the Administrator credentials.</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment odd alt depth-4" id="dsq-comment-622"> 
                <div id="dsq-comment-header-622" class="dsq-comment-header"> 
                 <cite id="dsq-cite-622"> <a id="dsq-author-user-622" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                </div> 
                <div id="dsq-comment-body-622" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-622" class="dsq-comment-message">
                  <p>With this I wouldn’t be able to help – obviously there is some funky AD business going on. I’d look into PrincipalContext overrides: <a href="https://msdn.microsoft.com/en-us/library/system.directoryservices.accountmanagement.principalcontext(v=vs.110)" rel="nofollow">https://msdn.microsoft.com/en-us/library/system.directoryservices.accountmanagement.principalcontext(v=vs.110)</a>.aspx – you’ll be able to specify domain controller name and username/pass to login. One of the combinations will probably work in your setup.</p> 
                 </div> 
                </div> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-even depth-1" id="dsq-comment-624"> 
          <div id="dsq-comment-header-624" class="dsq-comment-header"> 
           <cite id="dsq-cite-624"> <span id="dsq-author-user-624">EE</span> </cite> 
          </div> 
          <div id="dsq-comment-body-624" class="dsq-comment-body"> 
           <div id="dsq-comment-message-624" class="dsq-comment-message">
            <p>where do i need to put this LDAP://tnb.my:389/ ?</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment odd alt depth-2" id="dsq-comment-626"> 
            <div id="dsq-comment-header-626" class="dsq-comment-header"> 
             <cite id="dsq-cite-626"> <a id="dsq-author-user-626" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-626" class="dsq-comment-body"> 
             <div id="dsq-comment-message-626" class="dsq-comment-message">
              <p>Probably here: <a href="https://github.com/trailmax/OwinADAuthentication/blob/master/ActiveDirectoryAuthentication/Models/AdAuthenticationService.cs#L46" rel="nofollow">https://github.com/trailmax/OwinADAuthentication/blob/master/ActiveDirectoryAuthentication/Models/AdAuthenticationService.cs#L46</a> Principal context has constructor overloads that can take server URL, username, password, etc. Check MSDN docs <a href="https://msdn.microsoft.com/en-us/library/system.directoryservices.accountmanagement.principalcontext(v=vs.110)" rel="nofollow">https://msdn.microsoft.com/en-us/library/system.directoryservices.accountmanagement.principalcontext(v=vs.110)</a>.aspx for this</p> 
             </div> 
            </div> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-629"> 
          <div id="dsq-comment-header-629" class="dsq-comment-header"> 
           <cite id="dsq-cite-629"> <span id="dsq-author-user-629">Flexabust bergson</span> </cite> 
          </div> 
          <div id="dsq-comment-body-629" class="dsq-comment-body"> 
           <div id="dsq-comment-message-629" class="dsq-comment-message">
            <p>Thanks for this! It works for me, but only problem is once I am logged in, I get Javascript syntax errors all over the place (which don’t occur when I am not logged in). Any ideas why? My redirections do not work any more, I try to click for example on “search a user” which redirects to a different controller but I get every time this error</p> 
           </div> 
          </div> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-even depth-1" id="dsq-comment-631"> 
          <div id="dsq-comment-header-631" class="dsq-comment-header"> 
           <cite id="dsq-cite-631"> <span id="dsq-author-user-631">Flexabust bergson</span> </cite> 
          </div> 
          <div id="dsq-comment-body-631" class="dsq-comment-body"> 
           <div id="dsq-comment-message-631" class="dsq-comment-message">
            <p>My comment has been deleted maybe it will be back. Thanks for the post, it’s working but I got one issue, the ‘a’ tag inside of _LoginPartial.cshtml containing the user name has a hashtag inside href that makes my whole application crash. I get a javascript syntax error ‘unrecognized expression #’. Taking out href makes it work.</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-632"> 
            <div id="dsq-comment-header-632" class="dsq-comment-header"> 
             <cite id="dsq-cite-632"> <a id="dsq-author-user-632" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-632" class="dsq-comment-body"> 
             <div id="dsq-comment-message-632" class="dsq-comment-message">
              <p>Ah, yeah, I’ve seen your comment in email notification, but could not find it here to reply. Good you found the solution!</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment odd alt depth-3" id="dsq-comment-633"> 
              <div id="dsq-comment-header-633" class="dsq-comment-header"> 
               <cite id="dsq-cite-633"> <span id="dsq-author-user-633">Flexabust bergson</span> </cite> 
              </div> 
              <div id="dsq-comment-body-633" class="dsq-comment-body"> 
               <div id="dsq-comment-message-633" class="dsq-comment-message">
                <p>Thanks! Any idea why that could’ve happened though?</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment even depth-4" id="dsq-comment-634"> 
                <div id="dsq-comment-header-634" class="dsq-comment-header"> 
                 <cite id="dsq-cite-634"> <a id="dsq-author-user-634" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                </div> 
                <div id="dsq-comment-body-634" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-634" class="dsq-comment-message">
                  <p>Sorry, can’t be guessing anything without looking on your codebase.</p> 
                 </div> 
                </div> 
                <ul class="children"> 
                 <li class="comment odd alt depth-5" id="dsq-comment-635"> 
                  <div id="dsq-comment-header-635" class="dsq-comment-header"> 
                   <cite id="dsq-cite-635"> <span id="dsq-author-user-635">Flexabust bergson</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-635" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-635" class="dsq-comment-message">
                    <p>Ok no problem, thanks again for this :)</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                </ul>
                <!-- .children --> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
         <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-664"> 
          <div id="dsq-comment-header-664" class="dsq-comment-header"> 
           <cite id="dsq-cite-664"> <span id="dsq-author-user-664">Otman Ighoulassen</span> </cite> 
          </div> 
          <div id="dsq-comment-body-664" class="dsq-comment-body"> 
           <div id="dsq-comment-message-664" class="dsq-comment-message">
            <p>Great Article ! Complete and straightforward.<br> Thanks a lot.</p> 
           </div> 
          </div> </li>
         <!-- #comment-## --> 
         <li class="comment odd alt thread-even depth-1" id="dsq-comment-665"> 
          <div id="dsq-comment-header-665" class="dsq-comment-header"> 
           <cite id="dsq-cite-665"> <span id="dsq-author-user-665">Chris Wiles</span> </cite> 
          </div> 
          <div id="dsq-comment-body-665" class="dsq-comment-body"> 
           <div id="dsq-comment-message-665" class="dsq-comment-message">
            <p>Thanks for putting this together and is working for a single domain. What should I do if I need to login with a different domain that’s in our forest? There will be cases where I’ll need to login as a different “elevated” user for specific domains, and be able to input the username in the “DOMAINusername” format. I’m only able to get the username to work if I enter it without the domain, and it only authenticates with the current domain that the application resides.</p> 
           </div> 
          </div> 
          <ul class="children"> 
           <li class="comment even depth-2" id="dsq-comment-666"> 
            <div id="dsq-comment-header-666" class="dsq-comment-header"> 
             <cite id="dsq-cite-666"> <a id="dsq-author-user-666" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
            </div> 
            <div id="dsq-comment-body-666" class="dsq-comment-body"> 
             <div id="dsq-comment-message-666" class="dsq-comment-message">
              <p>Chris, I’ve not done this, so can’t be 100% sure. See this bit of code: <a href="https://github.com/trailmax/OwinADAuthentication/blob/master/ActiveDirectoryAuthentication/Models/AdAuthenticationService.cs#L46" rel="nofollow">https://github.com/trailmax/OwinADAuthentication/blob/master/ActiveDirectoryAuthentication/Models/AdAuthenticationService.cs#L46</a> this is where the connection to AD is created. And there are a number of overloads for PrincipalContext: <a href="https://msdn.microsoft.com/en-us/library/system.directoryservices.accountmanagement.principalcontext(v=vs.110)" rel="nofollow">https://msdn.microsoft.com/en-us/library/system.directoryservices.accountmanagement.principalcontext(v=vs.110)</a>.aspx some of them allow you to specify domain – try that.</p> 
             </div> 
            </div> 
            <ul class="children"> 
             <li class="comment odd alt depth-3" id="dsq-comment-667"> 
              <div id="dsq-comment-header-667" class="dsq-comment-header"> 
               <cite id="dsq-cite-667"> <span id="dsq-author-user-667">Chris Wiles</span> </cite> 
              </div> 
              <div id="dsq-comment-body-667" class="dsq-comment-body"> 
               <div id="dsq-comment-message-667" class="dsq-comment-message">
                <p>Thanks! I’ll use one of the overloaded PrincipalContext constructors that allow to specify the name of the domain.</p> 
                <p>Also… The steps in the article work great when debugging, but when I publish it to my localhost IIS (specifically, the Default Web Site), I now get a 404.15 error about a continual Redirection loop maximizing the query string:</p> 
                <p>“http://localhost:80/Login?ReturnUrl=%2FLogin%3FReturnUrl%3D%252FLogin%253FReturnUrl%253D%25252FLogin%25253FReturnUrl%25253D%2525252FLogin%2525253FReturnUrl%2525253D%25252….” etc.</p> 
                <p>Any idea what might be causing this on the local IIS instance?</p> 
               </div> 
              </div> 
              <ul class="children"> 
               <li class="comment even depth-4" id="dsq-comment-668"> 
                <div id="dsq-comment-header-668" class="dsq-comment-header"> 
                 <cite id="dsq-cite-668"> <a id="dsq-author-user-668" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                </div> 
                <div id="dsq-comment-body-668" class="dsq-comment-body"> 
                 <div id="dsq-comment-message-668" class="dsq-comment-message">
                  <p>Is this configured correctly in your code? <a href="https://github.com/trailmax/OwinADAuthentication/blob/master/ActiveDirectoryAuthentication/App_Start/Startup.Auth.cs#L22" rel="nofollow">https://github.com/trailmax/OwinADAuthentication/blob/master/ActiveDirectoryAuthentication/App_Start/Startup.Auth.cs#L22</a></p> 
                  <p>Also do you have [AllowAnonymous] here?: <a href="https://github.com/trailmax/OwinADAuthentication/blob/master/ActiveDirectoryAuthentication/Controllers/LoginController.cs#L14" rel="nofollow">https://github.com/trailmax/OwinADAuthentication/blob/master/ActiveDirectoryAuthentication/Controllers/LoginController.cs#L14</a></p> 
                 </div> 
                </div> 
                <ul class="children"> 
                 <li class="comment odd alt depth-5" id="dsq-comment-669"> 
                  <div id="dsq-comment-header-669" class="dsq-comment-header"> 
                   <cite id="dsq-cite-669"> <span id="dsq-author-user-669">Chris Wiles</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-669" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-669" class="dsq-comment-message">
                    <p>Yes to both. I deleted all the files on the local IIS site and re-published. The loop no longer exists, but now nothing is showing up for the Login view.</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment even depth-5" id="dsq-comment-670"> 
                  <div id="dsq-comment-header-670" class="dsq-comment-header"> 
                   <cite id="dsq-cite-670"> <a id="dsq-author-user-670" href="http://tech.trailmax.info/" target="_blank" rel="nofollow">trailmax</a> </cite> 
                  </div> 
                  <div id="dsq-comment-body-670" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-670" class="dsq-comment-message">
                    <p>The loop means that something on /Login page requires authentication. Do you not have partial views/actions on that page that do not have [AllowAnonymous]? </p> 
                    <p>As for not showing up anything – sorry, can’t help much without looking on your code/server.</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                 <li class="comment odd alt depth-5" id="dsq-comment-671"> 
                  <div id="dsq-comment-header-671" class="dsq-comment-header"> 
                   <cite id="dsq-cite-671"> <span id="dsq-author-user-671">Chris Wiles</span> </cite> 
                  </div> 
                  <div id="dsq-comment-body-671" class="dsq-comment-body"> 
                   <div id="dsq-comment-message-671" class="dsq-comment-message">
                    <p>Everything works as expected now… was a glitch with my VS environment of old files conflicting with new ones once I had renamed the project</p> 
                   </div> 
                  </div> </li>
                 <!-- #comment-## --> 
                </ul>
                <!-- .children --> </li>
               <!-- #comment-## --> 
              </ul>
              <!-- .children --> </li>
             <!-- #comment-## --> 
            </ul>
            <!-- .children --> </li>
           <!-- #comment-## --> 
          </ul>
          <!-- .children --> </li>
         <!-- #comment-## --> 
        </ul> 
       </div> 
      </div> 
      <script type="text/javascript">
var disqus_url = 'http://tech.trailmax.info/2016/03/using-owin-and-active-directory-to-authenticate-users-in-asp-net-mvc-5-application/';
var disqus_identifier = '1182 http://tech.trailmax.info/?p=1182';
var disqus_container_id = 'disqus_thread';
var disqus_shortname = 'trailmaxtech';
var disqus_title = "Using OWIN and Active Directory to authenticate users in ASP.Net MVC 5 application";
var disqus_config_custom = window.disqus_config;
var disqus_config = function () {
    /*
    All currently supported events:
    onReady: fires when everything is ready,
    onNewComment: fires when a new comment is posted,
    onIdentify: fires when user is authenticated
    */
    
    
    this.language = '';
        this.callbacks.onReady.push(function () {

        // sync comments in the background so we don't block the page
        var script = document.createElement('script');
        script.async = true;
        script.src = '?cf_action=sync_comments&post_id=1182';

        var firstScript = document.getElementsByTagName('script')[0];
        firstScript.parentNode.insertBefore(script, firstScript);
    });
    
    if (disqus_config_custom) {
        disqus_config_custom.call(this);
    }
};

(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script> 
      <nav id="nav-single" class="pager"> 
       <h3 class="assistive-text">Post navigation</h3> 
       <span class="next"><a href="http://tech.trailmax.info/2016/03/performance-tuning-of-entity-framework-requests/" rel="next">Next Post <span class="meta-nav">?</span></a></span> 
       <span class="previous"><a href="http://tech.trailmax.info/2016/02/maths-is-hard/" rel="prev"><span class="meta-nav">?</span> Previous Post</a></span> 
      </nav>
      <!-- #nav-single --> 
     </div>
     <!-- #content --> 
    </section>
    <!-- #primary --> 
    <section id="secondary" class="widget-area span4" role="complementary"> 
     <aside id="search-4" class="widget well widget_search">
      <form method="get" id="searchform" class="form-search" action="http://tech.trailmax.info/"> 
       <label for="s" class="assistive-text hidden">Search</label> 
       <div class="input-append"> 
        <input id="s" class="span2 search-query" type="search" name="s" placeholder="Search">
        <!--
	 -->
        <button class="btn btn-primary" name="submit" id="searchsubmit" type="submit">Go</button> 
       </div> 
      </form> 
     </aside>
     <aside id="tag_cloud-4" class="widget well widget_tag_cloud">
      <h2 class="widget-title">Tags</h2>
      <div class="tagcloud">
       <a href="http://tech.trailmax.info/tag/net/" class="tag-cloud-link tag-link-34 tag-link-position-1" style="font-size: 22pt;" aria-label=".Net (78 items)">.Net</a> 
       <a href="http://tech.trailmax.info/tag/asp-net/" class="tag-cloud-link tag-link-86 tag-link-position-2" style="font-size: 14.6056338028pt;" aria-label="asp.net (13 items)">asp.net</a> 
       <a href="http://tech.trailmax.info/tag/autofixture/" class="tag-cloud-link tag-link-68 tag-link-position-3" style="font-size: 10.1690140845pt;" aria-label="Autofixture (4 items)">Autofixture</a> 
       <a href="http://tech.trailmax.info/tag/automation/" class="tag-cloud-link tag-link-61 tag-link-position-4" style="font-size: 11.6478873239pt;" aria-label="automation (6 items)">automation</a> 
       <a href="http://tech.trailmax.info/tag/azure/" class="tag-cloud-link tag-link-70 tag-link-position-5" style="font-size: 14.2112676056pt;" aria-label="azure (12 items)">azure</a> 
       <a href="http://tech.trailmax.info/tag/bat/" class="tag-cloud-link tag-link-42 tag-link-position-6" style="font-size: 9.18309859155pt;" aria-label="bat (3 items)">bat</a> 
       <a href="http://tech.trailmax.info/tag/buildserver/" class="tag-cloud-link tag-link-77 tag-link-position-7" style="font-size: 10.1690140845pt;" aria-label="BuildServer (4 items)">BuildServer</a> 
       <a href="http://tech.trailmax.info/tag/c/" class="tag-cloud-link tag-link-41 tag-link-position-8" style="font-size: 21.3098591549pt;" aria-label="c# (66 items)">c#</a> 
       <a href="http://tech.trailmax.info/tag/cakebuild/" class="tag-cloud-link tag-link-101 tag-link-position-9" style="font-size: 10.1690140845pt;" aria-label="cakebuild (4 items)">cakebuild</a> 
       <a href="http://tech.trailmax.info/tag/commands/" class="tag-cloud-link tag-link-26 tag-link-position-10" style="font-size: 10.1690140845pt;" aria-label="commands (4 items)">commands</a> 
       <a href="http://tech.trailmax.info/tag/dependencyinjection/" class="tag-cloud-link tag-link-52 tag-link-position-11" style="font-size: 13.1267605634pt;" aria-label="Dependency Injection (9 items)">Dependency Injection</a> 
       <a href="http://tech.trailmax.info/tag/di/" class="tag-cloud-link tag-link-75 tag-link-position-12" style="font-size: 12.6338028169pt;" aria-label="di (8 items)">di</a> 
       <a href="http://tech.trailmax.info/tag/drivers/" class="tag-cloud-link tag-link-11 tag-link-position-13" style="font-size: 9.18309859155pt;" aria-label="drivers (3 items)">drivers</a> 
       <a href="http://tech.trailmax.info/tag/eclipse/" class="tag-cloud-link tag-link-24 tag-link-position-14" style="font-size: 9.18309859155pt;" aria-label="eclipse (3 items)">eclipse</a> 
       <a href="http://tech.trailmax.info/tag/entityframework/" class="tag-cloud-link tag-link-43 tag-link-position-15" style="font-size: 12.6338028169pt;" aria-label="EntityFramework (8 items)">EntityFramework</a> 
       <a href="http://tech.trailmax.info/tag/firefox/" class="tag-cloud-link tag-link-13 tag-link-position-16" style="font-size: 9.18309859155pt;" aria-label="firefox (3 items)">firefox</a> 
       <a href="http://tech.trailmax.info/tag/html/" class="tag-cloud-link tag-link-50 tag-link-position-17" style="font-size: 9.18309859155pt;" aria-label="html (3 items)">html</a> 
       <a href="http://tech.trailmax.info/tag/https/" class="tag-cloud-link tag-link-83 tag-link-position-18" style="font-size: 9.18309859155pt;" aria-label="https (3 items)">https</a> 
       <a href="http://tech.trailmax.info/tag/identity/" class="tag-cloud-link tag-link-85 tag-link-position-19" style="font-size: 14.9014084507pt;" aria-label="Identity (14 items)">Identity</a> 
       <a href="http://tech.trailmax.info/tag/iis/" class="tag-cloud-link tag-link-47 tag-link-position-20" style="font-size: 12.1408450704pt;" aria-label="iis (7 items)">iis</a> 
       <a href="http://tech.trailmax.info/tag/java/" class="tag-cloud-link tag-link-28 tag-link-position-21" style="font-size: 9.18309859155pt;" aria-label="java (3 items)">java</a> 
       <a href="http://tech.trailmax.info/tag/javascript/" class="tag-cloud-link tag-link-57 tag-link-position-22" style="font-size: 10.9577464789pt;" aria-label="javascript (5 items)">javascript</a> 
       <a href="http://tech.trailmax.info/tag/jquery/" class="tag-cloud-link tag-link-56 tag-link-position-23" style="font-size: 11.6478873239pt;" aria-label="jquery (6 items)">jquery</a> 
       <a href="http://tech.trailmax.info/tag/linux/" class="tag-cloud-link tag-link-5 tag-link-position-24" style="font-size: 11.6478873239pt;" aria-label="Linux (6 items)">Linux</a> 
       <a href="http://tech.trailmax.info/tag/microsoft/" class="tag-cloud-link tag-link-21 tag-link-position-25" style="font-size: 9.18309859155pt;" aria-label="microsoft (3 items)">microsoft</a> 
       <a href="http://tech.trailmax.info/tag/mocking/" class="tag-cloud-link tag-link-72 tag-link-position-26" style="font-size: 9.18309859155pt;" aria-label="mocking (3 items)">mocking</a> 
       <a href="http://tech.trailmax.info/tag/mvc/" class="tag-cloud-link tag-link-51 tag-link-position-27" style="font-size: 18.6478873239pt;" aria-label="mvc (35 items)">mvc</a> 
       <a href="http://tech.trailmax.info/tag/ntfs/" class="tag-cloud-link tag-link-6 tag-link-position-28" style="font-size: 8pt;" aria-label="NTFS (2 items)">NTFS</a> 
       <a href="http://tech.trailmax.info/tag/openxml/" class="tag-cloud-link tag-link-84 tag-link-position-29" style="font-size: 9.18309859155pt;" aria-label="OpenXml (3 items)">OpenXml</a> 
       <a href="http://tech.trailmax.info/tag/recipe/" class="tag-cloud-link tag-link-53 tag-link-position-30" style="font-size: 17.3661971831pt;" aria-label="recipe (26 items)">recipe</a> 
       <a href="http://tech.trailmax.info/tag/regexp/" class="tag-cloud-link tag-link-44 tag-link-position-31" style="font-size: 9.18309859155pt;" aria-label="regexp (3 items)">regexp</a> 
       <a href="http://tech.trailmax.info/tag/registry/" class="tag-cloud-link tag-link-10 tag-link-position-32" style="font-size: 12.1408450704pt;" aria-label="Registry (7 items)">Registry</a> 
       <a href="http://tech.trailmax.info/tag/script/" class="tag-cloud-link tag-link-7 tag-link-position-33" style="font-size: 10.9577464789pt;" aria-label="script (5 items)">script</a> 
       <a href="http://tech.trailmax.info/tag/sql/" class="tag-cloud-link tag-link-15 tag-link-position-34" style="font-size: 14.2112676056pt;" aria-label="sql (12 items)">sql</a> 
       <a href="http://tech.trailmax.info/tag/sql-server/" class="tag-cloud-link tag-link-27 tag-link-position-35" style="font-size: 15.8873239437pt;" aria-label="sql server (18 items)">sql server</a> 
       <a href="http://tech.trailmax.info/tag/stackoverflow/" class="tag-cloud-link tag-link-46 tag-link-position-36" style="font-size: 9.18309859155pt;" aria-label="stackoverflow (3 items)">stackoverflow</a> 
       <a href="http://tech.trailmax.info/tag/testing/" class="tag-cloud-link tag-link-67 tag-link-position-37" style="font-size: 16.2816901408pt;" aria-label="testing (20 items)">testing</a> 
       <a href="http://tech.trailmax.info/tag/tfs/" class="tag-cloud-link tag-link-81 tag-link-position-38" style="font-size: 10.1690140845pt;" aria-label="tfs (4 items)">tfs</a> 
       <a href="http://tech.trailmax.info/tag/unit-testing/" class="tag-cloud-link tag-link-69 tag-link-position-39" style="font-size: 9.18309859155pt;" aria-label="unit-testing (3 items)">unit-testing</a> 
       <a href="http://tech.trailmax.info/tag/vista/" class="tag-cloud-link tag-link-8 tag-link-position-40" style="font-size: 12.1408450704pt;" aria-label="Vista (7 items)">Vista</a> 
       <a href="http://tech.trailmax.info/tag/visual-studio/" class="tag-cloud-link tag-link-31 tag-link-position-41" style="font-size: 16.0845070423pt;" aria-label="visual studio (19 items)">visual studio</a> 
       <a href="http://tech.trailmax.info/tag/vsts/" class="tag-cloud-link tag-link-98 tag-link-position-42" style="font-size: 11.6478873239pt;" aria-label="VSTS (6 items)">VSTS</a> 
       <a href="http://tech.trailmax.info/tag/windows/" class="tag-cloud-link tag-link-3 tag-link-position-43" style="font-size: 16.2816901408pt;" aria-label="Windows (20 items)">Windows</a> 
       <a href="http://tech.trailmax.info/tag/wireless/" class="tag-cloud-link tag-link-9 tag-link-position-44" style="font-size: 9.18309859155pt;" aria-label="Wireless (3 items)">Wireless</a> 
       <a href="http://tech.trailmax.info/tag/xp/" class="tag-cloud-link tag-link-4 tag-link-position-45" style="font-size: 13.9154929577pt;" aria-label="XP (11 items)">XP</a>
      </div> 
     </aside>
     <aside id="linkcat-2" class="widget well widget_links">
      <h2 class="widget-title">Blogroll</h2> 
      <ul class="xoxo blogroll"> 
       <li><a href="http://hrnet.trailmax.info" target="_blank">HR.Net Consaltancy and blog</a></li> 
       <li><a href="http://tech.trailmax.info/2017/02/my-git-cheat-sheet/" title="My Git Cheat-Sheet">My Git Cheat-Sheet</a></li> 
       <li><a href="https://twitter.com/trailmax" target="_blank">My Twitter</a></li> 
      </ul> 
     </aside> 
    </section>
    <!-- #secondary .widget-area --> 
    <script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-500128-11']);
_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script> 
    <footer id="colophon" role="contentinfo" class="span12"> 
     <div id="page-footer" class="well clearfix"> 
      <span class="credits alignleft">© 2017 <a href="http://tech.trailmax.info/">Trailmax Tech</a>, all rights reserved.</span> 
      <div id="site-generator"> 
       <a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" target="_blank" rel="generator">Proudly powered by WordPress</a> 
      </div> 
     </div>
     <!-- #page-footer .well .clearfix --> 
    </footer>
    <!-- #colophon --> 
   </div>
   <!-- #page --> 
  </div>
  <!-- .container --> 
  <!-- 59 queries. 0.630 seconds. --> 
  <script type="text/javascript">
        // <![CDATA[
        var disqus_shortname = 'trailmaxtech';
        (function () {
            var nodes = document.getElementsByTagName('span');
            for (var i = 0, url; i < nodes.length; i++) {
                if (nodes[i].className.indexOf('dsq-postid') != -1 && nodes[i].parentNode.tagName == 'A') {
                    nodes[i].parentNode.setAttribute('data-disqus-identifier', nodes[i].getAttribute('data-dsqidentifier'));
                    url = nodes[i].parentNode.href.split('#', 1);
                    if (url.length == 1) { url = url[0]; }
                    else { url = url[1]; }
                    nodes[i].parentNode.href = url + '#disqus_thread';
                }
            }
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
        // ]]>
        </script> 
  <div style="clear:both;width:100%;text-align:center; font-size:11px; ">
   <a target="_blank" title="Facebook Auto Publish" href="http://xyzscripts.com/wordpress-plugins/facebook-auto-publish/details">Facebook Auto Publish</a> Powered By : 
   <a target="_blank" title="PHP Scripts &amp; Programs" href="http://www.xyzscripts.com">XYZScripts.com</a>
  </div>
  <script type="text/javascript" src="http://tech.trailmax.info/wp-content/themes/the-bootstrap/js/bootstrap.min.js?ver=2.0.3"></script> 
  <script type="text/javascript" src="http://tech.trailmax.info/wp-content/themes/the-bootstrap/js/the-bootstrap.min.js?ver=2.0.1"></script> 
  <script type="text/javascript" src="http://tech.trailmax.info/wp-includes/js/wp-embed.min.js?ver=4.8.1"></script> 
  <script type="text/javascript" src="http://tech.trailmax.info/wp-content/plugins/wp-markdown/js/markdown.min.js?ver=1.5.1"></script>   
 </body>
</html>